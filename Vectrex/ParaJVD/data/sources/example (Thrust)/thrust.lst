AS09 Assembler for M6809 [1.40].  Copyright 1994-2005, Frank A. Kingswood                                                                                                                     Page    1
--------------------------------------------------------------------------------------------- THRUST.ASM ----------------------------------------------------------------------------------------------

15614 lines read, no errors in pass 1.
                        ; Vectrex Thrust main program
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        ;----------------------------------------
                        ; THRUST.ASM
                        ;----------------------------------------
                        
                          opt   ;optimizations on
                          include "def.asm"
                        ; Macros, defines and BSS.
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        
0100 =                  ScreenW equ 256
0100 =                  ScreenH equ 256
0008 =                  TileCountX equ 8   ;Must be power of 2
0008 =                  TileCountY equ 8   ;Must be power of 2
0020 =                  TileW equ ScreenW/TileCountX
0020 =                  TileH equ ScreenH/TileCountY
                        
0008 =                  ShipMaxVeloc equ 8      ;Max velocity of ship
                        
00f0 =                  EmptySpaceH = 240       ;Height of empty space over levels
ff10 =                  WorldTopY = -EmptySpaceH
                        
0014 =                  DrawScale equ 20 ;15        ;Scale value used when drawing sprite-vectors
                        
0000 =                  StartLevel = 1 - 1
                        
0002 =                  Fixed = 2               ;Nr of bits to use for fixed point coords (need to change more than this)
                        
                        ;normal setting all 0
0000 =                  Immortal = 0            ;Set to 1 to make ship immortal
0000 =                  Level1Only = 0          ;Set to 1 to only include level 1 (smaller binary for debug)
0000 =                  DemoRecord = 0          ;Set to 1 to record user input for demo-playback.
                        
0040 =                  RefuelDistance = 64             ;Max Y distance from ship to fuel when refueling.
003c =                  BeamLength = 60                 ;Length of tractor beam (distance to pod)
                        
0008 =                  ShipArea = 8                    ;Hit area for ship
0018 =                  PlantArea = 24                  ;Hit area, shot and ship vs powerplant
0006 =                  PodArea = 6                     ;Hit area, carried pod vs gunshots, level, fuelcells
0018 =                  FuelArea = 24                   ;Hit area, shots and ship vs fuelcells
000e =                  GunArea = 14                    ;Hit area, ship shots vs guns
000a =                  SwitchArea = 10                 ;Hit area, shot vs switch
000e =                  StationaryPodArea = 14          ;Hit area, ship vs stationary pod
                        
                        ;B1 is lock, B2 is Tractor, B3 is Thrust, B4 is fire
00d8 =                  DefaultButtonConfig = (3 << 6) | (1 << 4) | (2 << 2) | (0 << 0)
                        ;DefaultButtonConfig = (0 << 6) | (1 << 4) | (2 << 2) | (3 << 0)
                        
0030 =                  WallIntensity = $30
                        
0000 =                    struct LevelEntry
0000 =                      db leSizeX          ;level width in tiles (must be first byte)
0001 =                      db leSizeY          ;level height in tiles
0002 =                      dw leTiles          ;address of tiles
0004 =                      dw leGuns           ;address to list of guns
0006 =                      dw leFuel           ;address to list of fuel pods
0008 =                      dw leOrbX           ;X/Y coords of orb
000a =                      dw leOrbY
000c =                      dw lePowerX         ;X/Y coords of powerplant
000e =                      dw lePowerY
0010 =                      dw leRestart        ;pointer to list of restart points
0012 =                      dw leDoors          ;pointer to list of doors
0014 =                      dw leSwitches       ;pointer to list of doorswitches
                          end struct
                        
0000 =                    struct SpriteEntry
0000 =                      dw seLinesRel       ;address to vectorlist used when drawing not clipped
0002 =                      dw seLinesAbs       ;address to vectorlist used when drawing clipped
                          end struct
                        
0000 =                    struct TileEntry
0000 =                      dw teLinesRel       ;address to vectorlist used when drawing not clipped
0002 =                      dw teLinesAbs       ;address to vectorlist used when drawing clipped
0004 =                      dw teCollisionSub   ;address to subroutine for collisiontest
                          end struct
                        
                        
                        ;Returns an oscillating (sawtooth) value in a
                        ;Max must be power of 2
                        ;Max=4, returns 012210
                        mTicToc macro max
                          local l1
                          lda LoopCounterLow
                          anda #max-1
                          cmpa #max/2
                          bcc l1
                          eora #max-1
                        l1:
                          endm
                        
                        
                        ;Set the hi/lo part of a 16-bit register individually
                        mCombine macro reg,hival,loval
                          ld\1 #(lo hival)<<8 | (lo loval)
                          endm
                        
                        
                        ;Collision test point vs box.
                        ;size is width/height intersection test
                        ;miss_label is where to bransch if no intersection
                        ;u and y points to x1,y1 and x2,y2 respectively
                        ;(x1>=x2 - (size/2)) && (x1<=x2 + (size/2)) &&  (y1>=y2 - (size/2)) && (y1<=y2 + (size/2));
                        mPointVsArea macro size,miss_label, X1,Y1, X2,Y2
                          ldx     X1,u
                          ldd     X2,y
                          subd    #Size/2
                          std -2,s
                          cmpx -2,s
                          lblt    miss_label
                          addd    #size
                          std -2,s
                          cmpx -2,s
                          lbgt    miss_label
                          ldx     Y1,u
                          ldd     Y2,y
                          subd    #Size/2
                          std -2,s
                          cmpx -2,s
                          lblt    miss_label
                          addd    #size
                          std -2,s
                          cmpx -2,s
                          lbgt    miss_label
                          endm
                        
                        
                        ;Collision test point vs rectangle.
                        ;sizeW/H is width/height of rectangle
                        ;x1/y1 is point, x2/y2 is rectangle center
                        ;miss_label is where to branch if no intersection
                        ;u and y points to x1,y1 and x2,y2 respectively
                        ;(x1>=x2 - (sizeW/2)) && (x1<=x2 + (sizeW/2)) &&  (y1>=y2 - (sizeH/2)) && (y1<=y2 + (sizeH/2));
                        mPointVsRect macro sizeW,sizeH,miss_label, X1,Y1, X2,Y2
                          ldx     X1,u
                          ldd     X2,y
                          subd    #sizeW/2
                          std -2,s
                          cmpx -2,s
                          blt    miss_label
                          addd    #sizeW
                          std -2,s
                          cmpx -2,s
                          bgt    miss_label
                          ldx     Y1,u
                          ldd     Y2,y
                          subd    #sizeH/2
                          std -2,s
                          cmpx -2,s
                          blt    miss_label
                          addd    #sizeH
                          std -2,s
                          cmpx -2,s
                          bgt    miss_label
                          endm
                        
                        
                        ;Collision test area vs area
                        ;xmin1,xmax1,ymin1,ymax1 are s-relative dimensions of first rectangle
                        ;centerx2,centery2 are u-relative center-coords of second rectangle
                        ;size2 is height/width of second rectangle
                        mTestAreaVsArea macro xmin1,xmax1,ymin1,ymax1,centerx2,centery2,size2,miss_label
                          ldx     centerx2,u
                        
                          leax    size2/2,x
                          cmpx    xmin1,s
                          blt    miss_label
                        
                          leax    -size2,x
                          cmpx    xmax1,s
                          bgt    miss_label
                        
                          ldx     centery2,u
                          leax    size2/2,x
                          cmpx    ymin1,s
                          blt    miss_label
                        
                          leax    -size2,x
                          cmpx    ymax1,s
                          bgt    miss_label
                          endm
                        
                        
                        ;Helper macro for mDecLocals
                        _mLocal macro s1,size,label
                         if s1>0
                           if size=1
                        LocalB\3 = FrameSize
                           endif
                           if size=2
                        LocalW\3 = FrameSize
                           endif
                        FrameSize=FrameSize + size
                        s1=s1-1
                         endif
                         endm
                        
                        ;Declare local stack frame.
                        ;  s1 nr of 1-byte locals,
                        ;  s2 nr of 2-byte locals
                        ;  bufsize is size of extra buffer (can be omitted)
                        ;Locals are named Local1B etc for byte, Local1W for word, buffer is named LocalBuffer.
                        mDecLocals macro s1,s2,bufsize
                          nolist
                        FrameSize=0
                        _aa=s1                  ;declare one byte locals
                          _mLocal _aa,1,1
                          _mLocal _aa,1,2
                          _mLocal _aa,1,3
                          _mLocal _aa,1,4
                          _mLocal _aa,1,5
                          _mLocal _aa,1,6
                          _mLocal _aa,1,7
                          ;7 B is max, add more if needed
                        _aa=s2                  ;declare two byte locals
                          _mLocal _aa,2,1
                          _mLocal _aa,2,2
                          _mLocal _aa,2,3
                          _mLocal _aa,2,4
                          _mLocal _aa,2,5
                          if \0=3              ;declare buffer
                        LocalBuffer = FrameSize
                        FrameSize = FrameSize + bufsize
                          endif
                          ;5 W is max, add more if needed
                          leas -FrameSize,s
                          list
                         endm
                        
                        ;Free local stack frame declared with mDecLocals
                        mFreeLocals macro
                          leas FrameSize,s
                         endm
                        
                        
                        mSetFlag macro flag
                          if 255>flag
                            lda #flag
                            ora GameFlags1
                            sta GameFlags1
                          else
                            lda #(flag)>>8
                            ora GameFlags2
                            sta GameFlags2
                          endif
                          endm
                        
                        mTestFlag macro flag
                          if 255>flag
                            lda GameFlags1
                            bita #flag
                          else
                            lda GameFlags2
                            bita #(flag)>>8
                          endif
                          endm
                        
                        mClearFlag macro flag
                          if 255>flag
                            lda #~flag
                            anda GameFlags1
                            sta GameFlags1
                          else
                            lda #~((flag)>>8)
                            anda GameFlags2
                            sta GameFlags2
                          endif
                          endm
                        
                        ;D0 directs -1, all d0 relative code is written with explicit '<'
                        mDptoD0 macro
                          lda   #0xD0
                          tfr   a,dp
                          direct -1
                          endm
                        
                        ;C8 always directs c8, all game variables are implicitly relative
                        mDptoC8 macro
                          lda   #0xC8
                          tfr   a,dp
                          direct $c8
                          endm
                        
                        
                        ;Returns a value in D between 0-255 if coord is on screen
                        ;Tests for world wrap-around
                        mGetScreenX macro xptr
                          local L143
                          if  \0 = 0    ;no param, X holds X-coord
                            tfr x,y
                          endif
                          if  \0 = 1
                            ldy     xptr
                          endif
                          if  \0 = 2   ;as09 treats "2,y" as two separate macro arguments
                            ldy     \1,\2
                          endif
                          ldx     ViewX
                          tfr     y,d
                          stx -2,s
                          subd -2,s
                          bge     L143
                          ldd     CurLevelEndX
                        ;  stx -2,s
                          subd -2,s
                          sty -2,s
                          addd -2,s
                        L143:
                          endm
                        
                        
                        ;Coordinates in game world are stored in fixed point three bytes
                        ;The integer part is in the first two bytes, the fraction is in the top two bits of the third byte
                        
                        ;Store d into three bytes in x
                        mStore_D_as_fixed macro
                          clr 2,x
                        
                          asra
                          rorb
                          ror 2,x
                        
                          asra
                          rorb
                          ror 2,x
                        
                          std ,x
                          endm
                        
                        
                        ;Read three bytes from x into d
                        mGet_D_from_fixed macro
                          ldd ,x
                        
                          asl 2,x
                          rolb
                          rola
                        
                          asl 2,x
                          rolb
                          rola
                          endm
                        
                        
                        
                        ;Update x-coordinate in sprite structure. Apply velocity and test for world wrap.
                        ;  u is pointer to sprite structure
                        ;  X_Offset is u-relative offset to 3 byte x-coordinate
                        ;  VelocX_Offset is u-relative offset to x-velocity
                        mUpdateXCoord macro X_Offset, VelocX_Offset
                          local CheckRightEdge,XOk
                          leax X_Offset,u               ;Update sprite X coordinate
                          mGet_D_from_fixed
                          std -2,s
                          ldb VelocX_Offset,u
                          sex
                          addd -2,s
                          mStore_D_as_fixed
                          tsta                          ;Check for world ends
                          bpl CheckRightEdge
                            addd CurLevelEndX           ;Left end hit, wrap
                            std X_Offset,u
                            bra XOk
                        CheckRightEdge:
                            subd CurLevelEndX
                            bmi XOk
                            std X_Offset,u              ;Right edge hit
                        XOk:
                          endm
                        
                        
                        ;Update y-coordinate in sprite structure. Apply velocity and test for top of world.
                        ;  u is pointer to sprite structure
                        ;  X_Offset is u-relative offset to 3 byte x-coordinate
                        ;  VelocX_Offset is u-relative offset to x-velocity
                        ;  HitTopLabel label where to jump if top of world
                        mUpdateYCoord macro Y_Offset, VelocY_Offset, HitTopLabel
                          local NotHitTopOfWorld
                          leax Y_Offset,u               ;Update sprite Y coordinate
                          mGet_D_from_fixed
                          std -2,s
                          ldb VelocY_Offset,u
                          sex
                          addd -2,s
                          cmpd #WorldTopY << Fixed
                          bgt NotHitTopOfWorld
                            lbra HitTopLabel            ;Top of world hit, bransch to remove
                        NotHitTopOfWorld:
                          mStore_D_as_fixed
                          endm
                        
                        
                        
                        
                        ;Clear bit A in address adddr.
                        ;  a holds the bit nr
                        ;  addr is the address of the byte where the bit should be cleared
                        mClearBitA macro addr
                          local lop
                          ldb #255                    ;start with all bits set
                          andcc #$fe                  ;clear carry flag, rolb will shift it into b
                        lop:                          ;rotate a zero into b
                          rolb
                          deca
                          bpl lop
                          andb addr                   ;b now has a hole in it, AND with addr to clear bit
                          stb addr
                          endm
                        
                        ;16 bit version of ClearBitA
                        mClearWordBitA macro addr
                          local lop
                          sta -1,s
                          ldd #$ffff                  ;start with all bits set
                          andcc #$fe                  ;clear carry flag, rolb will shift it into d
                        lop:                          ;rotate a zero into d
                          rolb
                          rola
                          dec -1,s
                          bpl lop
                          anda addr                  ;D now has a hole in it, AND with addr to clear bit
                          andb addr+1
                          std addr
                          endm
                        
                        mSetBitA macro addr
                          local lop,fin
                          ldb #1
                        lop:
                          deca
                          bmi fin
                          rolb
                          bra lop
                        fin:
                          orb addr
                          stb addr
                          endm
                        
                        mSetByte macro addr, value
                         if 0=value
                           clr addr
                         else
                           lda #value
                           sta addr
                         endif
                         endm
                        
                        mSetWord macro addr, value
                         if 0=value
                           clra
                           clrb
                         else
                           ldd #value
                         endif
                         std addr
                         endm
                        
                        
                        ;D = D div TileW
                        mDivTileW macro
                          if TileW > 32
                            asra
                            rorb
                          endif
                          if TileW > 16
                            asra
                            rorb
                          endif
                          if TileW > 8
                            asra
                            rorb
                          endif
                          if TileW > 4
                            asra
                            rorb
                          endif
                          if TileW > 2
                            asra
                            rorb
                          endif
                          if TileW > 1
                            asra
                            rorb
                          endif
                          endm
                        
                        ;D = D div TileH
                        mDivTileH macro
                          if TileH > 32
                            asra
                            rorb
                          endif
                          if TileH > 16
                            asra
                            rorb
                          endif
                          if TileH > 8
                            asra
                            rorb
                          endif
                          if TileH > 4
                            asra
                            rorb
                          endif
                          if TileH > 2
                            asra
                            rorb
                          endif
                          if TileH > 1
                            asra
                            rorb
                          endif
                          endm
                        
                        ;x,y is world coords, returns tile pointer in y
                        mGetLevelTile macro
                          ;calc tile pointer: x = tiles + (CurLevelSizeX * (WorldY div TileH)) + (WorldX div TileW)
                          tfr x,d               ;x
                          mDivTileW
                          ldx CurLevelEntry
                          ldx leTiles,x
                          abx
                          tfr y,d               ;y
                          mDivTileH
                          lda CurLevelSizeX
                          mul
                          leax d,x
                          endm
                        
                        
                        
                        
                        ;Get a random value to A
                        mRandomToA macro
                          jsr random                    ;call rom
                          endm
                        
                        ;Set pointer to three byte random seed in u, save old ptr in oldptr,s
                        mSetRandomSeedToU macro oldptr
                          if \0=1
                            ldd $c87b
                            std oldptr,s
                          endif
                          stu $c87b
                          endm
                        
                        
                        mTestRangeD macro min,max,falselabel
                          cmpd #min
                          blt falselabel
                          cmpd #max
                          bgt falselabel
                          endm
                        
                        mSetIntensity macro intensity
                          if \0=1
                            lda   #intensity            ;if argument exists, load into a, otherwise use current a
                          endif
                          if false
                            sta   <01
                            ;sta   $C827
                            ldd   #$0504
                            sta   <00
                            stb   <00
                            stb   <00
                            ldb   #01
                            stb   <00
                          endif
                          sta   <01
                          ldd   #$0401
                          sta   <00
                          stb   <00
                          endm
                        
                        
                        mSetScale macro scale
                          if \0=1
                            lda #scale                  ;if argument exists, load into a, otherwise use current a
                          endif
                          sta <$04
                          endm
                        
                        
                        mDrawToD macro
                          local wait1
                          sta   <$01
                          clr   <$00
                        ;  leax  2,x
                          ;Ev. måste flera nop läggas till här för att kompensera att föregående rad
                          ;kommenterats bort
                        ;  nop
                          inc   <$00
                          stb   <$01
                          ldd   #$FF00
                          sta   <$0A
                          stb   <$05
                          lda   #$40
                        wait1:
                          bita  <$0D
                          beq   wait1
                        ;  nop
                          stb   <$0A
                          endm
                        
                        ;Move to d, without the extra wait that the ROM version use
                        mMove_pen_d_Quick macro
                          local PF33D,PF33B,PF341
                          sta   <0x01
                          clr   <0x00
                          lda   #0xCE
                          sta   <0x0C
                          clr   <0x0A
                          inc   <0x00
                          stb   <0x01
                          clr   <0x05
                          ldb   #0x40
                        PF33D: bitb  <0x0D
                          beq   PF33D
                        ;PF33B: lda   #0x04
                        ;PF341: deca
                        ;  bne   PF341
                          endm
                        
                        ;move pen to d
                         if false
                        mMove_pen_d macro
                          local PF58B,PF592,PF33B,PF33D,PF341,PF345,exit
                          sta   <0x01
                          clr   <0x00
                          std -2,s
                          lda   #0xCE
                          sta   <0x0C
                          clr   <0x0A
                          inc   <0x00
                          stb   <0x01
                          clr   <0x05
                          ldd -2,s
                          ;inline convert ab to abs
                          ;the following is just to calc how long to wait for finish
                          tsta
                          bpl   PF58B
                          nega
                          bvc   PF58B
                          deca
                        PF58B: tstb
                          bpl   PF592
                          negb
                          bvc   PF592
                          decb
                        PF592:  ;end inline
                          stb   -1,s
                          ora   -1,s
                          ldb   #0x40
                          cmpa  #0x40
                          bls   PF345
                          cmpa  #0x64
                          bls   PF33B
                          lda   #0x08
                          bra   PF33D
                        PF33B: lda   #0x04
                        PF33D: bitb  <0x0D
                          beq   PF33D
                        PF341: deca
                          bne   PF341
                          bra exit
                        PF345: bitb  <0x0D
                          beq   PF345
                        exit:
                         endm
                         endif
                        
                        mDot_at_current_position macro dot_dwell
                          ; From vectrex.txt
                          ;    "(WARNING! high intensity and long Vec_Dot_Dwell might result in a burn in on
                          ;     your vectrex monitor, be carefull while experimenting with this!)"
                          local PF2CC
                               lda   #0xFF
                               sta   <0x0A
                        ;       ldb   #dot_dwell         ;dot_dwell is a value for how long the dot is lit
                        ;PF2CC: decb                     ;dwell is not the same as intensity
                        ;       bne   PF2CC
                               clr   <0x0A
                         endm
                        
                        mGiveScore macro Score
                          lda #Score / 10
                          jsr GiveScoreA
                          endm
                        
                         if false  ;removed in 1.01
                        mVerifyCheckSum macro
                          local vcsLoop,vcsOk
                          ldx #CreditsText-20
                          leax 20,x
                          ldy #0
                          clra
                        vcsLoop:
                          ldb ,x+
                          pshs a
                          andb #7
                          anda #7
                          mul
                          leay d,y
                          puls a
                          inca
                          cmpx #CreditsTextEnd
                          bne vcsLoop
                          cmpy #CreditsTextCheckSum
                          beq vcsOk
                            ;sty ,s      ;crash
                            rts
                        vcsOk:
                         endm
                         endif
                        
                        ;System Executive Entry Points
f85e =                  convert_a_to_bcd_and_add  EQU     $f85e
f87c =                  add_score_d             EQU     $f87c
f256 =                  byte_2_sound_chip       equ $f256
f545 =                  clear_256_bytes         EQU     $f545
f272 =                  clear_sound_chip        equ $f272
f8c7 =                  compare_scores          EQU     $f8c7
f601 =                  convert_angle_to_rise_run EQU     $F601
f27d =                  copy_bytes_2_sound_chip equ $f27d
f85e =                  covert_add_bcd          EQU     $f85e
f495 =                  display_string          EQU     $f495
f289 =                  do_sound                EQU     $f289
f2c5 =                  dot_at_current_position equ  $F2C5
f2c3 =                  dot_at_d                EQU     $f2c3
f2c3 =                  dot_d                   EQU     $f2c3
f2c1 =                  dot_ix                  EQU     $f2c1
f1af =                  dptoC8                  EQU     $f1af
f1aa =                  dptoD0                  EQU     $f1aa
f3df =                  draw_to_d               equ $f3df
f3da =                  draw_vl_a               EQU     $f3da
f3ce =                  draw_vl_count4          EQU     $f3ce
f40e =                  drawl1b                 EQU     $f40e
f434 =                  dwp_with_count=$F434
f92e =                  explosion_snd           EQU     $f92e
f584 =                  get_abs_val_ab          EQU     $F584
f7a9 =                  get_pl_game             EQU     $f7a9
f533 =                  init_music_buf          EQU     $f533
f68d =                  init_sound              EQU     $f68d
f687 =                  init_sound_chk          EQU     $f687
f29d =                  intensity_to_1f         EQU     $f29d
f2a1 =                  intensity_to_3f         EQU     $f2a1
f2a5 =                  intensity_to_5f         EQU     $f2a5
f2a9 =                  intensity_to_7f         EQU     $f2a9
f2ab =                  intensity_to_A          EQU     $f2ab
f1f5 =                  joy_analog              EQU     $f1f5
f67f =                  move_block              EQU     $f67f
f683 =                  move_block2             EQU     $f683
f3b7 =                  move_draw_VL4           EQU     $f3b7
f310 =                  move_pen                EQU     $f310
f30c =                  move_pen7f              EQU     $f30c
f2fc =                  move_pen7f_to_d         EQU     $f2fc
f312 =                  move_pen_d              EQU     $f312
f308 =                  move_penff              EQU     $f308
f2fc =                  moveto_d_7f             EQU     $F2FC
f8d8 =                  check_4_new_hi_score = $f8d8
f8ff =                  obj_hit                 EQU     $f8ff
f373 =                  print_1_string          EQU     $f373
f37a =                  print_at_d              EQU     $f37a
f393 =                  print_ships             EQU     $f393
f37a =                  print_str_d             EQU     $f37a
f38a =                  printu2                 EQU     $f38a
f511 =                  random                  EQU     $f511
f1f8 =                  read_joystick           EQU     $f1f8
f1b4 =                  read_switches           EQU     $f1b4
f1ba =                  read_switches2          EQU     $f1ba
f354 =                  reset0ref               EQU     $f354
f61f =                  rot_vec_list1           EQU     $f61f
f610 =                  rot_vec_list2           EQU     $f610
f84f =                  set_dft_score           EQU     $f84f
f192 =                  waitrecal               EQU     $f192
                        
                        ;System RAM locations
c812 =                  stick1_button1 equ $c812
c813 =                  stick1_button2 equ $c813
c814 =                  stick1_button3 equ $c814
c815 =                  stick1_button4 equ $c815
c82a =                  _text_size              EQU     $c82a
c81f =                  _stick1_mask            EQU     $c81f
c820 =                  _stick2_mask            EQU     $c820
c821 =                  _stick3_mask            EQU     $c821
c822 =                  _stick4_mask            EQU     $c822
c81a =                  _stick_res              EQU     $c81a
c823 =                  _stick_type             EQU     $c823
c81c =                  _pot_y                  EQU     $c81c
c827 =                  _intensity              EQU     $c827
c856 =                  _music_ready            EQU     $c856
c83d =                  _refresh_time           EQU     $c83d
                        
c825 =                  LoopCounterHigh = $C825
c826 =                  LoopCounterLow = $C826
c829 =                  Pattern = $C829
                        
                        
                        ;*****************************
                        ; BSS section.
                        ; Data declared here is not part of the binary image.
                        ; The ORG line tells the assembler where to start allocating memory adresses
                        ; to the names defined in this section.
                        
                        ; Labels needs to be declared before use to let the assembler optimize direct addressing with DP.
                        
                          bss
c880 =                    org $c880
                        
0007 =                  HighscoreEntry = (6+1)  ;score + end $80
                        
                        ;**************
                        ;EEPROM-buffer, loaded with eeprom content or default values on boot
                        ;Keep in sync with eeprom_format
c880 =                  eeprom_buffer           ;32 bytes
c880 =                  ButtonConfig:
c880 =                    ds 1                  ;Button configuration
c881 =                  BonusGameEnabled:
c881 =                    ds 1                  ;non-zero if bonus game is enabled
c882 =                  Highscores:
c882 =                    ds HighscoreEntry*4   ;Highscores for each game mode, including hidden bonus game
c89e =                    ds 31-(*-eeprom_buffer);pad to 32-bytes
c89f =                    ds 1                  ;last byte is checksum
                        ;End of EEPROM
                        ;**************
                        
                        
c8a0 =                  UserRamStart:
                        
                        ;Temps used by refreshdrawlist, and collision
c8a0 =                  TemporaryArea:
c8a0 =                  TempPosXStart: db 0
c8a1 =                  TempPosX: db 0  ;keep
c8a2 =                  TempPosY: db 0  ;together
c8a3 =                  TempTileWY: dw 0
c8a5 =                  TempTileWX: dw 0
c8a7 =                  TempTileWXStart: dw 0
c8a9 =                  TempTilePtr: ds 2
c8ab =                  TempAdjustX: ds 1
                        
                        
                        ;Represents the center point between ship and the pod
                        ;Fixed point 2 bits, 3 bytes
                        ;The fraction part is in the third byte, this makes it easy to read the integer part with ldd.
c8ac =                  CenterX: ds 3
c8af =                  CenterY: ds 3
                        
                        ;Current angle between ship and pod
                        ;8 bit fixed point, hi(Alpha) is 0..240 (unsigned)
00f0 =                  ALPHA_MAX      = 240
c8b2 =                  Alpha: ds 2
c8b2 =                  AlphaHi: equ Alpha
                        
                        ;Amount to change alpha (spin speed)
c8b4 =                  AlphaDelta: ds 2
                        
c8b6 =                  ShipAngle: ds 1
c868 =                  LockedShipAngle = $C868         ;Angle when using locked thrust (rom unused)
                        
c8b7 =                  ShipSpeedX: ds 2
c8b7 =                  ShipSpeedXHi: equ ShipSpeedX
c8b9 =                  ShipSpeedY: ds 2
c8b9 =                  ShipSpeedYHi: equ ShipSpeedY
                        
                        ; Ship coordinates.
                        ; Position in game world.
c8bb =                  ShipX: ds 2     ;keep
c8bd =                  ShipY: ds 2     ;together
                        
                        ; Pod (when carried by ship)
c8bf =                  PodX: ds 2      ;keep
c8c1 =                  PodY: ds 2      ;together
                        
                        ;Ship directions 0--32, 8=up.
                        ;Vectrex ROM direction 0--64, 0=up.
0020 =                  SHIP_DIRMAX       = 32
0040 =                  VEC_DIRMAX        = 64
                        
                        ;Conversion macro: ship angle -> vectrex angle
                        mShipAngleToVec macro reg
                         local l1
                         lsl\1
                         sub\1 #16
                         bpl l1
                           add\1 #VEC_DIRMAX
                        l1:
                         endm
                        
000a =                  ShipVectorCount equ 10
0003 =                  ThrustVectorCount = 3
                        
                        
                        ; Scrolling view
c8c3 =                  ScrollX: ds 1           ;0=no scroll, negative scroll left, positive scroll right
c8c4 =                  ScrollY: ds 1           ;0=no scroll, negative scroll up, positive scroll down
                        
                        
c8c5 =                  NeedRefresh:  db 0      ;1 if need refresh drawlist
                        
                        ; Coordinate in game world for top left edge of screen.
                        ; This value is subtracted from sprite coord to produce screen coord.
c8c6 =                  ViewX: ds 2
c8c8 =                  ViewY: ds 2
                        
                        
                        ; Game mode = difficulty
0000 =                  NormalGame = 0
0001 =                  HardGame = 1
0002 =                  TimeAttackGame = 2
0003 =                  BonusGame = 3
0004 =                  DemoGame = 4
c87a =                  GameMode = $C87A   ;(rom game version)
                        
                        
                        ; Current level
c8ca =                  CurLevelEntry: ds 2
c8cc =                  CurLevelSizeX: ds 1
c8cd =                  CurLevelEndX:  ds 2
c8cf =                  CurLevelEndY:  ds 2     ;Actually highest ViewY (=EndY - ScreenH)
c8d1 =                  CurLevel:      ds 1
                        
                        ; CLIP globals (same as viewx/y)
c8d2 =                  _clip_xmin:     ds   2
c8d4 =                  _clip_ymin:     ds   2
c8d6 =                  _clip_xmax:     ds   2
c8d8 =                  _clip_ymax:     ds   2
                        
                        
                        ; Status-display: Score and fuel
0006 =                  DigitCount = 6
c8da =                  PlayerScore: ds DigitCount
                        ;NOTE first byte after PlayerScore is overwritten in Text_GameOver
c8e0 =                  ShipLives: ds 1
c8e1 =                  ShipFuel: ds 2
                        
                        
                        ; Demo mode, use same RAM as playerscore, no score is displayed in demomode
c8da =                  DemoBase = PlayerScore
c8da =                  DemoMode = DemoBase
c8db =                  DemoPtr = DemoBase+1
c8dd =                  DemoCounter = DemoBase+3
c86c =                  DemoSelected = $C86C            ;temp for which demo was selected in menu (rom unused)
                        
                        ; Time attack
c8e3 =                  TimeAttackTime: ds 1            ;countdown in timeattack game
                        
                        
                        ; Frame counter
                        ; This differs from the ROM loopcounter.
                        ; Two separate counters are combined in one byte, which makes
                        ; non-power of two frame interval tests possible.
                        ; Thanks to Thomas Jentzsch.
0001 =                  FRAME2MASK      = %00000001
00c0 =                  FRAME3MASK      = %11000000
0003 =                  FRAME4MASK      = %00000011
00c1 =                  FRAME6MASK      = FRAME2MASK|FRAME3MASK     ; %11000001
0007 =                  FRAME8MASK      = %00000111
00c3 =                  FRAME12MASK     = FRAME4MASK|FRAME3MASK     ; %11000011
000f =                  FRAME16MASK     = %00001111
001f =                  FRAME32MASK     = %00011111
00cf =                  FRAME48MASK     = FRAME16MASK|FRAME3MASK    ; %11001111
003f =                  FRAME64MASK     = %00111111
00df =                  FRAME96MASK     = FRAME32MASK|FRAME3MASK    ; %11011111
00ff =                  FRAME192MASK    = FRAME64MASK|FRAME3MASK    ; %11111111
c8e4 =                  FrameCounter: ds 1
                        
                        
                        ;---------------------------------------
c8e5 =                  LevelClearLabel:        ;256 bytes from this label is cleared when a level is finished
                        ;---------------------------------------
                        
                        
                        ; Flags
0001 =                  ShieldFlag = 1          ;ship shield is active
0002 =                  RefuelFlag = 2          ;ship is refueling
0004 =                  HasOrbFlag = 4          ;ship is carrying orb
0008 =                  PullFlag   = 8          ;ship is pulling orb from orb-platform
0010 =                  InactiveFlag = 16       ;ship is invisible and cannot be controlled (exploding, materializing)
0020 =                  ThrustFlag   = 32       ;ship is thrusting
0040 =                  GameOverFlag = 64       ;set when game over
0080 =                  ReverseGravFlag = 128   ;Reverse gravity
0100 =                  NoLandscapeFlag = 256   ;Landscape is invisible
0200 =                  HomingGunShotsFlag = 512  ;Homing gunshots (hard gamemode)
0400 =                  LockedThrustFlag = 1024 ;Locked thrust angle active (hard gamemode)
                        
c8e5 =                  GameFlags1: ds 1
c8e6 =                  GameFlags2: ds 1
                        
                        
                        ; Guns
0010 =                  MaxGunCount = 16
c8e7 =                  GunsActive: ds 2        ;Each bit is a activeflag for a gun
                        
0000 =                    struct GunEntry       ;Guns are stored in rom with level data
0000 =                      ds geGunX,2         ;x
0002 =                      ds geGunY,2         ;y
0004 =                      ds geGunSprite,1    ;sprite id
                          end struct
                        
                        
                        ; Fuel cells
0008 =                  MaxFuelCount = 8
c8e9 =                  FuelActive: ds 1                ;Each bit is a activeflag for a fuel cell
c8ea =                  FuelAmounts: ds MaxFuelCount    ;Amount of fuel left in each cell
0010 =                  FullFuel = 16                   ;Amount of fuel in a full cell
                        
0000 =                    struct FuelEntry      ;Fuel cells are stored in rom with level data
                            ds 2                ;x
                            ds 2                ;y
                          end struct
                        
                        
                        ; Doors and switches
                        
0020 =                  DoorSize = 32                   ;Opencounter for door
                        
0000 =                    struct DoorEntry
0000 =                      db deDoorDir                ;Direction door closes: 0=right, 1=up
0001 =                      dw deDoorX
0003 =                      dw deDoorY
                          end struct
                        
0000 =                    struct SwitchEntry            ;Door switch
0000 =                      dw seSwitchX
0002 =                      dw seSwitchY
0004 =                      db seSwitchDir              ;0=left wall, 1=right wall
                          end struct
                        
                        
c8f2 =                  DoorCounter: ds 1               ;Counter used when opening doors
                        
                        
                        ; Powerplant
c8f3 =                  PowerLife ds 1                  ;hitpoints. <0 = countdown, >0 = hitpoints left
c8f4 =                  PowerShot ds 1                  ;>0 recently shot
                        
                        ; Perfect bonus
c8f5 =                  PerfectBonus: ds 1
                        
                        
                        ; Gun shots
c8f6 =                  GunShotActive: ds 1       ;Each bit is a activeflag for a gunshot.
0003 =                  MaxGunShots = 3
0007 =                  GunShotAllActive = %111   ;Must be in sync with maxgunshots
                        
0000 =                    struct GunShotEntry
0000 =                      ds gsShotX,3          ;3 byte world coordinate
0003 =                      ds gsShotY,3          ;3 byte world coordinate
0006 =                      db gsShotVelocX       ;Velocity
0007 =                      db gsShotVelocY
                          end struct
c8f7 =                  GunShotTimer: ds 1        ;Delay timer for next shot
c8f8 =                  GunShotMask: ds 1         ;Mask and delay for new shots, constants depending on level no and gamemode
c8f9 =                  GunShotDelay: ds 1
c8fa =                  GunShotSpeed: ds 1
c8fb =                  GunShots: ds GunShotEntry * MaxGunShots
                        
                        
                        ; Fx
                        ; Each entry is three bytes:
                        ;    Time       8 bits: timeleft, 0=inactive
                        ;    TargetType 4 bits: ship,Pod,gun,fuel,switch,plant
                        ;    FxType     4 bits: explosion,teleportfx,250score,planetexplode
                        ;    Index      8 bits: fuel,switch etc index
0003 =                  MaxFx = 3
c913 =                  FxList: ds 3 * MaxFx
                        
                        
                        ; Ship shots.
                        
                        ; Max nr of shots active at one time. This value can be increased.
0004 =                  ShipShotCount = 4
                        
                        ; Structure holding info about one shot.
0000 =                    struct ShipShotEntry
0000 =                      db ssShotActive       ;Flag: is shot active?
0001 =                      ds ssShotX,3          ;3 byte world coordinate
0004 =                      ds ssShotY,3          ;3 byte world coordinate
0007 =                      db ssShotVelocX       ;Velocity
0008 =                      db ssShotVelocY
                          end struct
                        
                        ; Array with shots.
c91c =                  ShipShotList:
c91c =                    ds ShipShotEntry * ShipShotCount
                        
                        
                        ;Sound data, see Thrust_Sound.asm
                        ;Sound slot = Sound channel
0003 =                  SlotCount = 3
c940 =                  SoundSlots: ds SlotCount*2              ;contains id,timer of current sound, 0=empty
                        
                        
                        ; Cheat mode, if both are zero then cheat is not active
c86a =                  CheatLives = $C86A  ;rom unused, <>0 for infinitive lives
c86b =                  CheatLevel = $C86B  ;rom unused, <>0 for select start level
c86a =                  Cheat = CheatLives
                        
                        
                        ; Dynamic length, keep at end of BSS-section
c946 =                  DrawList:
                        
                          code
0000 =                    org 0
                        
                          ;ROM-header
0000 : 6720               db $67,$20
0002 : 47434520323030..   db "GCE 2004",$80
000b : fd0d               dw $FD0D      ;ptr to execrom-music
000d : fc3072a8544852..   db $FC,$30,  $72,$A8,  "THRUST FOR VECTREX 1.01",$80
0029 : fc3060a8425920..   db $FC,$30,  $60,$A8,  "BY VILLE ",$6a,$80
0038 : 00                 db $0
                        
0039 :                  Boot:
0039 : bd7eac             jsr eeprom_load
                        
003c : cc0103             ldd #$0103            ;init joystick
003f : fdc81f             std $c81f
                        
                        ;  jsr Zzap_Start        ;uncomment while debugging bonusgame
                        
0042 :                  Start:
                          mDptoD0
0042 : 86d0            >  lda   #0xD0
0044 : 1f8b            >  tfr   a,dp
                       >  direct -1
                        
                        
0046 : bd7ed8             jsr eeprom_save       ;save to eeprom if changed (options and highscores)
0049 : bd5f37             jsr ShowTitleScreen
                        
                          mDptoC8               ;Set DP to C8 for game logic code
004c : 86c8            >  lda   #0xC8
004e : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
                        
0050 : 4f                 clra
0051 : bd296b             jsr InitNewGame
0054 : bd283e             jsr PrepareLevel
                        
0057 :                  MainLoop:
                          mDptoC8               ;Set DP to C8 for game logic code
0057 : 86c8            >  lda   #0xC8
0059 : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
                        
005b : bd0a8f             jsr Ship_Update
005e : bd074f             jsr UpdateFx
0061 : bd1b4a             jsr UpdateGuns
0064 : bd23e0             jsr UpdateShipShots
0067 : bd1c2a             jsr UpdateGunShots
006a : bd1f7e             jsr UpdateDoors
006d : bd1b06             jsr AdjustFuel
0070 : bd1a0f             jsr UpdateFrameCounter
0073 : bd049c             jsr UpdateSound
                        
                          mTestFlag GameOverFlag
                       >  if 255>GameOverFlag
0076 : 96e5            >    lda GameFlags1
0078 : 8540            >    bita #GameOverFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(GameOverFlag)>>8
                       >  endif
                        
007a : 2635               bne GameOver
                        
007c : bd29c6             jsr SetView
007f : bd2b19             jsr RefreshDrawList
                        
                          ;Wait for screen sync
                          ;DP is D0 after call to waitrecal
                          ;Keep DP at D0 for draw vector code
0082 : bdf192             jsr waitrecal
                        
0085 : bdf289             jsr UpdateSoundChip
0088 : bd2a7b             jsr DrawLevel
008b : bd0f14             jsr Ship_Draw
008e : bd2655             jsr DrawShipShots
0091 : bd1f0d             jsr DrawGuns
0094 : bd1dfb             jsr DrawFuel
0097 : bd070d             jsr DrawFx
009a : bd1d8c             jsr DrawGunShots
009d : bd1e29             jsr DrawOrb
00a0 : bd1e47             jsr DrawPowerplant
00a3 : bd2c91             jsr DrawStars
00a6 : bd1fa9             jsr DrawDoors
00a9 : bd1f4c             jsr DrawSwitches
00ac : bd1a28             jsr DrawDisplay
                        
00af : 20a6               bra MainLoop
                        
00b1 :                  GameOver:
00b1 : 96da               lda DemoMode                  ;do not display 'game over' in demo mode
00b3 : 2b03               bmi maiIsDemo
00b5 : bd513a               jsr Text_GameOver
00b8 :                  maiIsDemo:
                        
                          direct -1
00b8 : 2088               bra Start
                        
                        
                        
                          direct $c8
                          include "clip.asm"
                        ; Line-clipping subroutine
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        ; This code was originally written in C and compiled with the GCC for 6809 compiler.
                        
                        ;**optimize:
                        ;  byt ut s++ mot -2,s.
                        ;  byt ut jmp mot bra
                        ;  byt ut lbxx mot bxx
                        
                        
00ba :                  _CohenSutherlandClip:
                        ;;;-----------------------------------------
                        ;;;  PROLOGUE for CohenSutherlandClip
                        ;;;-----------------------------------------
00ba : 32e8e2                   leas    -(30),s ; allocate auto variables
00bd : 3470                     pshs    x,y,u   ;save registers
                        ;;;END PROLOGUE
00bf : 6fe818                   clr     24,s    ;clrqi 24,s
00c2 : aee826                   ldx     38,s    ;movhi: 38,s -> R:x
00c5 : e680                     ldb     ,x+     ;extendqihi: ,x+ -> R:d
00c7 : 1d                       sex
00c8 : 1f03                     tfr     d,u     ;movhi: R:d -> R:u
00ca : afe826                   stx     38,s    ;movhi: R:x -> 38,s
00cd : 335f                     leau    -1,u    ;addhi: R:u = R:u + #-1
00cf : 1183ffff                 cmpu    #-1     ;cmphi:
00d3 : 1027035a                 lbeq    L37
00d7 :                  L38:
00d7 : aee826                   ldx     38,s    ;movhi: 38,s -> R:x
00da : e680                     ldb     ,x+     ;movqi: ,x+ -> R:b
00dc : e7e819                   stb     25,s    ;movqi: R:b -> 25,s
00df : e680                     ldb     ,x+     ;extendqihi: ,x+ -> R:d
00e1 : 1d                       sex
00e2 : e3e82a                   addd    42,s    ;addhi: R:d += 42,s
00e5 : ede822                   std     34,s    ;movhi: R:d -> 34,s
00e8 : e680                     ldb     ,x+     ;extendqihi: ,x+ -> R:d
00ea : 1d                       sex
00eb : afe826                   stx     38,s    ;movhi: R:x -> 38,s
00ee : 10aee82c                 ldy     44,s    ;movhi: 44,s -> R:y
00f2 : 30ab                     leax    d,y     ;addhi: R:x = R:y + R:d
00f4 : afe820                   stx     32,s    ;movhi: R:x -> 32,s
00f7 : 10aee826                 ldy     38,s    ;movhi: 38,s -> R:y
00fb : e6a0                     ldb     ,y+     ;extendqihi: ,y+ -> R:d
00fd : 1d                       sex
00fe : e3e82a                   addd    42,s    ;addhi: R:d += 42,s
0101 : ede81e                   std     30,s    ;movhi: R:d -> 30,s
0104 : e6a0                     ldb     ,y+     ;extendqihi: ,y+ -> R:d
0106 : 1d                       sex
0107 : 10afe826                 sty     38,s    ;movhi: R:y -> 38,s
010b : e3e82c                   addd    44,s    ;addhi: R:d += 44,s
010e : ede81c                   std     28,s    ;movhi: R:d -> 28,s
0111 : 5f                       clrb            ;clrqi REG:b
0112 : 9cd8                     cmpx    _clip_ymax      ;cmphi:
0114 : 2f04                     ble    L39
0116 : c601                     ldb     #1      ;movqi: #1 -> R:b
0118 : 2006                     bra     L40
011a :                  L39:
011a : 9cd4                     cmpx    _clip_ymin      ;cmphi:
011c : 2c02                     bge    L40
011e : c602                     ldb     #2      ;movqi: #2 -> R:b
0120 :                  L40:
0120 : aee822                   ldx     34,s    ;movhi: 34,s -> R:x
0123 : 109ed6                   ldy     _clip_xmax      ;movhi: _clip_xmax -> R:y
0126 : 3420                     pshs    y       ;cmphi: R:y with R:x
0128 : ace1                     cmpx    ,s++    ;cmphi:
012a : 2f04                     ble    L42
012c : ca04                     orb     #4      ;iorqi: b |= #4
012e : 2006                     bra     L43
0130 :                  L42:
0130 : 9cd2                     cmpx    _clip_xmin      ;cmphi:
0132 : 2c02                     bge    L43
0134 : ca08                     orb     #8      ;iorqi: b |= #8
0136 :                  L43:
0136 : e7e81b                   stb     27,s    ;movqi: R:b -> 27,s
0139 : 5f                       clrb            ;clrqi REG:b
013a : aee81c                   ldx     28,s    ;movhi: 28,s -> R:x
013d : 9cd8                     cmpx    _clip_ymax      ;cmphi:
013f : 2f04                     ble    L46
0141 : c601                     ldb     #1      ;movqi: #1 -> R:b
0143 : 2006                     bra     L47
0145 :                  L46:
0145 : 9cd4                     cmpx    _clip_ymin      ;cmphi:
0147 : 2c02                     bge    L47
0149 : c602                     ldb     #2      ;movqi: #2 -> R:b
014b :                  L47:
014b : aee81e                   ldx     30,s    ;movhi: 30,s -> R:x
014e : 3420                     pshs    y       ;cmphi: R:y with R:x
0150 : ace1                     cmpx    ,s++    ;cmphi:
0152 : 2f04                     ble    L49
0154 : ca04                     orb     #4      ;iorqi: b |= #4
0156 : 2006                     bra     L50
0158 :                  L49:
0158 : 9cd2                     cmpx    _clip_xmin      ;cmphi:
015a : 2c02                     bge    L50
015c : ca08                     orb     #8      ;iorqi: b |= #8
015e :                  L50:
015e : e7e81a                   stb     26,s    ;movqi: R:b -> 26,s
0161 : 305f                     leax    -1,u    ;addhi: R:x = R:u + #-1
0163 : af66                     stx     6,s     ;movhi: R:x -> 6,s
0165 : 7e03d4                   jmp     L53
0168 :                  L56:
0168 : e6e81b                   ldb     27,s    ;movqi: 27,s -> R:b
016b : e4e81a                   andb    26,s    ;andqi: R:b &= 26,s
016e : 5d                       tstb            ;tstqi: R:b
016f : 102602b4                 lbne    L36
0173 : 6de81b                   tst     27,s    ;tstqi: MEM:27,s
0176 : 10270133                 lbeq    L58
017a : 31e822                   leay    34,s    ;addhi: R:y = R:s + #34
017d : 10afe812                 sty     18,s    ;movhi: R:y -> 18,s
0181 : 30e820                   leax    32,s    ;addhi: R:x = R:s + #32
0184 : afe810                   stx     16,s    ;movhi: R:x -> 16,s
0187 : e6e819                   ldb     25,s    ;movqi: 25,s -> R:b
018a : c101                     cmpb    #1      ;cmpqi:
018c : 272c                     beq    L59
018e : 2e06                     bgt    L60
0190 : 5d                       tstb            ;tstqi: R:b
0191 : 270d                     beq    L61
0193 : 7e0281                   jmp     L83
0196 :                  L60:
0196 : e6e819                   ldb     25,s    ;movqi: 25,s -> R:b
0199 : c102                     cmpb    #2      ;cmpqi:
019b : 2737                     beq    L63
019d : 7e0281                   jmp     L83
01a0 :                  L61:
01a0 : e6e81b                   ldb     27,s    ;movqi: 27,s -> R:b
01a3 : c401                     andb    #1      ;andqi: R:b &= #1
01a5 : 5d                       tstb            ;tstqi: R:b
01a6 : 2706                     beq    L64
01a8 : 109ed8                   ldy     _clip_ymax      ;movhi: _clip_ymax -> R:y
01ab : 200412                   jmp     L126
01ae :                  L64:
01ae : 109ed4                   ldy     _clip_ymin      ;movhi: _clip_ymin -> R:y
01b1 :                  L126:
01b1 : aee810                   ldx     16,s    ;movhi: 16,s -> R:x
01b4 : 10af84                   sty     ,x      ;movhi: R:y -> ,x
01b7 : 7e0281                   jmp     L83
01ba :                  L59:
01ba : e6e81b                   ldb     27,s    ;movqi: 27,s -> R:b
01bd : c404                     andb    #4      ;andqi: R:b &= #4
01bf : 5d                       tstb            ;tstqi: R:b
01c0 : 2706                     beq    L66
01c2 : 109ed6                   ldy     _clip_xmax      ;movhi: _clip_xmax -> R:y
01c5 : 200412                   jmp     L127
01c8 :                  L66:
01c8 : 109ed2                   ldy     _clip_xmin      ;movhi: _clip_xmin -> R:y
01cb :                  L127:
01cb : aee812                   ldx     18,s    ;movhi: 18,s -> R:x
01ce : 10af84                   sty     ,x      ;movhi: R:y -> ,x
01d1 : 7e0281                   jmp     L83
01d4 :                  L63:
01d4 : e6e81b                   ldb     27,s    ;movqi: 27,s -> R:b
01d7 : c401                     andb    #1      ;andqi: R:b &= #1
01d9 : 5d                       tstb            ;tstqi: R:b
01da : 272e                     beq    L68
01dc : aee810                   ldx     16,s    ;movhi: 16,s -> R:x
01df : ec84                     ldd     ,x      ;movhi: ,x -> R:d
01e1 : ded8                     ldu     _clip_ymax      ;movhi: _clip_ymax -> R:u
01e3 : 3440                     pshs    u       ;subhi: R:d -= R:u
01e5 : a3e1                     subd    ,s++
                                                ;ashlhi: d by #1
01e7 : 58                       aslb
01e8 : 49                       rola
01e9 : 1f02                     tfr     d,y     ;movhi: R:d -> R:y
01eb : aee812                   ldx     18,s    ;movhi: 18,s -> R:x
01ee : ec84                     ldd     ,x      ;movhi: ,x -> R:d
01f0 : 30ab                     leax    d,y     ;addhi: R:x = R:y + R:d
01f2 : 10a3e81e                 cmpd    30,s    ;cmphi:
01f6 : 2d06                     blt    L69
01f8 : 3420                     pshs    y       ;subhi: R:d -= R:y
01fa : a3e1                     subd    ,s++
01fc : 1f01                     tfr     d,x     ;movhi: R:d -> R:x
01fe :                  L69:
01fe : 10aee812                 ldy     18,s    ;movhi: 18,s -> R:y
0202 : afa4                     stx     ,y      ;movhi: R:x -> ,y
0204 : aee810                   ldx     16,s    ;movhi: 16,s -> R:x
0207 : 207612                   jmp     L128
020a :                  L68:
020a : e6e81b                   ldb     27,s    ;movqi: 27,s -> R:b
020d : c402                     andb    #2      ;andqi: R:b &= #2
020f : 5d                       tstb            ;tstqi: R:b
0210 : 272d                     beq    L72
0212 : ded4                     ldu     _clip_ymin      ;movhi: _clip_ymin -> R:u
0214 : 1f30                     tfr     u,d     ;movhi: R:u -> R:d
0216 : 10aee810                 ldy     16,s    ;movhi: 16,s -> R:y
021a : a3a4                     subd    ,y      ;subhi: R:d -= ,y
                                                ;ashlhi: d by #1
021c : 58                       aslb
021d : 49                       rola
021e : 1f02                     tfr     d,y     ;movhi: R:d -> R:y
0220 : aee812                   ldx     18,s    ;movhi: 18,s -> R:x
0223 : ec84                     ldd     ,x      ;movhi: ,x -> R:d
0225 : 30ab                     leax    d,y     ;addhi: R:x = R:y + R:d
0227 : 10a3e81e                 cmpd    30,s    ;cmphi:
022b : 2d06                     blt    L73
022d : 3420                     pshs    y       ;subhi: R:d -= R:y
022f : a3e1                     subd    ,s++
0231 : 1f01                     tfr     d,x     ;movhi: R:d -> R:x
0233 :                  L73:
0233 : 10aee812                 ldy     18,s    ;movhi: 18,s -> R:y
0237 : afa4                     stx     ,y      ;movhi: R:x -> ,y
0239 : aee810                   ldx     16,s    ;movhi: 16,s -> R:x
023c : 204112                   jmp     L128
023f :                  L72:
023f : e6e81b                   ldb     27,s    ;movqi: 27,s -> R:b
0242 : c404                     andb    #4      ;andqi: R:b &= #4
0244 : 5d                       tstb            ;tstqi: R:b
0245 : 270e                     beq    L75
0247 : 10aee812                 ldy     18,s    ;movhi: 18,s -> R:y
024b : eca4                     ldd     ,y      ;movhi: ,y -> R:d
024d : ded6                     ldu     _clip_xmax      ;movhi: _clip_xmax -> R:u
024f : 3440                     pshs    u       ;subhi: R:d -= R:u
0251 : a3e1                     subd    ,s++
0253 : 200a                     bra     L132
0255 :                  L75:
0255 : ded2                     ldu     _clip_xmin      ;movhi: _clip_xmin -> R:u
0257 : 1f30                     tfr     u,d     ;movhi: R:u -> R:d
0259 : 10aee812                 ldy     18,s    ;movhi: 18,s -> R:y
025d : a3a4                     subd    ,y      ;subhi: R:d -= ,y
025f :                  L132:
                                                ;ashrhi: d by #1
025f : 47                       asra
0260 : 56                       rorb
0261 : 1f02                     tfr     d,y     ;movhi: R:d -> R:y
0263 : aee810                   ldx     16,s    ;movhi: 16,s -> R:x
0266 : ec84                     ldd     ,x      ;movhi: ,x -> R:d
0268 : 30ab                     leax    d,y     ;addhi: R:x = R:y + R:d
026a : 10a3e81c                 cmpd    28,s    ;cmphi:
026e : 2d06                     blt    L78
0270 : 3420                     pshs    y       ;subhi: R:d -= R:y
0272 : a3e1                     subd    ,s++
0274 : 1f01                     tfr     d,x     ;movhi: R:d -> R:x
0276 :                  L78:
0276 : 10aee810                 ldy     16,s    ;movhi: 16,s -> R:y
027a : afa4                     stx     ,y      ;movhi: R:x -> ,y
027c : aee812                   ldx     18,s    ;movhi: 18,s -> R:x
027f :                  L128:
027f : ef84                     stu     ,x      ;movhi: R:u -> ,x
0281 :                  L83:
0281 : 10aee822                 ldy     34,s    ;movhi: 34,s -> R:y
0285 : aee820                   ldx     32,s    ;movhi: 32,s -> R:x
0288 : 5f                       clrb            ;clrqi REG:b
0289 : 9cd8                     cmpx    _clip_ymax      ;cmphi:
028b : 2f04                     ble    L84
028d : c601                     ldb     #1      ;movqi: #1 -> R:b
028f : 2006                     bra     L85
0291 :                  L84:
0291 : 9cd4                     cmpx    _clip_ymin      ;cmphi:
0293 : 2c02                     bge    L85
0295 : c602                     ldb     #2      ;movqi: #2 -> R:b
0297 :                  L85:
0297 : 109cd6                   cmpy    _clip_xmax      ;cmphi:
029a : 2f04                     ble    L87
029c : ca04                     orb     #4      ;iorqi: b |= #4
029e : 2007                     bra     L88
02a0 :                  L87:
02a0 : 109cd2                   cmpy    _clip_xmin      ;cmphi:
02a3 : 2c02                     bge    L88
02a5 : ca08                     orb     #8      ;iorqi: b |= #8
02a7 :                  L88:
02a7 : e7e81b                   stb     27,s    ;movqi: R:b -> 27,s
02aa : 7e03d4                   jmp     L53
02ad :                  L58:
02ad : 31e81e                   leay    30,s    ;addhi: R:y = R:s + #30
02b0 : 10af6e                   sty     14,s    ;movhi: R:y -> 14,s
02b3 : 30e81c                   leax    28,s    ;addhi: R:x = R:s + #28
02b6 : af6c                     stx     12,s    ;movhi: R:x -> 12,s
02b8 : 10aee822                 ldy     34,s    ;movhi: 34,s -> R:y
02bc : 10af6a                   sty     10,s    ;movhi: R:y -> 10,s
02bf : ece820                   ldd     32,s    ;movhi: 32,s -> R:d
02c2 : ed68                     std     8,s     ;movhi: R:d -> 8,s
02c4 : e6e819                   ldb     25,s    ;movqi: 25,s -> R:b
02c7 : c101                     cmpb    #1      ;cmpqi:
02c9 : 272b                     beq    L92
02cb : 2e06                     bgt    L93
02cd : 5d                       tstb            ;tstqi: R:b
02ce : 270d                     beq    L94
02d0 : 7e03ab                   jmp     L116
02d3 :                  L93:
02d3 : e6e819                   ldb     25,s    ;movqi: 25,s -> R:b
02d6 : c102                     cmpb    #2      ;cmpqi:
02d8 : 2734                     beq    L96
02da : 7e03ab                   jmp     L116
02dd :                  L94:
02dd : e6e81a                   ldb     26,s    ;movqi: 26,s -> R:b
02e0 : c401                     andb    #1      ;andqi: R:b &= #1
02e2 : 5d                       tstb            ;tstqi: R:b
02e3 : 2706                     beq    L97
02e5 : 109ed8                   ldy     _clip_ymax      ;movhi: _clip_ymax -> R:y
02e8 : 200412                   jmp     L129
02eb :                  L97:
02eb : 109ed4                   ldy     _clip_ymin      ;movhi: _clip_ymin -> R:y
02ee :                  L129:
02ee : ae6c                     ldx     12,s    ;movhi: 12,s -> R:x
02f0 : 10af84                   sty     ,x      ;movhi: R:y -> ,x
02f3 : 7e03ab                   jmp     L116
02f6 :                  L92:
02f6 : e6e81a                   ldb     26,s    ;movqi: 26,s -> R:b
02f9 : c404                     andb    #4      ;andqi: R:b &= #4
02fb : 5d                       tstb            ;tstqi: R:b
02fc : 2705                     beq    L99
02fe : 109ed6                   ldy     _clip_xmax      ;movhi: _clip_xmax -> R:y
0301 : 2003                     bra     L130
0303 :                  L99:
0303 : 109ed2                   ldy     _clip_xmin      ;movhi: _clip_xmin -> R:y
0306 :                  L130:
0306 : ae6e                     ldx     14,s    ;movhi: 14,s -> R:x
0308 : 10af84                   sty     ,x      ;movhi: R:y -> ,x
030b : 7e03ab                   jmp     L116
030e :                  L96:
030e : e6e81a                   ldb     26,s    ;movqi: 26,s -> R:b
0311 : c401                     andb    #1      ;andqi: R:b &= #1
0313 : 5d                       tstb            ;tstqi: R:b
0314 : 2729                     beq    L101
0316 : ae6c                     ldx     12,s    ;movhi: 12,s -> R:x
0318 : ec84                     ldd     ,x      ;movhi: ,x -> R:d
031a : ded8                     ldu     _clip_ymax      ;movhi: _clip_ymax -> R:u
031c : 3440                     pshs    u       ;subhi: R:d -= R:u
031e : a3e1                     subd    ,s++
                                                ;ashlhi: d by #1
0320 : 58                       aslb
0321 : 49                       rola
0322 : 1f02                     tfr     d,y     ;movhi: R:d -> R:y
0324 : ae6e                     ldx     14,s    ;movhi: 14,s -> R:x
0326 : ec84                     ldd     ,x      ;movhi: ,x -> R:d
0328 : 30ab                     leax    d,y     ;addhi: R:x = R:y + R:d
032a : 10a36a                   cmpd    10,s    ;cmphi:
032d : 2d06                     blt    L102
032f : 3420                     pshs    y       ;subhi: R:d -= R:y
0331 : a3e1                     subd    ,s++
0333 : 1f01                     tfr     d,x     ;movhi: R:d -> R:x
0335 :                  L102:
0335 : 10ae6e                   ldy     14,s    ;movhi: 14,s -> R:y
0338 : afa4                     stx     ,y      ;movhi: R:x -> ,y
033a : ae6c                     ldx     12,s    ;movhi: 12,s -> R:x
033c : 206b12                   jmp     L131
033f :                  L101:
033f : e6e81a                   ldb     26,s    ;movqi: 26,s -> R:b
0342 : c402                     andb    #2      ;andqi: R:b &= #2
0344 : 5d                       tstb            ;tstqi: R:b
0345 : 2728                     beq    L105
0347 : ded4                     ldu     _clip_ymin      ;movhi: _clip_ymin -> R:u
0349 : 1f30                     tfr     u,d     ;movhi: R:u -> R:d
034b : 10ae6c                   ldy     12,s    ;movhi: 12,s -> R:y
034e : a3a4                     subd    ,y      ;subhi: R:d -= ,y
                                                ;ashlhi: d by #1
0350 : 58                       aslb
0351 : 49                       rola
0352 : 1f02                     tfr     d,y     ;movhi: R:d -> R:y
0354 : ae6e                     ldx     14,s    ;movhi: 14,s -> R:x
0356 : ec84                     ldd     ,x      ;movhi: ,x -> R:d
0358 : 30ab                     leax    d,y     ;addhi: R:x = R:y + R:d
035a : 10a36a                   cmpd    10,s    ;cmphi:
035d : 2d06                     blt    L106
035f : 3420                     pshs    y       ;subhi: R:d -= R:y
0361 : a3e1                     subd    ,s++
0363 : 1f01                     tfr     d,x     ;movhi: R:d -> R:x
0365 :                  L106:
0365 : 10ae6e                   ldy     14,s    ;movhi: 14,s -> R:y
0368 : afa4                     stx     ,y      ;movhi: R:x -> ,y
036a : ae6c                     ldx     12,s    ;movhi: 12,s -> R:x
036c : 203b12                   jmp     L131
036f :                  L105:
036f : e6e81a                   ldb     26,s    ;movqi: 26,s -> R:b
0372 : c404                     andb    #4      ;andqi: R:b &= #4
0374 : 5d                       tstb            ;tstqi: R:b
0375 : 270d                     beq    L108
0377 : 10ae6e                   ldy     14,s    ;movhi: 14,s -> R:y
037a : eca4                     ldd     ,y      ;movhi: ,y -> R:d
037c : ded6                     ldu     _clip_xmax      ;movhi: _clip_xmax -> R:u
037e : 3440                     pshs    u       ;subhi: R:d -= R:u
0380 : a3e1                     subd    ,s++
0382 : 2009                     bra     L133
0384 :                  L108:
0384 : ded2                     ldu     _clip_xmin      ;movhi: _clip_xmin -> R:u
0386 : 1f30                     tfr     u,d     ;movhi: R:u -> R:d
0388 : 10ae6e                   ldy     14,s    ;movhi: 14,s -> R:y
038b : a3a4                     subd    ,y      ;subhi: R:d -= ,y
038d :                  L133:
                                                ;ashrhi: d by #1
038d : 47                       asra
038e : 56                       rorb
038f : 1f02                     tfr     d,y     ;movhi: R:d -> R:y
0391 : ae6c                     ldx     12,s    ;movhi: 12,s -> R:x
0393 : ec84                     ldd     ,x      ;movhi: ,x -> R:d
0395 : 30ab                     leax    d,y     ;addhi: R:x = R:y + R:d
0397 : 10a368                   cmpd    8,s     ;cmphi:
039a : 2d06                     blt    L111
039c : 3420                     pshs    y       ;subhi: R:d -= R:y
039e : a3e1                     subd    ,s++
03a0 : 1f01                     tfr     d,x     ;movhi: R:d -> R:x
03a2 :                  L111:
03a2 : 10ae6c                   ldy     12,s    ;movhi: 12,s -> R:y
03a5 : afa4                     stx     ,y      ;movhi: R:x -> ,y
03a7 : ae6e                     ldx     14,s    ;movhi: 14,s -> R:x
03a9 :                  L131:
03a9 : ef84                     stu     ,x      ;movhi: R:u -> ,x
03ab :                  L116:
03ab : 10aee81e                 ldy     30,s    ;movhi: 30,s -> R:y
03af : aee81c                   ldx     28,s    ;movhi: 28,s -> R:x
03b2 : 5f                       clrb            ;clrqi REG:b
03b3 : 9cd8                     cmpx    _clip_ymax      ;cmphi:
03b5 : 2f04                     ble    L117
03b7 : c601                     ldb     #1      ;movqi: #1 -> R:b
03b9 : 2006                     bra     L118
03bb :                  L117:
03bb : 9cd4                     cmpx    _clip_ymin      ;cmphi:
03bd : 2c02                     bge    L118
03bf : c602                     ldb     #2      ;movqi: #2 -> R:b
03c1 :                  L118:
03c1 : 109cd6                   cmpy    _clip_xmax      ;cmphi:
03c4 : 2f04                     ble    L120
03c6 : ca04                     orb     #4      ;iorqi: b |= #4
03c8 : 2007                     bra     L121
03ca :                  L120:
03ca : 109cd2                   cmpy    _clip_xmin      ;cmphi:
03cd : 2c02                     bge    L121
03cf : ca08                     orb     #8      ;iorqi: b |= #8
03d1 :                  L121:
03d1 : e7e81a                   stb     26,s    ;movqi: R:b -> 26,s
03d4 :                  L53:
03d4 : e6e81b                   ldb     27,s    ;movqi: 27,s -> R:b
03d7 : eae81a                   orb     26,s    ;iorqi: b |= 26,s
03da : 5d                       tstb            ;tstqi: R:b
03db : 1026fd89                 lbne    L56
03df : ece822                   ldd     34,s    ;movhi: 34,s -> R:d
03e2 : 93d2                     subd    _clip_xmin      ;subhi: R:d -= _clip_xmin
03e4 : ede816                   std     22,s    ;movhi: R:d -> 22,s
03e7 : dcd4                     ldd     _clip_ymin      ;movhi: _clip_ymin -> R:d
03e9 : a3e820                   subd    32,s    ;subhi: R:d -= 32,s
03ec : ede814                   std     20,s    ;movhi: R:d -> 20,s
03ef : aee828                   ldx     40,s    ;movhi: 40,s -> R:x
03f2 : c6ff                     ldb     #-1     ;movqi: #-1 -> R:b
03f4 : e780                     stb     ,x+     ;movqi: R:b -> ,x+
03f6 : e6e815                   ldb     21,s    ;movlsbqihi: 20,s -> R:b (with corrected memadress)
03f9 : cb7f                     addb    #127    ;addqi: R:b += #127
03fb : e780                     stb     ,x+     ;movqi: R:b -> ,x+
03fd : e6e817                   ldb     23,s    ;movlsbqihi: 22,s -> R:b (with corrected memadress)
0400 : cb80                     addb    #-128   ;addqi: R:b += #-128
0402 : e780                     stb     ,x+     ;movqi: R:b -> ,x+
0404 : c601                     ldb     #1      ;movqi: #1 -> R:b
0406 : e780                     stb     ,x+     ;movqi: R:b -> ,x+
0408 : dcd4                     ldd     _clip_ymin      ;movhi: _clip_ymin -> R:d
040a : a3e81c                   subd    28,s    ;subhi: R:d -= 28,s
040d : a3e814                   subd    20,s    ;subhi: R:d -= 20,s
0410 : e780                     stb     ,x+     ;movqi: R:b -> ,x+
0412 : ece81e                   ldd     30,s    ;movhi: 30,s -> R:d
0415 : 93d2                     subd    _clip_xmin      ;subhi: R:d -= _clip_xmin
0417 : a3e816                   subd    22,s    ;subhi: R:d -= 22,s
041a : e780                     stb     ,x+     ;movqi: R:b -> ,x+
041c : afe828                   stx     40,s    ;movhi: R:x -> 40,s
041f : e6e818                   ldb     24,s    ;movqi: 24,s -> R:b
0422 : cb06                     addb    #6      ;addqi: R:b += #6
0424 : e7e818                   stb     24,s    ;movqi: R:b -> 24,s
0427 :                  L36:
0427 : ee66                     ldu     6,s     ;movhi: 6,s -> R:u
0429 : 1183ffff                 cmpu    #-1     ;cmphi:
042d : 1026fca6                 lbne    L38
0431 :                  L37:
0431 : e6e818                   ldb     24,s    ;extendqihi: 24,s -> R:d
0434 : 1d                       sex
                        ;;;EPILOGUE
0435 : 3570                     puls    x,y,u   ;restore registers
0437 : 32e81e                   leas    30,s    ; deallocate auto variables
043a : 39                       rts             ; return from function
                        ;;;-----------------------------------------
                        ;;; END EPILOGUE for CohenSutherlandClip
                        ;;;-----------------------------------------
                        
                          direct -1
                        
                          include "Thrust_Sound.asm"
                        ; Thrust sound effects
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        ;   todo: anropa init_music_buf samtidigt som levelclearlabel
                        ;     ResetSounds, nullar buffer, sätter mixer till konstant
                        ;
                        ;dåligt
                        ;  vad är fel med current solution?
                        ;  två ljud kan inte dela channel
                        ;
                        ;Sound_Thrust_Init
                        ;  sätter mixers
                        ;  sätter timer
                        ;Sound_Thrust_Update
                        ;  sätter ljudreg
                        ;
                        ;ideer
                        ;  freq baserat på sinus
                        ;  arpeggio baserat på sinus
                        ;  vibrato baserat på sinus
                        ;
                        ;  slå på/av vibrato/arpeggio
                        ;    källor: frame tictoc, sinus
                        ;
                        ;  random changes
                        
                        
                        
c800 =                  SoundShadow equ $C800                   ;current chip values
c83f =                  SoundWork equ $C83F                     ;current work values
                        
                        
                        ;Use frequency-table from Thrust_Music.asm
0018 =                  Octave = 24
0008 =                  OctaveCount = 8
7274 =                  FreqTable = L059582
                        
                        
                        mSoundId macro id,slot,name
                        name = (id << 2) | slot
                         endm
                        
                        ;This is a bit clumsy:
                        ; - changing id (priority) also means having to switch position in tables
                        ; - changing slot (channel) also means having to change channel in sound code
                         mSoundId 1,2,ThrustSoundId
0006 =                 >ThrustSoundId = (1 << 2) | 2
                        
                         mSoundId 14,2,WalkerDestroyedSoundId
003a =                 >WalkerDestroyedSoundId = (14 << 2) | 2
                        
                        
                         mSoundId 2,0,GunFireSoundId
0008 =                 >GunFireSoundId = (2 << 2) | 0
                        
                         mSoundId 3,0,ShipFireSoundId
000c =                 >ShipFireSoundId = (3 << 2) | 0
                        
                         mSoundId 4,0,ExtraLifeSoundId
0010 =                 >ExtraLifeSoundId = (4 << 2) | 0
                        
                        
                         mSoundId 5,1,WalkerBounceSoundId
0015 =                 >WalkerBounceSoundId = (5 << 2) | 1
                        
                         mSoundId 6,1,ShieldSoundId
0019 =                 >ShieldSoundId = (6 << 2) | 1
                        
                         mSoundId 7,1,WarpOutSoundId
001d =                 >WarpOutSoundId = (7 << 2) | 1
                        
                         mSoundId 8,1,ExplosionSoundId
0021 =                 >ExplosionSoundId = (8 << 2) | 1
                        
                         mSoundId 9,1,PickupSoundId
0025 =                 >PickupSoundId = (9 << 2) | 1
                        
                         mSoundId 10,1,WarpInSoundId
0029 =                 >WarpInSoundId = (10 << 2) | 1
                        
                         mSoundId 11,1,CountdownSoundId
002d =                 >CountdownSoundId = (11 << 2) | 1
                        
                         mSoundId 12,1,PlanetExplodeSoundId
0031 =                 >PlanetExplodeSoundId = (12 << 2) | 1
                        
                         mSoundId 13,1,PerfectBonusSoundId
0035 =                 >PerfectBonusSoundId = (13 << 2) | 1
                        
                        
                        
043b :                  SoundsTable:
043b : 0000               dw 0                  ;0 is unused
043d : 04de               dw Sound_Thrust
043f : 0592               dw Sound_GunFire
0441 : 04f0               dw Sound_ShipFire
0443 : 0647               dw Sound_ExtraLife
0445 : 04ca               dw Sound_Dummy        ;bounce
0447 : 0555               dw Sound_Shield
0449 : 05a2               dw Sound_WarpOut
044b : 051c               dw Sound_Explosion
044d : 0566               dw Sound_Pickup
044f : 05b6               dw Sound_WarpIn
0451 : 06ab               dw Sound_Countdown
0453 : 05de               dw Sound_PlanetExplode
0455 : 0606               dw Sound_PerfectBonus
0457 : 0683               dw Sound_WalkerDestroyed
                        
0459 :                  SoundsInitTable:
0459 : 0000               dw 0                  ;0 is unused
045b : 04cb               dw Sound_Thrust_Init
045d : 0573               dw Sound_GunFire_Init
045f : 04e3               dw Sound_ShipFire_Init
0461 : 063c               dw Sound_ExtraLife_Init
0463 : 0656               dw Sound_WalkerBounce_Init
0465 : 0524               dw Sound_Shield_Init
0467 : 0593               dw Sound_WarpOut_Init
0469 : 0505               dw Sound_Explosion_Init
046b : 0556               dw Sound_Pickup_Init
046d : 05a7               dw Sound_WarpIn_Init
046f : 069c               dw Sound_Countdown_Init
0471 : 05cf               dw Sound_PlanetExplode_Init
0473 : 05f9               dw Sound_PerfectBonus_Init
0475 : 0674               dw Sound_WalkerDestroyed_Init
                        
                        ;Emit sound, all registers except D are preserved
                        mEmitSound macro SoundId
                          if \0=1
                            lda #SoundId
                          endif
                          jsr EmitSound
                          endm
                        
                        
                        ;*****************
0477 :                  EmitSound:
0477 : 3470               pshs x,y,u
                        
0479 : 1f89               tfr a,b
                        
047b : 8403               anda #3
047d : 48                 lsla
047e : 54                 lsrb
047f : c4fe               andb #254
                          ;a=slot*2, b=sound id * 2
                        
0481 : 8ec940             ldx #SoundSlots
0484 : 6d86               tst a,x
0486 : 2704               beq esOkEmit          ;slot is free
0488 : e186               cmpb a,x              ;slot busy, test priority
048a : 250e               blo esExit
                        
048c :                  esOkEmit:
048c : e786               stb a,x
                        
048e : 3186               leay a,x
                          ;y=sound slot
                        
0490 : ce0459             ldu #SoundsInitTable
0493 : 8ec83f             ldx #SoundWork
0496 : add5               jsr [b,u]
0498 : a721               sta 1,y               ;set timer
                        
049a :                  esExit:
                        
049a : 35f0               puls x,y,u,pc
                        ;  rts
                        
                        
                        ;*****************
049c :                  UpdateSound:
                          direct $c8
049c : 8ec83f             ldx #SoundWork
049f : cec944             ldu #SoundSlots + ((SlotCount-1)*2)
04a2 : 8603               lda #SlotCount
04a4 :                  usLop1:
04a4 : e6c4               ldb ,u                ;b=sound id * 2
04a6 : 271d               beq usNext
                        
04a8 : 6a41               dec 1,u               ;decrease time
04aa : 270e               beq usSoundFin
                        
04ac : 3442               pshs a,u
                        
04ae : a641               lda 1,u               ;a=timer
                        
04b0 : 108e043b           ldy #SoundsTable
04b4 : adb5               jsr [b,y]
                        
04b6 : 3542               puls a,u
                        
04b8 : 200b               bra usNext
                        
04ba :                  usSoundFin:
04ba : 6fc4               clr ,u                ;make slot empty
04bc : 1f89               tfr a,b
                        
04be : cb07               addb #7
04c0 : 50                 negb
04c1 : cb0d               addb #$d              ;b=this channels volume register
04c3 : 6f85               clr b,x               ;clear volume
                        
04c5 :                  usNext:
04c5 : 335e               leau -2,u
04c7 : 4a                 deca
04c8 : 26da               bne usLop1
                          direct -1
04ca :                  Sound_Dummy:
04ca : 39                 rts
                        
                        
                        ;*****************
f289 =                  UpdateSoundChip = $f289
                        
                        
                        ;*****************
                        ;Sound-routines
                        ;Separate sound-function for each soundid
                        ;*****************
                        
                        ;SoundWork have the registers reversed
000d =                  RegPitchA1 = $d - 0
000c =                  RegPitchA2 = $d - 1
000b =                  RegPitchB1 = $d - 2
000a =                  RegPitchB2 = $d - 3
0009 =                  RegPitchC1 = $d - 4
0008 =                  RegPitchC2 = $d - 5
0007 =                  RegNoisePitch = $d - 6
0006 =                  RegMixer =      $d - 7
0005 =                  RegVolA = $d - 8
0004 =                  RegVolB = $d - 9
0003 =                  RegVolC = $d - 10
                        
0001 =                  MixerToneA = 1
0002 =                  MixerToneB = 2
0004 =                  MixerToneC = 4
0008 =                  MixerNoiseA = 8
0010 =                  MixerNoiseB = 16
0020 =                  MixerNoiseC = 32
                        
                        ;x must point to sound regs
                        mMixerOn macro flag
                         lda #~flag
                         anda RegMixer,x
                         sta RegMixer,x
                         endm
                        
                        ;x must point to sound regs
                        mMixerOff macro flag
                         lda #flag
                         ora RegMixer,x
                         sta RegMixer,x
                         endm
                        
                        ;x must point to sound regs
                        mMixerOnOff macro onbit,offbit
                         lda #~onbit
                         anda RegMixer,x
                         ora #offbit
                         sta RegMixer,x
                         endm
                        
                        ;x must point to sound regs
                        mSound macro reg,value
                         if \0>1
                           lda #value
                         endif
                         sta reg,x
                         endm
                        
04cb :                  Sound_Thrust_Init:   ;return start time in A
                        ;  mMixerOn MixerNoiseC
                        ;  mMixerOff MixerToneC
                          mMixerOnOff MixerNoiseC,MixerToneC
04cb : 86df            > lda #~MixerNoiseC
04cd : a406            > anda RegMixer,x
04cf : 8a04            > ora #MixerToneC
04d1 : a706            > sta RegMixer,x
                        
                          mSound RegNoisePitch,$1f
                       > if 2>1
04d3 : 861f            >   lda #$1f
                       > endif
04d5 : a707            > sta RegNoisePitch,x
                        
                          mSound RegVolC,13
                       > if 2>1
04d7 : 860d            >   lda #13
                       > endif
04d9 : a703            > sta RegVolC,x
                        
04db : 860d               lda #13
04dd : 39                 rts
                        
04de :                  Sound_Thrust:   ;a=time, x=sound regs
04de : 6a07               dec RegNoisePitch,x  ;**todo: keep this? affects explosion sounds also
04e0 : 6a03               dec RegVolC,x
04e2 : 39                 rts
                        
04e3 :                  Sound_ShipFire_Init:
                          mSound RegVolA,14
                       > if 2>1
04e3 : 860e            >   lda #14
                       > endif
04e5 : a705            > sta RegVolA,x
                        
                        ;  mSound RegPitchA1,50
                        ;  mSound RegPitchA2,0
                          mMixerOn MixerToneA
04e7 : 86fe            > lda #~MixerToneA
04e9 : a406            > anda RegMixer,x
04eb : a706            > sta RegMixer,x
                        
04ed : 860a               lda #10
04ef : 39                 rts
                        
04f0 :                  Sound_ShipFire:
                          direct $c8
                          ;Arpeggio every frame + note falling every 2nd frame
04f0 : ce72e0             ldu #FreqTable + (Octave*4) + Octave/2
04f3 : d626               ldb LoopCounterLow
04f5 : c401               andb #1
04f7 : 2703               beq  ssf1
04f9 : 33c818               leau Octave,u
04fc :                  ssf1:
04fc : 44                 lsra
04fd : 48                 lsla
04fe : 33c6               leau a,u
0500 : ecc4               ldd ,u
0502 : ed0c               std RegPitchA2,x
                          direct -1
0504 : 39                 rts
                        
0505 :                  Sound_Explosion_Init:   ;return start time in A
                          mMixerOn MixerNoiseB
0505 : 86ef            > lda #~MixerNoiseB
0507 : a406            > anda RegMixer,x
0509 : a706            > sta RegMixer,x
                        
                          mMixerOff MixerToneB
050b : 8602            > lda #MixerToneB
050d : aa06            > ora RegMixer,x
050f : a706            > sta RegMixer,x
                        
                          mSound RegNoisePitch,$1f
                       > if 2>1
0511 : 861f            >   lda #$1f
                       > endif
0513 : a707            > sta RegNoisePitch,x
                        
                          mSound RegVolB,15
                       > if 2>1
0515 : 860f            >   lda #15
                       > endif
0517 : a704            > sta RegVolB,x
                        
0519 : 8640               lda #64
051b : 39                 rts
                        
051c :                  Sound_Explosion:   ;a=time, x=sound regs
051c : 8b40               adda #64
051e : 44                 lsra
051f : 44                 lsra
0520 : 44                 lsra
0521 : a704               sta RegVolB,x
0523 : 39                 rts
                        
                        
0524 :                  Sound_Shield_Init:   ;x=sound regs, return start time in A
                          direct $c8
                          mMixerOnOff MixerToneB,MixerNoiseB
0524 : 86fd            > lda #~MixerToneB
0526 : a406            > anda RegMixer,x
0528 : 8a10            > ora #MixerNoiseB
052a : a706            > sta RegMixer,x
                        
                          mSound RegVolB,11
                       > if 2>1
052c : 860b            >   lda #11
                       > endif
052e : a704            > sta RegVolB,x
                        
                        
0530 : ce7274             ldu #FreqTable ;+ (Octave)
                          mTestFlag RefuelFlag
                       >  if 255>RefuelFlag
0533 : 96e5            >    lda GameFlags1
0535 : 8502            >    bita #RefuelFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(RefuelFlag)>>8
                       >  endif
                        
0537 : 2708               beq ss1
0539 : 8618                 lda #Octave
053b : 33c6                 leau a,u
                            mSound RegVolB,12
                       > if 2>1
053d : 860c            >   lda #12
                       > endif
053f : a704            > sta RegVolB,x
                        
0541 :                  ss1:
                        
                          mTicToc 4
0541 : 9626            >  lda LoopCounterLow
0543 : 8403            >  anda #4-1
0545 : 8102            >  cmpa #4/2
0547 : 2402            >  bcc l10032
0549 : 8803            >  eora #4-1
054b :                 >l10032:
                        
054b : c60c               ldb #Octave/2
054d : 3d                 mul
054e : eccb               ldd d,u
                        
0550 : ed0a               std RegPitchB2,x
                        
0552 : 8602               lda #2
                          direct -1
0554 : 39                 rts
                        
0555 :                  Sound_Shield:   ;a=time, x=sound regs
                          ;All sound is made in init
0555 : 39                 rts
                        
0556 :                  Sound_Pickup_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneB,MixerNoiseB
0556 : 86fd            > lda #~MixerToneB
0558 : a406            > anda RegMixer,x
055a : 8a10            > ora #MixerNoiseB
055c : a706            > sta RegMixer,x
                        
                        
055e : cc0021             ldd #$21
0561 : ed0a               std RegPitchB2,x
                        ;  mSound RegPitchB2
                        ;  tfr b,a
                        ;  mSound RegPitchB1
                        
0563 : 8608               lda #8
0565 : 39                 rts
                        
0566 :                  Sound_Pickup:   ;a=time, x=sound regs
0566 : 8402               anda #2
0568 : 2604               bne spBeep
056a : 6f04                 clr RegVolB,x
056c : 2004                 bra spExit
056e :                  spBeep:
                            mSound RegVolB,14
                       > if 2>1
056e : 860e            >   lda #14
                       > endif
0570 : a704            > sta RegVolB,x
                        
0572 :                  spExit:
0572 : 39                 rts
                        
0573 :                  Sound_GunFire_Init:   ;x=sound regs, return start time in A
                          direct $c8
                          mMixerOnOff MixerToneA,MixerNoiseA
0573 : 86fe            > lda #~MixerToneA
0575 : a406            > anda RegMixer,x
0577 : 8a08            > ora #MixerNoiseA
0579 : a706            > sta RegMixer,x
                        
                        
                          ;Slightly higher tone if homing
057b : ce7286             ldu #FreqTable + (Octave*0) + (2*9)
                          mTestFlag HomingGunShotsFlag
                       >  if 255>HomingGunShotsFlag
                       >    lda GameFlags1
                       >    bita #HomingGunShotsFlag
                       >  else
057e : 96e6            >    lda GameFlags2
0580 : 8502            >    bita #(HomingGunShotsFlag)>>8
                       >  endif
                        
0582 : 2703               beq sgfNoHoming
0584 : 33c830               leau Octave*2,u
0587 :                  sgfNoHoming:
0587 : ecc4               ldd ,u
                        
0589 : ed0c               std RegPitchA2,x
                          mSound RegVolA,12
                       > if 2>1
058b : 860c            >   lda #12
                       > endif
058d : a705            > sta RegVolA,x
                        
058f : 8602               lda #2
                          direct -1
0591 : 39                 rts
                        
0592 :                  Sound_GunFire:   ;a=time, x=sound regs
0592 : 39                 rts
                        
0593 :                  Sound_WarpOut_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneB,MixerNoiseB
0593 : 86fd            > lda #~MixerToneB
0595 : a406            > anda RegMixer,x
0597 : 8a10            > ora #MixerNoiseB
0599 : a706            > sta RegMixer,x
                        
                          mSound RegVolB,13
                       > if 2>1
059b : 860d            >   lda #13
                       > endif
059d : a704            > sta RegVolB,x
                        
059f : 8620               lda #32
05a1 : 39                 rts
                        
05a2 :                  Sound_WarpOut:   ;a=time, x=sound regs
                          direct $c8
05a2 : ce72a4             ldu #FreqTable + Octave*2
05a5 : 2017               bra SoundWarpSub
                          direct -1
                        ;  rts
                        
05a7 :                  Sound_WarpIn_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneB,MixerNoiseB
05a7 : 86fd            > lda #~MixerToneB
05a9 : a406            > anda RegMixer,x
05ab : 8a10            > ora #MixerNoiseB
05ad : a706            > sta RegMixer,x
                        
                          mSound RegVolB,12
                       > if 2>1
05af : 860c            >   lda #12
                       > endif
05b1 : a704            > sta RegVolB,x
                        
05b3 : 8620               lda #32
05b5 : 39                 rts
                        
05b6 :                  Sound_WarpIn:   ;a=time, x=sound regs
                          direct $c8
05b6 : ce72a4             ldu #FreqTable + Octave*2
05b9 : 40                 nega
05ba : 8b20               adda #32      ;reverse time
05bc : 2000               bra SoundWarpSub
                          direct -1
                        ;  rts
                        
05be :                  SoundWarpSub:
                          direct $c8
05be : 47                 asra
05bf : 48                 asla
05c0 : 48                 asla
05c1 : 33c6               leau a,u
                        
05c3 : 9626               lda LoopCounterLow
05c5 : 8401               anda #1
05c7 : c618               ldb #Octave
05c9 : 3d                 mul
05ca : eccb               ldd d,u
                        
05cc : ed0a               std RegPitchB2,x
                          direct -1
05ce : 39                 rts
                        
05cf :                  Sound_PlanetExplode_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneB,MixerNoiseB
05cf : 86fd            > lda #~MixerToneB
05d1 : a406            > anda RegMixer,x
05d3 : 8a10            > ora #MixerNoiseB
05d5 : a706            > sta RegMixer,x
                        
                          mSound RegVolB,14
                       > if 2>1
05d7 : 860e            >   lda #14
                       > endif
05d9 : a704            > sta RegVolB,x
                        
05db : 8640               lda #64
05dd : 39                 rts
                        
05de :                  Sound_PlanetExplode:   ;a=time, x=sound regs
                          direct $c8
05de : ce72bc             ldu #FreqTable + Octave*3
                        
05e1 : 8128               cmpa #40
05e3 : 2c08               bge speNoRandom
                            mRandomToA
05e5 : bdf511          >  jsr random                    ;call rom
                        
05e8 : 841f                 anda #31
05ea : 48                   asla
05eb : 33c6                 leau a,u
05ed :                  speNoRandom:
                        
05ed : 9626               lda LoopCounterLow
05ef : 8401               anda #1
05f1 : c618               ldb #Octave
05f3 : 3d                 mul
                        
05f4 : eccb               ldd d,u
05f6 : ed0a               std RegPitchB2,x
                        
                          direct -1
05f8 : 39                 rts
                        
05f9 :                  Sound_PerfectBonus_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneB,MixerNoiseB
05f9 : 86fd            > lda #~MixerToneB
05fb : a406            > anda RegMixer,x
05fd : 8a10            > ora #MixerNoiseB
05ff : a706            > sta RegMixer,x
                        
0601 : 6f04               clr RegVolB,x
0603 : 8650               lda #80
0605 : 39                 rts
                        
0606 :                  Sound_PerfectBonus:   ;a=time, x=sound regs
                          direct $c8
0606 : ce7274             ldu #FreqTable ;+ Octave*1
                        
0609 : 8120               cmpa #32
060b : 2c2e               bge speNoSound
                        
060d : 47                 asra
060e : 48                 asla
060f : 48                 asla
0610 : 108e6d3f           ldy #SineTable
0614 : a6a6               lda a,y
0616 : 48                 asla
0617 : 33c6               leau a,u
                        
0619 : 9626               lda LoopCounterLow
061b : 8401               anda #1
061d : c618               ldb #Octave
061f : 3d                 mul
0620 : 33c5               leau b,u
                        
                          mTicToc 32
0622 : 9626            >  lda LoopCounterLow
0624 : 841f            >  anda #32-1
0626 : 8110            >  cmpa #32/2
0628 : 2402            >  bcc l10046
062a : 881f            >  eora #32-1
062c :                 >l10046:
                        
062c : a6a6               lda a,y
062e : 47                 asra
062f : ab41               adda 1,u
                        
                          mSound RegPitchB1
                       > if 1>1
                       >   lda #
                       > endif
0631 : a70b            > sta RegPitchB1,x
                        
0633 : a6c4               lda ,u
                          mSound RegPitchB2
                       > if 1>1
                       >   lda #
                       > endif
0635 : a70a            > sta RegPitchB2,x
                        
                        
                          mSound RegVolB,14
                       > if 2>1
0637 : 860e            >   lda #14
                       > endif
0639 : a704            > sta RegVolB,x
                        
063b :                  speNoSound:
                          direct -1
063b : 39                 rts
                        
063c :                  Sound_ExtraLife_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneA,MixerNoiseA
063c : 86fe            > lda #~MixerToneA
063e : a406            > anda RegMixer,x
0640 : 8a08            > ora #MixerNoiseA
0642 : a706            > sta RegMixer,x
                        
0644 : 8608               lda #8
0646 : 39                 rts
                        
0647 :                  Sound_ExtraLife:   ;a=time, x=sound regs
                          direct $c8
0647 : 8402               anda #2
0649 : c607               ldb #7
064b : 3d                 mul
064c : e705               stb RegVolA,x
                        
064e : ce7344             ldu #FreqTable + Octave*8  + (2*8)
0651 : ecc4               ldd ,u
                        
0653 : ed0c               std RegPitchA2,x
                          direct -1
0655 : 39                 rts
                        
0656 :                  Sound_WalkerBounce_Init:   ;x=sound regs, return start time in A
                          direct $c8
                          mMixerOnOff MixerToneB,MixerNoiseB
0656 : 86fd            > lda #~MixerToneB
0658 : a406            > anda RegMixer,x
065a : 8a10            > ora #MixerNoiseB
065c : a706            > sta RegMixer,x
                        
                        
                          ;Use hardcoded adress for jumping to avoid long constants
065e : b6c9ca             lda ZzapConfig+4
                        ;  lda zcJumping,y
                        
0661 : 44                 lsra
0662 : 44                 lsra
0663 : 840f               anda #15
0665 : 40                 nega
0666 : 8b0f               adda #15
0668 : 847f               anda #127
066a : a704               sta RegVolB,x
                        
066c : cc060c             ldd #$60c
                        
066f : ed0a               std RegPitchB2,x
                        
0671 : 8602               lda #2
                          direct -1
0673 : 39                 rts
                        
0674 :                  Sound_WalkerDestroyed_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneC,MixerNoiseC
0674 : 86fb            > lda #~MixerToneC
0676 : a406            > anda RegMixer,x
0678 : 8a20            > ora #MixerNoiseC
067a : a706            > sta RegMixer,x
                        
                          mSound RegVolC,15
                       > if 2>1
067c : 860f            >   lda #15
                       > endif
067e : a703            > sta RegVolC,x
                        
0680 : 8640               lda #64
0682 : 39                 rts
                        
0683 :                  Sound_WalkerDestroyed:   ;a=time, x=sound regs
                          direct $c8
                        
0683 : ce72a4             ldu #FreqTable + Octave*2
                        
0686 : a77f               sta -1,s
                        
0688 : 8403               anda #3
068a : c618               ldb #Octave
068c : 3d                 mul
068d : 33cb               leau d,u
                        
068f : e67f               ldb -1,s
0691 : 57                 asrb
0692 : 57                 asrb
0693 : 57                 asrb
                        
0694 : a67f               lda -1,s
0696 : 3d                 mul
0697 : e3c4               addd ,u
                        
0699 : ed08               std RegPitchC2,x
                        
                          direct -1
069b : 39                 rts
                        
069c :                  Sound_Countdown_Init:   ;x=sound regs, return start time in A
                          mMixerOnOff MixerToneB,MixerNoiseB
069c : 86fd            > lda #~MixerToneB
069e : a406            > anda RegMixer,x
06a0 : 8a10            > ora #MixerNoiseB
06a2 : a706            > sta RegMixer,x
                        
06a4 : 860e               lda #14
06a6 : a704               sta RegVolB,x
06a8 : 8602               lda #2
06aa : 39                 rts
                        
06ab :                  Sound_Countdown:   ;a=time, x=sound regs
                          direct $c8
                        
06ab : ce72d4             ldu #FreqTable + Octave*4
06ae : 860a               lda #10
06b0 : 9bf3               adda PowerLife
06b2 : c606               ldb #Octave/4
06b4 : 3d                 mul
06b5 : 33cb               leau d,u
                        
06b7 : ecc4               ldd ,u
                        
06b9 : ed0a               std RegPitchB2,x
                          direct -1
06bb : 39                 rts
                        
                          include "Thrust_Fx.asm"
                        ; Thrust graphical effects
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        ;    Time       8 bits:
                        ;    TargetType 4 bits: ship,orb,gun,fuel,switch,plant
                        ;    FxType     4 bits: explosion,teleportfx,250score,planetexplode
                        ;    Index      8 bits: fuel,switch etc index
                        ;      en del dör direkt, refuel stänger av sig själv, använder endast loopcounter
                        ;  DrawFx
                        ;    jumptable for targettype, returns coords
                        ;      FxGetCoords index
                        ;    jumptable for fxtype
                        ;      FxDrawFx coords,time
                        ;      every fx-rutin can also be called separately, FxRotatingStar is called from refueling
                        ;  UpdateFx
                        ;    dec time
                        ;    jumptable for Finish
                        ;      FxFinish_Ship FxType
                        ;        case TeleportInFx
                        ;          set active
                        ;        case TeleportOutFx
                        ;          jsr finishlevel
                        ;        case Explosion
                        ;          call loselife
                        ;  Thrust_Fx.asm
                        ;  requirements
                        ;    able to draw refueling effect
                        ;    teleport in/out effect
                        ;  mEmitFx FxTarget,FxType,InitTime,IndexReg (optional)
                        
                        
c8a0 =                  FxTempEntry = TemporaryArea    ;Temporary storage for drawfx
                        
0000 =                  FxTargetShip   = 0
0001 =                  FxTargetPod    = 1
0002 =                  FxTargetGun    = 2
0003 =                  FxTargetPlant  = 3
0004 =                  FxTargetFuel   = 4
0005 =                  FxTargetSwitch = 5
0006 =                  FxTargetWalker = 6      ;bonus game
                        
0000 =                  FxTypeDotShatter = 0
0001 =                  FxTypeRefueling  = 1
0002 =                  FxTypePickUpPod  = 2
0003 =                  FxTypeScore150   = 3
0004 =                  FxTypeScore300   = 4
0005 =                  FxTypeScore750   = 5
0006 =                  FxTypeWarpIn     = 6
0007 =                  FxTypeWarpOut    = 7
0008 =                  FxTypeFuelCell   = 8
0009 =                  FxTypePlanetExplode = 9
000a =                  FxTypeGunFire = 10
                        
0040 =                  ShatterStartTime = 64
                        
                        ;A holds byte, exits with targettype in a, and fxtype in b
                        mFxSplitTargetFx macro
                          tfr a,b
                          anda #15
                          lsrb
                          lsrb
                          lsrb
                          lsrb
                          endm
                        
                        
                        ;Emit effect, all registers except D are preserved
                        mEmitFx macro FxTarget,FxType,IndexReg
                          if ('IndexReg'!='0') && ('IndexReg'!='b')
                            tfr IndexReg,b
                          endif
                          lda #FxTarget | (FxType<<4)
                          jsr EmitFx
                          endm
                        
                        
                        ;*****************
06bc :                  EmitFx:         ;a=encoded target/type, b=index
06bc : 3430               pshs x,y
                          mDecLocals 4,0,0
                       >  nolist
                        
0000 =                  LocalTarget = LocalB1
0001 =                  LocalFx = LocalB2
0002 =                  LocalIndex = LocalB3
0003 =                  LocalEncoded = LocalB4
                        
06c0 : a763               sta LocalEncoded,s
06c2 : e762               stb LocalIndex,s
                          mFxSplitTargetFx
06c4 : 1f89            >  tfr a,b
06c6 : 840f            >  anda #15
06c8 : 54              >  lsrb
06c9 : 54              >  lsrb
06ca : 54              >  lsrb
06cb : 54              >  lsrb
                        
06cc : a7e4               sta LocalTarget,s
06ce : e761               stb LocalFx,s
                        
                          ;find free
06d0 : 8ec913             ldx #FxList
06d3 : c603               ldb #MaxFx
06d5 :                  efxLoop:
06d5 : 6d84               tst ,x
06d7 : 2714               beq efxFound
06d9 : 3003               leax 3,x
06db : 5a                 decb
06dc : 26f7               bne efxLoop
                        
                          ;no free found, replace first that isn't target ship
                          ;ships fx must be prioritized because ExplodeShip/ExitLevel is called from end of fx
06de : 8ec913             ldx #FxList
06e1 :                  efxLoop2:
06e1 : a601               lda 1,x
06e3 : 840f               anda #15
06e5 : 8100               cmpa #FxTargetShip
06e7 : 2604               bne efxFound
06e9 : 3003               leax 3,x
06eb : 20f4               bra efxLoop2
                        
06ed :                  efxFound:                       ;free found, write new fx
06ed : 108e0a3f           ldy #FxInitTable
06f1 : a661               lda LocalFx,s
06f3 : 48                 lsla
06f4 : 31a6               leay a,y
                        
06f6 : a6a4               lda ,y                        ;time
06f8 : a784               sta ,x
                        
06fa : a663               lda LocalEncoded,s            ;target/fx as one byte
06fc : a701               sta 1,x
                        
06fe : a662               lda LocalIndex,s              ;index
0700 : a702               sta 2,x
                        
0702 : a621               lda 1,y                       ;sound fx
0704 : 2703               beq efxNoSound
                            mEmitSound
                       >  if 0=1
                       >    lda #
                       >  endif
0706 : bd0477          >  jsr EmitSound
                        
0709 :                  efxNoSound:
                        
                          mFreeLocals
0709 : 3264            >  leas FrameSize,s
                        
070b : 35b0               puls x,y,pc
                        ;  rts
                        
                        
                        ;*****************
070d :                  DrawFx:
                          mDecLocals 4,1,0
                       >  nolist
                        
0001 =                  LocalTarget = LocalB2
0002 =                  LocalFx = LocalB3
0003 =                  LocalTime = LocalB4
                        
070f : 108ec913           ldy #FxList
0713 : c603               ldb #MaxFx
0715 :                  dfxLoop:
0715 : a6a4               lda ,y
0717 : 272e               beq dfxNext
                        
0719 : e7e4               stb LocalB1,s
071b : 10af64             sty LocalW1,s
                        
071e : a763               sta LocalTime,s
                        
0720 : a621               lda 1,y
                          mFxSplitTargetFx
0722 : 1f89            >  tfr a,b
0724 : 840f            >  anda #15
0726 : 54              >  lsrb
0727 : 54              >  lsrb
0728 : 54              >  lsrb
0729 : 54              >  lsrb
                        
072a : a761               sta LocalTarget,s
072c : e762               stb LocalFx,s
                        
072e : e661               ldb LocalTarget,s
0730 : 58                 lslb
0731 : 8e0a6b             ldx #FxGetCoordsTable
0734 : a622               lda 2,y               ;A holds index
0736 : ad95               jsr [b,x]
                        
                          ;X and Y holds world coords
                        
0738 : ce0a55             ldu #FxDrawTable
073b : e662               ldb LocalFx,s
073d : 58                 lslb
073e : a663               lda LocalTime,s       ;A holds time
0740 : add5               jsr [b,u]
                        
0742 : e6e4               ldb LocalB1,s
0744 : 10ae64             ldy LocalW1,s
                        
0747 :                  dfxNext:
0747 : 3123               leay 3,y
0749 : 5a                 decb
074a : 26c9               bne dfxLoop
                        
                          mFreeLocals
074c : 3266            >  leas FrameSize,s
                        
074e : 39                 rts
                        
                        
                        ;*****************
074f :                  UpdateFx:
                          mDecLocals 3,1,0
                       >  nolist
                        
                          direct $c8
0001 =                  LocalTarget = LocalB2
0002 =                  LocalFx = LocalB3
                        
0751 : 108ec913           ldy #FxList
0755 : c603               ldb #MaxFx
0757 :                  ufxLoop:
0757 : 6da4               tst ,y
0759 : 272a               beq ufxNext
                        
075b : 6aa4               dec ,y                ;decrease time
075d : 2626               bne ufxNext
                        
075f : e7e4               stb LocalB1,s         ;reached zero, call finishevent
0761 : 10af63             sty LocalW1,s
                        
0764 : a621               lda 1,y
                          mFxSplitTargetFx
0766 : 1f89            >  tfr a,b
0768 : 840f            >  anda #15
076a : 54              >  lsrb
076b : 54              >  lsrb
076c : 54              >  lsrb
076d : 54              >  lsrb
                        
076e : a761               sta LocalTarget,s
0770 : e762               stb LocalFx,s
                        
0772 : ce0a79             ldu #FxFinishTable
0775 : e661               ldb LocalTarget,s
0777 : 58                 lslb
0778 : 33c5               leau b,u
077a : a662               lda LocalFx,s         ;A holds fxtype
077c : e622               ldb 2,y               ;B holds index
077e : add4               jsr [,u]
                        
0780 : e6e4               ldb LocalB1,s
0782 : 10ae63             ldy LocalW1,s
                        
0785 :                  ufxNext:
0785 : 3123               leay 3,y
0787 : 5a                 decb
0788 : 26cd               bne ufxLoop
                        
                          direct -1
                          mFreeLocals
078a : 3265            >  leas FrameSize,s
                        
078c : 39                 rts
                        
                        
                        ;*****************
078d :                  FxGetScreenCoords:      ;X/Y world coords, returns screen coords in D, Z set if offscreen
078d : 10af7c             sty -4,s              ;save y, mGetScreenMacro uses -2
                        
                          ;transform x
                          mGetScreenX
                       >  if  0 = 0    ;no param, X holds X-coord
0790 : 1f12            >    tfr x,y
                       >  endif
                       >  if  0 = 1
                       >    ldy     
                       >  endif
                       >  if  0 = 2   ;as09 treats "2,y" as two separate macro arguments
                       >    ldy     ,
                       >  endif
0792 : bec8c6          >  ldx     ViewX
0795 : 1f20            >  tfr     y,d
0797 : af7e            >  stx -2,s
0799 : a37e            >  subd -2,s
079b : 2c0a            >  bge     L1430101
079d : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
07a0 : a37e            >  subd -2,s
07a2 : 10af7e          >  sty -2,s
07a5 : e37e            >  addd -2,s
07a7 :                 >L1430101:
                        
07a7 : 2b19               bmi fxsOffScreen
07a9 : 4d                 tsta
07aa : 2616               bne fxsOffScreen
07ac : c080               subb #128
07ae : e77f               stb -1,s
                        
07b0 : ec7c               ldd -4,s              ;load y
07b2 : b3c8c8             subd ViewY            ;transform y
07b5 : 2b0b               bmi fxsOffScreen
07b7 : 4d                 tsta
07b8 : 2608               bne fxsOffScreen
                        
07ba : 50                 negb
07bb : 1f98               tfr b,a
07bd : e67f               ldb -1,s
07bf : 8b7f               adda #127
07c1 : 39                 rts
07c2 :                  fxsOffScreen:
07c2 : 4f                 clra
07c3 : 39                 rts
                        
                        ;*****************
07c4 :                  FxDrawSpriteVL:                 ;Draw a single sprite  u=pointer to x,y  x=vectorlist a=scale b=intensity
                          mDecLocals 2,2,0
                       >  nolist
                        
                          ;DP must be D0
                        
                          ;**todo: perhaps make a FxDrawVL also, this routine takes sprite format of VL
                        
07c6 : a7e4               sta LocalB1,s
07c8 : e761               stb LocalB2,s
07ca : af62               stx LocalW1,s
                        
07cc : aec4               ldx ,u
07ce : 10ae42             ldy 2,u
07d1 : 8dba               jsr FxGetScreenCoords
07d3 : 2739               beq fxdExit
                        
07d5 : ed64               std LocalW2,s
                          mSetScale $7f                 ;Scale $7f is required for move_pen_d to reach whole screen
                       >  if 1=1
07d7 : 867f            >    lda #$7f                                   ;if argument exists, load into a, otherwise use current a
                       >  endif
07d9 : 9704            >  sta <$04
                        
07db : bdf354             jsr reset0ref
07de : ec64               ldd LocalW2,s
                          mMove_pen_d_Quick
07e0 : 9701            >  sta   <0x01
07e2 : 0f00            >  clr   <0x00
07e4 : 86ce            >  lda   #0xCE
07e6 : 970c            >  sta   <0x0C
07e8 : 0f0a            >  clr   <0x0A
07ea : 0c00            >  inc   <0x00
07ec : d701            >  stb   <0x01
07ee : 0f05            >  clr   <0x05
07f0 : c640            >  ldb   #0x40
07f2 : d50d            >PF33D0116: bitb  <0x0D
07f4 : 27fc            >  beq   PF33D0116
                       >;PF33B0116: lda   #0x04
                       >;PF3410116: deca
                       >;  bne   PF3410116
                        
                        
07f6 : a661               lda LocalB2,s
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
07f8 : 9701            >  sta   <01
07fa : cc0401          >  ldd   #$0401
07fd : 9700            >  sta   <00
07ff : d700            >  stb   <00
                        
                        
0801 : ae62               ldx LocalW1,s
0803 : a680               lda ,x+                       ;Nr of vectors in list
0805 :                  fxdLoop:
0805 : e6e4               ldb LocalB1,s                 ;Scale
0807 : bdf3b7             jsr move_draw_VL4             ;Draw list
080a : a680               lda ,x+                       ;Get next count, $ff ends
080c : 2af7               bpl fxdLoop
080e :                  fxdExit:
                        
                          mFreeLocals
080e : 3266            >  leas FrameSize,s
                        
0810 : 39                 rts
                        
                        
                        ;*****************
0811 :                  FxMoveDrawPattern:                ;a=point count, x=vectors, 'Pattern' holds current pattern
0811 : a77f               sta -1,s
0813 : ec81               ldd ,x++
                          mMove_pen_d_Quick
0815 : 9701            >  sta   <0x01
0817 : 0f00            >  clr   <0x00
0819 : 86ce            >  lda   #0xCE
081b : 970c            >  sta   <0x0C
081d : 0f0a            >  clr   <0x0A
081f : 0c00            >  inc   <0x00
0821 : d701            >  stb   <0x01
0823 : 0f05            >  clr   <0x05
0825 : c640            >  ldb   #0x40
0827 : d50d            >PF33D0119: bitb  <0x0D
0829 : 27fc            >  beq   PF33D0119
                       >;PF33B0119: lda   #0x04
                       >;PF3410119: deca
                       >;  bne   PF3410119
                        
082b : a67f               lda -1,s
082d : 7ef434             jmp dwp_with_count
                        
                        
                        ;*****************
0830 :                  Draw_Warp:                      ;A=time, X/Y=world coords
                          mDecLocals 2,1,0
                       >  nolist
                        
0832 : a7e4               sta LocalB1,s
0834 : bd078d             jsr FxGetScreenCoords
0837 : ed62               std LocalW1,s
                        
0839 : bdf354             jsr reset0ref
083c : ec62               ldd LocalW1,s
083e : bdf2fc             jsr move_pen7f_to_d
                        
                          ;draw several times without reset0ref, each ring is drawn a bit above the last one
0841 : 8604               lda #4
0843 : a761               sta LocalB2,s
0845 :                  dwLoop:
0845 : a6e4               lda LocalB1,s
0847 : 8b14               adda #20
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
0849 : 9701            >  sta   <01
084b : cc0401          >  ldd   #$0401
084e : 9700            >  sta   <00
0850 : d700            >  stb   <00
                        
                        
0852 : 8e4b8d             ldx #WarpVectorList
0855 : a680               lda ,x+
0857 : e6e4               ldb LocalB1,s
0859 : cb06               addb #6       ;scale
                        
085b : bdf3b7             jsr move_draw_VL4
                        
085e : a6e4               lda LocalB1,s
0860 : 8b06               adda #6
0862 : a7e4               sta LocalB1,s
                        
0864 : 6a61               dec LocalB2,s
0866 : 26dd               bne dwLoop
                        
                          mFreeLocals
0868 : 3264            >  leas FrameSize,s
                        
086a : 39                 rts
                        
                        
                        ;*****************
086b :                  DrawRisingScore:                    ;A=time, X/Y=world coords, U=vectorlist
                          ;Draw a slowly rising score amount
                          mDecLocals 1,0,4
                       >  nolist
                        
                        
086d : a7e4               sta LocalB1,s
086f : a77f               sta -1,s
0871 : 8620               lda #32
0873 : a07f               suba -1,s
0875 : 1f89               tfr a,b
                        ;  lsla
0877 : 40                 nega
                        
0878 : af61               stx LocalBuffer,s
087a : 31a6               leay a,y
087c : 10af63             sty LocalBuffer+2,s
                        
087f : 1f31               tfr u,x
0881 : 3361               leau LocalBuffer,s
                        
0883 : 1f98               tfr b,a ;scale
0885 : 44                 lsra
                        ;  lsra
                        
0886 : e6e4               ldb LocalB1,s ;intensity
0888 : cb40               addb #$40
                        
088a : bd07c4             jsr FxDrawSpriteVL
                        
                          mFreeLocals
088d : 3265            >  leas FrameSize,s
                        
088f : 39                 rts
                        
                        
                        ;*****************
                        ;GetCoords-routines
                        ;Returns world-coords in X and Y for each type of target
                        ;*****************
                        
                        
                        ;*****************
0890 :                  FxGetCoords_Ship:
0890 : bec8bb             ldx ShipX
0893 : 10bec8bd           ldy ShipY
0897 : 39                 rts
                        
                        ;*****************
0898 :                  FxGetCoords_Pod:
0898 : bec8bf             ldx PodX
089b : 10bec8c1           ldy PodY
089f : 39                 rts
                        
                        ;*****************
08a0 :                  FxGetCoords_Gun:                ;index in A
08a0 : fec8ca             ldu CurLevelEntry             ;Gun
08a3 : ee44               ldu leGuns,u
08a5 : 3341               leau 1,u                      ;skip gun count
08a7 : c605               ldb #GunEntry
08a9 : 3d                 mul
08aa : 33cb               leau d,u                      ;u points to gun entry
08ac : ffc8a0             stu FxTempEntry
08af : aec4               ldx geGunX,u
08b1 : 10ae42             ldy geGunY,u
08b4 : 39                 rts
                        
                        ;*****************
08b5 :                  FxGetCoords_Plant:
08b5 : fec8ca             ldu CurLevelEntry
08b8 : ae4c               ldx lePowerX,u
08ba : 10ae4e             ldy lePowerY,u
08bd : 39                 rts
                        
                        ;*****************
08be :                  FxGetCoords_Fuel:               ;index in A
08be : fec8ca             ldu CurLevelEntry
08c1 : ee46               ldu leFuel,u
08c3 : 3341               leau 1,u                      ;skip fuel count
08c5 : c604               ldb #FuelEntry
08c7 : 3d                 mul
08c8 : 33cb               leau d,u                      ;u points to fuel coords
08ca : aec4               ldx ,u
08cc : 10ae42             ldy 2,u
08cf : 39                 rts
                        
                        ;*****************
08d0 :                  FxGetCoords_Switch:             ;index in A
08d0 : fec8ca             ldu CurLevelEntry
08d3 : eec814             ldu leSwitches,u
08d6 : 3341               leau 1,u                      ;skip switch count
08d8 : c605               ldb #SwitchEntry
08da : 3d                 mul
08db : 33cb               leau d,u                      ;u points to fuel coords
08dd : aec4               ldx seSwitchX,u
08df : 10ae42             ldy seSwitchY,u
08e2 : 39                 rts
                        
                        ;*****************
08e3 :                  FxGetCoords_Walker:             ;index in A
08e3 : cec962             ldu #WalkerList
08e6 : c607               ldb #WalkerEntry
08e8 : 3d                 mul
08e9 : 33cb               leau d,u
                          ;Walker constants are not declared yet
                          ;avoid 2-bytes offsets
08eb : ae42               ldx 2,u ;weWalkerX
08ed : 10ae44             ldy 4,u ;weWalkerY
08f0 : 39                 rts
                        
                        
                        
                        
                        
                        ;*****************
                        ;Draw-routines
                        ;Separate draw-function for each fxtype
                        ;*****************
                        
                        
                        ;*****************
08f1 :                  FxDraw_DotShatter:              ;A=time, X/Y=world coords
                          mDecLocals 0,0,4
                       >  nolist
                        
08f3 : afe4               stx LocalBuffer,s
08f5 : 10af62             sty LocalBuffer+2,s
08f8 : 33e4               leau LocalBuffer,s
                        
08fa : 40                 nega                          ;reverse time
08fb : 8b40               adda #ShatterStartTime
                        
08fd : bd22ba             jsr DotShatter
                          mFreeLocals
0900 : 3264            >  leas FrameSize,s
                        
0902 : 39                 rts
                        
                        ;*****************
0903 :                  FxDraw_Refueling:
                          mDecLocals 1,1,0
                       >  nolist
                        
                        
                          ;Surround fuelcell with box
0905 : bd078d             jsr FxGetScreenCoords
0908 : ed61               std LocalW1,s
090a : bdf354             jsr reset0ref
                          mSetIntensity $70
                       >  if 1=1
090d : 8670            >    lda   #$70            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
090f : 9701            >  sta   <01
0911 : cc0401          >  ldd   #$0401
0914 : 9700            >  sta   <00
0916 : d700            >  stb   <00
                        
0918 : ec61               ldd LocalW1,s
091a : bdf2fc             jsr move_pen7f_to_d
091d : 8e4bab             ldx #RefuelVectorList
                        
                          mRandomToA
0920 : bdf511          >  jsr random                    ;call rom
                        
0923 : b7c829             sta Pattern
                        
0926 : c614               ldb #DrawScale
0928 : b6c826             lda LoopCounterLow
092b : 840f               anda #15
092d : 40                 nega
092e : 3402               pshs a
0930 : e0e0               subb ,s+
0932 : 1f98               tfr b,a
                          mSetScale
                       >  if 0=1
                       >    lda #                  ;if argument exists, load into a, otherwise use current a
                       >  endif
0934 : 9704            >  sta <$04
                        
                        
0936 : 8603               lda #4-1
0938 : bd0811             jsr FxMoveDrawPattern
                        
                          ;Draw dots rising from the fuelcell
093b : 860c               lda #12
093d : a7e4               sta LocalB1,s
093f : 108ef000           ldy #$F000            ;offset each coordinate with data from exec-rom + loopcounter
0943 :                  fdrStars:
0943 : bdf354             jsr reset0ref
                        
0946 : b6c826             lda LoopCounterLow
0949 : aba0               adda ,y+
094b : 841f               anda #31
094d : ab61               adda LocalW1,s
094f : 8b10               adda #16
                        
0951 : e6a0               ldb ,y+
0953 : c41f               andb #TileW-1
0955 : c010               subb #TileW/2
0957 : eb62               addb LocalW1+1,s
                        
0959 : bdf2fc             jsr move_pen7f_to_d
                          mDot_at_current_position 1
                       >  ; From vectrex.txt
                       >  ;    "(WARNING! high intensity and long Vec_Dot_Dwell might result in a burn in on
                       >  ;     your vectrex monitor, be carefull while experimenting with this!)"
095c : 86ff            >       lda   #0xFF
095e : 970a            >       sta   <0x0A
                       >;       ldb   #1         ;1 is a value for how long the dot is lit
                       >;PF2CC0179: decb                     ;dwell is not the same as intensity
                       >;       bne   PF2CC0179
0960 : 0f0a            >       clr   <0x0A
                        
                        
0962 : 6ae4               dec LocalB1,s
0964 : 26dd               bne fdrStars
                        
                          mFreeLocals
0966 : 3263            >  leas FrameSize,s
                        
0968 : 39                 rts
                        
                        ;*****************
0969 :                  FxDraw_PickUpPod:               ;A=time, X/Y=world coords
                          mDecLocals 2,1,20
                       >  nolist
                        
096c : a7e4               sta LocalB1,s
096e : bd078d             jsr FxGetScreenCoords
0971 : ed62               std LocalW1,s
                        
0973 : b6c826             lda LoopCounterLow            ;angle
0976 : 8e4b7a             ldx #OrbVectorList
0979 : e680               ldb ,x+
097b : e761               stb LocalB2,s                 ;vector count
097d : 3364               leau LocalBuffer,s            ;Vector buffer
097f : bdf610             jsr rot_vec_list2             ;Rotate vectors
                        
0982 : bdf354             jsr reset0ref
                        
0985 : a6e4               lda LocalB1,s
0987 : 8b40               adda #$40
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
0989 : 9701            >  sta   <01
098b : cc0401          >  ldd   #$0401
098e : 9700            >  sta   <00
0990 : d700            >  stb   <00
                        
                        
0992 : ec62               ldd LocalW1,s
0994 : bdf2fc             jsr move_pen7f_to_d
0997 : 3064               leax LocalBuffer,s
0999 : a661               lda LocalB2,s
099b : e6e4               ldb LocalB1,s
099d : cb14               addb #DrawScale
099f : bdf3b7             jsr move_draw_VL4
                          mFreeLocals
09a2 : 32e818          >  leas FrameSize,s
                        
09a5 : 39                 rts
                        
                        ;*****************
09a6 :                  FxDraw_Score150:                ;A=time, X/Y=world coords
09a6 : ce4c57             ldu #Score150_Lines
09a9 : bd086b             jsr DrawRisingScore
09ac : 39                 rts
                        
                        ;*****************
09ad :                  FxDraw_Score300:                ;A=time, X/Y=world coords
09ad : ce4c75             ldu #Score300_Lines
09b0 : bd086b             jsr DrawRisingScore
09b3 : 39                 rts
                        
                        ;*****************
09b4 :                  FxDraw_Score750:                ;A=time, X/Y=world coords
09b4 : ce4c9a             ldu #Score750_Lines
09b7 : bd086b             jsr DrawRisingScore
09ba : 39                 rts
                        
                        ;*****************
09bb :                  FxDraw_WarpIn:                  ;A=time, X/Y=world coords
09bb : 8118               cmpa #24
09bd : 260c               bne wi1
09bf : a77f                 sta -1,s
                            mClearFlag InactiveFlag
                       >  if 255>InactiveFlag
09c1 : 86ef            >    lda #~InactiveFlag
09c3 : b4c8e5          >    anda GameFlags1
09c6 : b7c8e5          >    sta GameFlags1
                       >  else
                       >    lda #~((InactiveFlag)>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
09c9 : a67f                 lda -1,s
09cb :                  wi1:
09cb : bd0830             jsr Draw_Warp
09ce : 39                 rts
                        
                        ;*****************
09cf :                  FxDraw_WarpOut:                 ;A=time, X/Y=world coords
09cf : a77f               sta -1,s
09d1 : 8620               lda #32                       ;reverse time
09d3 : a07f               suba -1,s
09d5 : bd0830             jsr Draw_Warp
09d8 : 39                 rts
                        
                        
                        ;*****************
09d9 :                  FxDraw_FuelCell:                ;A=time, X/Y=world coords
                          mDecLocals 1,0,4
                       >  nolist
                        
                        
09db : a7e4               sta LocalB1,s
                        
09dd : af61               stx LocalBuffer,s
09df : 10af63             sty LocalBuffer+2,s
09e2 : 3361               leau LocalBuffer,s
                        
                          ;scale
                        ;  lsra
                        
09e4 : e6e4               ldb LocalB1,s ;intensity
09e6 : cb40               addb #$40
                        
09e8 : 8e4bf5             ldx #SpriteFuelCell
09eb : bd07c4             jsr FxDrawSpriteVL
                        
                          mFreeLocals
09ee : 3265            >  leas FrameSize,s
                        
09f0 : 39                 rts
                        
                        
                        ;*****************
09f1 :                  FxDraw_PlanetExplode:                ;A=time, X/Y=world coords
09f1 : 8402               anda #2
09f3 : 270a               beq peShow
                            mClearFlag NoLandscapeFlag
                       >  if 255>NoLandscapeFlag
                       >    lda #~NoLandscapeFlag
                       >    anda GameFlags1
                       >    sta GameFlags1
                       >  else
09f5 : 86fe            >    lda #~((NoLandscapeFlag)>>8)
09f7 : b4c8e6          >    anda GameFlags2
09fa : b7c8e6          >    sta GameFlags2
                       >  endif
                        
09fd : 2008                 bra peOk
09ff :                  peShow:
                            mSetFlag NoLandscapeFlag
                       >  if 255>NoLandscapeFlag
                       >    lda #NoLandscapeFlag
                       >    ora GameFlags1
                       >    sta GameFlags1
                       >  else
09ff : 8601            >    lda #(NoLandscapeFlag)>>8
0a01 : bac8e6          >    ora GameFlags2
0a04 : b7c8e6          >    sta GameFlags2
                       >  endif
                        
0a07 :                  peOk:
0a07 : 39                 rts
                        
                        
                        ;*****************
0a08 :                  FxDraw_GunFire:                ;A=time, X/Y=world coords
                          mDecLocals 1,0,4
                       >  nolist
                        
0a0a : a7e4               sta LocalB1,s
                        
0a0c : af61               stx LocalBuffer,s
0a0e : 10af63             sty LocalBuffer+2,s
                        
                          ;Get lines for gun
0a11 : fec8a0             ldu FxTempEntry
0a14 : e644               ldb geGunSprite,u
0a16 : 58                 aslb
0a17 : 8e1f44             ldx #GunSpriteTable
0a1a : ae85               ldx b,x
                        
                          ;scale
0a1c : 48                 lsla
0a1d : 8b14               adda #DrawScale
                        
0a1f : e6e4               ldb LocalB1,s ;intensity
0a21 : cb60               addb #$60
                        ;  ldb #$5f
                        
0a23 : 3361               leau LocalBuffer,s
0a25 : bd07c4             jsr FxDrawSpriteVL
                        
                          mFreeLocals
0a28 : 3265            >  leas FrameSize,s
                        
0a2a : 39                 rts
                        
                        ;-----------------
                        ;Finish-routines
                        ;Separate finish-function for each target
                        ;Called when time has run out for the fx
                        ;-----------------
                        
                        ;*****************
0a2b :                  FxFinish_Ship:                  ;A=fxtype
0a2b : 8100               cmpa #FxTypeDotShatter
0a2d : 2605               bne fxsNext1
0a2f : bd26e5               jsr OnLoseLife
0a32 : 2009                 bra fxsExit
0a34 :                  fxsNext1:
                        ;  cmpa #FxTypeWarpIn
                        ;  bne fxsNext2
                        ;    mClearFlag InactiveFlag
                        ;    bra fxsExit
                        ;fxsNext2:
0a34 : 8107               cmpa #FxTypeWarpOut
0a36 : 2605               bne fxsNext3
0a38 : bd2922               jsr OnExitLevel
0a3b : 2000                 bra fxsExit
0a3d :                  fxsNext3:
0a3d :                  fxsExit:
0a3d : 39                 rts
                        
0a3e :                  FxFinish_Dummy:                 ;A=fxtype
0a3e : 39                 rts
                        
0a3f :                  FxInitTable: ;Starttime, soundfx for each fxtype
0a3f : 4021               db ShatterStartTime,ExplosionSoundId
0a41 : 0200               db 2,0
0a43 : 4025               db 64,PickupSoundId
0a45 : 2000               db 32,0
0a47 : 2000               db 32,0
0a49 : 2000               db 32,0
0a4b : 2029               db 32,WarpInSoundId
0a4d : 201d               db 32,WarpOutSoundId
0a4f : 1425               db DrawScale,PickupSoundId
0a51 : 4031               db 64,PlanetExplodeSoundId
0a53 : 0808               db 8,GunFireSoundId
                        
0a55 :                  FxDrawTable:
0a55 : 08f1               dw FxDraw_DotShatter
0a57 : 0903               dw FxDraw_Refueling
0a59 : 0969               dw FxDraw_PickUpPod
0a5b : 09a6               dw FxDraw_Score150
0a5d : 09ad               dw FxDraw_Score300
0a5f : 09b4               dw FxDraw_Score750
0a61 : 09bb               dw FxDraw_WarpIn
0a63 : 09cf               dw FxDraw_WarpOut
0a65 : 09d9               dw FxDraw_FuelCell
0a67 : 09f1               dw FxDraw_PlanetExplode
0a69 : 0a08               dw FxDraw_GunFire
                        
0a6b :                  FxGetCoordsTable:
0a6b : 0890               dw FxGetCoords_Ship
0a6d : 0898               dw FxGetCoords_Pod
0a6f : 08a0               dw FxGetCoords_Gun
0a71 : 08b5               dw FxGetCoords_Plant
0a73 : 08be               dw FxGetCoords_Fuel
0a75 : 08d0               dw FxGetCoords_Switch
0a77 : 08e3               dw FxGetCoords_Walker
                        
0a79 :                  FxFinishTable:          ;OnFinish-event for each target
0a79 : 0a2b               dw FxFinish_Ship
0a7b : 0a3e               dw FxFinish_Dummy
0a7d : 0a3e               dw FxFinish_Dummy
0a7f : 0a3e               dw FxFinish_Dummy
0a81 : 0a3e               dw FxFinish_Dummy
0a83 : 0a3e               dw FxFinish_Dummy
0a85 : 0a3e               dw FxFinish_Dummy
0a87 : 0a3e               dw FxFinish_Dummy
                        
                          include "Thrust_Ship.asm"
                        ; Code for handling ship and pod movement
                        ; Copyright (C) 2004  Ville Krumlinde
                        
000e =                  Gravity = 14
                        
                        ; Gamemode settings
0a89 : 102010           ShipShotSpeeds: db 16,32,16
0a8c : 010301           ShipRotateMasks: db 1,3,1
                        
                        
                        ;*****************
0a8f :                  Ship_Update:                    ;Update, called from main loop
                          direct $c8
                          mTestFlag InactiveFlag
                       >  if 255>InactiveFlag
0a8f : 96e5            >    lda GameFlags1
0a91 : 8510            >    bita #InactiveFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(InactiveFlag)>>8
                       >  endif
                        
0a93 : 2621               bne suExit
                        
0a95 : bd0cfc             jsr Ship_Control
0a98 : bd10ff             jsr Ship_DoMove
0a9b : bd1228             jsr Ship_UpdateShipPodPos
0a9e : 8d17               bsr Ship_Collisions
                        
0aa0 : 967a               lda GameMode
0aa2 : 8102               cmpa #TimeAttackGame
0aa4 : 2610               bne suExit
0aa6 : 9626               lda LoopCounterLow
0aa8 : 843f               anda #63
0aaa : 260a               bne suExit
0aac : 0ae3               dec TimeAttackTime
0aae : 2606               bne suExit
                          mSetFlag GameOverFlag
                       >  if 255>GameOverFlag
0ab0 : 8640            >    lda #GameOverFlag
0ab2 : 9ae5            >    ora GameFlags1
0ab4 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(GameOverFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                        
0ab6 :                  suExit:
                          direct -1
0ab6 : 39                 rts
                        
                        
                        ;*****************
0ab7 :                  Ship_Collisions:                ;Ship and pod collision tests
                          mDecLocals 1,5,0
                       >  nolist
                        
0003 =                  LocalXmin1=LocalW2
0005 =                  LocalXmax1=LocalW3
0007 =                  LocalYmin1=LocalW4
0009 =                  LocalYmax1=LocalW5
                          direct $c8
                        
                          ;Ship-tests
                        
                          ;Setup hit-rectangle of ship
0ab9 : 9ebb               ldx ShipX
0abb : 301c               leax -(ShipArea/2),x
0abd : af63               stx LocalXmin1,s
0abf : 3008               leax ShipArea,x
0ac1 : af65               stx LocalXmax1,s
0ac3 : 9ebd               ldx ShipY
0ac5 : 301c               leax -(ShipArea/2),x
0ac7 : af67               stx LocalYmin1,s
0ac9 : 3008               leax ShipArea,x
0acb : af69               stx LocalYmax1,s
0acd : 3363               leau LocalXmin1,s
0acf : bd12a6             jsr ValidateX
0ad2 : 3365               leau LocalXmax1,s
0ad4 : bd12a6             jsr ValidateX
                        
                        ;TODO?
                        ;  ldx ShipX
                        ;  ldy ShipY
                        ;  mMakeRect LocalXmin1,ShipArea
                        
0ad7 : deca               ldu CurLevelEntry             ;Collision ship vs fuel
0ad9 : ee46               ldu leFuel,u
0adb : a6c0               lda ,u+                       ;load count
0add : a7e4               sta LocalB1,s
0adf : 4f                 clra
0ae0 : d6e9               ldb FuelActive
0ae2 :                  scoVsFuelLoop:
0ae2 : 57                 asrb
0ae3 : 2424               bcc scoVsNextFuel
0ae5 : ed61               std LocalW1,s
                          mTestAreaVsArea LocalXmin1,LocalXmax1,LocalYmin1,LocalYmax1,0,2,FuelArea,scoVsFuelMiss
0ae7 : aec4            >  ldx     0,u
                       >
0ae9 : 300c            >  leax    FuelArea/2,x
0aeb : ac63            >  cmpx    LocalXmin1,s
0aed : 2d18            >  blt    scoVsFuelMiss
                       >
0aef : 3088e8          >  leax    -FuelArea,x
0af2 : ac65            >  cmpx    LocalXmax1,s
0af4 : 2e11            >  bgt    scoVsFuelMiss
                       >
0af6 : ae42            >  ldx     2,u
0af8 : 300c            >  leax    FuelArea/2,x
0afa : ac67            >  cmpx    LocalYmin1,s
0afc : 2d09            >  blt    scoVsFuelMiss
                       >
0afe : 3088e8          >  leax    -FuelArea,x
0b01 : ac69            >  cmpx    LocalYmax1,s
0b03 : 2e02            >  bgt    scoVsFuelMiss
                        
0b05 : 2058               bra scoExplodeShip
0b07 :                  scoVsFuelMiss:
0b07 : ec61               ldd LocalW1,s
0b09 :                  scoVsNextFuel:
0b09 : 3344               leau FuelEntry,u
0b0b : 4c                 inca
0b0c : a1e4               cmpa LocalB1,s
0b0e : 26d2               bne scoVsFuelLoop
                        
0b10 : 3363               leau LocalXmin1,s             ;Collision ship vs level
0b12 : bd2d63             jsr RectVsLevel
0b15 : 2548               bcs scoExplodeShip
                        
0b17 : deca               ldu CurLevelEntry             ;Collision ship vs powerplant
0b19 : 334c               leau lePowerX,u
                          mTestAreaVsArea LocalXmin1,LocalXmax1,LocalYmin1,LocalYmax1,0,2,PlantArea,scoVsPowerMiss
0b1b : aec4            >  ldx     0,u
                       >
0b1d : 300c            >  leax    PlantArea/2,x
0b1f : ac63            >  cmpx    LocalXmin1,s
0b21 : 2d18            >  blt    scoVsPowerMiss
                       >
0b23 : 3088e8          >  leax    -PlantArea,x
0b26 : ac65            >  cmpx    LocalXmax1,s
0b28 : 2e11            >  bgt    scoVsPowerMiss
                       >
0b2a : ae42            >  ldx     2,u
0b2c : 300c            >  leax    PlantArea/2,x
0b2e : ac67            >  cmpx    LocalYmin1,s
0b30 : 2d09            >  blt    scoVsPowerMiss
                       >
0b32 : 3088e8          >  leax    -PlantArea,x
0b35 : ac69            >  cmpx    LocalYmax1,s
0b37 : 2e02            >  bgt    scoVsPowerMiss
                        
0b39 : 2024               bra scoExplodeShip
0b3b :                  scoVsPowerMiss:
                        
                        ;  mTestFlag HasOrbFlag
                        ;  bne scoVsPodMiss
0b3b : deca               ldu CurLevelEntry             ;Collision ship vs stationary pod
0b3d : 3348               leau leOrbX,u
                          mTestAreaVsArea LocalXmin1,LocalXmax1,LocalYmin1,LocalYmax1,0,2,StationaryPodArea,scoVsPodMiss
0b3f : aec4            >  ldx     0,u
                       >
0b41 : 3007            >  leax    StationaryPodArea/2,x
0b43 : ac63            >  cmpx    LocalXmin1,s
0b45 : 2d16            >  blt    scoVsPodMiss
                       >
0b47 : 3012            >  leax    -StationaryPodArea,x
0b49 : ac65            >  cmpx    LocalXmax1,s
0b4b : 2e10            >  bgt    scoVsPodMiss
                       >
0b4d : ae42            >  ldx     2,u
0b4f : 3007            >  leax    StationaryPodArea/2,x
0b51 : ac67            >  cmpx    LocalYmin1,s
0b53 : 2d08            >  blt    scoVsPodMiss
                       >
0b55 : 3012            >  leax    -StationaryPodArea,x
0b57 : ac69            >  cmpx    LocalYmax1,s
0b59 : 2e02            >  bgt    scoVsPodMiss
                        
0b5b : 2002               bra scoExplodeShip
0b5d :                  scoVsPodMiss:
                        
0b5d : 2006               bra scoPodTests
                        
0b5f :                  scoExplodeShip:
0b5f : bd2af8             jsr ExplodeShip
0b62 : 7e0bf0             jmp scoExit
                        
                          ;Pod-tests
                        
0b65 :                  scoPodTests:
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
0b65 : 96e5            >    lda GameFlags1
0b67 : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
0b69 : 10270083           lbeq scoNoPod
                        
                          ;Setup hit-rectangle of pod
0b6d : 9ebf               ldx PodX
0b6f : 301d               leax -(PodArea/2),x
0b71 : af63               stx LocalXmin1,s
0b73 : 3006               leax PodArea,x
0b75 : af65               stx LocalXmax1,s
0b77 : 9ec1               ldx PodY
0b79 : 301d               leax -(PodArea/2),x
0b7b : af67               stx LocalYmin1,s
0b7d : 3006               leax PodArea,x
0b7f : af69               stx LocalYmax1,s
0b81 : 3363               leau LocalXmin1,s
0b83 : bd12a6             jsr ValidateX
0b86 : 3365               leau LocalXmax1,s
0b88 : bd12a6             jsr ValidateX
                        
0b8b : 3363               leau LocalXmin1,s             ;Collision pod vs level
0b8d : bd2d63             jsr RectVsLevel
0b90 : 25cd               bcs scoExplodeShip
                        
0b92 : deca               ldu CurLevelEntry             ;Collision pod vs fuel
0b94 : ee46               ldu leFuel,u
0b96 : a6c0               lda ,u+                       ;load count
0b98 : a7e4               sta LocalB1,s
0b9a : 4f                 clra
0b9b : d6e9               ldb FuelActive
0b9d :                  scoPodVsFuelLoop:
0b9d : 57                 asrb
0b9e : 2424               bcc scoPodVsNextFuel
0ba0 : ed61               std LocalW1,s
                          mTestAreaVsArea LocalXmin1,LocalXmax1,LocalYmin1,LocalYmax1,0,2,FuelArea,scoPodVsFuelMiss
0ba2 : aec4            >  ldx     0,u
                       >
0ba4 : 300c            >  leax    FuelArea/2,x
0ba6 : ac63            >  cmpx    LocalXmin1,s
0ba8 : 2d18            >  blt    scoPodVsFuelMiss
                       >
0baa : 3088e8          >  leax    -FuelArea,x
0bad : ac65            >  cmpx    LocalXmax1,s
0baf : 2e11            >  bgt    scoPodVsFuelMiss
                       >
0bb1 : ae42            >  ldx     2,u
0bb3 : 300c            >  leax    FuelArea/2,x
0bb5 : ac67            >  cmpx    LocalYmin1,s
0bb7 : 2d09            >  blt    scoPodVsFuelMiss
                       >
0bb9 : 3088e8          >  leax    -FuelArea,x
0bbc : ac69            >  cmpx    LocalYmax1,s
0bbe : 2e02            >  bgt    scoPodVsFuelMiss
                        
0bc0 : 209d               bra scoExplodeShip
0bc2 :                  scoPodVsFuelMiss:
0bc2 : ec61               ldd LocalW1,s
0bc4 :                  scoPodVsNextFuel:
0bc4 : 3344               leau FuelEntry,u
0bc6 : 4c                 inca
0bc7 : a1e4               cmpa LocalB1,s
0bc9 : 26d2               bne scoPodVsFuelLoop
                        
0bcb : deca               ldu CurLevelEntry             ;Collision pod vs powerplant
0bcd : 334c               leau lePowerX,u
                          mTestAreaVsArea LocalXmin1,LocalXmax1,LocalYmin1,LocalYmax1,0,2,PlantArea,scoPodVsPowerMiss
0bcf : aec4            >  ldx     0,u
                       >
0bd1 : 300c            >  leax    PlantArea/2,x
0bd3 : ac63            >  cmpx    LocalXmin1,s
0bd5 : 2d19            >  blt    scoPodVsPowerMiss
                       >
0bd7 : 3088e8          >  leax    -PlantArea,x
0bda : ac65            >  cmpx    LocalXmax1,s
0bdc : 2e12            >  bgt    scoPodVsPowerMiss
                       >
0bde : ae42            >  ldx     2,u
0be0 : 300c            >  leax    PlantArea/2,x
0be2 : ac67            >  cmpx    LocalYmin1,s
0be4 : 2d0a            >  blt    scoPodVsPowerMiss
                       >
0be6 : 3088e8          >  leax    -PlantArea,x
0be9 : ac69            >  cmpx    LocalYmax1,s
0beb : 2e03            >  bgt    scoPodVsPowerMiss
                        
0bed : 7e0b5f             bra scoExplodeShip
0bf0 :                  scoPodVsPowerMiss:
                        
0bf0 :                  scoNoPod:
                        
                        
0bf0 :                  scoExit:
                        
                          direct -1
                          mFreeLocals
0bf0 : 326b            >  leas FrameSize,s
                        
0bf2 : 39                 rts
                        
                        
                        ;*****************
0bf3 :                  Ship_Loaded:            ;Set pod to be carried by ship
                          direct $c8
                        
0bf3 : 109eca             ldy CurLevelEntry
                          mClearFlag PullFlag
                       >  if 255>PullFlag
0bf6 : 86f7            >    lda #~PullFlag
0bf8 : 94e5            >    anda GameFlags1
0bfa : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~((PullFlag)>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                          mSetFlag HasOrbFlag
                       >  if 255>HasOrbFlag
0bfc : 8604            >    lda #HasOrbFlag
0bfe : 9ae5            >    ora GameFlags1
0c00 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(HasOrbFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                        
                          ;Calculate center coordinate
0c02 : ec28               ldd leOrbX,y
0c04 : 93bb               subd ShipX
0c06 : 47                 asra
0c07 : 56                 rorb
0c08 : d3bb               addd ShipX
0c0a : ddac               std CenterX
                        
0c0c : ec2a               ldd leOrbY,y
0c0e : 93bd               subd ShipY
0c10 : 47                 asra
0c11 : 56                 rorb
0c12 : d3bd               addd ShipY
0c14 : ddaf               std CenterY
                        
0c16 : bd0c36             jsr Ship_FindLoadAngle
0c19 : 97b2               sta AlphaHi
                        
0c1b : bd1228             jsr Ship_UpdateShipPodPos ;Pod and ship coords need to be recalced
                        
0c1e : 967a               lda GameMode
0c20 : 8100               cmpa #NormalGame
0c22 : 260c               bne slSkipHalf
0c24 : dcb7               ldd ShipSpeedX            ;half speed
0c26 : 47                 asra
0c27 : 56                 rorb
0c28 : ddb7               std ShipSpeedX
0c2a : dcb9               ldd ShipSpeedY
0c2c : 47                 asra
0c2d : 56                 rorb
0c2e : ddb9               std ShipSpeedY
0c30 :                  slSkipHalf:
                        
                          mEmitFx FxTargetPod,FxTypePickUpPod,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
0c30 : 8621            >  lda #FxTargetPod | (FxTypePickUpPod<<4)
0c32 : bd06bc          >  jsr EmitFx
                        
                          direct -1
0c35 : 39                 rts
                        
                        
                        ;*****************
0c36 :                  Ship_FindLoadAngle:
                          ;Find the angle between pod and ship when pod is picked up.
                          ;Loop the distance table and find the best match, this is the angle.
                          ;This is quite slow but it is only called once during pick up.
                          direct $c8
                          mDecLocals 5,0,0
                       >  nolist
                        
0000 =                  LocalDx = LocalB1
0001 =                  LocalDy = LocalB2
0002 =                  LocalBest = LocalB3
0003 =                  LocalLoop = LocalB4
0004 =                  LocalBestI = LocalB5
                        
                          ; ShipX := PixX + DistanceLUT[ I ];
                          ; ShipY := PixY - DistanceLUT[ I+1 ];
                          ; PodX := PixX - DistanceLUT[ I ];
                          ; PodY := PixY + DistanceLUT[ I+1 ];
                        
0c38 : 109eca             ldy CurLevelEntry
                        
0c3b : dcbb               ldd ShipX
0c3d : a328               subd leOrbX,y
0c3f : 49                 rola
0c40 : 56                 rorb
0c41 : e7e4               stb LocalDx,s
                          ;b=distance/2, with sign bit
                        
0c43 : ec2a               ldd leOrbY,y
0c45 : 93bd               subd ShipY
0c47 : 49                 rola
0c48 : 56                 rorb
0c49 : e761               stb LocalDy,s
                          ;b=distance/2, with sign bit
                        
0c4b : 867f               lda #127
0c4d : a762               sta LocalBest,s
0c4f : 6f64               clr LocalBestI,s
                        
0c51 : ce12b8             ldu #DistanceTable
0c54 : 86f0               lda #ALPHA_MAX
0c56 : a763               sta LocalLoop,s
0c58 :                  flaLoop:
0c58 : a6e4               lda LocalDx,s
0c5a : a0c4               suba ,u
0c5c : 2a01               bpl flaXPos
0c5e : 40                   nega
0c5f :                  flaXPos:
0c5f : a77f               sta -1,s
                        
0c61 : a661               lda LocalDy,s
0c63 : a041               suba 1,u
0c65 : 2a01               bpl flaYPos
0c67 : 40                   nega
0c68 :                  flaYPos:
0c68 : ab7f               adda -1,s
                        
0c6a : a162               cmpa LocalBest,s
0c6c : 2c06               bge flaNotBetter
0c6e : a762                 sta LocalBest,s
0c70 : a663                 lda LocalLoop,s
0c72 : a764                 sta LocalBestI,s
0c74 :                  flaNotBetter:
                        
0c74 : 3342               leau 2,u
0c76 : 6a63               dec LocalLoop,s
0c78 : 26de               bne flaLoop
                        
0c7a : 86f0               lda #ALPHA_MAX
0c7c : a064               suba LocalBestI,s
                        
                          mFreeLocals
0c7e : 3265            >  leas FrameSize,s
                        
                          direct -1
0c80 : 39                 rts
                        
                        
                        ;*****************
0c81 :                  Ship_DemoControl:                        ;read input from demo data, return state in a
                          direct $c8
                        
0c81 : 9edb               ldx DemoPtr
                        
0c83 : 96dd               lda DemoCounter
0c85 : 2607               bne sdcDecCounter
0c87 : 3002                 leax 2,x
0c89 : 9fdb                 stx DemoPtr
0c8b : a601                 lda 1,x
0c8d : 4c                   inca
0c8e :                  sdcDecCounter:
0c8e : 4a                 deca
0c8f : 97dd               sta DemoCounter
                        
0c91 : a684               lda ,x
                        
                          direct -1
0c93 : 39                 rts
                        
                        
0001 =                  Button1 = 1
0002 =                  Button2 = 2
0004 =                  Button3 = 4
0008 =                  Button4 = 8
0010 =                  JoyLeft = 16
0020 =                  JoyRight = 32
0080 =                  JoyDown = 128
                        
                        ;*****************
0c94 :                  Ship_ConsoleControl:                    ;read input from joy + buttons, return state in a
                          direct $c8
                        
                          ;DP must be D0 when reading joystick
                          mDptoD0
0c94 : 86d0            >  lda   #0xD0
0c96 : 1f8b            >  tfr   a,dp
                       >  direct -1
                        
                        
0c98 : bdf1f8             jsr read_joystick
                        
                          ;A must have bit set for firebutton, to disable autofire
0c9b : 8601               lda #$1
0c9d : f6c880             ldb ButtonConfig
0ca0 : 2a02               bpl sccNo2Fire
0ca2 : 48                   lsla
0ca3 : 48                   lsla
0ca4 :                  sccNo2Fire:
0ca4 : 59                 rolb
0ca5 : 2a01               bpl sccNo1Fire
0ca7 : 48                   lsla
0ca8 :                  sccNo1Fire:
0ca8 : bdf1b4             jsr read_switches
                        
                          ;Back to C8
                          mDptoC8
0cab : 86c8            >  lda   #0xC8
0cad : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
                        
0caf : 4f                 clra
0cb0 : 8ec812             ldx #$C812
                        
0cb3 : d680               ldb ButtonConfig
                        
0cb5 : e77f               stb -1,s
0cb7 : c403               andb #3
0cb9 : 6d85               tst b,x
0cbb : 2702               beq sccNoButton4
0cbd : 8a08                 ora #Button4
0cbf :                  sccNoButton4:
0cbf : e67f               ldb -1,s
                        
0cc1 : 54                 lsrb
0cc2 : 54                 lsrb
0cc3 : e77f               stb -1,s
0cc5 : c403               andb #3
0cc7 : 6d85               tst b,x
0cc9 : 2702               beq sccNoButton3
0ccb : 8a04                 ora #Button3
0ccd :                  sccNoButton3:
0ccd : e67f               ldb -1,s
                        
0ccf : 54                 lsrb
0cd0 : 54                 lsrb
0cd1 : e77f               stb -1,s
0cd3 : c403               andb #3
0cd5 : 6d85               tst b,x
0cd7 : 2702               beq sccNoButton2
0cd9 : 8a02                 ora #Button2
0cdb :                  sccNoButton2:
0cdb : e67f               ldb -1,s
                        
0cdd : 54                 lsrb
0cde : 54                 lsrb
0cdf : 6d85               tst b,x
0ce1 : 2702               beq sccNoButton1
0ce3 : 8a01                 ora #Button1
0ce5 :                  sccNoButton1:
                        
0ce5 : d61b               ldb $c81b     ;read joystick
0ce7 : 2708               beq sccNoJoy
0ce9 : 2a04               bpl sccRight
0ceb : 8a10                 ora #JoyLeft
0ced : 2002                 bra sccNoJoy
0cef :                  sccRight:
0cef : 8a20                 ora #JoyRight
0cf1 :                  sccNoJoy:
                        
0cf1 : d61c               ldb $c81c     ;todo: test down is lock
0cf3 : 2706               beq sccNoUpDown
0cf5 : 2a04               bpl sccUp
0cf7 : 8a80                 ora #JoyDown
0cf9 : 2000                 bra sccNoUpDown
0cfb :                  sccUp:
0cfb :                  sccNoUpDown:
                        
                          direct -1
0cfb : 39                 rts
                        
                        ;*****************
0cfc :                  Ship_Control:
                          mDecLocals 2,1,4
                       >  nolist
                        
0000 =                  LocalInput = LocalB1
0001 =                  LocalFuelCount = LocalB2
                          direct $c8
                        
0cfe : 96da               lda DemoMode
0d00 : 2a05               bpl scNoDemo
0d02 : bd0c81               bsr Ship_DemoControl        ;read input from recorded demo data
0d05 : 2002                 bra scInputFin
0d07 :                  scNoDemo:                       ;read input from console
0d07 : 8d8b                 bsr Ship_ConsoleControl
0d09 :                  scInputFin:
0d09 : a7e4               sta LocalInput,s
                        
                          if DemoRecord=1
                            ;Unused instruction signal VecxMod to sample user input.
                            db $14
                          endif
                        
0d0b : 967a               lda GameMode                  ;lock thrust, button 4
0d0d : 8101               cmpa #HardGame
0d0f : 262a               bne scLockFinish
0d11 : a6e4               lda LocalInput,s
0d13 : 8588               bita #Button4 | JoyDown
0d15 : 271e               beq scNoLock
0d17 : 8a04                 ora #Button3        ;lock automatically also thrusts
0d19 : a7e4                 sta LocalInput,s
                          mTestFlag LockedThrustFlag
                       >  if 255>LockedThrustFlag
                       >    lda GameFlags1
                       >    bita #LockedThrustFlag
                       >  else
0d1b : 96e6            >    lda GameFlags2
0d1d : 8504            >    bita #(LockedThrustFlag)>>8
                       >  endif
                        
0d1f : 261a               bne scLockFinish
                        ;  lda ShipAngle
                        ;  sta LockedShipAngle
0d21 : c608               ldb #8  ;Lock up or down depending on gravity
                          mTestFlag ReverseGravFlag
                       >  if 255>ReverseGravFlag
0d23 : 96e5            >    lda GameFlags1
0d25 : 8580            >    bita #ReverseGravFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ReverseGravFlag)>>8
                       >  endif
                        
0d27 : 2702               beq scLockAngleUp
0d29 : cb10                 addb #SHIP_DIRMAX/2
0d2b :                  scLockAngleUp:
0d2b : d768               stb LockedShipAngle
                          mSetFlag LockedThrustFlag
                       >  if 255>LockedThrustFlag
                       >    lda #LockedThrustFlag
                       >    ora GameFlags1
                       >    sta GameFlags1
                       >  else
0d2d : 8604            >    lda #(LockedThrustFlag)>>8
0d2f : 9ae6            >    ora GameFlags2
0d31 : 97e6            >    sta GameFlags2
                       >  endif
                        
0d33 : 2006               bra scLockFinish
0d35 :                  scNoLock:
                          mClearFlag LockedThrustFlag
                       >  if 255>LockedThrustFlag
                       >    lda #~LockedThrustFlag
                       >    anda GameFlags1
                       >    sta GameFlags1
                       >  else
0d35 : 86fb            >    lda #~((LockedThrustFlag)>>8)
0d37 : 94e6            >    anda GameFlags2
0d39 : 97e6            >    sta GameFlags2
                       >  endif
                        
0d3b :                  scLockFinish:
                        
                        
                          ;Thrust
0d3b : a6e4               lda LocalInput,s
0d3d : 8504               bita #Button3
                        ;  tst stick1_button3
0d3f : 2714               beq scNotPressed_3
0d41 : dce1                 ldd ShipFuel
0d43 : 2710                 beq scNotPressed_3          ;Ship must have fuel left
                            mEmitSound ThrustSoundId
                       >  if 1=1
0d45 : 8606            >    lda #ThrustSoundId
                       >  endif
0d47 : bd0477          >  jsr EmitSound
                        
                            mSetFlag ThrustFlag
                       >  if 255>ThrustFlag
0d4a : 8620            >    lda #ThrustFlag
0d4c : 9ae5            >    ora GameFlags1
0d4e : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(ThrustFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
0d50 : bd11b3               jsr Ship_DoThrust
0d53 : 2006                 bra scThrustFin
0d55 :                  scNotPressed_3:                 ;No thrust
                            mClearFlag ThrustFlag
                       >  if 255>ThrustFlag
0d55 : 86df            >    lda #~ThrustFlag
0d57 : 94e5            >    anda GameFlags1
0d59 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~((ThrustFlag)>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
0d5b :                  scThrustFin:
                        
                        
                        ;  tst stick1_button1            ;Firebutton
0d5b : a6e4               lda LocalInput,s
0d5d : 8501               bita #Button1
0d5f : 273e               beq scFireFinish
                            mTestFlag ShieldFlag        ;can't fire while using shield
                       >  if 255>ShieldFlag        
0d61 : 96e5            >    lda GameFlags1
0d63 : 8501            >    bita #ShieldFlag        
                       >  else
                       >    lda GameFlags2
                       >    bita #(ShieldFlag        )>>8
                       >  endif
                        
0d65 : 2638                 bne scFireFinish
                            ;Find free
0d67 : 108ec91c             ldy #ShipShotList
0d6b : 8604                 lda #ShipShotCount
0d6d :                  scFire1:
0d6d : 6da4                 tst ssShotActive,y
0d6f : 2707                 beq scFreeFound
0d71 : 3129                 leay ShipShotEntry,y
0d73 : 4a                   deca
0d74 : 26f7                 bne scFire1
0d76 : 2027                 bra scFireFinish            ;No free found
0d78 :                  scFreeFound:
                            mEmitSound ShipFireSoundId
                       >  if 1=1
0d78 : 860c            >    lda #ShipFireSoundId
                       >  endif
0d7a : bd0477          >  jsr EmitSound
                        
0d7d : 63a4                 com ssShotActive,y          ;Set active
0d7f : d6b6                 ldb ShipAngle               ;Calc rise & run, use angle from ship
                            mShipAngleToVec b
0d81 : 58              > lslb
0d82 : c010            > subb #16
0d84 : 2a02            > bpl l10290
0d86 : cb40            >   addb #VEC_DIRMAX
0d88 :                 >l10290:
                        
0d88 : 8e0a89               ldx #ShipShotSpeeds
0d8b : 967a                 lda GameMode
0d8d : a686                 lda a,x                     ;scale
0d8f : bdf601               jsr convert_angle_to_rise_run  ;dp must be c8
                            ;D holds result, optimize assign both with std
0d92 : 40                   nega                        ;Y axis points down in our world
0d93 : a728                 sta ssShotVelocY,y
0d95 : e727                 stb ssShotVelocX,y
0d97 : dcbb                 ldd ShipX                   ;Set start position, use ship coordinates
0d99 : ed21                 std ssShotX,y
0d9b : dcbd                 ldd ShipY
0d9d : ed24                 std ssShotY,y
0d9f :                  scFireFinish:
                        
                        
0d9f : d67a               ldb GameMode
0da1 : 8e0a8c             ldx #ShipRotateMasks
0da4 : 9626               lda LoopCounterLow
0da6 : a485               anda b,x
0da8 : 271e               beq scLRFinished
                        
                        ;  lda $c81b
0daa : a6e4               lda LocalInput,s
0dac : 8430               anda #JoyLeft | JoyRight
0dae : 2718               beq scLRFinished
0db0 : 8510               bita #JoyLeft
0db2 : 260a               bne scRotateLeft
0db4 : 0ab6                 dec ShipAngle               ;Rotate right
0db6 : 2a10                 bpl scLRFinished
0db8 : 861f                   lda #SHIP_DIRMAX-1
0dba : 97b6                   sta ShipAngle
0dbc : 200a                 bra scLRFinished
0dbe :                  scRotateLeft:                   ;Rotate left
0dbe : 0cb6                inc ShipAngle
0dc0 : 96b6                lda ShipAngle
0dc2 : 8120                cmpa #SHIP_DIRMAX
0dc4 : 2d02                blt scLRFinished
0dc6 : 0fb6                  clr ShipAngle
0dc8 :                  scLRFinished:
                        
                        
                          ;Shield/pull
0dc8 : a6e4               lda LocalInput,s
0dca : 8502               bita #Button2
                        ;  tst stick1_button2
0dcc : 10270114           lbeq scNoShield
0dd0 : dce1                 ldd ShipFuel
0dd2 : 1027010e             lbeq scNoShield             ;Ship must have fuel left
                        
                            mSetFlag ShieldFlag
                       >  if 255>ShieldFlag
0dd6 : 8601            >    lda #ShieldFlag
0dd8 : 9ae5            >    ora GameFlags1
0dda : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(ShieldFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                            mEmitSound ShieldSoundId
                       >  if 1=1
0ddc : 8619            >    lda #ShieldSoundId
                       >  endif
0dde : bd0477          >  jsr EmitSound
                        
                        
0de1 : dcbb                 ldd ShipX                   ;Set up buffer with coords of a point under ship
0de3 : ed64                 std LocalBuffer,s
0de5 : dcbd                 ldd ShipY
0de7 : c30020               addd #RefuelDistance / 2
0dea : ed66                 std LocalBuffer+2,s
0dec : 3164                 leay LocalBuffer,s
                        
0dee : 967a                 lda GameMode                ;Refuel while carrying pod is only allowed in hard+ mode
0df0 : 8101                 cmpa #HardGame
0df2 : 2708                 beq scGoFuelTest
                            mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
0df4 : 96e5            >    lda GameFlags1
0df6 : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
0df8 : 10260093             lbne scSkipFuelTest
0dfc :                  scGoFuelTest:
                        
0dfc : deca                 ldu CurLevelEntry           ;Test if fuel is under ship
0dfe : ee46                 ldu leFuel,u
0e00 : a6c0                 lda ,u+                     ;load count
0e02 : a761                 sta LocalFuelCount,s
0e04 : 4f                   clra
0e05 : d6e9                 ldb FuelActive
0e07 :                  scFuelLoop:
0e07 : 57                   asrb
0e08 : 1024007a             lbcc scNextFuel
0e0c : ed62                 std LocalW1,s
                            ;point is fuel-pos, rect is area under ship
                            mPointVsRect (FuelArea+4),RefuelDistance,scFuelMiss, 0,2, 0,2
0e0e : aec4            >  ldx      0,u
0e10 : eca4            >  ldd      0,y
0e12 : 83000e          >  subd    #(FuelArea+4)/2
0e15 : ed7e            >  std -2,s
0e17 : ac7e            >  cmpx -2,s
0e19 : 2d69            >  blt    scFuelMiss
0e1b : c3001c          >  addd    #(FuelArea+4)
0e1e : ed7e            >  std -2,s
0e20 : ac7e            >  cmpx -2,s
0e22 : 2e60            >  bgt    scFuelMiss
0e24 : ae42            >  ldx     2,u
0e26 : ec22            >  ldd     2,y
0e28 : 830020          >  subd    #RefuelDistance/2
0e2b : ed7e            >  std -2,s
0e2d : ac7e            >  cmpx -2,s
0e2f : 2d53            >  blt    scFuelMiss
0e31 : c30040          >  addd    #RefuelDistance
0e34 : ed7e            >  std -2,s
0e36 : ac7e            >  cmpx -2,s
0e38 : 2e4a            >  bgt    scFuelMiss
                        
                        
                            mSetFlag RefuelFlag         ;Fuel found
                       >  if 255>RefuelFlag         
0e3a : 8602            >    lda #RefuelFlag         
0e3c : 9ae5            >    ora GameFlags1
0e3e : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(RefuelFlag         )>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                        
0e40 : a662                 lda LocalW1,s
                            mEmitFx FxTargetFuel,FxTypeRefueling,a
                       >  if ('a'!='0') && ('a'!='b')
0e42 : 1f89            >    tfr a,b
                       >  endif
0e44 : 8614            >  lda #FxTargetFuel | (FxTypeRefueling<<4)
0e46 : bd06bc          >  jsr EmitFx
                        
                        
0e49 : 9626                 lda LoopCounterLow          ;Refuel one unit every 4th frame
0e4b : 8403                 anda #3
0e4d : 10260099             lbne scShieldFin
                        
0e51 : 8ec8ea               ldx #FuelAmounts            ;Decrease amount in fuel cell, remove if empty
0e54 : a662                 lda LocalW1,s
0e56 : e686                 ldb a,x
0e58 : 5a                   decb
0e59 : e786                 stb a,x
0e5b : 1026008b             lbne scShieldFin
                        
                            mEmitFx FxTargetFuel,FxTypeFuelCell,a
                       >  if ('a'!='0') && ('a'!='b')
0e5f : 1f89            >    tfr a,b
                       >  endif
0e61 : 8684            >  lda #FxTargetFuel | (FxTypeFuelCell<<4)
0e63 : bd06bc          >  jsr EmitFx
                        
0e66 : a662                 lda LocalW1,s
                            mEmitFx FxTargetFuel,FxTypeScore300,a
                       >  if ('a'!='0') && ('a'!='b')
0e68 : 1f89            >    tfr a,b
                       >  endif
0e6a : 8644            >  lda #FxTargetFuel | (FxTypeScore300<<4)
0e6c : bd06bc          >  jsr EmitFx
                        
                        
0e6f : a662                 lda LocalW1,s
                            mClearBitA FuelActive
0e71 : c6ff            >  ldb #255                    ;start with all bits set
0e73 : 1cfe            >  andcc #$fe                  ;clear carry flag, rolb will shift it into b
0e75 :                 >lop0299:                          ;rotate a zero into b
0e75 : 59              >  rolb
0e76 : 4a              >  deca
0e77 : 2afc            >  bpl lop0299
0e79 : d4e9            >  andb FuelActive                   ;b now has a hole in it, AND with FuelActive to clear bit
0e7b : d7e9            >  stb FuelActive
                        
                        
                            mGiveScore 300
0e7d : 861e            >  lda #300 / 10
0e7f : bd1ad0          >  jsr GiveScoreA
                        
                        
0e82 : 2066                 bra scShieldFin
0e84 :                  scFuelMiss:
0e84 : ec62                 ldd LocalW1,s
0e86 :                  scNextFuel:
0e86 : 3344                 leau FuelEntry,u
0e88 : 4c                   inca
0e89 : a161                 cmpa LocalFuelCount,s
0e8b : 1026ff78             bne scFuelLoop
0e8f :                  scSkipFuelTest:
                            mClearFlag RefuelFlag       ;no fuel found
                       >  if 255>RefuelFlag       
0e8f : 86fd            >    lda #~RefuelFlag       
0e91 : 94e5            >    anda GameFlags1
0e93 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~((RefuelFlag       )>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                        
                        
                            mTestFlag HasOrbFlag        ;Test if pod is under ship
                       >  if 255>HasOrbFlag        
0e95 : 96e5            >    lda GameFlags1
0e97 : 8504            >    bita #HasOrbFlag        
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag        )>>8
                       >  endif
                        
0e99 : 264f                 bne scShieldFin
                        
0e9b : dcbd                 ldd ShipY
0e9d : ed66                 std LocalBuffer+2,s
0e9f : 3164                 leay LocalBuffer,s
                        
0ea1 : deca                 ldu CurLevelEntry           ;point is pod-pos, rect is area under ship
0ea3 : 3348                 leau leOrbX,u
                            mPointVsRect BeamLength*2,BeamLength*2,scPodMiss, 0,2, 0,2
0ea5 : aec4            >  ldx      0,u
0ea7 : eca4            >  ldd      0,y
0ea9 : 83003c          >  subd    #BeamLength*2/2
0eac : ed7e            >  std -2,s
0eae : ac7e            >  cmpx -2,s
0eb0 : 2d27            >  blt    scPodMiss
0eb2 : c30078          >  addd    #BeamLength*2
0eb5 : ed7e            >  std -2,s
0eb7 : ac7e            >  cmpx -2,s
0eb9 : 2e1e            >  bgt    scPodMiss
0ebb : ae42            >  ldx     2,u
0ebd : ec22            >  ldd     2,y
0ebf : 83003c          >  subd    #BeamLength*2/2
0ec2 : ed7e            >  std -2,s
0ec4 : ac7e            >  cmpx -2,s
0ec6 : 2d11            >  blt    scPodMiss
0ec8 : c30078          >  addd    #BeamLength*2
0ecb : ed7e            >  std -2,s
0ecd : ac7e            >  cmpx -2,s
0ecf : 2e08            >  bgt    scPodMiss
                        
                            mSetFlag PullFlag           ;pod found
                       >  if 255>PullFlag           
0ed1 : 8608            >    lda #PullFlag           
0ed3 : 9ae5            >    ora GameFlags1
0ed5 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(PullFlag           )>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
0ed7 : 2011                 bra scShieldFin
0ed9 :                  scPodMiss:
                            mTestFlag PullFlag
                       >  if 255>PullFlag
0ed9 : 96e5            >    lda GameFlags1
0edb : 8508            >    bita #PullFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(PullFlag)>>8
                       >  endif
                        
0edd : 270b                 beq scShieldFin
                              ;Ship has pulled the pod loose from the platform
0edf : bd0bf3                 jsr Ship_Loaded
0ee2 : 2006                 bra scShieldFin
0ee4 :                  scNoShield:
                            mClearFlag (ShieldFlag | RefuelFlag | PullFlag)
                       >  if 255>(ShieldFlag | RefuelFlag | PullFlag)
0ee4 : 86f4            >    lda #~(ShieldFlag | RefuelFlag | PullFlag)
0ee6 : 94e5            >    anda GameFlags1
0ee8 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~(((ShieldFlag | RefuelFlag | PullFlag))>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
0eea :                  scShieldFin:
                        
                          ;Decrease 'perfect' bonus when shield is used (and no pull/refuel/invisible)
                          mTestFlag ShieldFlag
                       >  if 255>ShieldFlag
0eea : 96e5            >    lda GameFlags1
0eec : 8501            >    bita #ShieldFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ShieldFlag)>>8
                       >  endif
                        
0eee : 2721               beq scSkipPerfect
0ef0 : 9626               lda LoopCounterLow
0ef2 : 8407               anda #7
0ef4 : 261b               bne scSkipPerfect
                          mTestFlag RefuelFlag
                       >  if 255>RefuelFlag
0ef6 : 96e5            >    lda GameFlags1
0ef8 : 8502            >    bita #RefuelFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(RefuelFlag)>>8
                       >  endif
                        
0efa : 2615               bne scSkipPerfect
                          mTestFlag PullFlag
                       >  if 255>PullFlag
0efc : 96e5            >    lda GameFlags1
0efe : 8508            >    bita #PullFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(PullFlag)>>8
                       >  endif
                        
0f00 : 260f               bne scSkipPerfect
                          mTestFlag NoLandscapeFlag
                       >  if 255>NoLandscapeFlag
                       >    lda GameFlags1
                       >    bita #NoLandscapeFlag
                       >  else
0f02 : 96e6            >    lda GameFlags2
0f04 : 8501            >    bita #(NoLandscapeFlag)>>8
                       >  endif
                        
0f06 : 2609               bne scSkipPerfect
0f08 : 96f5                 lda PerfectBonus
0f0a : 8102                 cmpa #2                     ;don't decrease below 2
0f0c : 2f03                 ble scSkipPerfect
0f0e : 4a                     deca
0f0f : 97f5                   sta PerfectBonus
0f11 :                  scSkipPerfect:
                        
0f11 :                  scExit:
                          mFreeLocals
0f11 : 3268            >  leas FrameSize,s
                        
                          direct -1
0f13 : 39                 rts
                        
                        
                        
                        
                        
                        ;*****************
0f14 :                  Ship_Draw:
                          ;DP must be D0
                          ;allocate buffer for rotated vectors
                          mDecLocals 0,2,((ShipVectorCount+ThrustVectorCount)*2)
                       >  nolist
                        
0000 =                  LocalShip = LocalW1
0002 =                  LocalPlatform = LocalW2
0002 =                  LocalOrb = LocalW2
                        
                          mTestFlag InactiveFlag
                       >  if 255>InactiveFlag
0f17 : b6c8e5          >    lda GameFlags1
0f1a : 8510            >    bita #InactiveFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(InactiveFlag)>>8
                       >  endif
                        
0f1c : 102601db           lbne sddExit
                        
                          ;Rotate vectors before reset pen, otherwise position will drift
0f20 : c609               ldb #ShipVectorCount-1
                          mTestFlag ThrustFlag
                       >  if 255>ThrustFlag
0f22 : b6c8e5          >    lda GameFlags1
0f25 : 8520            >    bita #ThrustFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ThrustFlag)>>8
                       >  endif
                        
0f27 : 2702               beq sddNoThrust1
0f29 : cb03                 addb #ThrustVectorCount
0f2b :                  sddNoThrust1:
0f2b : b6c8b6             lda ShipAngle
                          mShipAngleToVec a
0f2e : 48              > lsla
0f2f : 8010            > suba #16
0f31 : 2a02            > bpl l10327
0f33 : 8b40            >   adda #VEC_DIRMAX
0f35 :                 >l10327:
                        
0f35 : 8e4b60             ldx #ShipVectorList
0f38 : 3364               leau LocalBuffer,s            ;Vector buffer
0f3a : bdf610             jsr rot_vec_list2             ;Rotate vectors
                        
0f3d : bdf354             jsr reset0ref                 ;Reset pen
                        
                          mGetScreenX ShipX
                       >  if  1 = 0    ;no param, X holds X-coord
                       >    tfr x,y
                       >  endif
                       >  if  1 = 1
0f40 : 10bec8bb        >    ldy     ShipX
                       >  endif
                       >  if  1 = 2   ;as09 treats "2,y" as two separate macro arguments
                       >    ldy     ShipX,
                       >  endif
0f44 : bec8c6          >  ldx     ViewX
0f47 : 1f20            >  tfr     y,d
0f49 : af7e            >  stx -2,s
0f4b : a37e            >  subd -2,s
0f4d : 2c0a            >  bge     L1430328
0f4f : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
0f52 : a37e            >  subd -2,s
0f54 : 10af7e          >  sty -2,s
0f57 : e37e            >  addd -2,s
0f59 :                 >L1430328:
                        
0f59 : c080               subb #128
0f5b : 3404               pshs b
                        
0f5d : fcc8bd             ldd ShipY
0f60 : b3c8c8             subd ViewY
0f63 : 50                 negb
0f64 : 1f98               tfr b,a
0f66 : 3504               puls b
0f68 : 8b7f               adda #127
0f6a : ede4               std LocalShip,s               ;Save ship screen coords
0f6c : bdf2fc             jsr move_pen7f_to_d           ;Set pen position to value of d register
                        
                          mSetIntensity $4f
                       >  if 1=1
0f6f : 864f            >    lda   #$4f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
0f71 : 9701            >  sta   <01
0f73 : cc0401          >  ldd   #$0401
0f76 : 9700            >  sta   <00
0f78 : d700            >  stb   <00
                        
                        
0f7a : 3064               leax LocalBuffer,s            ;Vector buffer
0f7c : 8609               lda   #ShipVectorCount-1      ;Nr of vectors in list
0f7e : c614               ldb   #DrawScale              ;Scale
0f80 : bdf3b7             jsr   move_draw_VL4           ;Draw list
                        
                          mTestFlag ThrustFlag          ;Draw thrust-tail effect
                       >  if 255>ThrustFlag          
0f83 : b6c8e5          >    lda GameFlags1
0f86 : 8520            >    bita #ThrustFlag          
                       >  else
                       >    lda GameFlags2
                       >    bita #(ThrustFlag          )>>8
                       >  endif
                        
0f88 : 2726               beq sddNoThrust2
0f8a : b6c826               lda LoopCounterLow
                            ;asra
0f8d : 48                   asla
0f8e : 48                   asla
0f8f : 48                   asla
0f90 : 843f                 anda #63
                            ;adda #40
                            mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
0f92 : 9701            >  sta   <01
0f94 : cc0401          >  ldd   #$0401
0f97 : 9700            >  sta   <00
0f99 : d700            >  stb   <00
                        
0f9b : 30e818               leax LocalBuffer+(ShipVectorCount*2),s            ;Vector buffer
0f9e : c614                 ldb   #DrawScale              ;Scale
0fa0 : b6c826             lda LoopCounterLow
0fa3 : 44                 lsra
0fa4 : 44                 lsra
                        ; lda $C87D+2
                        ; lda ShipSpeedX
                        ; adda ShipSpeedY
                        ; mRandomToA
                        ;  adda DrawList
                        ;  asra
0fa5 : 8403               anda #3
0fa7 : a77f               sta -1,s
0fa9 : eb7f               addb -1,s
                        ;    lda LoopCounterLow
                        ;    rora
                        ;    rora
                        ;    anda #0
                        ;    sta -1,s
                        ;    subb -1,s
0fab : 8602                 lda   #ThrustVectorCount-1      ;Nr of vectors in list
0fad : bdf3b7               jsr   move_draw_VL4           ;Draw list
0fb0 :                  sddNoThrust2:
                        
                          mTestFlag ShieldFlag          ;Test for shield
                       >  if 255>ShieldFlag          
0fb0 : b6c8e5          >    lda GameFlags1
0fb3 : 8501            >    bita #ShieldFlag          
                       >  else
                       >    lda GameFlags2
                       >    bita #(ShieldFlag          )>>8
                       >  endif
                        
0fb5 : 273a               beq sddNoShield
0fb7 : bdf354               jsr reset0ref
0fba : 864f                 lda #$4f                    ;draw shield
0fbc : f6c826               ldb LoopCounterLow
0fbf : c41f                 andb #31
0fc1 : e77f                 stb -1,s
0fc3 : a07f                 suba -1,s
                            mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
0fc5 : 9701            >  sta   <01
0fc7 : cc0401          >  ldd   #$0401
0fca : 9700            >  sta   <00
0fcc : d700            >  stb   <00
                        
0fce : ece4                 ldd LocalShip,s
0fd0 : bdf2fc               jsr move_pen7f_to_d
                        
0fd3 : 8688                 lda #%10001000              ;set drawing pattern
0fd5 : f6c826               ldb LoopCounterLow
0fd8 : 54                   lsrb
0fd9 : 54                   lsrb
0fda : c403                 andb #3
0fdc :                  sddRor:
0fdc : 2704                 beq sddRorFin
0fde : 46                   rora
0fdf : 5a                   decb
0fe0 : 20fa                 bra sddRor
0fe2 :                  sddRorFin:
0fe2 : b7c829               sta $c829
                        
                            mSetScale DrawScale
                       >  if 1=1
0fe5 : 8614            >    lda #DrawScale                  ;if argument exists, load into a, otherwise use current a
                       >  endif
0fe7 : 9704            >  sta <$04
                        
                        
0fe9 : 8e4b99               ldx #ShieldVectorList
0fec : 8607                 lda #8-1
0fee : bd0811               jsr FxMoveDrawPattern
0ff1 :                  sddNoShield:
                        
                        
                          mTestFlag LockedThrustFlag
                       >  if 255>LockedThrustFlag
                       >    lda GameFlags1
                       >    bita #LockedThrustFlag
                       >  else
0ff1 : b6c8e6          >    lda GameFlags2
0ff4 : 8504            >    bita #(LockedThrustFlag)>>8
                       >  endif
                        
0ff6 : 2742               beq sddNoLock
0ff8 : c609                 ldb #ShipVectorCount-1
0ffa : b6c868               lda LockedShipAngle
                            mShipAngleToVec a
0ffd : 48              > lsla
0ffe : 8010            > suba #16
1000 : 2a02            > bpl l10336
1002 : 8b40            >   adda #VEC_DIRMAX
1004 :                 >l10336:
                        
1004 : 8e4b60               ldx #ShipVectorList
1007 : 3364                 leau LocalBuffer,s            ;Vector buffer
1009 : bdf610               jsr rot_vec_list2             ;Rotate vectors
                        
100c : bdf354               jsr reset0ref                 ;Reset pen
                            mSetIntensity $4f
                       >  if 1=1
100f : 864f            >    lda   #$4f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1011 : 9701            >  sta   <01
1013 : cc0401          >  ldd   #$0401
1016 : 9700            >  sta   <00
1018 : d700            >  stb   <00
                        
                        
101a : ece4                 ldd LocalShip,s               ;load ship screen coords
101c : bdf2fc               jsr move_pen7f_to_d           ;Set pen position to value of d register
                        
                            mTicToc 32
101f : b6c826          >  lda LoopCounterLow
1022 : 841f            >  anda #32-1
1024 : 8110            >  cmpa #32/2
1026 : 2402            >  bcc l10338
1028 : 881f            >  eora #32-1
102a :                 >l10338:
                        
102a : 8b30                 adda #48
                            mSetScale
                       >  if 0=1
                       >    lda #                  ;if argument exists, load into a, otherwise use current a
                       >  endif
102c : 9704            >  sta <$04
                        
                        
                            mSetByte Pattern,%10001000
                       > if 0=%10001000
                       >   clr Pattern
                       > else
102e : 8688            >   lda #%10001000
1030 : b7c829          >   sta Pattern
                       > endif
                        
1033 : 3064                 leax LocalBuffer,s            ;Vector buffer
1035 : 8608                 lda #ShipVectorCount-2        ;Nr of vectors in list
1037 : bd0811               jsr FxMoveDrawPattern
103a :                  sddNoLock:
                        
                        
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
103a : b6c8e5          >    lda GameFlags1
103d : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
103f : 2766               beq sddNoOrb
                            mSetIntensity $4f
                       >  if 1=1
1041 : 864f            >    lda   #$4f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1043 : 9701            >  sta   <01
1045 : cc0401          >  ldd   #$0401
1048 : 9700            >  sta   <00
104a : d700            >  stb   <00
                        
                            mGetScreenX PodX
                       >  if  1 = 0    ;no param, X holds X-coord
                       >    tfr x,y
                       >  endif
                       >  if  1 = 1
104c : 10bec8bf        >    ldy     PodX
                       >  endif
                       >  if  1 = 2   ;as09 treats "2,y" as two separate macro arguments
                       >    ldy     PodX,
                       >  endif
1050 : bec8c6          >  ldx     ViewX
1053 : 1f20            >  tfr     y,d
1055 : af7e            >  stx -2,s
1057 : a37e            >  subd -2,s
1059 : 2c0a            >  bge     L1430343
105b : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
105e : a37e            >  subd -2,s
1060 : 10af7e          >  sty -2,s
1063 : e37e            >  addd -2,s
1065 :                 >L1430343:
                        
1065 : c080                 subb #128
1067 : 3404                 pshs b
1069 : fcc8c1               ldd PodY
106c : b3c8c8               subd ViewY
106f : 50                   negb
1070 : 1f98                 tfr b,a
1072 : 3504                 puls b
1074 : 8b7f                 adda #127
1076 : ed62                 std LocalOrb,s
                        
1078 : bdf354               jsr reset0ref               ;Draw Orb
107b : ec62                 ldd LocalOrb,s
107d : bdf2fc               jsr move_pen7f_to_d
1080 : 8e4b7a               ldx #OrbVectorList
1083 : a680                 lda ,x+
1085 : c614                 ldb #DrawScale
1087 : bdf3b7               jsr move_draw_VL4
                        
108a : bdf354               jsr reset0ref               ;Draw tractor beam
108d : ece4                 ldd LocalShip,s
108f : bdf2fc               jsr move_pen7f_to_d
1092 : ece4                 ldd LocalShip,s
1094 : a062                 suba LocalOrb,s
1096 : 40                   nega
1097 : e063                 subb LocalOrb+1,s
1099 : 50                   negb
109a : ed64                 std LocalBuffer,s
109c : 3064                 leax LocalBuffer,s
                            mSetByte $c829,%10001000    ;use a pattern to draw the beam
                       > if 0=%10001000    
                       >   clr $c829
                       > else
109e : 8688            >   lda #%10001000    
10a0 : b7c829          >   sta $c829
                       > endif
                        
10a3 : 4f                   clra
10a4 : bdf434               jsr dwp_with_count
10a7 :                  sddNoOrb:
                        
                        
                          mTestFlag PullFlag            ;Test if ship is pulling orb from platform
                       >  if 255>PullFlag            
10a7 : b6c8e5          >    lda GameFlags1
10aa : 8508            >    bita #PullFlag            
                       >  else
                       >    lda GameFlags2
                       >    bita #(PullFlag            )>>8
                       >  endif
                        
10ac : 274d               beq sddNoPull
                            mSetIntensity $4f           ;Draw tractor beam from ship to orb-platform
                       >  if 1=1
10ae : 864f            >    lda   #$4f                       ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
10b0 : 9701            >  sta   <01
10b2 : cc0401          >  ldd   #$0401
10b5 : 9700            >  sta   <00
10b7 : d700            >  stb   <00
                        
                        
10b9 : fec8ca               ldu CurLevelEntry
                            mGetScreenX leOrbX,u
                       >  if  2 = 0    ;no param, X holds X-coord
                       >    tfr x,y
                       >  endif
                       >  if  2 = 1
                       >    ldy     leOrbX
                       >  endif
                       >  if  2 = 2   ;as09 treats "2,y" as two separate macro arguments
10bc : 10ae48          >    ldy     leOrbX,u
                       >  endif
10bf : bec8c6          >  ldx     ViewX
10c2 : 1f20            >  tfr     y,d
10c4 : af7e            >  stx -2,s
10c6 : a37e            >  subd -2,s
10c8 : 2c0a            >  bge     L1430347
10ca : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
10cd : a37e            >  subd -2,s
10cf : 10af7e          >  sty -2,s
10d2 : e37e            >  addd -2,s
10d4 :                 >L1430347:
                        
10d4 : c080                 subb #128
10d6 : 3404                 pshs b
10d8 : ec4a                 ldd leOrbY,u
10da : b3c8c8               subd ViewY
10dd : 50                   negb
10de : cb04                 addb #4
10e0 : 1f98                 tfr b,a
10e2 : 3504                 puls b
10e4 : 8b7f                 adda #127
10e6 : ed62                 std LocalPlatform,s
                        
10e8 : bdf354               jsr reset0ref
10eb : ece4                 ldd LocalShip,s
10ed : bdf2fc               jsr move_pen7f_to_d
10f0 : ece4                 ldd LocalShip,s
10f2 : a062                 suba LocalPlatform,s
10f4 : 40                   nega
10f5 : e063                 subb LocalPlatform+1,s
10f7 : 50                   negb
10f8 : bdf3df               jsr draw_to_d
10fb :                  sddNoPull:
                        
10fb :                  sddExit:
                          mFreeLocals
10fb : 32e81e          >  leas FrameSize,s
                        
10fe : 39                 rts
                        
                        
                        
                        ;*****************
10ff :                  Ship_DoMove:                    ;Update centerx/y and alpha
                          direct $c8
                        
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
10ff : 96e5            >    lda GameFlags1
1101 : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
1103 : 272d               beq sdmNoPod
                        
                          ;Alpha += dAlpha, 0..WDIRMAX
                        
                        ;  lda LoopCounterLow
                        ;  anda #SpinFrameMask
                        ;  bne sdmSkipAlpha
                        
1105 : dcb4               ldd AlphaDelta
1107 : 2b0a               bmi sdmNegD
1109 : d3b2               addd Alpha
110b : 81f0               cmpa #ALPHA_MAX
110d : 250e               blo sdmAlphaOk
110f : 80f0                 suba #ALPHA_MAX
1111 : 200a                 bra sdmAlphaOk
1113 :                  sdmNegD:
1113 : dcb2               ldd Alpha
1115 : d3b4               addd AlphaDelta
1117 : 81f0               cmpa #ALPHA_MAX
1119 : 2502               blo sdmAlphaOk
111b : 8bf0                 adda #ALPHA_MAX
111d :                  sdmAlphaOk:
111d : ddb2               std Alpha
                        ;sdmSkipAlpha:
                        
                          ;Alpha damping
                        
111f : 96e4               lda FrameCounter
1121 : 8403               anda #FRAME4MASK
1123 : 260d               bne sdmExitAlphaDamping
1125 : 86ff               lda #-1
1127 : 9eb4               ldx AlphaDelta
1129 : 2707               beq sdmExitAlphaDamping
112b : 2b01               bmi *+3
112d : 40                   nega
112e : 3086               leax a,x
1130 : 9fb4               stx AlphaDelta
1132 :                  sdmExitAlphaDamping:
                        
1132 :                  sdmNoPod:
                        
                          ;SpeedX damping + range test
1132 : dcb7               ldd ShipSpeedX
1134 : 271b               beq sdmNoXDamping
1136 : 1f89               tfr a,b
1138 : 57                 asrb
1139 : 2b03               bmi sdmNegXDamping
113b : 5c                 incb
113c : 2001               bra sdmXDampStore
113e :                  sdmNegXDamping:
113e : 5a                 decb
113f :                  sdmXDampStore:
113f : 50                 negb
1140 : 1d                 sex
1141 : d3b7               addd ShipSpeedX
000c =                  SpeedMax = 12                   ;keep x speed in range
1143 : 810c               cmpa #SpeedMax
1145 : 2d02               blt sdmXHiOk
1147 : 860c                 lda #SpeedMax
1149 :                  sdmXHiOk:
1149 : 81f4               cmpa #-SpeedMax
114b : 2c02               bge sdmXRangeFin
114d : 86f4                 lda #-SpeedMax
114f :                  sdmXRangeFin:
114f : ddb7               std ShipSpeedX
1151 :                  sdmNoXDamping:
                        
                          ;Gravity + range test
1151 : c60e               ldb #Gravity
                          mTestFlag ReverseGravFlag
                       >  if 255>ReverseGravFlag
1153 : 96e5            >    lda GameFlags1
1155 : 8580            >    bita #ReverseGravFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ReverseGravFlag)>>8
                       >  endif
                        
1157 : 2702               beq sdmNormalGrav
1159 : 50                   negb
115a : 57                   asrb ;try smaller gravity in reverse
115b :                  sdmNormalGrav:
115b : 1d                 sex
115c : d3b9               addd ShipSpeedY
115e : 810c               cmpa #SpeedMax                ;keep y speed in range
1160 : 2d02               blt sdmYHiOk
1162 : 860c                 lda #SpeedMax
1164 :                  sdmYHiOk:
1164 : 81f4               cmpa #-SpeedMax
1166 : 2c02               bge sdmYRangeFin
1168 : 86f4                 lda #-SpeedMax
116a :                  sdmYRangeFin:
116a : ddb9               std ShipSpeedY
                        
                          ;Center += ShipSpeed
                        
116c : d6b7               ldb ShipSpeedXHi
116e : 1d                 sex
116f : ed7e               std -2,s
1171 : 8ec8ac             ldx #CenterX
                          mGet_D_from_fixed
1174 : ec84            >  ldd ,x
                       >
1176 : 6802            >  asl 2,x
1178 : 59              >  rolb
1179 : 49              >  rola
                       >
117a : 6802            >  asl 2,x
117c : 59              >  rolb
117d : 49              >  rola
                        
117e : e37e               addd -2,s
                          mStore_D_as_fixed
1180 : 6f02            >  clr 2,x
                       >
1182 : 47              >  asra
1183 : 56              >  rorb
1184 : 6602            >  ror 2,x
                       >
1186 : 47              >  asra
1187 : 56              >  rorb
1188 : 6602            >  ror 2,x
                       >
118a : ed84            >  std ,x
                        
                        
118c : d6b9               ldb ShipSpeedYHi
118e : 1d                 sex
118f : ed7e               std -2,s
1191 : 8ec8af             ldx #CenterY
                          mGet_D_from_fixed
1194 : ec84            >  ldd ,x
                       >
1196 : 6802            >  asl 2,x
1198 : 59              >  rolb
1199 : 49              >  rola
                       >
119a : 6802            >  asl 2,x
119c : 59              >  rolb
119d : 49              >  rola
                        
119e : e37e               addd -2,s
                          mStore_D_as_fixed
11a0 : 6f02            >  clr 2,x
                       >
11a2 : 47              >  asra
11a3 : 56              >  rorb
11a4 : 6602            >  ror 2,x
                       >
11a6 : 47              >  asra
11a7 : 56              >  rorb
11a8 : 6602            >  ror 2,x
                       >
11aa : ed84            >  std ,x
                        
                        
11ac : cec8ac             ldu #CenterX
11af : bd12a6             jsr ValidateX
                        
                          direct -1
11b2 : 39                 rts
                        
                        
                        
                        ;*****************
11b3 :                  Ship_DoThrust:                  ;Adjust speed and spin
                          direct $c8
                          mDecLocals 1,0,0
                       >  nolist
                        
0000 =                  LocalAngle = LocalB1
                        
                          mTestFlag LockedThrustFlag
                       >  if 255>LockedThrustFlag
                       >    lda GameFlags1
                       >    bita #LockedThrustFlag
                       >  else
11b5 : 96e6            >    lda GameFlags2
11b7 : 8504            >    bita #(LockedThrustFlag)>>8
                       >  endif
                        
11b9 : 2604               bne sdtLocked
11bb : 96b6               lda ShipAngle
11bd : 2002               bra sdtStoreAngle
11bf :                  sdtLocked:
11bf : 9668               lda LockedShipAngle
11c1 :                  sdtStoreAngle:
11c1 : a7e4               sta LocalAngle,s
                        
                        ;  lda LocalAngle,s
11c3 : 48                 lsla
11c4 : 8e1498             ldx #AccelTable
11c7 : 3086               leax a,x
                        
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
11c9 : 96e5            >    lda GameFlags1
11cb : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
11cd : 2744               beq sdtNoPod
                        
                          ;ax := AccelLUT[ dir*2 ];
                          ;ay := AccelLUT[ dir*2+1 ];
11cf : e684               ldb ,x
11d1 : 1d                 sex
11d2 : d3b7               addd ShipSpeedX
11d4 : ddb7               std ShipSpeedX
                        
11d6 : e601               ldb 1,x
11d8 : 1d                 sex
11d9 : d3b9               addd ShipSpeedY
11db : ddb9               std ShipSpeedY
                        
                          ;adjust spin
                        ;  lda LoopCounterLow
                        ;  anda #SpinFrameMask
                        ;  bne sdtSkipAlpha
11dd : 96e4               lda FrameCounter
11df : 84c1               anda #FRAME6MASK
11e1 : 262e               bne sdtSkipAlpha
                        
                          ;calc index into spin-table
11e3 : a6e4               lda LocalAngle,s
11e5 : 8e14d8             ldx #ShipAngleToAlpha
11e8 : a686               lda a,x
11ea : 90b2               suba AlphaHi
11ec : 2402               bcc sdtIdxOk
11ee : 8bf0                 adda #ALPHA_MAX
11f0 :                  sdtIdxOk:
                        
                          ;Calc index into sine-table, and decide if value is positive or negative
11f0 : 5f                 clrb
11f1 : 8178               cmpa #ALPHA_MAX/2
11f3 : 2503               blo sdtSinPositive
11f5 : 8078                 suba #ALPHA_MAX/2
11f7 : 5a                   decb
11f8 :                  sdtSinPositive:
                          ;IF W >= 60 then W := 120 - W;
11f8 : 813c               cmpa #ALPHA_MAX/4
11fa : 2504               blo sdtNegSkip
11fc : 88ff                 eora #$FF
11fe : 8b78                 adda #ALPHA_MAX/2
1200 :                  sdtNegSkip:
1200 : 44                 lsra                          ;a = 0..30, b = -1 if value is negative
                        
1201 : 8e14f8             ldx #SpinSinTab
1204 : a686               lda a,x
1206 : 5d                 tstb
1207 : 2701               beq sdtPositive
1209 : 40                   nega
120a :                  sdtPositive:
120a : 1f89               tfr a,b
120c : 1d                 sex
                        
120d : d3b4               addd AlphaDelta
120f : ddb4               std AlphaDelta
1211 :                  sdtSkipAlpha:
                        
1211 : 2012               bra sdtExit
                        
1213 :                  sdtNoPod:
                          ;ax := AccelLUT[ dir*2 ] * 2;
                          ;ay := AccelLUT[ dir*2+1 ] * 2;
1213 : e684               ldb ,x
1215 : 1d                 sex
1216 : 58                 aslb
1217 : 49                 rola
1218 : d3b7               addd ShipSpeedX
121a : ddb7               std ShipSpeedX
                        
121c : e601               ldb 1,x
121e : 1d                 sex
121f : 58                 aslb
1220 : 49                 rola
1221 : d3b9               addd ShipSpeedY
1223 : ddb9               std ShipSpeedY
                        
1225 :                  sdtExit:
                        
                          mFreeLocals
1225 : 3261            >  leas FrameSize,s
                        
                          direct -1
1227 : 39                 rts
                        
                        
                        ;*****************
1228 :                  Ship_UpdateShipPodPos:                  ;refresh ship/pod coords from center-coords
                          ;Must be called after every change to centerx/y to keep ship in sync
ff42 =                  ShipExitY = WorldTopY + 50              ;exit below world top so that warp-out effect is visible
                          direct $c8
                        
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
1228 : 96e5            >    lda GameFlags1
122a : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
122c : 2764               beq uspNoPod
                        
                          ;Update ship and pod
                        
                          ; I := Hi(nAlpha) * 2;
122e : 8e12b8             ldx #DistanceTable
1231 : d6b2               ldb AlphaHi
1233 : 4f                 clra
1234 : 58                 lslb
1235 : 49                 rola
1236 : 308b               leax d,x
                        
                          ; ShipX := PixX + DistanceLUT[ I ];
                          ; ShipY := PixY - DistanceLUT[ I+1 ];
                          ; PodX := PixX - DistanceLUT[ I ];
                          ; PodY := PixY + DistanceLUT[ I+1 ];
1238 : a684               lda ,x
123a : 109eac             ldy CenterX
123d : 31a6               leay a,y
123f : 109fbb             sty ShipX
                        
1242 : 40                 nega
1243 : 109eac             ldy CenterX
1246 : 31a6               leay a,y
1248 : 109fbf             sty PodX
                        
124b : a601               lda 1,x
124d : 109eaf             ldy CenterY
1250 : 31a6               leay a,y
1252 : 108cff42             cmpy #ShipExitY
1256 : 2e02                 bgt uspPodYOk
1258 : 2020                 bra uspExitLevel
125a :                  uspPodYOk:
125a : 109fc1             sty PodY
                        
125d : 40                 nega
125e : 109eaf             ldy CenterY
1261 : 31a6               leay a,y
1263 : 108cff42             cmpy #ShipExitY
1267 : 2e02                 bgt uspShipYOk
1269 : 200f                 bra uspExitLevel
126b :                  uspShipYOk:
126b : 109fbd             sty ShipY
                        
126e : cec8bb             ldu #ShipX
1271 : 8d33               bsr ValidateX
1273 : cec8bf             ldu #PodX
1276 : 8d2e               bsr ValidateX
                        
1278 : 202b               bra uspExit
                        
127a :                  uspExitLevel:                   ;Top of world: end of mission
                          mSetFlag InactiveFlag         ;disable ship movement
                       >  if 255>InactiveFlag         
127a : 8610            >    lda #InactiveFlag         
127c : 9ae5            >    ora GameFlags1
127e : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(InactiveFlag         )>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                          mEmitFx FxTargetShip,FxTypeWarpOut,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
1280 : 8670            >  lda #FxTargetShip | (FxTypeWarpOut<<4)
1282 : bd06bc          >  jsr EmitFx
                        
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
1285 : 96e5            >    lda GameFlags1
1287 : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
1289 : 271a               beq uspExit
                          mEmitFx FxTargetPod,FxTypeWarpOut,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
128b : 8671            >  lda #FxTargetPod | (FxTypeWarpOut<<4)
128d : bd06bc          >  jsr EmitFx
                        
1290 : 2013               bra uspExit
                        
1292 :                  uspNoPod:                       ;update ship only
1292 : dcac               ldd CenterX
1294 : ddbb               std ShipX
1296 : dcaf               ldd CenterY
1298 : 1083ff42           cmpd #ShipExitY
129c : 2fdc               ble uspExitLevel
129e : ddbd               std ShipY
                        
12a0 : cec8bb             ldu #ShipX
12a3 : 8d01               bsr ValidateX
                        
12a5 :                  uspExit:
                        
                          direct -1
12a5 : 39                 rts
                        
                        
                        ;*****************
12a6 :                  ValidateX:                      ;u=pointer to x coord
                          direct $c8
12a6 : ecc4               ldd ,u
12a8 : 4d                 tsta                          ;Check for world ends
12a9 : 2a06               bpl vxCheckRightEdge
12ab : d3cd                 addd CurLevelEndX           ;Left end hit, wrap
                        ;    subd #1
12ad : edc4                 std ,u
12af : 2006                 bra vxXOk
12b1 :                  vxCheckRightEdge:
12b1 : 93cd                 subd CurLevelEndX
12b3 : 2b02                 bmi vxXOk
12b5 : edc4                 std ,u              ;Right edge hit
12b7 :                  vxXOk:
                          direct -1
12b7 : 39                 rts
                        
                        
                        ;Distance from center to ship/pod. Xy-pairs.
                        ;This is the complete circle, we could use 1/4 circle instead to save some bytes
12b8 :                  DistanceTable:
12b8 : 1e001e001d011d..  db 30,0, 30,0, 29,1, 29,1, 29,3, 29,3, 29,4, 29,4, 29,6, 29,6, 28,7, 28,7, 28,9, 28,9, 28,10, 28,10
12d8 : 1b0c1b0c1a0d1a..  db 27,12, 27,12, 26,13, 26,13, 25,15, 25,15, 25,16, 25,16, 24,17, 24,17, 23,18, 23,18, 22,20, 22,20
12f4 : 15151515141614..  db 21,21, 21,21, 20,22, 20,22, 18,23, 18,23, 17,24, 17,24, 16,25, 16,25, 14,25, 14,25, 13,26, 13,26
1310 : 0c1b0c1b0a1c0a..  db 12,27, 12,27, 10,28, 10,28, 9,28, 9,28, 7,28, 7,28, 6,29, 6,29, 4,29, 4,29, 3,29, 3,29, 1,29, 1,29
1330 : 001e001eff1dff..  db 0,30, 0,30, -1,29, -1,29, -3,29, -3,29, -4,29, -4,29, -6,29, -6,29, -7,28, -7,28, -9,28, -9,28
134c : f61cf61cf41bf4..  db -10,28, -10,28, -12,27, -12,27, -13,26, -13,26, -15,25, -15,25, -16,25, -16,25, -17,24, -17,24
1364 : ee17ee17ec16ec..  db -18,23, -18,23, -20,22, -20,22, -21,21, -21,21, -22,20, -22,20, -23,18, -23,18, -24,17, -24,17
137c : e710e710e70ee7..  db -25,16, -25,16, -25,14, -25,14, -26,13, -26,13, -27,12, -27,12, -28,10, -28,10, -28,9, -28,9
1394 : e407e407e306e3..  db -28,7, -28,7, -29,6, -29,6, -29,4, -29,4, -29,3, -29,3, -29,1, -29,1, -30,0, -30,0, -29,-1, -29,-1
13b0 : e3fde3fde3fce3..  db -29,-3, -29,-3, -29,-4, -29,-4, -29,-6, -29,-6, -28,-7, -28,-7, -28,-9, -28,-9, -28,-10, -28,-10
13c8 : e5f4e5f4e6f3e6..  db -27,-12, -27,-12, -26,-13, -26,-13, -25,-15, -25,-15, -25,-16, -25,-16, -24,-17, -24,-17, -23,-18
13de : e9eeeaeceaeceb..  db -23,-18, -22,-20, -22,-20, -21,-21, -21,-21, -20,-22, -20,-22, -18,-23, -18,-23, -17,-24, -17,-24
13f4 : f0e7f0e7f2e7f2..  db -16,-25, -16,-25, -14,-25, -14,-25, -13,-26, -13,-26, -12,-27, -12,-27, -10,-28, -10,-28, -9,-28
140a : f7e4f9e4f9e4fa..  db -9,-28, -7,-28, -7,-28, -6,-29, -6,-29, -4,-29, -4,-29, -3,-29, -3,-29, -1,-29, -1,-29, 0,-30
1422 : 00e201e301e303..  db 0,-30, 1,-29, 1,-29, 3,-29, 3,-29, 4,-29, 4,-29, 6,-29, 6,-29, 7,-28, 7,-28, 9,-28, 9,-28, 10,-28
143e : 0ae40ce50ce50d..  db 10,-28, 12,-27, 12,-27, 13,-26, 13,-26, 15,-25, 15,-25, 16,-25, 16,-25, 17,-24, 17,-24, 18,-23
1456 : 12e914ea14ea15..  db 18,-23, 20,-22, 20,-22, 21,-21, 21,-21, 22,-20, 22,-20, 23,-18, 23,-18, 24,-17, 24,-17, 25,-16
146e : 19f019f219f21a..  db 25,-16, 25,-14, 25,-14, 26,-13, 26,-13, 27,-12, 27,-12, 28,-10, 28,-10, 28,-9, 28,-9, 28,-7, 28,-7
1488 : 1dfa1dfa1dfc1d..  db 29,-6, 29,-6, 29,-4, 29,-4, 29,-3, 29,-3, 29,-1, 29,-1
                        
                        ;Acceleration values xy-pairs for each ship direction
1498 :                  AccelTable:
1498 : 190018fc17f714..  db 25,0, 24,-4, 23,-9, 20,-13, 17,-17, 13,-20, 9,-23, 4,-24, 0,-25, -4,-24
14ac : f7e9f3ecefefec..  db -9,-23, -13,-20, -17,-17, -20,-13, -23,-9, -24,-4, -25,0, -24,4, -23,9
14be : ec0def11f314f7..  db -20,13, -17,17, -13,20, -9,23, -4,24, 0,25, 4,24, 9,23, 13,20, 17,17
14d2 : 140d17091804      db 20,13, 23,9, 24,4
                        
                        ;Map ShipAngle -> AlphaDir
14d8 :                  ShipAngleToAlpha:
14d8 : 00080f171e262d35  db   0,  8, 15, 23, 30, 38, 45, 53
14e0 : 3c444b535a626971  db  60, 68, 75, 83, 90, 98,105,113
14e8 : 7880878f969ea5ad  db 120,128,135,143,150,158,165,173
14f0 : b4bcc3cbd2dae1e9  db 180,188,195,203,210,218,225,233
                        
                        ;Contains sine-values for a quarter of a circle
14f8 :                  SpinSinTab:
14f8 : 000305080a0d0f..  db   0,  3,  5,  8, 10, 13, 15, 18, 20, 23
1502 : 191b1d1f212325..  db  25, 27, 29, 31, 33, 35, 37, 39, 40, 42
150c : 2b2d2e2f303031..  db  43, 45, 46, 47, 48, 48, 49, 49, 50, 50
1516 : 32                db  50
                        
1517 :                  DemoList:
1517 : 151d15e51769       dw DemoData1,DemoData2,DemoData3
                        
                        ;Recorded demo data
                        ;First two bytes: start level, reserved
151d :                  DemoData1:
151d : 0000              db 0,0
151f : 000b100700010c..  db $00, $0b, $10, $07, $00, $01, $0c, $07, $20, $09, $2c, $0c, $0c, $0a, $2c, $03
152f : 20082100000801..  db $20, $08, $21, $00, $00, $08, $01, $00, $00, $05, $10, $00, $00, $00, $01, $00
153f : 00050100000501..  db $00, $05, $01, $00, $00, $05, $01, $00, $00, $03, $01, $00, $00, $00, $10, $0b
154f : 1c150c141c070c..  db $1c, $15, $0c, $14, $1c, $07, $0c, $15, $00, $02, $20, $0c, $0c, $07, $00, $09
155f : 0c05001120022c..  db $0c, $05, $00, $11, $20, $02, $2c, $06, $0c, $00, $00, $09, $10, $06, $00, $08
156f : 20022c040c041c..  db $20, $02, $2c, $04, $0c, $04, $1c, $07, $0c, $01, $00, $0b, $02, $06, $12, $06
157f : 1e020e0502040e..  db $1e, $02, $0e, $05, $02, $04, $0e, $01, $2e, $02, $22, $05, $2e, $03, $0e, $00
158f : 02040e0b020c22..  db $02, $04, $0e, $0b, $02, $0c, $22, $01, $2e, $07, $0e, $0b, $2e, $04, $02, $00
159f : 00062003000b20..  db $00, $06, $20, $03, $00, $0b, $20, $04, $00, $0e, $01, $00, $00, $04, $01, $00
15af : 00060100000110..  db $00, $06, $01, $00, $00, $01, $10, $02, $11, $00, $10, $03, $11, $00, $10, $13
15bf : 1c000c072c0c0c..  db $1c, $00, $0c, $07, $2c, $0c, $0c, $15, $1c, $07, $0c, $01, $00, $04, $10, $0c
15cf : 1c020c030e0b2e..  db $1c, $02, $0c, $03, $0e, $0b, $2e, $0f, $0e, $10, $1e, $05, $0e, $19, $2e, $06
15df : 0e291e010e7d      db $0e, $29, $1e, $01, $0e, $7d
                        
15e5 :                  DemoData2:
15e5 : 0100              db 1,0
15e7 : 000f20072c010c..  db $00, $0f, $20, $07, $2c, $01, $0c, $12, $00, $02, $10, $20, $00, $17, $01, $00
15f7 : 0008200a2c0f0c..  db $00, $08, $20, $0a, $2c, $0f, $0c, $0f, $20, $06, $0c, $07, $1c, $02, $0c, $02
1607 : 000320052c010c..  db $00, $03, $20, $05, $2c, $01, $0c, $06, $00, $09, $10, $19, $00, $04, $0c, $0c
1617 : 000b0c06001920..  db $00, $0b, $0c, $06, $00, $19, $20, $03, $00, $11, $10, $04, $00, $00, $0c, $05
1627 : 000220062c010c..  db $00, $02, $20, $06, $2c, $01, $0c, $12, $2c, $14, $20, $00, $00, $26, $01, $00
1637 : 00060100000610..  db $00, $06, $01, $00, $00, $06, $10, $01, $1c, $0b, $1e, $02, $0e, $0a, $0c, $09
1647 : 1c050c0d2c0820..  db $1c, $05, $0c, $0d, $2c, $08, $20, $03, $00, $01, $01, $00, $00, $06, $01, $00
1657 : 00070100000501..  db $00, $07, $01, $00, $00, $05, $01, $00, $00, $08, $01, $00, $00, $00, $10, $01
1667 : 00040100000b01..  db $00, $04, $01, $00, $00, $0b, $01, $00, $00, $07, $0c, $06, $1c, $0b, $0c, $0f
1677 : 1c061002001220..  db $1c, $06, $10, $02, $00, $12, $20, $07, $00, $12, $20, $07, $00, $02, $0c, $13
1687 : 00270c0b000720..  db $00, $27, $0c, $0b, $00, $07, $20, $0c, $00, $06, $0c, $03, $1c, $0a, $0c, $01
1697 : 00030100000710..  db $00, $03, $01, $00, $00, $07, $10, $0a, $02, $0e, $22, $08, $2e, $01, $0e, $0b
16a7 : 1e0a0e0802050c..  db $1e, $0a, $0e, $08, $02, $05, $0c, $09, $00, $14, $20, $04, $00, $06, $01, $00
16b7 : 000b1002120102..  db $00, $0b, $10, $02, $12, $01, $02, $06, $0e, $02, $2e, $04, $22, $07, $02, $01
16c7 : 0e0a1e0f0e0302..  db $0e, $0a, $1e, $0f, $0e, $03, $02, $02, $00, $10, $10, $03, $00, $0b, $01, $00
16d7 : 00070100000601..  db $00, $07, $01, $00, $00, $06, $01, $00, $00, $06, $01, $00, $00, $06, $2c, $06
16e7 : 0c0c1c040c0600..  db $0c, $0c, $1c, $04, $0c, $06, $00, $06, $20, $03, $00, $07, $01, $00, $00, $06
16f7 : 01000007010000..  db $01, $00, $00, $07, $01, $00, $00, $04, $01, $00, $00, $01, $0c, $04, $2c, $0a
1707 : 0c100000100100..  db $0c, $10, $00, $00, $10, $01, $00, $08, $01, $00, $00, $05, $01, $00, $00, $04
1717 : 01000004010000..  db $01, $00, $00, $04, $01, $00, $00, $08, $01, $00, $00, $07, $01, $00, $00, $06
1727 : 0c052c080c0a1c..  db $0c, $05, $2c, $08, $0c, $0a, $1c, $01, $10, $06, $00, $01, $01, $00, $00, $09
1737 : 0100000e0c052c..  db $01, $00, $00, $0e, $0c, $05, $2c, $00, $20, $07, $00, $00, $02, $08, $12, $06
1747 : 0e350005200d0c..  db $0e, $35, $00, $05, $20, $0d, $0c, $08, $00, $04, $10, $05, $1c, $07, $0c, $0e
1757 : 1c030c132c040c..  db $1c, $03, $0c, $13, $2c, $04, $0c, $19, $1c, $03, $0c, $60, $1c, $03, $0c, $5c
1767 : 0051              db $00, $51
                        
1769 :                  DemoData3:
1769 : 0200              db 2,0
176b : 0006200f2c020c..  db $00, $06, $20, $0f, $2c, $02, $0c, $09, $00, $0d, $10, $1a, $0c, $03, $0e, $07
177b : 2e060e0002020e..  db $2e, $06, $0e, $00, $02, $02, $0e, $18, $02, $05, $0e, $03, $2e, $08, $0e, $0c
178b : 2e012c00200a2c..  db $2e, $01, $2c, $00, $20, $0a, $2c, $00, $0c, $08, $1c, $03, $10, $03, $00, $00
179b : 01000007200f00..  db $01, $00, $00, $07, $20, $0f, $00, $00, $0c, $03, $00, $05, $20, $0d, $00, $03
17ab : 0c1b2c0020142c..  db $0c, $1b, $2c, $00, $20, $14, $2c, $01, $0c, $07, $00, $03, $10, $09, $00, $02
17bb : 0c0f2c030c051c..  db $0c, $0f, $2c, $03, $0c, $05, $1c, $0d, $10, $06, $00, $17, $01, $00, $20, $02
17cb : 00030100000320..  db $00, $03, $01, $00, $00, $03, $20, $06, $2c, $0d, $0e, $09, $0c, $03, $2c, $04
17db : 0c051c0f0c0e00..  db $0c, $05, $1c, $0f, $0c, $0e, $00, $14, $02, $0c, $0e, $08, $12, $04, $02, $02
17eb : 0e0102040e032e..  db $0e, $01, $02, $04, $0e, $03, $2e, $00, $22, $02, $02, $01, $0e, $03, $02, $0d
17fb : 22062e000e072e..  db $22, $06, $2e, $00, $0e, $07, $2e, $0b, $0e, $02, $02, $00, $00, $10, $10, $0b
180b : 000502050e031e..  db $00, $05, $02, $05, $0e, $03, $1e, $02, $12, $03, $1e, $00, $0e, $05, $02, $07
181b : 0e0312051e000e..  db $0e, $03, $12, $05, $1e, $00, $0e, $08, $02, $03, $22, $0c, $2e, $05, $0e, $0f
182b : 2e042008002910..  db $2e, $04, $20, $08, $00, $29, $10, $0b, $00, $00, $02, $03, $0e, $04, $1e, $0c
183b : 0e0b1e01120102..  db $0e, $0b, $1e, $01, $12, $01, $02, $11, $12, $1b, $10, $02, $00, $03, $01, $00
184b : 000510021c111e..  db $00, $05, $10, $02, $1c, $11, $1e, $0b, $1f, $00, $0e, $1c, $2e, $0b, $20, $11
185b : 01000009010000..  db $01, $00, $00, $09, $01, $00, $00, $07, $01, $00, $00, $09, $01, $00, $00, $06
186b : 01000007010000..  db $01, $00, $00, $07, $01, $00, $00, $03, $01, $00, $00, $04, $10, $0a, $1c, $10
187b : 0c121c0010091c..  db $0c, $12, $1c, $00, $10, $09, $1c, $00, $0c, $07, $00, $0a, $20, $06, $2c, $0a
188b : 0c000009200e2c..  db $0c, $00, $00, $09, $20, $0e, $2c, $03, $0c, $14, $00, $17, $10, $0e, $00, $0d
189b : 100400030c1a2c..  db $10, $04, $00, $03, $0c, $1a, $2c, $0c, $0c, $00, $0e, $04, $1e, $06, $0e, $03
18ab : 020912001e030e..  db $02, $09, $12, $00, $1e, $03, $0e, $02, $02, $08, $0e, $01, $02, $04, $12, $03
18bb : 02020e0302060e..  db $02, $02, $0e, $03, $02, $06, $0e, $0d, $1e, $08, $0e, $04, $0c, $02, $00, $04
18cb : 01000004200221..  db $01, $00, $00, $04, $20, $02, $21, $00, $00, $07, $01, $00, $00, $05, $01, $00
18db : 00060100000601..  db $00, $06, $01, $00, $00, $06, $01, $00, $00, $03, $01, $00, $00, $03, $01, $00
18eb : 00060100000401..  db $00, $06, $01, $00, $00, $04, $01, $00, $00, $05, $01, $00, $00, $05, $01, $00
18fb : 00070100000320..  db $00, $07, $01, $00, $00, $03, $20, $04, $2c, $08, $0e, $14, $02, $03, $00, $01
190b : 10070000020422..  db $10, $07, $00, $00, $02, $04, $22, $11, $02, $04, $12, $0c, $02, $04, $22, $01
191b : 0200000920092c..  db $02, $00, $00, $09, $20, $09, $2c, $01, $0c, $05, $2c, $00, $20, $0e, $00, $13
192b : 01000006010000..  db $01, $00, $00, $06, $01, $00, $00, $04, $10, $10, $1c, $09, $1e, $07, $0e, $0c
193b : 1e030e04020000..  db $1e, $03, $0e, $04, $02, $00, $00, $21, $01, $00, $00, $02, $2c, $07, $0c, $0e
194b : 0d00000c010000..  db $0d, $00, $00, $0c, $01, $00, $00, $06, $10, $02, $11, $00, $10, $00, $00, $05
195b : 01000006010000..  db $01, $00, $00, $06, $01, $00, $00, $0a, $20, $11, $00, $12, $10, $0a, $00, $09
196b : 0c160008200502..  db $0c, $16, $00, $08, $20, $05, $02, $03, $0e, $20, $02, $0c, $00, $09, $10, $0a
197b : 1c000c07000620..  db $1c, $00, $0c, $07, $00, $06, $20, $05, $22, $00, $02, $05, $0e, $1c, $2e, $02
198b : 0e171e040e080c..  db $0e, $17, $1e, $04, $0e, $08, $0c, $1b, $2c, $05, $0c, $0f, $2c, $04, $0c, $03
199b : 1c0e001a010000..  db $1c, $0e, $00, $1a, $01, $00, $00, $07, $01, $00, $00, $07, $01, $00, $00, $07
19ab : 0100000420082c..  db $01, $00, $00, $04, $20, $08, $2c, $04, $0c, $29, $1c, $03, $0c, $18, $00, $07
19bb : 020400050c0700..  db $02, $04, $00, $05, $0c, $07, $00, $01, $10, $04, $00, $09, $10, $08, $1c, $00
19cb : 0c0a00080c132c..  db $0c, $0a, $00, $08, $0c, $13, $2c, $07, $0c, $18, $2c, $05, $0c, $0f, $2c, $03
19db : 0c0b0002200900..  db $0c, $0b, $00, $02, $20, $09, $00, $05, $0c, $08, $1c, $0b, $0c, $05, $00, $0f
19eb : 0c021c06100500..  db $0c, $02, $1c, $06, $10, $05, $00, $07, $0c, $19, $2c, $06, $0c, $1d, $2c, $03
19fb : 0c0d1c010c352c..  db $0c, $0d, $1c, $01, $0c, $35, $2c, $04, $0c, $14, $1c, $03, $0c, $0e, $1c, $04
1a0b : 0cd5001b          db $0c, $d5, $00, $1b
                        
                        
                        ;*****************
1a0f :                  UpdateFrameCounter:
                          direct $c8
1a0f : 96e4               lda FrameCounter
1a11 : 2a02               bpl ufcOkCnt3
1a13 : 8a40                 ora #$40
1a15 :                  ufcOkCnt3:
1a15 : 8b40               adda #$40
1a17 : 97e4               sta FrameCounter
                        
1a19 : 843f               anda #$3f
1a1b : 2604               bne ufcOkCnt64
1a1d : 863f                 lda #$3f
1a1f : 2002                 bra ufcDoAdd
1a21 :                  ufcOkCnt64:
1a21 : 86ff               lda #$ff
1a23 :                  ufcDoAdd:
1a23 : 9be4               adda FrameCounter
1a25 : 97e4               sta FrameCounter
                        
                         if false
                            ;Atari 2600 code
                            lda     FrameCnt            ; 3
                            sta     FrameCnt1
                            bpl     .okCnt3             ; 2³
                            ora     #$40                ; 2         reset Cnt3
                        .okCnt3:
                            clc                         ; 2
                            adc     #$40                ; 2         increase Cnt3
                            sta     FrameCnt            ; 3
                        
                            and     #$3f                ; 2
                            bne     .okCnt64            ; 2³
                            lda     #$3f                ; 2         reset Cnt64
                            BIT_W                       ; 2
                        .okCnt64:
                            lda     #$ff                ; 2         increase Cnt64
                            clc                         ; 2
                            adc     FrameCnt            ; 3
                            sta     FrameCnt            ; 3 = 28-32
                          endif
                        
                          direct -1
1a27 : 39                 rts
                        
                        
                        ;*****************
1a28 :                  DrawDisplay:            ;Draw status panel. Copy to buffer and print as a single string.
1a28 : b6c8da             lda DemoMode          ;no display in demomode
1a2b : 2a01               bpl ddGoOn
1a2d : 39                   rts
1a2e :                  ddGoOn:
                          mDecLocals 0,0,20
                       >  nolist
                        
                        
1a31 : 33e4               leau LocalBuffer,s
                        
1a33 : b6c87a             lda GameMode
1a36 : 8102               cmpa #TimeAttackGame
1a38 : 2632               bne ddNoTimeAttack
                        
1a3a : cc5449             ldd #'TI'
1a3d : edc1               std ,u++
1a3f : cc4d45             ldd #'ME'
1a42 : edc1               std ,u++
1a44 : cc3a20             ldd #': '
1a47 : edc1               std ,u++
1a49 : f6c8e3             ldb TimeAttackTime    ;time, flash if low
1a4c : c10a               cmpb #10
1a4e : 2c10               bge ddDoTime
1a50 : b6c826             lda LoopCounterLow
1a53 : 8408               anda #8
1a55 : 2609               bne ddDoTime
1a57 : cc2020             ldd #'  '
1a5a : edc4               std ,u
1a5c : ed42               std 2,u
1a5e : 2006               bra ddTimeFin
1a60 :                  ddDoTime:
1a60 : 4f                 clra
1a61 : 1f01               tfr d,x
1a63 : bd4de9             jsr Text_ConvertX
1a66 :                  ddTimeFin:
1a66 : c680               ldb #$80              ;end byte
1a68 : e744               stb 4,u
1a6a : 2042               bra ddDoDraw
                        
1a6c :                  ddNoTimeAttack:         ;normal game
1a6c : 8ec8da             ldx #PlayerScore      ;copy score to buffer
1a6f : c620               ldb #' '
1a71 : 8d48               bsr CopyScoreFromXtoU
                        
1a73 : 3347               leau 7,u              ;Nr of ships left
1a75 : e7c4               stb ,u
1a77 : b6c8e0             lda ShipLives
1a7a : 8b30               adda #'0'
1a7c : ed41               std 1,u
                        
1a7e : 3343               leau 3,u              ;Fuel, flash if low
1a80 : b6c87a             lda GameMode
1a83 : 8103               cmpa #BonusGame
1a85 : 2608               bne ddNotBonus
                            ;In bonusgame, draw current level instead of fuel
1a87 : f6c8d1               ldb CurLevel
1a8a : 4f                   clra
1a8b : 1f01                 tfr d,x
1a8d : 2018                 bra ddDrawFuel
1a8f :                  ddNotBonus
1a8f : bec8e1             ldx ShipFuel
1a92 : 8c012c             cmpx #300
1a95 : 2c10               bge ddDrawFuel
1a97 : b6c826             lda LoopCounterLow
1a9a : 8408               anda #8
1a9c : 2609               bne ddDrawFuel
1a9e :                  ddSkipFuel:
1a9e : cc2020             ldd #'  '
1aa1 : edc4               std ,u
1aa3 : ed42               std 2,u
1aa5 : 2003               bra ddFuelFin
1aa7 :                  ddDrawFuel:
1aa7 : bd4de9             jsr Text_ConvertX
1aaa :                  ddFuelFin:
1aaa : c680               ldb #$80              ;End byte
1aac : e744               stb 4,u
                        
1aae :                  ddDoDraw:
1aae : 8672               lda #114
1ab0 : c6b3               ldb #-127 + 50
1ab2 : 30e4               leax LocalBuffer,s
1ab4 : bd4cba             jsr Text_Print
                        
                          mFreeLocals
1ab7 : 32e814          >  leas FrameSize,s
                        
1aba : 39                 rts
                        
1abb :                  CopyScoreFromXtoU:      ;u=destination buffer, b=end byte
1abb : e77f               stb -1,s
1abd : ec84               ldd ,x
1abf : edc4               std ,u
1ac1 : ec02               ldd 2,x
1ac3 : ed42               std 2,u
1ac5 : ec04               ldd 4,x
1ac7 : ed44               std 4,u
1ac9 : 8630               lda #$30            ;extra zero + end byte
1acb : e67f               ldb -1,s
1acd : ed46               std 6,u
1acf : 39                 rts
                        
                        ;*****************
1ad0 :                  GiveScoreA:
0009 =                  MAX_LIVES = 9
1ad0 : f6c8da             ldb DemoMode          ;no score in demomode
1ad3 : 2a01               bpl gsaGoOn
1ad5 : 39                   rts
1ad6 :                  gsaGoOn:
1ad6 : 3450               pshs x,u
1ad8 : 8ec8da             ldx #PlayerScore
1adb : 10ae02             ldy 2,x
1ade : bdf85e             jsr convert_a_to_bcd_and_add
1ae1 : 1f20               tfr y,d
1ae3 : a102               cmpa 2,x              ;extra life each 10000 points
1ae5 : 271c               beq gsaExit
1ae7 : b6c87a               lda GameMode
1aea : 8101                 cmpa #HardGame      ;every 20000 for hard mode
1aec : 2606                 bne gsaExtra
1aee : a602                   lda 2,x
1af0 : 8401                   anda #1
1af2 : 260f                   bne gsaExit
1af4 :                  gsaExtra:
1af4 : b6c8e0               lda ShipLives
1af7 : 8109                 cmpa #MAX_LIVES
1af9 : 2708                 beq gsaExit
1afb : 7cc8e0               inc ShipLives
                            mEmitSound ExtraLifeSoundId
                       >  if 1=1
1afe : 8610            >    lda #ExtraLifeSoundId
                       >  endif
1b00 : bd0477          >  jsr EmitSound
                        
1b03 :                  gsaExit:
1b03 : 3550               puls x,u
1b05 : 39                 rts
                        
                        
                        
                        
                        
                        ;*****************
1b06 :                  AdjustFuel:                     ;Update ship fuel amount
                          direct $c8
                          mDecLocals 1,0,0
                       >  nolist
                        
                        
1b08 : 96e4               lda FrameCounter
1b0a : 84c0               anda #FRAME3MASK
1b0c : 2635               bne afExit
                        
1b0e : 0d6a               tst CheatLives
1b10 : 2631               bne afExit
                        
                          mTestFlag InactiveFlag
                       >  if 255>InactiveFlag
1b12 : 96e5            >    lda GameFlags1
1b14 : 8510            >    bita #InactiveFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(InactiveFlag)>>8
                       >  endif
                        
1b16 : 262b               bne afExit
                        
                          ;if refueling, inc 1
                          ;else
                          ;  if shield -1
                          ;  if thrust -1 (if hasorb extra -1)
                        
1b18 : 6fe4               clr LocalB1,s
                        
                          mTestFlag RefuelFlag
                       >  if 255>RefuelFlag
1b1a : 96e5            >    lda GameFlags1
1b1c : 8502            >    bita #RefuelFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(RefuelFlag)>>8
                       >  endif
                        
1b1e : 2612               bne afRefueling
                        
                          mTestFlag ThrustFlag
                       >  if 255>ThrustFlag
1b20 : 96e5            >    lda GameFlags1
1b22 : 8520            >    bita #ThrustFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ThrustFlag)>>8
                       >  endif
                        
1b24 : 2702               beq afTestShield
1b26 : 6ae4                 dec LocalB1,s
                        ;    mTestFlag HasOrbFlag
                        ;    beq afTestShield
                        ;      dec LocalB1,s
1b28 :                  afTestShield:
                          mTestFlag ShieldFlag
                       >  if 255>ShieldFlag
1b28 : 96e5            >    lda GameFlags1
1b2a : 8501            >    bita #ShieldFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ShieldFlag)>>8
                       >  endif
                        
1b2c : 2708               beq afStore
1b2e : 6ae4                 dec LocalB1,s
1b30 : 2004                 bra afStore
                        
1b32 :                  afRefueling:
1b32 : 8610               lda #16
1b34 : a7e4               sta LocalB1,s
                        
1b36 :                  afStore:
1b36 : e6e4               ldb LocalB1,s
1b38 : 2709               beq afExit
1b3a : 1d                 sex
1b3b : d3e1               addd ShipFuel
1b3d : 2a02               bpl afOk
1b3f : 4f                   clra
1b40 : 5f                   clrb
1b41 :                  afOk:
1b41 : dde1               std ShipFuel
1b43 :                  afExit:
                        
                          mFreeLocals
1b43 : 3261            >  leas FrameSize,s
                        
                          direct -1
1b45 : 39                 rts
                        
                        
                        ;*****************              ;See if it's time to emit a new gun shot.
                        ;List of center angle for each gun type
                        ;NE,NW,SE,SW
1b46 : f808e818         GunShotAngles: db -8,8,-24,24
                        
1b4a :                  UpdateGuns:
                          mDecLocals 2,2
                       >  nolist
                        
0001 =                  LocalAngle = LocalB2
0004 =                  LocalGun = LocalW2
0078 =                  MaxGunDistance = 120            ;Minimum distance from firing gun to ship
                          direct $c8
                        
1b4c : 96f7               lda GunShotTimer              ;Check delay timer
1b4e : 2706               beq ugTimeOk
1b50 : 4a                   deca
1b51 : 97f7                 sta GunShotTimer
1b53 : 7e1c27               lbra ugFin
                        
1b56 :                  ugTimeOk:
1b56 : 96f6               lda GunShotActive             ;Exit if no empty slot
1b58 : 8107               cmpa #GunShotAllActive
1b5a : 102700c9           lbeq ugFin
                        
1b5e : 0df4               tst PowerShot                 ;Exit if guns are disabled (powerplant recently shot)
1b60 : 102600c3           lbne ugFin
                        
1b64 : deca               ldu CurLevelEntry             ;Find a gun that can fire
1b66 : ee44               ldu leGuns,u
1b68 : 102700bb           lbeq ugFin                    ;exit if no guns
1b6c : e6c0               ldb ,u+                       ;load guncount
1b6e : e7e4               stb LocalB1,s
1b70 : dce7               ldd GunsActive
1b72 :                  ugGunLoop:
1b72 : 47                 asra
1b73 : 56                 rorb
1b74 : 242f               bcc ugGunNotActive
1b76 : ed62               std LocalW1,s
                        
1b78 : ecc4               ldd geGunX,u
1b7a : 93bb               subd ShipX
                          mTestRangeD -MaxGunDistance,MaxGunDistance,ugNextGun
1b7c : 1083ff88        >  cmpd #-MaxGunDistance
1b80 : 2d21            >  blt ugNextGun
1b82 : 10830078        >  cmpd #MaxGunDistance
1b86 : 2e1b            >  bgt ugNextGun
                        
                        
1b88 : ec42               ldd geGunY,u
1b8a : 93bd               subd ShipY
                          mTestRangeD -MaxGunDistance,MaxGunDistance,ugNextGun
1b8c : 1083ff88        >  cmpd #-MaxGunDistance
1b90 : 2d11            >  blt ugNextGun
1b92 : 10830078        >  cmpd #MaxGunDistance
1b96 : 2e0b            >  bgt ugNextGun
                        
                        
                          ;Gun can shoot, throw a dice to see if choose this gun
                          ;Otherwise the first closest gun would always fire
                          mRandomToA
1b98 : bdf511          >  jsr random                    ;call rom
                        
1b9b : 8403               anda #3
1b9d : 2604               bne ugNextGun
                        
1b9f : ef64               stu LocalGun,s
1ba1 : 200b               bra ugGunFound
                        
1ba3 :                  ugNextGun:
1ba3 : ec62               ldd LocalW1,s
1ba5 :                  ugGunNotActive:
1ba5 : 3345               leau GunEntry,u
1ba7 : 6ae4               dec LocalB1,s
1ba9 : 26c7               bne ugGunLoop
1bab : 207a12             jmp ugFin                     ;No gun was found, exit
1bae :                  ugGunFound:
                        
1bae : 8600               lda #0                        ;Find a free gunshot-slot
1bb0 : d6f6               ldb GunShotActive
1bb2 : cec8fb             ldu #GunShots
1bb5 :                  ugLoop:
1bb5 : 57                 asrb                          ;test active
1bb6 : 2568               bcs ugAlreadyActive
1bb8 : ed62               std LocalW1,s
                        
1bba : ae64               ldx LocalGun,s                ;Slot found, emit shot
1bbc : ec84               ldd geGunX,x
1bbe : edc4               std gsShotX,u
1bc0 : ec02               ldd geGunY,x
1bc2 : ed43               std gsShotY,u
                        
1bc4 : a604               lda geGunSprite,x
1bc6 : 8e1b46             ldx #GunShotAngles
1bc9 : e686               ldb a,x
                        
                          ;16 is 90 deg
                        
                          ;gun can shoot in 135 deg (0..23)
                          ;repeat until we have a random value 0..23
1bcb : 8e0000             ldx #0
1bce :                  ugRndAngle:
1bce : 3001               leax 1,x
1bd0 : 8c0005             cmpx #5                       ;bailout after 5 iterations
1bd3 : 2604               bne ugRndAngle1
1bd5 : 860c                 lda #12
1bd7 : 200b                 bra ugRndAngle2
1bd9 :                  ugRndAngle1:
                          mRandomToA
1bd9 : bdf511          >  jsr random                    ;call rom
                        
                          ;improve randomness by xoring loopcounter
1bdc : 9826               eora LoopCounterLow
1bde : 841f               anda #31
1be0 : 8117               cmpa #23
1be2 : 22ea               bhi ugRndAngle
1be4 :                  ugRndAngle2:
1be4 : 800c               suba #12                      ;a is -12..11
                        
1be6 : a77f               sta -1,s
1be8 : eb7f               addb -1,s                     ;final angle is gun center + random
1bea : e761               stb LocalAngle,s
                        
1bec : e661               ldb LocalAngle,s              ;Calc rise & run
1bee : 96fa               lda GunShotSpeed              ;scale
                        
1bf0 : bdf601             jsr convert_angle_to_rise_run ;dp must be c8
1bf3 : 40                 nega                          ;Y axis points down in our world
1bf4 : a747               sta gsShotVelocY,u
1bf6 : e746               stb gsShotVelocX,u
                        
1bf8 : a662               lda LocalW1,s                 ;Set shot active
                          mSetBitA GunShotActive
1bfa : c601            >  ldb #1
1bfc :                 >lop0426:
1bfc : 4a              >  deca
1bfd : 2b03            >  bmi fin0426
1bff : 59              >  rolb
1c00 : 20fa            >  bra lop0426
1c02 :                 >fin0426:
1c02 : daf6            >  orb GunShotActive
1c04 : d7f6            >  stb GunShotActive
                        
                        
                          mRandomToA                    ;Reset delay for next shot
1c06 : bdf511          >  jsr random                    ;call rom
                        
1c09 : 94f8               anda GunShotMask
1c0b : 9bf9               adda GunShotDelay
1c0d : 97f7               sta GunShotTimer
                        
                          ;mEmitSound GunFireSoundId
1c0f : deca               ldu CurLevelEntry             ;Get index of firing gun, use for fx
1c11 : ee44               ldu leGuns,u
1c13 : e6c4               ldb ,u
1c15 : e0e4               subb LocalB1,s
                          mEmitFx FxTargetGun,FxTypeGunFire,b
                       >  if ('b'!='0') && ('b'!='b')
                       >    tfr b,b
                       >  endif
1c17 : 86a2            >  lda #FxTargetGun | (FxTypeGunFire<<4)
1c19 : bd06bc          >  jsr EmitFx
                        
                        
1c1c : 2009               bra ugFin                     ;Exit
                        
1c1e :                  ugNext:
1c1e : ec62               ldd LocalW1,s
1c20 :                  ugAlreadyActive:
1c20 : 3348               leau GunShotEntry,u
1c22 : 4c                 inca
1c23 : 8103               cmpa #MaxGunShots
1c25 : 268e               bne ugLoop
                        
1c27 :                  ugFin:
                          direct -1
                          mFreeLocals
1c27 : 3266            >  leas FrameSize,s
                        
1c29 : 39                 rts
                        
                        
                        ;*****************              ;Update active gun shots.
1c2a :                  UpdateGunShots
                          mDecLocals 0,1
                       >  nolist
                        
                          direct $c8
                        
1c2c : 8600               lda #0                        ;loop from 0 to MaxGunShots
1c2e : d6f6               ldb GunShotActive
1c30 : cec8fb             ldu #GunShots
1c33 :                  gsMoveLoop:
1c33 : 57                 asrb                          ;test active
1c34 : 10240148           lbcc gsNotActive
1c38 : ede4               std LocalW1,s
                        
                          ;Move
                          mUpdateXCoord gsShotX, gsShotVelocX
1c3a : 30c4            >  leax gsShotX,u               ;Update sprite X coordinate
                       >  mGet_D_from_fixed
1c3c : ec84            >  ldd ,x
                       >
1c3e : 6802            >  asl 2,x
1c40 : 59              >  rolb
1c41 : 49              >  rola
                       >
1c42 : 6802            >  asl 2,x
1c44 : 59              >  rolb
1c45 : 49              >  rola
                       >
1c46 : ed7e            >  std -2,s
1c48 : e646            >  ldb  gsShotVelocX,u
1c4a : 1d              >  sex
1c4b : e37e            >  addd -2,s
                       >  mStore_D_as_fixed
1c4d : 6f02            >  clr 2,x
                       >
1c4f : 47              >  asra
1c50 : 56              >  rorb
1c51 : 6602            >  ror 2,x
                       >
1c53 : 47              >  asra
1c54 : 56              >  rorb
1c55 : 6602            >  ror 2,x
                       >
1c57 : ed84            >  std ,x
                       >
1c59 : 4d              >  tsta                          ;Check for world ends
1c5a : 2a06            >  bpl CheckRightEdge0443
1c5c : d3cd            >    addd CurLevelEndX           ;Left end hit, wrap
1c5e : edc4            >    std gsShotX,u
1c60 : 2006            >    bra XOk0443
1c62 :                 >CheckRightEdge0443:
1c62 : 93cd            >    subd CurLevelEndX
1c64 : 2b02            >    bmi XOk0443
1c66 : edc4            >    std gsShotX,u              ;Right edge hit
1c68 :                 >XOk0443:
                        
                          mUpdateYCoord gsShotY, gsShotVelocY, gsRemoveShot
1c68 : 3043            >  leax gsShotY,u               ;Update sprite Y coordinate
                       >  mGet_D_from_fixed
1c6a : ec84            >  ldd ,x
                       >
1c6c : 6802            >  asl 2,x
1c6e : 59              >  rolb
1c6f : 49              >  rola
                       >
1c70 : 6802            >  asl 2,x
1c72 : 59              >  rolb
1c73 : 49              >  rola
                       >
1c74 : ed7e            >  std -2,s
1c76 : e647            >  ldb  gsShotVelocY,u
1c78 : 1d              >  sex
1c79 : e37e            >  addd -2,s
1c7b : 1083fc40        >  cmpd #WorldTopY << Fixed
1c7f : 2e03            >  bgt NotHitTopOfWorld0446
1c81 : 7e1d70          >    lbra  gsRemoveShot            ;Top of world hit, bransch to remove
1c84 :                 >NotHitTopOfWorld0446:
                       >  mStore_D_as_fixed
1c84 : 6f02            >  clr 2,x
                       >
1c86 : 47              >  asra
1c87 : 56              >  rorb
1c88 : 6602            >  ror 2,x
                       >
1c8a : 47              >  asra
1c8b : 56              >  rorb
1c8c : 6602            >  ror 2,x
                       >
1c8e : ed84            >  std ,x
                       >
                        
                        
                          mTestFlag HomingGunShotsFlag
                       >  if 255>HomingGunShotsFlag
                       >    lda GameFlags1
                       >    bita #HomingGunShotsFlag
                       >  else
1c90 : 96e6            >    lda GameFlags2
1c92 : 8502            >    bita #(HomingGunShotsFlag)>>8
                       >  endif
                        
1c94 : 2746               beq gsNoHoming
                          ;Try to make the homing missiles move unpredictably
                          ;Skip homingness a while each second to avoid them constantly circling ship
1c96 : 9626               lda LoopCounterLow
1c98 : 8120               cmpa #32
1c9a : 2540               blo gsNoHoming
1c9c : 8401               anda #1
1c9e : 273c               beq gsNoHoming
1ca0 : a6e4               lda LocalW1,s
1ca2 : 8401               anda #1
1ca4 : 2636               bne gsNoHoming
000c =                  ShotVelocXMax=12
1ca6 : dcbb               ldd ShipX
1ca8 : 10a3c4             cmpd gsShotX,u
1cab : 250b               blo gsHomeXDec
1cad : a646                 lda gsShotVelocX,u
1caf : 810c                 cmpa #ShotVelocXMax
1cb1 : 2c0e                 bge gsHomeXFin
1cb3 : 4c                   inca
1cb4 : a746                 sta gsShotVelocX,u
                        ;    inc gsShotVelocX,u
1cb6 : 2009                 bra gsHomeXFin
1cb8 :                  gsHomeXDec:
1cb8 : a646                 lda gsShotVelocX,u
1cba : 81f4                 cmpa #-ShotVelocXMax
1cbc : 2f03                 ble gsHomeXFin
1cbe : 4a                   deca
1cbf : a746                 sta gsShotVelocX,u
                        ;    dec gsShotVelocX,u
1cc1 :                  gsHomeXFin
                        
000c =                  ShotVelocYMax=12
1cc1 : dcbd               ldd ShipY
1cc3 : 10a343             cmpd gsShotY,u
1cc6 : 250b               blo gsHomeYDec
1cc8 : a647                 lda gsShotVelocY,u
1cca : 810c                 cmpa #ShotVelocYMax
1ccc : 2c0e                 bge gsHomeYFin
1cce : 4c                   inca
1ccf : a747                 sta gsShotVelocY,u
1cd1 : 2009                 bra gsHomeYFin
1cd3 :                  gsHomeYDec:
1cd3 : a647                 lda gsShotVelocY,u
1cd5 : 81f4                 cmpa #-ShotVelocYMax
1cd7 : 2f03                 ble gsHomeYFin
1cd9 : 4a                   deca
1cda : a747                 sta gsShotVelocY,u
1cdc :                  gsHomeYFin
                        
1cdc :                  gsNoHoming:
                        
1cdc : 108ec8bb           ldy #ShipX                    ;Collision gunshots vs ship
                          mPointVsArea ShipArea,gsShipOk, gsShotX,gsShotY, 0,2
1ce0 : aec4            >  ldx      gsShotX,u
1ce2 : eca4            >  ldd      0,y
1ce4 : 830004          >  subd    #ShipArea/2
1ce7 : ed7e            >  std -2,s
1ce9 : ac7e            >  cmpx -2,s
1ceb : 102d0030        >  lblt    gsShipOk
1cef : c30008          >  addd    #ShipArea
1cf2 : ed7e            >  std -2,s
1cf4 : ac7e            >  cmpx -2,s
1cf6 : 102e0025        >  lbgt    gsShipOk
1cfa : ae43            >  ldx     gsShotY,u
1cfc : ec22            >  ldd     2,y
1cfe : 830004          >  subd    #ShipArea/2
1d01 : ed7e            >  std -2,s
1d03 : ac7e            >  cmpx -2,s
1d05 : 102d0016        >  lblt    gsShipOk
1d09 : c30008          >  addd    #ShipArea
1d0c : ed7e            >  std -2,s
1d0e : ac7e            >  cmpx -2,s
1d10 : 102e000b        >  lbgt    gsShipOk
                        
                            mTestFlag ShieldFlag        ;if shield, just remove shot
                       >  if 255>ShieldFlag        
1d14 : 96e5            >    lda GameFlags1
1d16 : 8501            >    bita #ShieldFlag        
                       >  else
                       >    lda GameFlags2
                       >    bita #(ShieldFlag        )>>8
                       >  endif
                        
1d18 : 2603                 bne gsShipSkipExplode
1d1a : bd2af8                 jsr ExplodeShip
1d1d :                  gsShipSkipExplode:
1d1d : 2051                 bra gsRemoveShot
1d1f :                  gsShipOk:
                        
                          mTestFlag HasOrbFlag          ;Collision gunshots vs pod
                       >  if 255>HasOrbFlag          
1d1f : 96e5            >    lda GameFlags1
1d21 : 8504            >    bita #HasOrbFlag          
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag          )>>8
                       >  endif
                        
1d23 : 273d               beq gsPodOk
1d25 : 108ec8bf             ldy #PodX
                            mPointVsArea PodArea,gsPodOk, gsShotX,gsShotY, 0,2
1d29 : aec4            >  ldx      gsShotX,u
1d2b : eca4            >  ldd      0,y
1d2d : 830003          >  subd    #PodArea/2
1d30 : ed7e            >  std -2,s
1d32 : ac7e            >  cmpx -2,s
1d34 : 102d002a        >  lblt    gsPodOk
1d38 : c30006          >  addd    #PodArea
1d3b : ed7e            >  std -2,s
1d3d : ac7e            >  cmpx -2,s
1d3f : 102e001f        >  lbgt    gsPodOk
1d43 : ae43            >  ldx     gsShotY,u
1d45 : ec22            >  ldd     2,y
1d47 : 830003          >  subd    #PodArea/2
1d4a : ed7e            >  std -2,s
1d4c : ac7e            >  cmpx -2,s
1d4e : 102d0010        >  lblt    gsPodOk
1d52 : c30006          >  addd    #PodArea
1d55 : ed7e            >  std -2,s
1d57 : ac7e            >  cmpx -2,s
1d59 : 102e0005        >  lbgt    gsPodOk
                        
1d5d : bd2af8                 jsr ExplodeShip
1d60 : 200e                   bra gsRemoveShot
1d62 :                  gsPodOk:
                        
1d62 : 10ae43             ldy gsShotY,u                 ;Collision shots vs level
1d65 : aec4               ldx gsShotX,u
1d67 : bd2d93             jsr PointVsLevel
1d6a : 2402               bcc gsNoHit
1d6c : 2002                 bra gsRemoveShot
1d6e :                  gsNoHit:
                        
1d6e : 200e               bra gsMoveNext
1d70 :                  gsRemoveShot:
1d70 : a6e4               lda LocalW1,s                 ;a is current loop index, clear this bit to remove shot
                          mClearBitA GunShotActive
1d72 : c6ff            >  ldb #255                    ;start with all bits set
1d74 : 1cfe            >  andcc #$fe                  ;clear carry flag, rolb will shift it into b
1d76 :                 >lop0454:                          ;rotate a zero into b
1d76 : 59              >  rolb
1d77 : 4a              >  deca
1d78 : 2afc            >  bpl lop0454
1d7a : d4f6            >  andb GunShotActive                   ;b now has a hole in it, AND with GunShotActive to clear bit
1d7c : d7f6            >  stb GunShotActive
                        
                        
1d7e :                  gsMoveNext:
1d7e : ece4               ldd LocalW1,s
1d80 :                  gsNotActive:
1d80 : 3348               leau GunShotEntry,u
1d82 : 4c                 inca
1d83 : 8103               cmpa #MaxGunShots
1d85 : 1026feaa           bne gsMoveLoop
                        
                          direct -1
                          mFreeLocals
1d89 : 3262            >  leas FrameSize,s
                        
1d8b : 39                 rts
                        
                        
                        
                        ;*****************
1d8c :                  DrawGunShots:
                          ;DP must be D0
                          mDecLocals 0,2,4
                       >  nolist
                        
                        
                          mSetScale $7f                 ;Scale $7f is required for move_pen_d to reach whole screen
                       >  if 1=1
1d8e : 867f            >    lda #$7f                                   ;if argument exists, load into a, otherwise use current a
                       >  endif
1d90 : 9704            >  sta <$04
                        
                        
1d92 : 8ec8fb             ldx #GunShots                 ;Draw all active shots.
1d95 : 8603               lda #MaxGunShots
1d97 : f6c8f6             ldb GunShotActive
1d9a :                  dgsLoop:
1d9a : 57                 asrb                          ;test active
1d9b : 2456               bcc dgsNotActive
1d9d : ede4               std LocalW1,s
                        
                          mTestFlag HomingGunShotsFlag
                       >  if 255>HomingGunShotsFlag
                       >    lda GameFlags1
                       >    bita #HomingGunShotsFlag
                       >  else
1d9f : b6c8e6          >    lda GameFlags2
1da2 : 8502            >    bita #(HomingGunShotsFlag)>>8
                       >  endif
                        
1da4 : 2615               bne dgsHoming
                        
1da6 :                  dgsNormal:
1da6 : af62               stx LocalW2,s
1da8 : 3364               leau LocalBuffer,s
1daa : ec84               ldd gsShotX,x
1dac : edc4               std ,u
1dae : ec03               ldd gsShotY,x
1db0 : ed42               std 2,u
1db2 : 867f               lda #$7f
1db4 : bd2111             jsr DrawDot
1db7 : ae62               ldx LocalW2,s
1db9 : 2036               bra dgsNext
                        
1dbb :                  dgsHoming:
1dbb : a6e4               lda LocalW1,s
1dbd : 8401               anda #1
1dbf : 27e5               beq dgsNormal
                        
1dc1 : af62               stx LocalW2,s
1dc3 : 3364               leau LocalBuffer,s
1dc5 : ec84               ldd gsShotX,x
1dc7 : edc4               std ,u
1dc9 : ec03               ldd gsShotY,x
1dcb : ed42               std 2,u
1dcd : 867f               lda #$7f
1dcf : bd217a             jsr DrawBullet
1dd2 : ae62               ldx LocalW2,s
                        
                          ;Draw a 'tail' on the homing shots by subtracting velocity to draw a dot at the previous position
1dd4 : 3364               leau LocalBuffer,s
1dd6 : e606               ldb gsShotVelocX,x
1dd8 : 50                 negb
1dd9 : 57                 asrb
1dda : 57                 asrb
1ddb : 1d                 sex
1ddc : e3c4               addd ,u
1dde : edc4               std ,u
1de0 : e607               ldb gsShotVelocY,x
1de2 : 50                 negb
1de3 : 57                 asrb
1de4 : 57                 asrb
1de5 : 1d                 sex
1de6 : e342               addd 2,u
1de8 : ed42               std 2,u
1dea : 8634               lda #$34
1dec : bd217a             jsr DrawBullet
1def : ae62               ldx LocalW2,s
                        
1df1 :                  dgsNext:
1df1 : ece4               ldd LocalW1,s
1df3 :                  dgsNotActive:
1df3 : 3008               leax GunShotEntry,x
1df5 : 4a                 deca
1df6 : 26a2               bne dgsLoop
                        
                          mFreeLocals
1df8 : 3268            >  leas FrameSize,s
                        
1dfa : 39                 rts
                        
                        
                        
                        ;*****************
1dfb :                  DrawFuel:                       ;Draw active fuel pods on level
0002 =                  FrameSize set 2                 ;Size of stack frame
0000 =                  Local1 set 0
                          ;DP must be D0
1dfb : 327e               leas    -FrameSize,s
                        
                          mSetIntensity $5f
                       >  if 1=1
1dfd : 865f            >    lda   #$5f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1dff : 9701            >  sta   <01
1e01 : cc0401          >  ldd   #$0401
1e04 : 9700            >  sta   <00
1e06 : d700            >  stb   <00
                        
                        
1e08 : fec8ca             ldu CurLevelEntry
1e0b : ee46               ldu leFuel,u
1e0d : 2717               beq dfExit                    ;exit if no fuel pods
1e0f : f6c8e9             ldb FuelActive
1e12 : a6c0               lda ,u+                       ;load count
1e14 :                  dfLoop:
1e14 : 57                 asrb                          ;test active
1e15 : 240a               bcc dfNext
                        
1e17 : ede4               std Local1,s
                        
1e19 : 8e4bf5             ldx #SpriteFuelCell
1e1c : bd2379             jsr DrawSprite
                        
1e1f : ece4               ldd Local1,s
                        
1e21 :                  dfNext:
1e21 : 3344               leau FuelEntry,u
1e23 : 4a                 deca
1e24 : 26ee               bne dfLoop
                        
1e26 :                  dfExit:
1e26 : 3262               leas    FrameSize,s
1e28 : 39                 rts
                        
                        
                        ;*****************
1e29 :                  DrawOrb:                        ;Draw stationary orb + platform on level
                          ;DP must be D0
                        
                          mTestFlag HasOrbFlag          ;Exit if ship is carrying orb
                       >  if 255>HasOrbFlag          
1e29 : b6c8e5          >    lda GameFlags1
1e2c : 8504            >    bita #HasOrbFlag          
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag          )>>8
                       >  endif
                        
1e2e : 2616               bne doExit
                        
                          mSetIntensity $5f
                       >  if 1=1
1e30 : 865f            >    lda   #$5f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1e32 : 9701            >  sta   <01
1e34 : cc0401          >  ldd   #$0401
1e37 : 9700            >  sta   <00
1e39 : d700            >  stb   <00
                        
                        
1e3b : fec8ca             ldu CurLevelEntry
1e3e : 3348               leau leOrbX,u
1e40 : 8e4c0f             ldx #SpriteStationaryPod
1e43 : bd2379             jsr DrawSprite
                        
1e46 :                  doExit:
1e46 : 39                 rts
                        
                        
                        ;*****************
1e47 :                  DrawPowerplant:                 ;Draw powerplant on level
                          ;DP must be D0
                          mDecLocals 0,1,10
                       >  nolist
                        
                        
1e49 : f6c8f4             ldb PowerShot                 ;Decrease gun disabled timer
1e4c : 270b               beq dpSkip
1e4e : b6c826             lda LoopCounterLow
1e51 : 841f               anda #31
1e53 : 2604               bne dpSkip
1e55 : 5a                 decb
1e56 : f7c8f4             stb PowerShot
1e59 :                  dpSkip:
                        
1e59 : b6c8f3             lda PowerLife                 ;Flash if about to explode
1e5c : 2a6c               bpl dpDraw
1e5e : 3062                 leax LocalBuffer,s
1e60 : 40                   nega                        ;Display countdown
1e61 : 8b2f                 adda #'0'-1
1e63 : c620                 ldb #' '                    ;ROM display must print at least 2 characters
1e65 : e784                 stb ,x
1e67 : c680                 ldb #$80
1e69 : ed01                 std 1,x
                        
1e6b : b6c826               lda LoopCounterLow
1e6e : 843f                 anda #63
1e70 : 40                   nega
1e71 : 8b40                 adda #64
1e73 : a7e4                 sta LocalW1,s
1e75 : 44                   lsra
1e76 : 44                   lsra
1e77 : 40                   nega
1e78 : c670                 ldb #$70
1e7a : fdc82a               std   $C82A           ;Specify height and width
1e7d : bdf354               jsr reset0ref
                            mCombine d,-30,-30
1e80 : cce2e2          >  ldd #(lo -30)<<8 | (lo -30)
                        
1e83 : abe4                 adda LocalW1,s
1e85 : bdf312               jsr move_pen_d
                        ;    lda #$40
                        ;    suba LocalW1,s
                            mTicToc 64
1e88 : b6c826          >  lda LoopCounterLow
1e8b : 843f            >  anda #64-1
1e8d : 8120            >  cmpa #64/2
1e8f : 2402            >  bcc l10489
1e91 : 883f            >  eora #64-1
1e93 :                 >l10489:
                        
1e93 : 8b20                 adda #32
                            mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1e95 : 9701            >  sta   <01
1e97 : cc0401          >  ldd   #$0401
1e9a : 9700            >  sta   <00
1e9c : d700            >  stb   <00
                        
                        
1e9e : 1f13                 tfr x,u
1ea0 : bdf495               jsr display_string
                        
1ea3 : b6c826               lda LoopCounterLow
1ea6 : 843f                 anda #63
1ea8 : 2619                 bne dpNoAdjustCounter
                              mEmitSound CountdownSoundId
                       >  if 1=1
1eaa : 862d            >    lda #CountdownSoundId
                       >  endif
1eac : bd0477          >  jsr EmitSound
                        
1eaf : 7cc8f3                 inc PowerLife
1eb2 : b6c8f3                 lda PowerLife
1eb5 : 81ff                   cmpa #-1
1eb7 : 260a                   bne dpNoAdjustCounter
                                ;Planet exploded
                                mEmitFx FxTargetShip,FxTypePlanetExplode,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
1eb9 : 8690            >  lda #FxTargetShip | (FxTypePlanetExplode<<4)
1ebb : bd06bc          >  jsr EmitFx
                        
1ebe : bd2af8                   jsr ExplodeShip
1ec1 : 2047                     bra dpExit
1ec3 :                  dpNoAdjustCounter:
                        
1ec3 : b6c826               lda LoopCounterLow
1ec6 : 8408                 anda #8
1ec8 : 2740                 beq dpExit
1eca :                  dpDraw:
                          mSetIntensity $5f
                       >  if 1=1
1eca : 865f            >    lda   #$5f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1ecc : 9701            >  sta   <01
1ece : cc0401          >  ldd   #$0401
1ed1 : 9700            >  sta   <00
1ed3 : d700            >  stb   <00
                        
                        
1ed5 : fec8ca             ldu CurLevelEntry
1ed8 : 334c               leau lePowerX,u
1eda : efe4               stu LocalW1,s
1edc : 8e4c2a             ldx #SpritePowerplant
1edf : bd2379             jsr DrawSprite
                        
1ee2 : 7dc8f4             tst PowerShot                 ;draw rising dot if active
1ee5 : 2623               bne dpExit
                        
1ee7 : aee4               ldx LocalW1,s
1ee9 : 3362               leau LocalBuffer,s
1eeb : ec84               ldd ,x
1eed : c30009             addd #9
1ef0 : edc4               std ,u
1ef2 : ec02               ldd 2,x
1ef4 : 83000c             subd #12
1ef7 : ed7e               std -2,s
1ef9 : f6c826             ldb LoopCounterLow
1efc : c40f               andb #15
1efe : 54                 lsrb
1eff : 50                 negb
1f00 : 1d                 sex
1f01 : e37e               addd -2,s
1f03 : ed42               std 2,u
1f05 : 8660               lda #$60
                        ;  jsr DrawDot
1f07 : bd217a             jsr DrawBullet
                        
1f0a :                  dpExit:
                        
                          mFreeLocals
1f0a : 326c            >  leas FrameSize,s
                        
1f0c : 39                 rts
                        
                        
                        ;*****************
1f0d :                  DrawGuns:                       ;Draw active guns on level
                          mDecLocals 1,1
                       >  nolist
                        
                        
                          ;DP must be D0
                          mSetIntensity $5f
                       >  if 1=1
1f0f : 865f            >    lda   #$5f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1f11 : 9701            >  sta   <01
1f13 : cc0401          >  ldd   #$0401
1f16 : 9700            >  sta   <00
1f18 : d700            >  stb   <00
                        
                        
1f1a : fec8ca             ldu CurLevelEntry
1f1d : ee44               ldu leGuns,u
1f1f : 2720               beq dgExit                    ;exit if no guns
1f21 : a6c0               lda ,u+                       ;load guncount
1f23 : a7e4               sta LocalB1,s
1f25 : fcc8e7             ldd GunsActive
1f28 :                  dgLoop:
1f28 : 47                 asra
1f29 : 56                 rorb
1f2a : 240f               bcc dgNext
                        
1f2c : ed61               std LocalW1,s
                        
1f2e : a644               lda geGunSprite,u             ;sprite entry
1f30 : 48                 asla
1f31 : 8e1f44             ldx #GunSpriteTable
1f34 : ae86               ldx a,x
1f36 : bd2379             jsr DrawSprite
                        
1f39 : ec61               ldd LocalW1,s
                        
1f3b :                  dgNext:
1f3b : 3345               leau GunEntry,u
1f3d : 6ae4               dec LocalB1,s
1f3f : 26e7               bne dgLoop
                        
1f41 :                  dgExit:
                          mFreeLocals
1f41 : 3263            >  leas FrameSize,s
                        
1f43 : 39                 rts
                        
1f44 :                  GunSpriteTable:
1f44 : 4bb54bc54bd54be5   dw SpriteGunNE,SpriteGunNW,SpriteGunSE,SpriteGunSW
                        
                        
                        
                        ;*****************
1f4c :                  DrawSwitches:                   ;Draw door switches
                          ;DP must be D0
                          mDecLocals 1,0,0
                       >  nolist
                        
                        
                          mSetIntensity $5f
                       >  if 1=1
1f4e : 865f            >    lda   #$5f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1f50 : 9701            >  sta   <01
1f52 : cc0401          >  ldd   #$0401
1f55 : 9700            >  sta   <00
1f57 : d700            >  stb   <00
                        
                        
1f59 : fec8ca             ldu CurLevelEntry
1f5c : eec814             ldu leSwitches,u
1f5f : a6c0               lda ,u+                       ;load count
1f61 : 2718               beq dswExit                   ;exit if no switches
1f63 :                  dswLoop:
1f63 : a7e4               sta LocalB1,s
                        
1f65 : a644               lda seSwitchDir,u
1f67 : 2705               beq dswDrawLeft
1f69 : 8e4c4f             ldx #SpriteSwitchRight
1f6c : 2003               bra dswDraw
1f6e :                  dswDrawLeft:
1f6e : 8e4c47             ldx #SpriteSwitchLeft
1f71 :                  dswDraw:
1f71 : bd2379             jsr DrawSprite
                        
1f74 : a6e4               lda LocalB1,s
1f76 :                  dswNext:
1f76 : 3345               leau SwitchEntry,u
1f78 : 4a                 deca
1f79 : 26e8               bne dswLoop
                        
1f7b :                  dswExit:
                          mFreeLocals
1f7b : 3261            >  leas FrameSize,s
                        
1f7d : 39                 rts
                        
                        
                        
                        ;*****************
1f7e :                  UpdateDoors:
                          ;  DoorCounter
                          ;    0  : stängd, exit
                          ;    bit 7
                          ;      0 : opening
                          ;          öka med 1, om max sätt bit 7
                          ;      1 : closing
                          ;          minska med 1, om noll clear bit 7
                          ;      >=DoorSize : fully open
                          direct $c8
                        
1f7e : 9626               lda LoopCounterLow
1f80 : 8404               anda #4
1f82 : 2724               beq udoExit
                        
1f84 : 96f2               lda DoorCounter
1f86 : 2720               beq udoExit
1f88 : 2b0f               bmi udoClosing
                        
1f8a : 4c                 inca
1f8b : 2904               bvs udoSetClose
1f8d : 97f2               sta DoorCounter
1f8f : 2017               bra udoExit
1f91 :                  udoSetClose:
1f91 : 8620               lda #DoorSize
1f93 : 8a80               ora #%10000000
1f95 : 97f2               sta DoorCounter
1f97 : 200f               bra udoExit
                        
1f99 :                  udoClosing:
1f99 : 847f               anda #%01111111
1f9b : 4a                 deca
1f9c : 2706               beq udoSetOpen
1f9e : 8a80               ora #%10000000
1fa0 : 97f2               sta DoorCounter
1fa2 : 2004               bra udoExit
                        
1fa4 :                  udoSetOpen:
1fa4 : 8600               lda #0
1fa6 : 97f2               sta DoorCounter
                        
1fa8 :                  udoExit:
                        
                          direct -1
1fa8 : 39                 rts
                        
                        
                        ;*****************
                        ;Lines for doors are generated on stack, then drawn with clipdraw
1fa9 :                  DrawDoors:
0019 =                  DoorLineSize = 25               ;Size of buffer to hold lines
0019 =                  DoorListSize = 25               ;Size of buffer to hold drawlist for lines (5*linecount)
                          mDecLocals 3,0,DoorLineSize+DoorListSize
                       >  nolist
                        
0003 =                  LocalDoorLines = LocalBuffer
001c =                  LocalDoorList  = LocalBuffer+DoorLineSize
0001 =                  LocalOpen = LocalB2
0002 =                  LocalTmp = LocalB3
                        
1fac : b6c8f2             lda DoorCounter
1faf : 847f               anda #%01111111
                        ;  cmpa #DoorSize
                        ;  lbge dorExit                  ;doors are fully opened, exit
1fb1 : a761               sta LocalOpen,s               ;amount to open door
                        
                          mSetIntensity WallIntensity
                       >  if 1=1
1fb3 : 8630            >    lda   #WallIntensity            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
1fb5 : 9701            >  sta   <01
1fb7 : cc0401          >  ldd   #$0401
1fba : 9700            >  sta   <00
1fbc : d700            >  stb   <00
                        
                        
1fbe : fec8ca             ldu CurLevelEntry
1fc1 : eec812             ldu leDoors,u
                        
1fc4 : a6c0               lda ,u+                       ;load count
1fc6 : 1027011e           lbeq dorExit
1fca :                  dorLoop:
1fca : a7e4               sta LocalB1,s
                        
1fcc : 3063               leax LocalDoorLines,s
1fce : 31e81c             leay LocalDoorList,s
1fd1 : 10af81             sty ,x++
1fd4 : ec43               ldd deDoorY,u
1fd6 : ed81               std ,x++
1fd8 : ec41               ldd deDoorX,u
1fda : ed81               std ,x++
                        
1fdc : a6c4               lda deDoorDir,u
1fde : 48                 asla
1fdf : 108e1fe5           ldy #dorTable
1fe3 : 6eb6               jmp [a,y]
                        
1fe5 :                  dorTable:
1fe5 : 1fed2044207e208c   dw dorRightDoor,dorUpDoor,dorInvertRightDoor,dorUpDoorWalls
                        
1fed :                  dorRightDoor:                           ;draw door closing right, 1*2 tiles
                          ;--
                          ;  |
                          ;--
                          ;positive y is down, positive x is right
                          ;  db 1  ;line count
                          ;  db 1  ;linetype, 0=vert, 1=horiz, 2=slope
                          ;  db FullW,0  ;x0,y0
                          ;  db 0,HalfH  ;x1,y1
1fed : a661               lda LocalOpen,s
1fef : 8120               cmpa #DoorSize
1ff1 : 102c00ea           lbge dorNext
1ff5 : 48                 asla
1ff6 : a762               sta LocalTmp,s
                        
1ff8 :                  dorDoHoriz:
1ff8 : a662               lda LocalTmp,s
1ffa : 8140               cmpa #TileW*2
1ffc : 102400df           lbhs dorNext
                        
2000 : 8603               lda #3
2002 : a780               sta ,x+
                        
2004 : 8601               lda #1        ;line 1
2006 : a780               sta ,x+
                        
2008 : 4f                 clra
2009 : a780               sta ,x+
200b : a780               sta ,x+
                        
200d : 8640               lda #TileW*2
200f : a062               suba LocalTmp,s
2011 : a780               sta ,x+
2013 : 4f                 clra
2014 : a780               sta ,x+
                        
                        
2016 : 4f                 clra          ;line 2
2017 : a780               sta ,x+
                        
2019 : 8640               lda #TileW*2
201b : a062               suba LocalTmp,s
201d : a780               sta ,x+
201f : 4f                 clra
2020 : a780               sta ,x+
                        
2022 : 8640               lda #TileW*2
2024 : a062               suba LocalTmp,s
2026 : a780               sta ,x+
2028 : 8620               lda #TileH
202a : a780               sta ,x+
                        
                        
202c : 8601               lda #1        ;line 3
202e : a780               sta ,x+
                        
2030 : 4f                 clra
2031 : a780               sta ,x+
2033 : 8620               lda #TileH
2035 : a780               sta ,x+
                        
2037 : 8640               lda #TileW*2
2039 : a062               suba LocalTmp,s
203b : a780               sta ,x+
203d : 8620               lda #TileH
203f : a780               sta ,x+
                        
2041 : 7e20d9             jmp dorDraw
                        
                        
2044 :                  dorUpDoor:                      ;draw door closing up, 2*2 tiles
                          ;----
                          ;____
                          ;positive y is down, positive x is right
                          ;  db 1  ;line count
                          ;  db 1  ;linetype, 0=vert, 1=horiz, 2=slope
                          ;  db FullW,0  ;x0,y0
                          ;  db 0,HalfH  ;x1,y1
2044 : a661               lda LocalOpen,s
2046 : 8120               cmpa #DoorSize
2048 : 102c0093           lbge dorNext
                        
204c : 8602               lda #2
204e : a780               sta ,x+
                        
                          ;Bottom line, fixed
2050 : 8601               lda #1
2052 : a780               sta ,x+
                        
2054 : 8600               lda #0
2056 : a780               sta ,x+
2058 : 8640               lda #TileH*2
205a : a780               sta ,x+
                        
205c : 8640               lda #TileW*2
205e : a780               sta ,x+
2060 : 8640               lda #TileH*2
2062 : a780               sta ,x+
                        
                        
                          ;Top line, this moves down when door opens
2064 : 8601               lda #1
2066 : a780               sta ,x+
                        
2068 : 4f                 clra
2069 : a780               sta ,x+
206b : ab61               adda LocalOpen,s              ;add twice, tileh=2*tilew
206d : ab61               adda LocalOpen,s
206f : a780               sta ,x+
                        
2071 : 8640               lda #(TileW*2)
2073 : a780               sta ,x+
2075 : 4f                 clra
2076 : ab61               adda LocalOpen,s              ;add twice, tileh=2*tilew
2078 : ab61               adda LocalOpen,s
207a : a780               sta ,x+
207c : 205b               bra dorDraw
                        
207e :                  dorInvertRightDoor:
207e : a661               lda LocalOpen,s
2080 : 40                 nega
2081 : 8b20               adda #DoorSize
2083 : 2a01               bpl dorInvertR1
2085 : 4f                   clra
2086 :                  dorInvertR1:
2086 : 48                 asla
2087 : a762               sta LocalTmp,s
2089 : 7e1ff8             bra dorDoHoriz
                        
                        
208c :                  dorUpDoorWalls:                      ;draw door closing up, 2*2 tiles
                          ; ----
                          ;|    |
                          ;|    |
                          ;positive y is down, positive x is right
                          ;  db 1  ;line count
                          ;  db 1  ;linetype, 0=vert, 1=horiz, 2=slope
                          ;  db FullW,0  ;x0,y0
                          ;  db 0,HalfH  ;x1,y1
208c : a661               lda LocalOpen,s
208e : 8120               cmpa #DoorSize
2090 : 102c004b           lbge dorNext
                        
2094 : 8603               lda #3
2096 : a780               sta ,x+
                        
                          ;Left wall
2098 : 4f                 clra
2099 : a780               sta ,x+       ;linetype
209b : a780               sta ,x+       ;x0
209d : ab61               adda LocalOpen,s
209f : ab61               adda LocalOpen,s
20a1 : a780               sta ,x+       ;y0
20a3 : 4f                 clra
20a4 : a780               sta ,x+       ;x1
20a6 : 8640               lda #(TileH*2)
20a8 : a780               sta ,x+       ;y1
                        
                          ;Right wall
20aa : 4f                 clra
20ab : a780               sta ,x+       ;linetype
20ad : 8640               lda #(TileW*2)
20af : a780               sta ,x+       ;x0
20b1 : a661               lda LocalOpen,s
20b3 : ab61               adda LocalOpen,s
20b5 : a780               sta ,x+       ;y0
20b7 : 8640               lda #(TileW*2)
20b9 : a780               sta ,x+       ;x1
20bb : 8640               lda #(TileH*2)
20bd : a780               sta ,x+       ;y1
                        
                          ;Top line, this moves down when door opens
20bf : 8601               lda #1
20c1 : a780               sta ,x+
                        
20c3 : 4f                 clra
20c4 : a780               sta ,x+
20c6 : ab61               adda LocalOpen,s              ;add twice, tileh=2*tilew
20c8 : ab61               adda LocalOpen,s
20ca : a780               sta ,x+
                        
20cc : 8640               lda #(TileW*2)
20ce : a780               sta ,x+
20d0 : 4f                 clra
20d1 : ab61               adda LocalOpen,s              ;add twice, tileh=2*tilew
20d3 : ab61               adda LocalOpen,s
20d5 : a780               sta ,x+
20d7 : 2000               bra dorDraw
                        
                        
20d9 :                  dorDraw:
20d9 : 3163               leay LocalDoorLines,s
20db : 8630               lda #WallIntensity
20dd : 8d0d               bsr ClipDraw
                        
20df :                  dorNext:
20df : a6e4               lda LocalB1,s
20e1 : 3345               leau DoorEntry,u
20e3 : 4a                 deca
20e4 : 1026fee2           bne dorLoop
                        
20e8 :                  dorExit:
                          mFreeLocals
20e8 : 32e835          >  leas FrameSize,s
                        
20eb : 39                 rts
                        
                        
                        ;*****************
20ec :                  ClipDraw:              ;a=intensity, y points to: destlinesptr,offsety,offsetx,abslines
                          ;**todo: this will not work when x-world-wrap is on screen
                          ;_CohenSutherlandClip is not aware of world-wrap
                          ;clipX coord will need to be adjusted to ViewX+Screen(clipX)
                        
20ec : aea1               ldx ,y++                      ;destlines
                        
20ee : 340a               pshs a,dp                     ;save intensity + dp
                          mDptoC8                       ;clip needs c8
20f0 : 86c8            >  lda   #0xC8
20f2 : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
20f4 : eca1               ldd ,y++
20f6 : ede3               std ,--s                      ;offset y
20f8 : eca1               ldd ,y++
20fa : ede3               std ,--s                      ;offset x
20fc : afe3               stx ,--s                      ;pointer to destination drawlist
20fe : 10afe3             sty ,--s                      ;pointer to lines
2101 : bd00ba             jsr _CohenSutherlandClip
2104 : 3268               leas  8,s
2106 : 350a               puls dp,a                     ;restore dp + intensity
2108 : 5d                 tstb
2109 : 2705               beq cdrExit                   ;empty list, all is clipped
                        
210b : 6f85               clr b,x                       ;write end of drawlist, b holds nr of bytes written
                        
                          ;a holds intensity
210d : bd2a9b             jsr GoDrawList
                        
2110 :                  cdrExit:
                          direct -1
2110 : 39                 rts
                        
                        
                        
                        ;*****************
2111 :                  DrawDot:                        ;a=intensity,  u=pointer to x,y
                          mDecLocals 3,0
                       >  nolist
                        
0000 =                  LocalTempX = LocalB1
0001 =                  LocalTempY = LocalB2
0002 =                  LocalInt = LocalB3
2113 : a762               sta LocalInt,s
                        
                          ;X coord
                          mGetScreenX ,u
                       >  if  2 = 0    ;no param, X holds X-coord
                       >    tfr x,y
                       >  endif
                       >  if  2 = 1
                       >    ldy     
                       >  endif
                       >  if  2 = 2   ;as09 treats "2,y" as two separate macro arguments
2115 : 10aec4          >    ldy     ,u
                       >  endif
2118 : bec8c6          >  ldx     ViewX
211b : 1f20            >  tfr     y,d
211d : af7e            >  stx -2,s
211f : a37e            >  subd -2,s
2121 : 2c0a            >  bge     L1430554
2123 : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
2126 : a37e            >  subd -2,s
2128 : 10af7e          >  sty -2,s
212b : e37e            >  addd -2,s
212d :                 >L1430554:
                        
212d : 2b48               bmi ddExit                    ;offscreen, skip
212f : 4d                 tsta
2130 : 2645               bne ddExit                    ;offscreen, skip
                        
2132 : c080               subb #128
2134 : e7e4               stb LocalTempX,s
                        
                          ;Y coord
2136 : ec42               ldd 2,u
2138 : b3c8c8             subd ViewY
213b : 2b3a               bmi ddExit                    ;offscreen, skip
213d : 4d                 tsta
213e : 2637               bne ddExit                    ;offscreen, skip
                        
2140 : e761               stb LocalTempY,s
2142 : bdf354             jsr reset0ref                 ;this dot should be drawn, reset pen
                          mSetScale $7f
                       >  if 1=1
2145 : 867f            >    lda #$7f                  ;if argument exists, load into a, otherwise use current a
                       >  endif
2147 : 9704            >  sta <$04
                        
2149 : a662               lda LocalInt,s
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
214b : 9701            >  sta   <01
214d : cc0401          >  ldd   #$0401
2150 : 9700            >  sta   <00
2152 : d700            >  stb   <00
                        
2154 : a661               lda LocalTempY,s
                        
2156 : 40                 nega
2157 : 8b7f               adda #127
2159 : e6e4               ldb LocalTempX,s
                        
                          mMove_pen_d_Quick
215b : 9701            >  sta   <0x01
215d : 0f00            >  clr   <0x00
215f : 86ce            >  lda   #0xCE
2161 : 970c            >  sta   <0x0C
2163 : 0f0a            >  clr   <0x0A
2165 : 0c00            >  inc   <0x00
2167 : d701            >  stb   <0x01
2169 : 0f05            >  clr   <0x05
216b : c640            >  ldb   #0x40
216d : d50d            >PF33D0557: bitb  <0x0D
216f : 27fc            >  beq   PF33D0557
                       >;PF33B0557: lda   #0x04
                       >;PF3410557: deca
                       >;  bne   PF3410557
                        
                          mDot_at_current_position 1
                       >  ; From vectrex.txt
                       >  ;    "(WARNING! high intensity and long Vec_Dot_Dwell might result in a burn in on
                       >  ;     your vectrex monitor, be carefull while experimenting with this!)"
2171 : 86ff            >       lda   #0xFF
2173 : 970a            >       sta   <0x0A
                       >;       ldb   #1         ;1 is a value for how long the dot is lit
                       >;PF2CC0558: decb                     ;dwell is not the same as intensity
                       >;       bne   PF2CC0558
2175 : 0f0a            >       clr   <0x0A
                        
2177 :                  ddExit:
                          mFreeLocals
2177 : 3263            >  leas FrameSize,s
                        
2179 : 39                 rts
                        
                        
                        ;*****************
217a :                  DrawBullet:                        ;a=intensity,  u=pointer to x,y
                          mDecLocals 3,0
                       >  nolist
                        
0000 =                  LocalTempX = LocalB1
0001 =                  LocalTempY = LocalB2
0002 =                  LocalInt = LocalB3
217c : a762               sta LocalInt,s
                        
                          ;X coord
                          mGetScreenX ,u
                       >  if  2 = 0    ;no param, X holds X-coord
                       >    tfr x,y
                       >  endif
                       >  if  2 = 1
                       >    ldy     
                       >  endif
                       >  if  2 = 2   ;as09 treats "2,y" as two separate macro arguments
217e : 10aec4          >    ldy     ,u
                       >  endif
2181 : bec8c6          >  ldx     ViewX
2184 : 1f20            >  tfr     y,d
2186 : af7e            >  stx -2,s
2188 : a37e            >  subd -2,s
218a : 2c0a            >  bge     L1430573
218c : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
218f : a37e            >  subd -2,s
2191 : 10af7e          >  sty -2,s
2194 : e37e            >  addd -2,s
2196 :                 >L1430573:
                        
2196 : 2b44               bmi dbExit                    ;offscreen, skip
2198 : 4d                 tsta
2199 : 2641               bne dbExit                    ;offscreen, skip
                        
219b : c080               subb #128
219d : e7e4               stb LocalTempX,s
                        
                          ;Y coord
219f : ec42               ldd 2,u
21a1 : b3c8c8             subd ViewY
21a4 : 2b36               bmi dbExit                    ;offscreen, skip
21a6 : 4d                 tsta
21a7 : 2633               bne dbExit                    ;offscreen, skip
                        
21a9 : e761               stb LocalTempY,s
21ab : bdf354             jsr reset0ref                 ;this dot should be drawn, reset pen
                          mSetScale $7f
                       >  if 1=1
21ae : 867f            >    lda #$7f                  ;if argument exists, load into a, otherwise use current a
                       >  endif
21b0 : 9704            >  sta <$04
                        
21b2 : a662               lda LocalInt,s
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
21b4 : 9701            >  sta   <01
21b6 : cc0401          >  ldd   #$0401
21b9 : 9700            >  sta   <00
21bb : d700            >  stb   <00
                        
21bd : a661               lda LocalTempY,s
                        
21bf : 40                 nega
21c0 : 8b7f               adda #127
21c2 : e6e4               ldb LocalTempX,s
                        
                          mMove_pen_d_Quick
21c4 : 9701            >  sta   <0x01
21c6 : 0f00            >  clr   <0x00
21c8 : 86ce            >  lda   #0xCE
21ca : 970c            >  sta   <0x0C
21cc : 0f0a            >  clr   <0x0A
21ce : 0c00            >  inc   <0x00
21d0 : d701            >  stb   <0x01
21d2 : 0f05            >  clr   <0x05
21d4 : c640            >  ldb   #0x40
21d6 : d50d            >PF33D0576: bitb  <0x0D
21d8 : 27fc            >  beq   PF33D0576
                       >;PF33B0576: lda   #0x04
                       >;PF3410576: deca
                       >;  bne   PF3410576
                        
21da : 8d03               bsr DrawBulletAtCurrentPosition
                        ;  clra  ;z if visible
21dc :                  dbExit:
                          mFreeLocals
21dc : 3263            >  leas FrameSize,s
                        
21de : 39                 rts
                        
                        
                        ;*****************
                         ;Quick draw macros
                        
                        _QpenOn macro
                          lda   #0xFF ;pen on
                          sta   <0x0A
                         endm
                        
                        _QpenOff macro
                          clr   <0x0A ;pen off
                         endm
                        
                        _Qmove macro xx,yy,ww
                        One = ($20-1)/2
                          mCombine d,xx*One,yy*One
                          sta   <0x01
                          clr   <0x00
                          inc   <0x00
                          stb   <0x01
                          clr   <0x05
                          if 1\3=11
                            ;need to wait for long lines (third param=1)
                            ldb   #0x40
                        wait\?
                            bitb  <0x0D
                            beq   wait\?
                          endif
                         endm
                        
                        
                        ;*****************
21df :                  DrawBulletAtCurrentPosition:
                          mSetScale 1
                       >  if 1=1
21df : 8601            >    lda #1                  ;if argument exists, load into a, otherwise use current a
                       >  endif
21e1 : 9704            >  sta <$04
                        
                        
                        ;  _db1 -1,-1
                        
                          _Qmove 2,-1
000f =                 >One = ($20-1)/2
                       >  mCombine d,2*One,-1*One
21e3 : cc1ef1          >  ldd #(lo 2*One)<<8 | (lo -1*One)
                       >
21e6 : 9701            >  sta   <0x01
21e8 : 0f00            >  clr   <0x00
21ea : 0c00            >  inc   <0x00
21ec : d701            >  stb   <0x01
21ee : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0579
                       >    bitb  <0x0D
                       >    beq   wait0579
                       >  endif
                        
                        
                          _QpenOn
21f0 : 86ff            >  lda   #0xFF ;pen on
21f2 : 970a            >  sta   <0x0A
                        
                        
                          _Qmove 0,2
000f =                 >One = ($20-1)/2
                       >  mCombine d,0*One,2*One
21f4 : cc001e          >  ldd #(lo 0*One)<<8 | (lo 2*One)
                       >
21f7 : 9701            >  sta   <0x01
21f9 : 0f00            >  clr   <0x00
21fb : 0c00            >  inc   <0x00
21fd : d701            >  stb   <0x01
21ff : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0582
                       >    bitb  <0x0D
                       >    beq   wait0582
                       >  endif
                        
                          _Qmove -1,1
000f =                 >One = ($20-1)/2
                       >  mCombine d,-1*One,1*One
2201 : ccf10f          >  ldd #(lo -1*One)<<8 | (lo 1*One)
                       >
2204 : 9701            >  sta   <0x01
2206 : 0f00            >  clr   <0x00
2208 : 0c00            >  inc   <0x00
220a : d701            >  stb   <0x01
220c : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0584
                       >    bitb  <0x0D
                       >    beq   wait0584
                       >  endif
                        
                          _Qmove -2,0
000f =                 >One = ($20-1)/2
                       >  mCombine d,-2*One,0*One
220e : cce200          >  ldd #(lo -2*One)<<8 | (lo 0*One)
                       >
2211 : 9701            >  sta   <0x01
2213 : 0f00            >  clr   <0x00
2215 : 0c00            >  inc   <0x00
2217 : d701            >  stb   <0x01
2219 : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0586
                       >    bitb  <0x0D
                       >    beq   wait0586
                       >  endif
                        
                          _Qmove -1,-1
000f =                 >One = ($20-1)/2
                       >  mCombine d,-1*One,-1*One
221b : ccf1f1          >  ldd #(lo -1*One)<<8 | (lo -1*One)
                       >
221e : 9701            >  sta   <0x01
2220 : 0f00            >  clr   <0x00
2222 : 0c00            >  inc   <0x00
2224 : d701            >  stb   <0x01
2226 : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0588
                       >    bitb  <0x0D
                       >    beq   wait0588
                       >  endif
                        
                          _Qmove 0,-2
000f =                 >One = ($20-1)/2
                       >  mCombine d,0*One,-2*One
2228 : cc00e2          >  ldd #(lo 0*One)<<8 | (lo -2*One)
                       >
222b : 9701            >  sta   <0x01
222d : 0f00            >  clr   <0x00
222f : 0c00            >  inc   <0x00
2231 : d701            >  stb   <0x01
2233 : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0590
                       >    bitb  <0x0D
                       >    beq   wait0590
                       >  endif
                        
                          _Qmove 1,-1
000f =                 >One = ($20-1)/2
                       >  mCombine d,1*One,-1*One
2235 : cc0ff1          >  ldd #(lo 1*One)<<8 | (lo -1*One)
                       >
2238 : 9701            >  sta   <0x01
223a : 0f00            >  clr   <0x00
223c : 0c00            >  inc   <0x00
223e : d701            >  stb   <0x01
2240 : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0592
                       >    bitb  <0x0D
                       >    beq   wait0592
                       >  endif
                        
                          _Qmove 2,0
000f =                 >One = ($20-1)/2
                       >  mCombine d,2*One,0*One
2242 : cc1e00          >  ldd #(lo 2*One)<<8 | (lo 0*One)
                       >
2245 : 9701            >  sta   <0x01
2247 : 0f00            >  clr   <0x00
2249 : 0c00            >  inc   <0x00
224b : d701            >  stb   <0x01
224d : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0594
                       >    bitb  <0x0D
                       >    beq   wait0594
                       >  endif
                        
                          _Qmove 1,1
000f =                 >One = ($20-1)/2
                       >  mCombine d,1*One,1*One
224f : cc0f0f          >  ldd #(lo 1*One)<<8 | (lo 1*One)
                       >
2252 : 9701            >  sta   <0x01
2254 : 0f00            >  clr   <0x00
2256 : 0c00            >  inc   <0x00
2258 : d701            >  stb   <0x01
225a : 0f05            >  clr   <0x05
                       >  if 1=11
                       >    ;need to wait for long lines (third param=1)
                       >    ldb   #0x40
                       >wait0596
                       >    bitb  <0x0D
                       >    beq   wait0596
                       >  endif
                        
                        
                         if false
                          _db1 2,0
                          _db1 0,2
                          _db1 -2,0
                          _db1 0,-2
                         endif
                        
                          _QpenOff
225c : 0f0a            >  clr   <0x0A ;pen off
                        
                        
225e : 39                 rts
                        
                        
                        ;*****************
225f :                  DrawPlusAtCurrentPosition:  ;a=scale
                          mSetScale
                       >  if 0=1
                       >    lda #                  ;if argument exists, load into a, otherwise use current a
                       >  endif
225f : 9704            >  sta <$04
                        
                        
                          ;negative y is down, negative x is left
                        
                          _Qmove -2,0,1
000f =                 >One = ($20-1)/2
                       >  mCombine d,-2*One,0*One
2261 : cce200          >  ldd #(lo -2*One)<<8 | (lo 0*One)
                       >
2264 : 9701            >  sta   <0x01
2266 : 0f00            >  clr   <0x00
2268 : 0c00            >  inc   <0x00
226a : d701            >  stb   <0x01
226c : 0f05            >  clr   <0x05
                       >  if 11=11
                       >    ;need to wait for long lines (third param=1)
226e : c640            >    ldb   #0x40
2270 :                 >wait0600
2270 : d50d            >    bitb  <0x0D
2272 : 27fc            >    beq   wait0600
                       >  endif
                        
                          _QpenOn
2274 : 86ff            >  lda   #0xFF ;pen on
2276 : 970a            >  sta   <0x0A
                        
                          _Qmove 4,0,1
000f =                 >One = ($20-1)/2
                       >  mCombine d,4*One,0*One
2278 : cc3c00          >  ldd #(lo 4*One)<<8 | (lo 0*One)
                       >
227b : 9701            >  sta   <0x01
227d : 0f00            >  clr   <0x00
227f : 0c00            >  inc   <0x00
2281 : d701            >  stb   <0x01
2283 : 0f05            >  clr   <0x05
                       >  if 11=11
                       >    ;need to wait for long lines (third param=1)
2285 : c640            >    ldb   #0x40
2287 :                 >wait0603
2287 : d50d            >    bitb  <0x0D
2289 : 27fc            >    beq   wait0603
                       >  endif
                        
                          _QpenOff
228b : 0f0a            >  clr   <0x0A ;pen off
                        
                          _Qmove -2,2,1
000f =                 >One = ($20-1)/2
                       >  mCombine d,-2*One,2*One
228d : cce21e          >  ldd #(lo -2*One)<<8 | (lo 2*One)
                       >
2290 : 9701            >  sta   <0x01
2292 : 0f00            >  clr   <0x00
2294 : 0c00            >  inc   <0x00
2296 : d701            >  stb   <0x01
2298 : 0f05            >  clr   <0x05
                       >  if 11=11
                       >    ;need to wait for long lines (third param=1)
229a : c640            >    ldb   #0x40
229c :                 >wait0606
229c : d50d            >    bitb  <0x0D
229e : 27fc            >    beq   wait0606
                       >  endif
                        
                          _QpenOn
22a0 : 86ff            >  lda   #0xFF ;pen on
22a2 : 970a            >  sta   <0x0A
                        
                          _Qmove 0,-4,1
000f =                 >One = ($20-1)/2
                       >  mCombine d,0*One,-4*One
22a4 : cc00c4          >  ldd #(lo 0*One)<<8 | (lo -4*One)
                       >
22a7 : 9701            >  sta   <0x01
22a9 : 0f00            >  clr   <0x00
22ab : 0c00            >  inc   <0x00
22ad : d701            >  stb   <0x01
22af : 0f05            >  clr   <0x05
                       >  if 11=11
                       >    ;need to wait for long lines (third param=1)
22b1 : c640            >    ldb   #0x40
22b3 :                 >wait0609
22b3 : d50d            >    bitb  <0x0D
22b5 : 27fc            >    beq   wait0609
                       >  endif
                        
                          _QpenOff
22b7 : 0f0a            >  clr   <0x0A ;pen off
                        
                        
22b9 : 39                 rts
                        
                        
                        ;*****************
22ba :                  DotShatter:                     ;u=pointer to x,y   a=time
                          mDecLocals 1,3,4
                       >  nolist
                        
0000 =                  LocalInt = LocalB1
0001 =                  LocalPos = LocalW1
0003 =                  LocalNeg = LocalW2
0005 =                  LocalPtr = LocalW3
                        
                          ;Calc intensity based on time
22bc : c67f               ldb #$7f
22be : a77f               sta -1,s
22c0 : e07f               subb -1,s
22c2 : e07f               subb -1,s
22c4 : 2a01               bpl dsIntPositive
22c6 : 5f                   clrb
22c7 :                  dsIntPositive:
22c7 : e7e4               stb LocalInt,s
                        
22c9 : f6c826             ldb LoopCounterLow
22cc : c401               andb #1
22ce : 2701               beq dsSkip1
22d0 : 44                   lsra
22d1 :                  dsSkip1:
                        
22d1 : 1f89               tfr a,b
22d3 : 4f                 clra
22d4 : ed61               std LocalPos,s
22d6 : 50                 negb
22d7 : 1d                 sex
22d8 : ed63               std LocalNeg,s
                        
22da : ef65               stu LocalPtr,s
22dc : 3367               leau LocalBuffer,s
                        
                        mShatter macro xmod,ymod
                          ldy LocalPtr,s
                          ldd ,y
                          if xmod!=-1
                            addd xmod,s
                          endif
                          std ,u
                          ldd 2,y
                          if ymod!=-1
                            addd ymod,s
                          endif
                          std 2,u
                          lda LocalInt,s
                          jsr DrawDot
                          endm
                        
                          mShatter LocalNeg,LocalNeg
22de : 10ae65          >  ldy LocalPtr,s
22e1 : eca4            >  ldd ,y
                       >  if LocalNeg!=-1
22e3 : e363            >    addd LocalNeg,s
                       >  endif
22e5 : edc4            >  std ,u
22e7 : ec22            >  ldd 2,y
                       >  if LocalNeg!=-1
22e9 : e363            >    addd LocalNeg,s
                       >  endif
22eb : ed42            >  std 2,u
22ed : a6e4            >  lda LocalInt,s
22ef : bd2111          >  jsr DrawDot
                        
                          mShatter -1,LocalNeg
22f2 : 10ae65          >  ldy LocalPtr,s
22f5 : eca4            >  ldd ,y
                       >  if -1!=-1
                       >    addd -1,s
                       >  endif
22f7 : edc4            >  std ,u
22f9 : ec22            >  ldd 2,y
                       >  if LocalNeg!=-1
22fb : e363            >    addd LocalNeg,s
                       >  endif
22fd : ed42            >  std 2,u
22ff : a6e4            >  lda LocalInt,s
2301 : bd2111          >  jsr DrawDot
                        
                          mShatter LocalPos,LocalNeg
2304 : 10ae65          >  ldy LocalPtr,s
2307 : eca4            >  ldd ,y
                       >  if LocalPos!=-1
2309 : e361            >    addd LocalPos,s
                       >  endif
230b : edc4            >  std ,u
230d : ec22            >  ldd 2,y
                       >  if LocalNeg!=-1
230f : e363            >    addd LocalNeg,s
                       >  endif
2311 : ed42            >  std 2,u
2313 : a6e4            >  lda LocalInt,s
2315 : bd2111          >  jsr DrawDot
                        
                        
                          mShatter LocalNeg,-1
2318 : 10ae65          >  ldy LocalPtr,s
231b : eca4            >  ldd ,y
                       >  if LocalNeg!=-1
231d : e363            >    addd LocalNeg,s
                       >  endif
231f : edc4            >  std ,u
2321 : ec22            >  ldd 2,y
                       >  if -1!=-1
                       >    addd -1,s
                       >  endif
2323 : ed42            >  std 2,u
2325 : a6e4            >  lda LocalInt,s
2327 : bd2111          >  jsr DrawDot
                        
                          mShatter LocalPos,-1
232a : 10ae65          >  ldy LocalPtr,s
232d : eca4            >  ldd ,y
                       >  if LocalPos!=-1
232f : e361            >    addd LocalPos,s
                       >  endif
2331 : edc4            >  std ,u
2333 : ec22            >  ldd 2,y
                       >  if -1!=-1
                       >    addd -1,s
                       >  endif
2335 : ed42            >  std 2,u
2337 : a6e4            >  lda LocalInt,s
2339 : bd2111          >  jsr DrawDot
                        
                        
                          mShatter LocalNeg,LocalPos
233c : 10ae65          >  ldy LocalPtr,s
233f : eca4            >  ldd ,y
                       >  if LocalNeg!=-1
2341 : e363            >    addd LocalNeg,s
                       >  endif
2343 : edc4            >  std ,u
2345 : ec22            >  ldd 2,y
                       >  if LocalPos!=-1
2347 : e361            >    addd LocalPos,s
                       >  endif
2349 : ed42            >  std 2,u
234b : a6e4            >  lda LocalInt,s
234d : bd2111          >  jsr DrawDot
                        
                          mShatter -1,LocalPos
2350 : 10ae65          >  ldy LocalPtr,s
2353 : eca4            >  ldd ,y
                       >  if -1!=-1
                       >    addd -1,s
                       >  endif
2355 : edc4            >  std ,u
2357 : ec22            >  ldd 2,y
                       >  if LocalPos!=-1
2359 : e361            >    addd LocalPos,s
                       >  endif
235b : ed42            >  std 2,u
235d : a6e4            >  lda LocalInt,s
235f : bd2111          >  jsr DrawDot
                        
                          mShatter LocalPos,LocalPos
2362 : 10ae65          >  ldy LocalPtr,s
2365 : eca4            >  ldd ,y
                       >  if LocalPos!=-1
2367 : e361            >    addd LocalPos,s
                       >  endif
2369 : edc4            >  std ,u
236b : ec22            >  ldd 2,y
                       >  if LocalPos!=-1
236d : e361            >    addd LocalPos,s
                       >  endif
236f : ed42            >  std 2,u
2371 : a6e4            >  lda LocalInt,s
2373 : bd2111          >  jsr DrawDot
                        
                        
                          mFreeLocals
2376 : 326b            >  leas FrameSize,s
                        
2378 : 39                 rts
                        
                        
                        
                        ;*****************
2379 :                  DrawSprite:                     ;Draw a single sprite  u=pointer to x,y  x=lines
                          mDecLocals 1,2
                       >  nolist
                        
                          ;DP must be D0
                        
237b : af61               stx LocalW1,s
                        
                          mGetScreenX 0,u               ;X coord
                       >  if  2 = 0    ;no param, X holds X-coord
                       >    tfr x,y
                       >  endif
                       >  if  2 = 1
                       >    ldy     0
                       >  endif
                       >  if  2 = 2   ;as09 treats "2,y" as two separate macro arguments
237d : 10aec4          >    ldy     0,u               
                       >  endif
2380 : bec8c6          >  ldx     ViewX
2383 : 1f20            >  tfr     y,d
2385 : af7e            >  stx -2,s
2387 : a37e            >  subd -2,s
2389 : 2c0a            >  bge     L1430647
238b : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
238e : a37e            >  subd -2,s
2390 : 10af7e          >  sty -2,s
2393 : e37e            >  addd -2,s
2395 :                 >L1430647:
                        
2395 : 2b46               bmi drExit                    ;offscreen, skip
2397 : 4d                 tsta
2398 : 2643               bne drExit                    ;offscreen, skip
                        
239a : c080               subb #128
239c : e7e4               stb LocalB1,s
                        
239e : ec42               ldd 2,u                       ;Y coord
23a0 : b3c8c8             subd ViewY
23a3 : 2b38               bmi drExit                    ;offscreen, skip
23a5 : 4d                 tsta
23a6 : 2635               bne drExit                    ;offscreen, skip
                        
23a8 : 50                 negb
23a9 : 1f98               tfr b,a
23ab : e6e4               ldb LocalB1,s
23ad : 8b7f               adda #127
                        
23af : ed63               std LocalW2,s
                          mSetScale $7f                 ;Scale $7f is required for move_pen_d to reach whole screen
                       >  if 1=1
23b1 : 867f            >    lda #$7f                                   ;if argument exists, load into a, otherwise use current a
                       >  endif
23b3 : 9704            >  sta <$04
                        
23b5 : bdf354             jsr reset0ref
23b8 : ec63               ldd LocalW2,s
                          mMove_pen_d_Quick
23ba : 9701            >  sta   <0x01
23bc : 0f00            >  clr   <0x00
23be : 86ce            >  lda   #0xCE
23c0 : 970c            >  sta   <0x0C
23c2 : 0f0a            >  clr   <0x0A
23c4 : 0c00            >  inc   <0x00
23c6 : d701            >  stb   <0x01
23c8 : 0f05            >  clr   <0x05
23ca : c640            >  ldb   #0x40
23cc : d50d            >PF33D0649: bitb  <0x0D
23ce : 27fc            >  beq   PF33D0649
                       >;PF33B0649: lda   #0x04
                       >;PF3410649: deca
                       >;  bne   PF3410649
                        
                        
23d0 : ae61               ldx LocalW1,s
23d2 : a680               lda ,x+                       ;Nr of vectors in list
23d4 :                  drLoop:
23d4 : c614               ldb #DrawScale                ;Scale
23d6 : bdf3b7             jsr move_draw_VL4             ;Draw list
23d9 : a680               lda ,x+                       ;Get next count, $ff ends
23db : 2af7               bpl drLoop
23dd :                  drExit:
                        
                          mFreeLocals
23dd : 3265            >  leas FrameSize,s
                        
23df : 39                 rts
                        
                        
                        
                        ;*****************
23e0 :                  UpdateShipShots:                ;Move all active shots.
                          direct $c8
                          mDecLocals 3,2
                       >  nolist
                        
0003 =                  Local1 = LocalW1
0005 =                  Local2 = LocalW2
0001 =                  LocalGunCount = LocalB2
0001 =                  LocalFuelCount = LocalB2        ;fuel use same temp as gun
0001 =                  LocalCount = LocalB2
                        
23e2 : cec91c             ldu #ShipShotList
23e5 : 8604               lda #ShipShotCount
23e7 :                  ussLoop:
23e7 : a762               sta LocalB3,s                  ;spill loop index
23e9 : 6dc4               tst ssShotActive,u
23eb : 1027025a           lbeq ussNext
                        
                          ;Move shots
                          mUpdateXCoord ssShotX, ssShotVelocX
23ef : 3041            >  leax ssShotX,u               ;Update sprite X coordinate
                       >  mGet_D_from_fixed
23f1 : ec84            >  ldd ,x
                       >
23f3 : 6802            >  asl 2,x
23f5 : 59              >  rolb
23f6 : 49              >  rola
                       >
23f7 : 6802            >  asl 2,x
23f9 : 59              >  rolb
23fa : 49              >  rola
                       >
23fb : ed7e            >  std -2,s
23fd : e647            >  ldb  ssShotVelocX,u
23ff : 1d              >  sex
2400 : e37e            >  addd -2,s
                       >  mStore_D_as_fixed
2402 : 6f02            >  clr 2,x
                       >
2404 : 47              >  asra
2405 : 56              >  rorb
2406 : 6602            >  ror 2,x
                       >
2408 : 47              >  asra
2409 : 56              >  rorb
240a : 6602            >  ror 2,x
                       >
240c : ed84            >  std ,x
                       >
240e : 4d              >  tsta                          ;Check for world ends
240f : 2a06            >  bpl CheckRightEdge0664
2411 : d3cd            >    addd CurLevelEndX           ;Left end hit, wrap
2413 : ed41            >    std ssShotX,u
2415 : 2006            >    bra XOk0664
2417 :                 >CheckRightEdge0664:
2417 : 93cd            >    subd CurLevelEndX
2419 : 2b02            >    bmi XOk0664
241b : ed41            >    std ssShotX,u              ;Right edge hit
241d :                 >XOk0664:
                        
                          mUpdateYCoord ssShotY, ssShotVelocY, ussRemoveShot
241d : 3044            >  leax ssShotY,u               ;Update sprite Y coordinate
                       >  mGet_D_from_fixed
241f : ec84            >  ldd ,x
                       >
2421 : 6802            >  asl 2,x
2423 : 59              >  rolb
2424 : 49              >  rola
                       >
2425 : 6802            >  asl 2,x
2427 : 59              >  rolb
2428 : 49              >  rola
                       >
2429 : ed7e            >  std -2,s
242b : e648            >  ldb  ssShotVelocY,u
242d : 1d              >  sex
242e : e37e            >  addd -2,s
2430 : 1083fc40        >  cmpd #WorldTopY << Fixed
2434 : 2e03            >  bgt NotHitTopOfWorld0667
2436 : 7e2647          >    lbra  ussRemoveShot            ;Top of world hit, bransch to remove
2439 :                 >NotHitTopOfWorld0667:
                       >  mStore_D_as_fixed
2439 : 6f02            >  clr 2,x
                       >
243b : 47              >  asra
243c : 56              >  rorb
243d : 6602            >  ror 2,x
                       >
243f : 47              >  asra
2440 : 56              >  rorb
2441 : 6602            >  ror 2,x
                       >
2443 : ed84            >  std ,x
                       >
                        
                        
2445 : 10ae44             ldy ssShotY,u                 ;Collision shots vs level
2448 : ae41               ldx ssShotX,u
244a : bd2d93             jsr PointVsLevel
244d : 2403               bcc ussNoHit
244f : 7e2647               lbra ussRemoveShot          ;remove shot
2452 :                  ussNoHit:
                        
2452 : 109eca             ldy CurLevelEntry             ;Collision shots vs guns
2455 : 10ae24             ldy leGuns,y
2458 : 1027007b           lbeq ussNoGuns
245c : a6a0               lda ,y+                       ;load guncount
245e : a761               sta LocalGunCount,s
2460 : a7e4               sta LocalB1,s
2462 : dce7               ldd GunsActive
2464 :                  ussGunLoop:
2464 : 47                 asra
2465 : 56                 rorb
2466 : 2469               bcc ussNextGun
2468 : ed63               std LocalW1,s
                          mPointVsArea GunArea,ussGunMiss, ssShotX,ssShotY, geGunX,geGunY
246a : ae41            >  ldx      ssShotX,u
246c : eca4            >  ldd      geGunX,y
246e : 830007          >  subd    #GunArea/2
2471 : ed7e            >  std -2,s
2473 : ac7e            >  cmpx -2,s
2475 : 102d0056        >  lblt    ussGunMiss
2479 : c3000e          >  addd    #GunArea
247c : ed7e            >  std -2,s
247e : ac7e            >  cmpx -2,s
2480 : 102e004b        >  lbgt    ussGunMiss
2484 : ae44            >  ldx     ssShotY,u
2486 : ec22            >  ldd     geGunY,y
2488 : 830007          >  subd    #GunArea/2
248b : ed7e            >  std -2,s
248d : ac7e            >  cmpx -2,s
248f : 102d003c        >  lblt    ussGunMiss
2493 : c3000e          >  addd    #GunArea
2496 : ed7e            >  std -2,s
2498 : ac7e            >  cmpx -2,s
249a : 102e0031        >  lbgt    ussGunMiss
                        
249e : a661                 lda LocalGunCount,s         ;hit, clear active bit of gun
24a0 : a0e4                 suba LocalB1,s
                            mClearWordBitA GunsActive
24a2 : a77f            >  sta -1,s
24a4 : ccffff          >  ldd #$ffff                  ;start with all bits set
24a7 : 1cfe            >  andcc #$fe                  ;clear carry flag, rolb will shift it into d
24a9 :                 >lop0671:                          ;rotate a zero into d
24a9 : 59              >  rolb
24aa : 49              >  rola
24ab : 6a7f            >  dec -1,s
24ad : 2afa            >  bpl lop0671
24af : 94e7            >  anda GunsActive                  ;D now has a hole in it, AND with GunsActive to clear bit
24b1 : d4e8            >  andb GunsActive+1
24b3 : dde7            >  std GunsActive
                        
                        
24b5 : e661                 ldb LocalGunCount,s         ;gun index
24b7 : e0e4                 subb LocalB1,s
                            mEmitFx FxTargetGun,FxTypeDotShatter,b
                       >  if ('b'!='0') && ('b'!='b')
                       >    tfr b,b
                       >  endif
24b9 : 8602            >  lda #FxTargetGun | (FxTypeDotShatter<<4)
24bb : bd06bc          >  jsr EmitFx
                        
                        
24be : e661                 ldb LocalGunCount,s         ;gun index
24c0 : e0e4                 subb LocalB1,s
                            mEmitFx FxTargetGun,FxTypeScore750,b
                       >  if ('b'!='0') && ('b'!='b')
                       >    tfr b,b
                       >  endif
24c2 : 8652            >  lda #FxTargetGun | (FxTypeScore750<<4)
24c4 : bd06bc          >  jsr EmitFx
                        
                        
                            mGiveScore 750
24c7 : 864b            >  lda #750 / 10
24c9 : bd1ad0          >  jsr GiveScoreA
                        
24cc : 7e2647               jmp ussRemoveShot           ;remove shot
24cf :                  ussGunMiss:
24cf : ec63               ldd LocalW1,s
24d1 :                  ussNextGun:
24d1 : 3125               leay GunEntry,y
24d3 : 6ae4               dec LocalB1,s
24d5 : 268d               bne ussGunLoop
24d7 :                  ussNoGuns:
                        
                        
24d7 : 109eca             ldy CurLevelEntry             ;Collision shots vs fuel
24da : 10ae26             ldy leFuel,y
24dd : 276d               beq ussNoFuel
24df : a6a0               lda ,y+                       ;load count
24e1 : a761               sta LocalFuelCount,s
24e3 : 4f                 clra
24e4 : d6e9               ldb FuelActive
24e6 :                  ussFuelLoop:
24e6 : 57                 asrb
24e7 : 245c               bcc ussNextFuel
24e9 : ed63               std LocalW1,s
                          mPointVsArea FuelArea,ussFuelMiss, ssShotX,ssShotY, 0,2
24eb : ae41            >  ldx      ssShotX,u
24ed : eca4            >  ldd      0,y
24ef : 83000c          >  subd    #FuelArea/2
24f2 : ed7e            >  std -2,s
24f4 : ac7e            >  cmpx -2,s
24f6 : 102d0049        >  lblt    ussFuelMiss
24fa : c30018          >  addd    #FuelArea
24fd : ed7e            >  std -2,s
24ff : ac7e            >  cmpx -2,s
2501 : 102e003e        >  lbgt    ussFuelMiss
2505 : ae44            >  ldx     ssShotY,u
2507 : ec22            >  ldd     2,y
2509 : 83000c          >  subd    #FuelArea/2
250c : ed7e            >  std -2,s
250e : ac7e            >  cmpx -2,s
2510 : 102d002f        >  lblt    ussFuelMiss
2514 : c30018          >  addd    #FuelArea
2517 : ed7e            >  std -2,s
2519 : ac7e            >  cmpx -2,s
251b : 102e0024        >  lbgt    ussFuelMiss
                        
251f : a663                 lda LocalW1,s               ;hit, clear active bit of fuel
                            mClearBitA FuelActive
2521 : c6ff            >  ldb #255                    ;start with all bits set
2523 : 1cfe            >  andcc #$fe                  ;clear carry flag, rolb will shift it into b
2525 :                 >lop0676:                          ;rotate a zero into b
2525 : 59              >  rolb
2526 : 4a              >  deca
2527 : 2afc            >  bpl lop0676
2529 : d4e9            >  andb FuelActive                   ;b now has a hole in it, AND with FuelActive to clear bit
252b : d7e9            >  stb FuelActive
                        
                        
252d : e663                 ldb LocalW1,s               ;fuel cell index
                            mEmitFx FxTargetFuel,FxTypeDotShatter,b
                       >  if ('b'!='0') && ('b'!='b')
                       >    tfr b,b
                       >  endif
252f : 8604            >  lda #FxTargetFuel | (FxTypeDotShatter<<4)
2531 : bd06bc          >  jsr EmitFx
                        
                        
2534 : e663                 ldb LocalW1,s               ;fuel cell index
                            mEmitFx FxTargetFuel,FxTypeScore150,b
                       >  if ('b'!='0') && ('b'!='b')
                       >    tfr b,b
                       >  endif
2536 : 8634            >  lda #FxTargetFuel | (FxTypeScore150<<4)
2538 : bd06bc          >  jsr EmitFx
                        
                        
                            mGiveScore 150
253b : 860f            >  lda #150 / 10
253d : bd1ad0          >  jsr GiveScoreA
                        
2540 : 7e2647               jmp ussRemoveShot           ;remove shot
2543 :                  ussFuelMiss:
2543 : ec63               ldd LocalW1,s
2545 :                  ussNextFuel:
2545 : 3124               leay FuelEntry,y
2547 : 4c                 inca
2548 : a161               cmpa LocalFuelCount,s
254a : 269a               bne ussFuelLoop
254c :                  ussNoFuel:
                        
254c : 109eca             ldy CurLevelEntry             ;Collision shot vs powerplant
254f : 312c               leay lePowerX,y
                          mPointVsArea PlantArea,ussPowerMiss, ssShotX,ssShotY, 0,2
2551 : ae41            >  ldx      ssShotX,u
2553 : eca4            >  ldd      0,y
2555 : 83000c          >  subd    #PlantArea/2
2558 : ed7e            >  std -2,s
255a : ac7e            >  cmpx -2,s
255c : 102d0042        >  lblt    ussPowerMiss
2560 : c30018          >  addd    #PlantArea
2563 : ed7e            >  std -2,s
2565 : ac7e            >  cmpx -2,s
2567 : 102e0037        >  lbgt    ussPowerMiss
256b : ae44            >  ldx     ssShotY,u
256d : ec22            >  ldd     2,y
256f : 83000c          >  subd    #PlantArea/2
2572 : ed7e            >  std -2,s
2574 : ac7e            >  cmpx -2,s
2576 : 102d0028        >  lblt    ussPowerMiss
257a : c30018          >  addd    #PlantArea
257d : ed7e            >  std -2,s
257f : ac7e            >  cmpx -2,s
2581 : 102e001d        >  lbgt    ussPowerMiss
                        
                            mEmitFx FxTargetPlant,FxTypeDotShatter,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
2585 : 8603            >  lda #FxTargetPlant | (FxTypeDotShatter<<4)
2587 : bd06bc          >  jsr EmitFx
                        
258a : 96f3                 lda PowerLife
258c : 2b11                 bmi ussPowerDead
258e : 1f89                   tfr a,b
2590 : 4a                     deca                      ;decrease powerplant hitpoints
2591 : 8101                   cmpa #1
2593 : 2602                   bne ussStorePower
2595 : 86f6                     lda #-10                ;Start planet explode countdown
2597 :                  ussStorePower:
2597 : 97f3                   sta PowerLife
                        
                              ;one hit when powerlife 15 =  1 second wait
                              ;             "          1 = 30 seconds wait
2599 : 50                     negb                      ;disable guns for a while
259a : cb10                   addb #16
259c : 58                     aslb
259d : d7f4                   stb PowerShot
259f :                  ussPowerDead:
259f : 7e2647               lbra ussRemoveShot           ;remove shot
25a2 :                  ussPowerMiss:
                        
                        
25a2 : 109eca             ldy CurLevelEntry             ;Collision shots vs switches
25a5 : 96f2               lda DoorCounter
25a7 : 2659               bne ussNoSwitches             ;skip check if door is not closed
25a9 : 10aea814           ldy leSwitches,y
25ad : a6a0               lda ,y+                       ;load count
25af : 2751               beq ussNoSwitches
25b1 : a761               sta LocalCount,s
25b3 : 4f                 clra
25b4 :                  ussSwitchLoop:
25b4 : a7e4               sta LocalB1,s
                          mPointVsArea SwitchArea,ussNextSwitch, ssShotX,ssShotY, seSwitchX,seSwitchY
25b6 : ae41            >  ldx      ssShotX,u
25b8 : eca4            >  ldd      seSwitchX,y
25ba : 830005          >  subd    #SwitchArea/2
25bd : ed7e            >  std -2,s
25bf : ac7e            >  cmpx -2,s
25c1 : 102d0034        >  lblt    ussNextSwitch
25c5 : c3000a          >  addd    #SwitchArea
25c8 : ed7e            >  std -2,s
25ca : ac7e            >  cmpx -2,s
25cc : 102e0029        >  lbgt    ussNextSwitch
25d0 : ae44            >  ldx     ssShotY,u
25d2 : ec22            >  ldd     seSwitchY,y
25d4 : 830005          >  subd    #SwitchArea/2
25d7 : ed7e            >  std -2,s
25d9 : ac7e            >  cmpx -2,s
25db : 102d001a        >  lblt    ussNextSwitch
25df : c3000a          >  addd    #SwitchArea
25e2 : ed7e            >  std -2,s
25e4 : ac7e            >  cmpx -2,s
25e6 : 102e000f        >  lbgt    ussNextSwitch
                        
                            mSetByte DoorCounter,1      ;hit, open doors
                       > if 0=1      
                       >   clr DoorCounter
                       > else
25ea : 8601            >   lda #1      
25ec : 97f2            >   sta DoorCounter
                       > endif
                        
                        
25ee : a6e4                 lda LocalB1,s
                            mEmitFx FxTargetSwitch,FxTypeDotShatter,a
                       >  if ('a'!='0') && ('a'!='b')
25f0 : 1f89            >    tfr a,b
                       >  endif
25f2 : 8605            >  lda #FxTargetSwitch | (FxTypeDotShatter<<4)
25f4 : bd06bc          >  jsr EmitFx
                        
                        
25f7 : 204e                 bra ussRemoveShot           ;remove shot
25f9 :                  ussNextSwitch:
25f9 : a6e4               lda LocalB1,s
25fb : 3125               leay SwitchEntry,y
25fd : 4c                 inca
25fe : a161               cmpa LocalCount,s
2600 : 26b2               bne ussSwitchLoop
2602 :                  ussNoSwitches:
                        
                        
                          mTestFlag HasOrbFlag          ;shots vs pod
                       >  if 255>HasOrbFlag          
2602 : 96e5            >    lda GameFlags1
2604 : 8504            >    bita #HasOrbFlag          
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag          )>>8
                       >  endif
                        
2606 : 273d               beq ussPodMiss
2608 : 108ec8bf           ldy #PodX
                          mPointVsArea PodArea,ussPodMiss, ssShotX,ssShotY, 0, 2
260c : ae41            >  ldx      ssShotX,u
260e : eca4            >  ldd      0,y
2610 : 830003          >  subd    #PodArea/2
2613 : ed7e            >  std -2,s
2615 : ac7e            >  cmpx -2,s
2617 : 102d002a        >  lblt    ussPodMiss
261b : c30006          >  addd    #PodArea
261e : ed7e            >  std -2,s
2620 : ac7e            >  cmpx -2,s
2622 : 102e001f        >  lbgt    ussPodMiss
2626 : ae44            >  ldx     ssShotY,u
2628 : ec22            >  ldd      2,y
262a : 830003          >  subd    #PodArea/2
262d : ed7e            >  std -2,s
262f : ac7e            >  cmpx -2,s
2631 : 102d0010        >  lblt    ussPodMiss
2635 : c30006          >  addd    #PodArea
2638 : ed7e            >  std -2,s
263a : ac7e            >  cmpx -2,s
263c : 102e0005        >  lbgt    ussPodMiss
                        
2640 : bd2af8             jsr ExplodeShip
2643 : 2002               bra ussRemoveShot
2645 :                  ussPodMiss:
                        
                        
2645 : 2002               bra ussNext
                        
2647 :                  ussRemoveShot:
2647 : 6fc4               clr ssShotActive,u            ;remove shot
                        
2649 :                  ussNext:
2649 : a662               lda LocalB3,s                 ;restore loop index
264b : 3349               leau ShipShotEntry,u
264d : 4a                 deca
264e : 1026fd95           bne ussLoop
                        
                          mFreeLocals
2652 : 3267            >  leas FrameSize,s
                        
                          direct -1
2654 : 39                 rts
                        
                        
                        
                        ;*****************
2655 :                  DrawShipShots:
                          ;DP must be D0
                          mDecLocals 2,1
                       >  nolist
                        
0000 =                  LocalTempX = LocalB1
0001 =                  LocalTempY = LocalB2
                        
2657 : cec91c             ldu #ShipShotList             ;Draw all active shots.
265a : 8604               lda #ShipShotCount
265c :                  dssLoop:
265c : ed62               std LocalW1,s
265e : 6dc4               tst ssShotActive,u
2660 : 261c               bne dssActive
2662 :                  dssNext:
2662 : 3349               leau ShipShotEntry,u
2664 : ec62               ldd LocalW1,s
2666 : 4a                 deca
2667 : 26f3               bne dssLoop
2669 : 207712             lbra dssFin
                        
266c :                  dssTestRemove:
266c : 10830164           cmpd #256 + 100               ;remove if too far off-screen
2670 : 2c08               bge dssRemove
2672 : 1083ff9c           cmpd #-100
2676 : 2d02               blt dssRemove
2678 : 20e8               bra dssNext
267a :                  dssRemove:
267a : 6fc4               clr ssShotActive,u            ;remove shot
267c : 20e4               bra dssNext
                        
267e :                  dssActive:
                          ;X coord
                          mGetScreenX ssShotX,u
                       >  if  2 = 0    ;no param, X holds X-coord
                       >    tfr x,y
                       >  endif
                       >  if  2 = 1
                       >    ldy     ssShotX
                       >  endif
                       >  if  2 = 2   ;as09 treats "2,y" as two separate macro arguments
267e : 10ae41          >    ldy     ssShotX,u
                       >  endif
2681 : bec8c6          >  ldx     ViewX
2684 : 1f20            >  tfr     y,d
2686 : af7e            >  stx -2,s
2688 : a37e            >  subd -2,s
268a : 2c0a            >  bge     L1430701
268c : fcc8cd          >  ldd     CurLevelEndX
                       >;  stx -2,s
268f : a37e            >  subd -2,s
2691 : 10af7e          >  sty -2,s
2694 : e37e            >  addd -2,s
2696 :                 >L1430701:
                        
2696 : 2bd4               bmi dssTestRemove  ;offscreen, skip
2698 : 4d                 tsta
2699 : 26d1               bne dssTestRemove  ;offscreen, skip
                        
269b : c080               subb #128
269d : e7e4               stb LocalTempX,s
                        
                          ;Y coord
269f : ec44               ldd ssShotY,u
26a1 : b3c8c8             subd ViewY
26a4 : 2bbc               bmi dssNext  ;offscreen, skip
26a6 : 4d                 tsta
26a7 : 26b9               bne dssNext  ;offscreen, skip
                        
26a9 : e761               stb LocalTempY,s
26ab : bdf354             jsr reset0ref                 ;this shot should be drawn, reset pen
                          mSetScale $7f                 ;Scale $7f is required for move_pen_d to reach whole screen
                       >  if 1=1
26ae : 867f            >    lda #$7f                                   ;if argument exists, load into a, otherwise use current a
                       >  endif
26b0 : 9704            >  sta <$04
                        
                        
                          mSetIntensity $50
                       >  if 1=1
26b2 : 8650            >    lda   #$50            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
26b4 : 9701            >  sta   <01
26b6 : cc0401          >  ldd   #$0401
26b9 : 9700            >  sta   <00
26bb : d700            >  stb   <00
                        
26bd : a661               lda LocalTempY,s
                        
26bf : 40                 nega
26c0 : 8b7f               adda #127
26c2 : e6e4               ldb LocalTempX,s
                        
                          mMove_pen_d_Quick
26c4 : 9701            >  sta   <0x01
26c6 : 0f00            >  clr   <0x00
26c8 : 86ce            >  lda   #0xCE
26ca : 970c            >  sta   <0x0C
26cc : 0f0a            >  clr   <0x0A
26ce : 0c00            >  inc   <0x00
26d0 : d701            >  stb   <0x01
26d2 : 0f05            >  clr   <0x05
26d4 : c640            >  ldb   #0x40
26d6 : d50d            >PF33D0704: bitb  <0x0D
26d8 : 27fc            >  beq   PF33D0704
                       >;PF33B0704: lda   #0x04
                       >;PF3410704: deca
                       >;  bne   PF3410704
                        
                          mDot_at_current_position 1
                       >  ; From vectrex.txt
                       >  ;    "(WARNING! high intensity and long Vec_Dot_Dwell might result in a burn in on
                       >  ;     your vectrex monitor, be carefull while experimenting with this!)"
26da : 86ff            >       lda   #0xFF
26dc : 970a            >       sta   <0x0A
                       >;       ldb   #1         ;1 is a value for how long the dot is lit
                       >;PF2CC0705: decb                     ;dwell is not the same as intensity
                       >;       bne   PF2CC0705
26de : 0f0a            >       clr   <0x0A
                        
                        ;  jsr DrawBulletAtCurrentPosition
26e0 : 2080               bra dssNext
                        
26e2 :                  dssFin:
                        
                          mFreeLocals
26e2 : 3264            >  leas FrameSize,s
                        
26e4 : 39                 rts
                        
                        
                        
                        ;*****************
                          if false
                        ClipTest:
                            ldd ViewX
                            std _clip_xmin
                            addd #256
                            std _clip_xmax
                        
                            ldd ViewY
                            std _clip_ymin
                            addd #256
                            std _clip_ymax
                        
                            ldd #(TileH*1)  ;offset y
                            std ,--s
                            ldd #(TileW*6)  ;offset x
                            std ,--s
                            ldd #DrawList
                            std ,--s
                            ldd #TestLines
                            std ,--s
                            jsr     _CohenSutherlandClip    ;CALL: (VOIDmode) _CohenSutherlandClip (11 bytes)
                            leas  8,s
                        
                            ;end of drawlist
                            ldy #DrawList+6
                            clr ,y
                            mSetByte NeedRefresh,1
                          rts
                        TestLines:
                          db 1  ;linecount
                          db 2  ;linetype, 0=vert, 1=horiz, 2=slope
                          db (TileW * 5),((TileH/2) * 5)  ;x0,y0
                          db 0,0  ;x1,y1
                          endif
                        
                        
                        ;*****************
26e5 :                  OnLoseLife:
                        ;         dec Lives, beq GameOver
                        ;         om Fuel=0, beq GameOver
                        ;         else RestartLevel
                          direct $c8
                        
26e5 : 967a               lda GameMode
26e7 : 8103               cmpa #BonusGame
26e9 : 2726               beq ollGameOver
                        
26eb : 0d6a               tst CheatLives
26ed : 260b               bne ollCheating
26ef : 96e0                 lda ShipLives
26f1 : 271e                 beq ollGameOver
26f3 : 4a                   deca
26f4 : 97e0                 sta ShipLives
26f6 : dce1                 ldd ShipFuel
26f8 : 2717                 beq ollGameOver
26fa :                  ollCheating:
                        
26fa : 4f                 clra
26fb : 97f5               sta PerfectBonus              ;no perfect bonus
                        
                          ;if planet destroyed, exit mission
26fd : 0df3               tst PowerLife
26ff : 2a0b               bpl ollPlanetOk
                        
                          mClearFlag HasOrbFlag
                       >  if 255>HasOrbFlag
2701 : 86fb            >    lda #~HasOrbFlag
2703 : 94e5            >    anda GameFlags1
2705 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~((HasOrbFlag)>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
2707 : bd2922             jsr OnExitLevel
                        
270a : 200b               bra ollExit
270c :                  ollPlanetOk:
270c : bd2777             jsr RestartLevel
270f : 2006               bra ollExit
2711 :                  ollGameOver:
                          mSetFlag GameOverFlag
                       >  if 255>GameOverFlag
2711 : 8640            >    lda #GameOverFlag
2713 : 9ae5            >    ora GameFlags1
2715 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(GameOverFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
2717 :                  ollExit:
                        
                          direct -1
2717 : 39                 rts
                        
                        
                        ;*****************
2718 :                  ViewShipCenter:                 ;Set view with ship in screen center
                          direct $c8
2718 : dcac               ldd CenterX
271a : 830080             subd #TileCountX / 2 * TileW
271d : 2a02               bpl vscXOk
271f : d3cd                 addd CurLevelEndX
2721 :                  vscXOk:
2721 : ddc6               std ViewX
                        
2723 : dcaf               ldd CenterY
2725 : 830080             subd #TileCountY / 2 * TileH
2728 : 1093cf             cmpd CurLevelEndY
272b : 2d02               blt vscYOk
272d : dccf                 ldd CurLevelEndY
272f :                  vscYOk:
272f : ddc8               std ViewY
                        
                          mSetByte NeedRefresh,1
                       > if 0=1
                       >   clr NeedRefresh
                       > else
2731 : 8601            >   lda #1
2733 : 97c5            >   sta NeedRefresh
                       > endif
                        
                          mSetByte ScrollX,0
                       > if 0=0
2735 : 0fc3            >   clr ScrollX
                       > else
                       >   lda #0
                       >   sta ScrollX
                       > endif
                        
                          mSetByte ScrollY,0
                       > if 0=0
2737 : 0fc4            >   clr ScrollY
                       > else
                       >   lda #0
                       >   sta ScrollY
                       > endif
                        
                          direct -1
2739 : 39                 rts
                        
                        
                        ;*****************
273a :                  ResetShip:                      ;Resets ship state
                          direct $c8
                          mClearFlag (InactiveFlag | RefuelFlag | ShieldFlag | PullFlag)
                       >  if 255>(InactiveFlag | RefuelFlag | ShieldFlag | PullFlag)
273a : 86e4            >    lda #~(InactiveFlag | RefuelFlag | ShieldFlag | PullFlag)
273c : 94e5            >    anda GameFlags1
273e : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~(((InactiveFlag | RefuelFlag | ShieldFlag | PullFlag))>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                        
                          ;Original Thrust have a slight angle on the towbar when restarting with pod attached
000f =                  AlphaInitAdjust = (ALPHA_MAX/16)
                        
                          ;Init ship direction up or down depending on gravity
                          mTestFlag ReverseGravFlag
                       >  if 255>ReverseGravFlag
2740 : 96e5            >    lda GameFlags1
2742 : 8580            >    bita #ReverseGravFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ReverseGravFlag)>>8
                       >  endif
                        
2744 : 260a               bne rsAngleDown
2746 : 8608               lda #8
2748 : 97b6               sta ShipAngle
274a : 864b               lda #(ALPHA_MAX/4) + AlphaInitAdjust
274c : 97b2               sta AlphaHi
274e : 2008               bra rsAngleEnd
2750 :                  rsAngleDown:
2750 : 8618               lda #8 + SHIP_DIRMAX/2
2752 : 97b6               sta ShipAngle
2754 : 86c3               lda #ALPHA_MAX/4 + ALPHA_MAX/2 + AlphaInitAdjust
2756 : 97b2               sta AlphaHi
2758 :                  rsAngleEnd:
                        
2758 : 4f                 clra
2759 : 5f                 clrb
275a : ddb4               std AlphaDelta
275c : ddb7               std ShipSpeedX
275e : ddb9               std ShipSpeedY
                        
                          ;mSetFlag HasOrbFlag          ;uncomment to always start with orb
                        
                          ;Warp-in effect
                          mSetFlag InactiveFlag         ;disable ship movement
                       >  if 255>InactiveFlag         
2760 : 8610            >    lda #InactiveFlag         
2762 : 9ae5            >    ora GameFlags1
2764 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(InactiveFlag         )>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                          mEmitFx FxTargetShip,FxTypeWarpIn,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
2766 : 8660            >  lda #FxTargetShip | (FxTypeWarpIn<<4)
2768 : bd06bc          >  jsr EmitFx
                        
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
276b : 96e5            >    lda GameFlags1
276d : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
276f : 2705               beq rsNoPod
                            mEmitFx FxTargetPod,FxTypeWarpIn,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
2771 : 8661            >  lda #FxTargetPod | (FxTypeWarpIn<<4)
2773 : bd06bc          >  jsr EmitFx
                        
2776 :                  rsNoPod:
                          direct -1
2776 : 39                 rts
                        
                        
                        ;*****************
2777 :                  RestartLevel:
                          mDecLocals 5,0,0
                       >  nolist
                        
                          direct $c8
0001 =                  LocalShipTileX = LocalB2
0002 =                  LocalShipTileY = LocalB3
0003 =                  LocalBest = LocalB4             ;best diff
0004 =                  LocalBestI = LocalB5            ;best index in restart list
                        
                          mClearFlag InactiveFlag
                       >  if 255>InactiveFlag
2779 : 86ef            >    lda #~InactiveFlag
277b : 94e5            >    anda GameFlags1
277d : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~((InactiveFlag)>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
                        
277f : dcaf               ldd CenterY                   ;find restart point closest to last ship position
2781 : 2a03               bpl rsPositiveY
2783 : cc0000               ldd #0
2786 :                  rsPositiveY:
                          mDivTileH
                       >  if TileH > 32
                       >    asra
                       >    rorb
                       >  endif
                       >  if TileH > 16
2786 : 47              >    asra
2787 : 56              >    rorb
                       >  endif
                       >  if TileH > 8
2788 : 47              >    asra
2789 : 56              >    rorb
                       >  endif
                       >  if TileH > 4
278a : 47              >    asra
278b : 56              >    rorb
                       >  endif
                       >  if TileH > 2
278c : 47              >    asra
278d : 56              >    rorb
                       >  endif
                       >  if TileH > 1
278e : 47              >    asra
278f : 56              >    rorb
                       >  endif
                        
2790 : e762               stb LocalShipTileY,s
                        
2792 : dcac               ldd CenterX
                          mDivTileW
                       >  if TileW > 32
                       >    asra
                       >    rorb
                       >  endif
                       >  if TileW > 16
2794 : 47              >    asra
2795 : 56              >    rorb
                       >  endif
                       >  if TileW > 8
2796 : 47              >    asra
2797 : 56              >    rorb
                       >  endif
                       >  if TileW > 4
2798 : 47              >    asra
2799 : 56              >    rorb
                       >  endif
                       >  if TileW > 2
279a : 47              >    asra
279b : 56              >    rorb
                       >  endif
                       >  if TileW > 1
279c : 47              >    asra
279d : 56              >    rorb
                       >  endif
                        
279e : e761               stb LocalShipTileX,s
                        
27a0 : 8678               lda #120
27a2 : a763               sta LocalBest,s
                        
27a4 : deca               ldu CurLevelEntry
27a6 : eec810             ldu leRestart,u
27a9 : e6c0               ldb ,u+
27ab : e7e4               stb LocalB1,s
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
27ad : 96e5            >    lda GameFlags1
27af : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
27b1 : 2702               beq *+4
                            ;Use different defaults for haspod
27b3 : c601                 ldb #1
27b5 : e764               stb LocalBestI,s
27b7 :                  rlPosLoop:
27b7 : e641               ldb 1,u                       ;compare abs(restartY - shipY) + abs(restartX - shipX), lowest is the winner
27b9 : e062               subb LocalShipTileY,s
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
27bb : 96e5            >    lda GameFlags1
27bd : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
27bf : 2606               bne rlHasOrb
                            ;no pod, only consider points with lower y (closer to planet surface)
                            ;if none found, use the first in list
27c1 : 5a                   decb ;0 is also ok
27c2 : 50                   negb
27c3 : 2b1a                 bmi rlNext
27c5 : 2003                 bra rlStoreYDiff
27c7 :                  rlHasOrb:
                            ;pod, only consider points with higher y (closer to pod base)
                            ;if none found, use the last in list (requires that the deepest restartpoint is last)
27c7 : 5d                   tstb
27c8 : 2b15                 bmi rlNext
27ca :                  rlStoreYDiff:
27ca : e77f               stb -1,s
                        
27cc : a6c4               lda ,u
27ce : a061               suba LocalShipTileX,s
27d0 : 2a01               bpl rlPosX
27d2 : 40                   nega
27d3 :                  rlPosX:
27d3 : ab7f               adda -1,s
                        
27d5 : a163               cmpa LocalBest,s
27d7 : 2c06               bge rlNext
27d9 : a763                 sta LocalBest,s
27db : a6e4                 lda LocalB1,s
27dd : a764                 sta LocalBestI,s
27df :                  rlNext:
27df : 3342               leau 2,u
27e1 : 6ae4               dec LocalB1,s
27e3 : 26d2               bne rlPosLoop
                        
                          ;keep pod if more than screenh from PodY
27e5 : deca               ldu CurLevelEntry
27e7 : ec4a               ldd leOrbY,u
27e9 : 93af               subd CenterY
27eb : 10830080           cmpd #ScreenH/2
27ef : 2c06               bge rsKeepPod
                            mClearFlag HasOrbFlag
                       >  if 255>HasOrbFlag
27f1 : 86fb            >    lda #~HasOrbFlag
27f3 : 94e5            >    anda GameFlags1
27f5 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #~((HasOrbFlag)>>8)
                       >    anda GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
27f7 :                  rsKeepPod:
                        
27f7 : deca               ldu CurLevelEntry
27f9 : eec810             ldu leRestart,u
27fc : a6c0               lda ,u+
27fe : a064               suba LocalBestI,s
2800 : 48                 lsla
2801 : 33c6               leau a,u
2803 : e6c0               ldb ,u+
2805 : 8620               lda #TileW
2807 : 3d                 mul
2808 : c30010             addd #TileW/2  ;center within tile
280b : ddac               std CenterX
280d : e6c0               ldb ,u+
280f : 8620               lda #TileH
2811 : 3d                 mul
2812 : c30010             addd #TileH/2  ;center within tile
2815 : ddaf               std CenterY
                        
                          mSetByte GunShotActive,0
                       > if 0=0
2817 : 0ff6            >   clr GunShotActive
                       > else
                       >   lda #0
                       >   sta GunShotActive
                       > endif
                        
                        
2819 : bd273a             jsr ResetShip
281c : bd1228             jsr Ship_UpdateShipPodPos
281f : bd2718             jsr ViewShipCenter
                        
                          mFreeLocals
2822 : 3265            >  leas FrameSize,s
                        
                          direct -1
2824 : 39                 rts
                        
                        ;*****************
2825 :                  SplitLevelNo:                     ;returns levello in A, levelhi i B
2825 : 8e283b             ldx #LevelCounts
2828 : b6c87a             lda GameMode
282b : 3086               leax a,x
282d : b6c8d1             lda CurLevel
2830 : 5f                 clrb
2831 :                  splLoop:
2831 : a184               cmpa ,x
2833 : 2d05               blt splExit
2835 : a084               suba ,x
2837 : 5c                 incb
2838 : 20f7               bra splLoop
283a :                  splExit:
283a : 39                 rts
283b : 060808           LevelCounts: db LevelCountNormal,LevelCount,LevelCount
                        
                        ;*****************
283e :                  PrepareLevel:                   ;Calculate level constants
                          mDecLocals 1,0,0
                       >  nolist
                        
0000 =                  LocalLevelLo = LocalB1
                          direct $c8
                        
2840 : 8ec8e5             ldx #LevelClearLabel
2843 : bdf545             jsr clear_256_bytes           ;Clear buffer
                        
2846 : 8ddd               bsr SplitLevelNo
2848 : a7e4               sta LocalLevelLo,s
284a : c501               bitb #1                       ;reverse on 1 and 3
284c : 2706               beq plNoReverse
                            mSetFlag ReverseGravFlag
                       >  if 255>ReverseGravFlag
284e : 8680            >    lda #ReverseGravFlag
2850 : 9ae5            >    ora GameFlags1
2852 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(ReverseGravFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
2854 :                  plNoReverse:
                        
2854 : c102               cmpb #2                       ;landscape invisible on 2 and 3
2856 : 2506               blo plNoNoLand
                            mSetFlag NoLandscapeFlag
                       >  if 255>NoLandscapeFlag
                       >    lda #NoLandscapeFlag
                       >    ora GameFlags1
                       >    sta GameFlags1
                       >  else
2858 : 8601            >    lda #(NoLandscapeFlag)>>8
285a : 9ae6            >    ora GameFlags2
285c : 97e6            >    sta GameFlags2
                       >  endif
                        
285e :                  plNoNoLand:
                        
285e : 967a               lda GameMode
2860 : 8101               cmpa #HardGame
2862 : 2606               bne plNoHard
                            mSetFlag HomingGunShotsFlag
                       >  if 255>HomingGunShotsFlag
                       >    lda #HomingGunShotsFlag
                       >    ora GameFlags1
                       >    sta GameFlags1
                       >  else
2864 : 8602            >    lda #(HomingGunShotsFlag)>>8
2866 : 9ae6            >    ora GameFlags2
2868 : 97e6            >    sta GameFlags2
                       >  endif
                        
286a :                  plNoHard:
                        
286a : a6e4               lda LocalLevelLo,s
286c : 8e3108             ldx #Levels
286f : c616               ldb #LevelEntry               ;size of levelentry
2871 : 3d                 mul
2872 : 3410               pshs x
2874 : e3e1               addd ,s++
2876 : 1f01               tfr d,x                       ;x is now levelentry
                        
2878 : 9fca               stx CurLevelEntry
                        
                          mSetWord GunsActive,$ffff     ;all guns active
                       > if 0=$ffff     
                       >   clra
                       >   clrb
                       > else
287a : ccffff          >   ldd #$ffff     
                       > endif
287d : dde7            > std GunsActive
                        
                          mSetByte FuelActive,$ff       ;all fuelpods active
                       > if 0=$ff       
                       >   clr FuelActive
                       > else
287f : 86ff            >   lda #$ff       
2881 : 97e9            >   sta FuelActive
                       > endif
                        
                        
                          mSetByte PowerLife,15         ;hitpoints for powerplant
                       > if 0=15         
                       >   clr PowerLife
                       > else
2883 : 860f            >   lda #15         
2885 : 97f3            >   sta PowerLife
                       > endif
                        
                        
2887 : a6e4               lda LocalLevelLo,s            ;1500 + (levelno * 100)
2889 : 8b0f               adda #15
288b : 97f5               sta PerfectBonus              ;init perfect bonus, decreases when shield is used
                        
288d : cec8ea             ldu #FuelAmounts              ;all fuelpods full
2890 : 8610               lda #FullFuel
2892 : c608               ldb #MaxFuelCount
2894 :                  plFuel:
2894 : a7c0               sta ,u+
2896 : 5a                 decb
2897 : 26fb               bne plFuel
                        
2899 : a684               lda leSizeX,x
289b : 97cc               sta CurLevelSizeX
                        
289d : 96cc               lda CurLevelSizeX
289f : c620               ldb #TileW
28a1 : 3d                 mul
28a2 : ddcd               std CurLevelEndX              ;CurLevelEndX = (CurLevelSizeX * TileW)
                        
28a4 : a601               lda leSizeY,x
28a6 : c620               ldb #TileH
28a8 : 3d                 mul
28a9 : 830100             subd #ScreenH
28ac : ddcf               std CurLevelEndY              ;CurLevelEndY = largest View Y
                        
                          ;Gun shot constants
                          ;Make guns fire more often on higher levels
                        
                          ;GunDelayMask = modeconstant >> (levello >> 1)
28ae : 967a               lda GameMode
28b0 : 8e291c             ldx #GunDelayMasks
28b3 : a686               lda a,x
28b5 : e6e4               ldb LocalLevelLo,s
28b7 : 57                 asrb
28b8 :                  plGunMaskLoop:
28b8 : 5d                 tstb
28b9 : 2708               beq plStoreGunDelayMask
28bb : 8107               cmpa #7
28bd : 2704               beq plStoreGunDelayMask
28bf : 47                 asra
28c0 : 5a                 decb
28c1 : 20f5               bra plGunMaskLoop
28c3 :                  plStoreGunDelayMask:
28c3 : 97f8               sta GunShotMask
                        
                          ;GunDelay = modeconstant - (levello * 8)
28c5 : 967a               lda GameMode
28c7 : 8e2919             ldx #GunDelays
28ca : a686               lda a,x
28cc : e6e4               ldb LocalLevelLo,s
28ce :                  plGunDelayLoop:
28ce : 5d                 tstb
28cf : 2708               beq plStoreGunDelay
28d1 : 4d                 tsta
28d2 : 2705               beq plStoreGunDelay
28d4 : 8008               suba #8
28d6 : 5a                 decb
28d7 : 20f5               bra plGunDelayLoop
28d9 :                  plStoreGunDelay:
28d9 : 97f9               sta GunShotDelay
                        
                          ;GunShotSpeed = modeconstant + (levello >> 1)
28db : 967a               lda GameMode
28dd : 8e291f             ldx #GunShotSpeeds
28e0 : a686               lda a,x
28e2 : e6e4               ldb LocalLevelLo,s
28e4 : 57                 asrb
28e5 :                  plGunSpeedLoop:
28e5 : 5d                 tstb
28e6 : 2708               beq plStoreGunSpeed
28e8 : 8118               cmpa #24
28ea : 2c04               bge plStoreGunSpeed
28ec : 4c                 inca
28ed : 5a                 decb
28ee : 20f5               bra plGunSpeedLoop
28f0 :                  plStoreGunSpeed:
28f0 : 97fa               sta GunShotSpeed
                        
                          ;Set ship start position
                          ;use first restart point
28f2 : deca               ldu CurLevelEntry
28f4 : eec810             ldu leRestart,u
28f7 : a6c0               lda ,u+
28f9 : e6c0               ldb ,u+
28fb : 8620               lda #TileW
28fd : 3d                 mul
28fe : c30010             addd #TileW/2  ;center within tile
2901 : ddac               std CenterX
2903 : e6c0               ldb ,u+
2905 : 8620               lda #TileH
2907 : 3d                 mul
2908 : c30010             addd #TileH/2  ;center within tile
290b : ddaf               std CenterY
                        
290d : bd273a             jsr ResetShip
2910 : bd1228             jsr Ship_UpdateShipPodPos
2913 : bd2718             jsr ViewShipCenter
                        
                          direct -1
                          mFreeLocals
2916 : 3261            >  leas FrameSize,s
                        
2918 : 39                 rts
                        
                        ;Gun fire delay for each game mode
2919 : 302030           GunDelays: db 48,32,48   ;multiple of 8
291c : 3f0f3f           GunDelayMasks: db 63,15,63
                        ;Gun shot speeds for each game mode
291f : 181218           GunShotSpeeds: db 24,18,24
                        
                        
                        ;*****************
2922 :                  OnExitLevel:
                          direct $c8
                        
2922 : 96da               lda DemoMode
2924 : 2a08               bpl oelNoDemo
                            mSetFlag GameOverFlag
                       >  if 255>GameOverFlag
2926 : 8640            >    lda #GameOverFlag
2928 : 9ae5            >    ora GameFlags1
292a : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(GameOverFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
292c : 203c                 bra oelExit
292e :                  oelNoDemo:
                        
292e : bd4f96             jsr Text_LevelExit
2931 : 2634               bne oelIncomplete
                        
2933 : 0cd1               inc CurLevel
                        
2935 : bd2825             bsr SplitLevelNo              ;check if new round
2938 : 4d                 tsta
2939 : 2627               bne oelNoSpecial
293b : 5d                 tstb
293c : 2724               beq oelNoSpecial              ;only display text on first level on each round
293e : c101                 cmpb #1
2940 : 2606                 bne oelNoGrav
2942 : 4f                     clra
2943 : bd5249                 jsr Text_Special          ;display 'reverse gravity'
2946 : 201a                   bra oelNoSpecial
2948 :                  oelNoGrav:
2948 : c102                 cmpb #2
294a : 2607                 bne oelNoNoLand
294c : 8601                   lda #1
294e : bd5249                 jsr Text_Special          ;display 'invisible landscape'
2951 : 200f                   bra oelNoSpecial
2953 :                  oelNoNoLand:
2953 : c103                 cmpb #3
2955 : 270b                 beq oelNoSpecial            ;b=3: both reverse and invisible, no message
2957 : bd5435               jsr Text_ShowWellDone       ;b=4: game completed
                            mSetFlag GameOverFlag
                       >  if 255>GameOverFlag
295a : 8640            >    lda #GameOverFlag
295c : 9ae5            >    ora GameFlags1
295e : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(GameOverFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
2960 : 2008                 bra oelExit
2962 :                  oelNoSpecial:
                        
2962 : bd283e             bsr PrepareLevel
2965 : 2003               bra oelExit
                        
2967 :                  oelIncomplete:
2967 : bd2777             bsr RestartLevel
                        
296a :                  oelExit:
                        
                          direct -1
296a : 39                 rts
                        
                        
                        ;*****************
296b :                  InitNewGame:    ;a <> 0 skip random reset
                          direct $c8
                        
296b : 4d                 tsta
296c : 260d               bne ingNoResetRnd
                            ;Reset random seeds
                            ;This is important for demo-playback and recording
                            mSetByte LoopCounterLow,0
                       > if 0=0
296e : 0f26            >   clr LoopCounterLow
                       > else
                       >   lda #0
                       >   sta LoopCounterLow
                       > endif
                        
                            mSetByte FrameCounter,0
                       > if 0=0
2970 : 0fe4            >   clr FrameCounter
                       > else
                       >   lda #0
                       >   sta FrameCounter
                       > endif
                        
2972 : 9e7b                 ldx $C87B
                            mCombine d,$ae,$77
2974 : ccae77          >  ldd #(lo $ae)<<8 | (lo $77)
                        
2977 : ed84                 std ,x
2979 : a702                 sta 2,x
297b :                  ingNoResetRnd:
                        
297b : 8ec8a0             ldx #UserRamStart
297e : bdf545             jsr clear_256_bytes   ;Clear buffer
                        
2981 : bdf272             jsr clear_sound_chip
                        
2984 : cc03e8             ldd #1000
2987 : dde1               std ShipFuel
                        
                          ;normal = 2
                          mSetByte ShipLives,2
                       > if 0=2
                       >   clr ShipLives
                       > else
2989 : 8602            >   lda #2
298b : 97e0            >   sta ShipLives
                       > endif
                        
                        
298d : 8ec8da             ldx #PlayerScore
2990 : cc2020             ldd #'  '
2993 : ed81               std ,x++
2995 : ed81               std ,x++
2997 : ed84               std ,x
                        
2999 : 967a               lda GameMode
299b : 8104               cmpa #DemoGame
299d : 2618               bne ingNoDemo
                            ;Init demo game
299f : 0f7a                 clr GameMode
                            mSetByte DemoMode,-1        ;set flag that this is demogame
                       > if 0=-1        
                       >   clr DemoMode
                       > else
29a1 : 86ff            >   lda #-1        
29a3 : 97da            >   sta DemoMode
                       > endif
                        
29a5 : 966c                 lda DemoSelected
29a7 : 48                   lsla
29a8 : 8e1517               ldx #DemoList
29ab : ae86                 ldx a,x
29ad : 9fdb                 stx DemoPtr
                            mSetByte DemoCounter,0
                       > if 0=0
29af : 0fdd            >   clr DemoCounter
                       > else
                       >   lda #0
                       >   sta DemoCounter
                       > endif
                        
29b1 : a684                 lda ,x                      ;read startlevel from demodata
29b3 : 97d1                 sta CurLevel
29b5 : 200e                 bra ingExit
29b7 :                  ingNoDemo:
29b7 : 8102                 cmpa #TimeAttackGame
29b9 : 2604                 bne ingNoTimeAttack
29bb : c64b                 ldb #75                     ;init timeattack
29bd : d7e3                 stb TimeAttackTime
29bf :                  ingNoTimeAttack:
29bf : 8600                 lda #StartLevel
29c1 : 9b6b                 adda CheatLevel
29c3 : 97d1                 sta CurLevel
29c5 :                  ingExit:
                        
                          direct -1
29c5 : 39                 rts
                        
                        
                        ;*****************
0004 =                  ScrollSpeed=4
004c =                  BorderWidth=76          ;Distance of ship to screen border before scrolling starts
0064 =                  EndBorderWidth=100      ;Distance ship<->border when scrolling stops
                        
29c6 :                  SetView:
                          direct $c8
                          mDecLocals 2,0,0
                       >  nolist
                        
0000 =                  LocalScreenX = LocalB1
0001 =                  LocalScreenY = LocalB2
                        
29c8 : dcc3               ldd ScrollX           ;load both scrollx/y
29ca : 2704               beq svNoRefresh       ;zero if not scrolling
                            mSetByte NeedRefresh,1
                       > if 0=1
                       >   clr NeedRefresh
                       > else
29cc : 8601            >   lda #1
29ce : 97c5            >   sta NeedRefresh
                       > endif
                        
29d0 :                  svNoRefresh:
                        
                          ;update scroll x
                        
29d0 : 9ebb               ldx ShipX
                          mGetScreenX
                       >  if  0 = 0    ;no param, X holds X-coord
29d2 : 1f12            >    tfr x,y
                       >  endif
                       >  if  0 = 1
                       >    ldy     
                       >  endif
                       >  if  0 = 2   ;as09 treats "2,y" as two separate macro arguments
                       >    ldy     ,
                       >  endif
29d4 : 9ec6            >  ldx     ViewX
29d6 : 1f20            >  tfr     y,d
29d8 : af7e            >  stx -2,s
29da : a37e            >  subd -2,s
29dc : 2c09            >  bge     L1430781
29de : dccd            >  ldd     CurLevelEndX
                       >;  stx -2,s
29e0 : a37e            >  subd -2,s
29e2 : 10af7e          >  sty -2,s
29e5 : e37e            >  addd -2,s
29e7 :                 >L1430781:
                        
29e7 : e7e4               stb LocalScreenX,s
                          ;b holds screen x
                        
29e9 : 0dc3               tst ScrollX
29eb : 2727               beq svScrollXFin
29ed : 2a11               bpl svScrollRight
                            ;scroll left
29ef : c19c                 cmpb #256-EndBorderWidth
29f1 : 2502                 blo *+4
29f3 : 0fc3                   clr ScrollX
29f5 : dcc6                 ldd ViewX
29f7 : 830004               subd #ScrollSpeed
29fa : 2a16                 bpl svStoreX
29fc : d3cd                 addd CurLevelEndX
29fe : 2012                 bra svStoreX
2a00 :                  svScrollRight:
2a00 : c164                 cmpb #EndBorderWidth
2a02 : 2202                 bhi *+4
2a04 : 0fc3                   clr ScrollX
2a06 : dcc6                 ldd ViewX
2a08 : c30004               addd #ScrollSpeed
2a0b : 1093cd               cmpd CurLevelEndX
2a0e : 2502                 blo svStoreX
2a10 : 93cd                 subd CurLevelEndX
2a12 :                  svStoreX:
2a12 : ddc6               std ViewX
2a14 :                  svScrollXFin:
                        
                          ;update scroll y
                        
2a14 : dcbd               ldd ShipY
2a16 : 93c8               subd ViewY
2a18 : e761               stb LocalScreenY,s
                          ;b holds screen y
                        
2a1a : 9ec8               ldx ViewY
2a1c : 0dc4               tst ScrollY
2a1e : 2724               beq svScrollYFin
2a20 : 2a12               bpl svScrollDown
                            ;scroll up
2a22 : c19c                 cmpb #256-EndBorderWidth
2a24 : 2502                 blo *+4
2a26 : 0fc4                   clr ScrollY
2a28 : 301c                 leax -ScrollSpeed,x
2a2a : 8cff10               cmpx #WorldTopY
2a2d : 2e13                 bgt svStoreY
2a2f : 8eff10               ldx #WorldTopY
2a32 : 200e                 bra svStoreY
2a34 :                  svScrollDown:
2a34 : c164                 cmpb #EndBorderWidth
2a36 : 2202                 bhi *+4
2a38 : 0fc4                   clr ScrollY
2a3a : 3004                 leax ScrollSpeed,x
2a3c : 9ccf                 cmpx CurLevelEndY
2a3e : 2d02                 blt svStoreY
2a40 : 9ecf                 ldx CurLevelEndY
2a42 :                  svStoreY:
2a42 : 9fc8               stx ViewY
2a44 :                  svScrollYFin:
                        
                          ;test if need to start scrolling
                        
2a44 : 0dc3               tst ScrollX
2a46 : 2616               bne svEndCheckScrollX
2a48 : e6e4                 ldb LocalScreenX,s
2a4a : c1b4                 cmpb #256 - BorderWidth  ;right edge
2a4c : 2206                 bhi svSetScrollRight
2a4e : c14c                 cmpb #BorderWidth        ;left edge
2a50 : 2508                 blo svSetScrollLeft
2a52 : 200a                 bra svEndCheckScrollX
2a54 :                  svSetScrollRight:
                            mSetByte ScrollX, 1
                       > if 0= 1
                       >   clr ScrollX
                       > else
2a54 : 8601            >   lda # 1
2a56 : 97c3            >   sta ScrollX
                       > endif
                        
2a58 : 2004                 bra svEndCheckScrollX
2a5a :                  svSetScrollLeft:
                            mSetByte ScrollX, -1
                       > if 0= -1
                       >   clr ScrollX
                       > else
2a5a : 86ff            >   lda # -1
2a5c : 97c3            >   sta ScrollX
                       > endif
                        
2a5e :                  svEndCheckScrollX:
                        
2a5e : 0dc4               tst ScrollY
2a60 : 2616               bne svEndCheckScrollY
2a62 : e661                 ldb LocalScreenY,s
2a64 : c1b4                 cmpb #256 - BorderWidth  ;bottom edge
2a66 : 2206                 bhi svSetScrollDown
2a68 : c14c                 cmpb #BorderWidth        ;top edge
2a6a : 2508                 blo svSetScrollUp
2a6c : 200a                 bra svEndCheckScrollY
2a6e :                  svSetScrollDown:
                            mSetByte ScrollY, 1
                       > if 0= 1
                       >   clr ScrollY
                       > else
2a6e : 8601            >   lda # 1
2a70 : 97c4            >   sta ScrollY
                       > endif
                        
2a72 : 2004                 bra svEndCheckScrollY
2a74 :                  svSetScrollUp:
                            mSetByte ScrollY, -1
                       > if 0= -1
                       >   clr ScrollY
                       > else
2a74 : 86ff            >   lda # -1
2a76 : 97c4            >   sta ScrollY
                       > endif
                        
2a78 :                  svEndCheckScrollY:
                        
                          mFreeLocals
2a78 : 3262            >  leas FrameSize,s
                        
                          direct -1
2a7a : 39                 rts
                        
                        
                        
                        ;*****************
2a7b :                  DrawLevel:
                          ;DP must be D0
                          mDecLocals 1,0,0
                       >  nolist
                        
0000 =                  LocalInt = LocalB1
                        
2a7d : 8ec946             ldx #DrawList
2a80 : 8630               lda #WallIntensity
2a82 : a7e4               sta LocalInt,s
                        
                          mTestFlag NoLandscapeFlag
                       >  if 255>NoLandscapeFlag
                       >    lda GameFlags1
                       >    bita #NoLandscapeFlag
                       >  else
2a84 : b6c8e6          >    lda GameFlags2
2a87 : 8501            >    bita #(NoLandscapeFlag)>>8
                       >  endif
                        
2a89 : 2709               beq dlNormal
                            ;If no landscape, only draw when shield is used
                            mTestFlag ShieldFlag
                       >  if 255>ShieldFlag
2a8b : b6c8e5          >    lda GameFlags1
2a8e : 8501            >    bita #ShieldFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(ShieldFlag)>>8
                       >  endif
                        
2a90 : 2602                 bne dlNormal
2a92 : 6fe4                 clr LocalInt,s
2a94 :                  dlNormal:
2a94 : a6e4               lda LocalInt,s
2a96 : 8d03               bsr GoDrawList
                        
                          mFreeLocals
2a98 : 3261            >  leas FrameSize,s
                        
2a9a : 39                 rts
                        
                        
                        ;*****************
2a9b :                  GoDrawList:                     ;x=drawlist, a=intensity
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
2a9b : 9701            >  sta   <01
2a9d : cc0401          >  ldd   #$0401
2aa0 : 9700            >  sta   <00
2aa2 : d700            >  stb   <00
                        
                          mSetScale $7f       ;Scale $7f is required for move_pen_d to reach whole screen
                       >  if 1=1
2aa4 : 867f            >    lda #$7f                         ;if argument exists, load into a, otherwise use current a
                       >  endif
2aa6 : 9704            >  sta <$04
                        
                        
2aa8 :                  dlLoop:
2aa8 : a680               lda ,x+
2aaa : 274b               beq dlFinish
2aac : 2c2e               bge dlLine
                        
                          ;setpen
                        
                          ;reset0ref inlined
2aae : cc00cc             ldd   #0x00CC
2ab1 : d70c               stb   <0x0C
2ab3 : 970a               sta   <0x0A
2ab5 : cc0302             ldd   #0x0302
2ab8 : 0f01               clr   <0x01
2aba : 9700               sta   <0x00
2abc : d700               stb   <0x00
                        ;  stb   <0x00
2abe : c601               ldb   #0x01
2ac0 : d700               stb   <0x00
                        
2ac2 : ec81               ldd ,x++
                          mMove_pen_d_Quick
2ac4 : 9701            >  sta   <0x01
2ac6 : 0f00            >  clr   <0x00
2ac8 : 86ce            >  lda   #0xCE
2aca : 970c            >  sta   <0x0C
2acc : 0f0a            >  clr   <0x0A
2ace : 0c00            >  inc   <0x00
2ad0 : d701            >  stb   <0x01
2ad2 : 0f05            >  clr   <0x05
2ad4 : c640            >  ldb   #0x40
2ad6 : d50d            >PF33D0805: bitb  <0x0D
2ad8 : 27fc            >  beq   PF33D0805
                       >;PF33B0805: lda   #0x04
                       >;PF3410805: deca
                       >;  bne   PF3410805
                        
                        
2ada : 20cc               bra dlLoop
                        
2adc :                  dlLine:
                          ;Optimize: Lines could be scaled down (scale 7f/2, length asla b)
                          ;This would require no line length larger than 63, doors have larger lines
                        
2adc : ec81               ldd ,x++
                          mDrawToD
2ade : 9701            >  sta   <$01
2ae0 : 0f00            >  clr   <$00
                       >;  leax  2,x
                       >  ;Ev. måste flera nop läggas till här för att kompensera att föregående rad
                       >  ;kommenterats bort
                       >;  nop
2ae2 : 0c00            >  inc   <$00
2ae4 : d701            >  stb   <$01
2ae6 : ccff00          >  ldd   #$FF00
2ae9 : 970a            >  sta   <$0A
2aeb : d705            >  stb   <$05
2aed : 8640            >  lda   #$40
2aef :                 >wait10806:
2aef : 950d            >  bita  <$0D
2af1 : 27fc            >  beq   wait10806
                       >;  nop
2af3 : d70a            >  stb   <$0A
                        
                        
2af5 : 20b1               bra dlLoop
                        
2af7 :                  dlFinish:
2af7 : 39                 rts
                        
                        
                         if false
                        mTestTile macro XX,YY
                           db -1, 127 - (YY*TileH), -127 + (XX*TileW)
                           db 1, -TileH, 0
                           db 1, 0, TileW
                         endm
                        
                        mTestOneRow macro YY
                         mTestTile 0,YY
                         mTestTile 1,YY
                         mTestTile 2,YY
                         mTestTile 3,YY
                         mTestTile 4,YY
                         mTestTile 5,YY
                         mTestTile 6,YY
                         mTestTile 7,YY
                         mTestTile 8,YY
                         endm
                        
                        testdrawlist:
                          mTestOneRow 0
                          mTestOneRow 1
                          mTestOneRow 2
                          mTestOneRow 3
                          mTestOneRow 4
                          mTestOneRow 5
                          mTestOneRow 6
                          mTestOneRow 7
                        ;  db -1, 127,-127   ;set pen
                        ;  db 1,  -50,50     ;draw line
                        ;  db -1, -120,-120   ;set pen
                        ;  db 1,  25,50     ;draw line
                          db 0             ;end list
                         endif
                        
                        
                        
                        ;*****************
2af8 :                  ExplodeShip:
                          if Immortal=0
                            mTestFlag InactiveFlag      ;do nothing if already exploding
                       >  if 255>InactiveFlag      
2af8 : b6c8e5          >    lda GameFlags1
2afb : 8510            >    bita #InactiveFlag      
                       >  else
                       >    lda GameFlags2
                       >    bita #(InactiveFlag      )>>8
                       >  endif
                        
2afd : 2619                 bne exsExit
                            mTestFlag HasOrbFlag        ;explode orb also if carried
                       >  if 255>HasOrbFlag        
2aff : b6c8e5          >    lda GameFlags1
2b02 : 8504            >    bita #HasOrbFlag        
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag        )>>8
                       >  endif
                        
2b04 : 2705                 beq exsNoPod
                              mEmitFx FxTargetPod,FxTypeDotShatter,0
                       >  if ('0'!='0') && ('0'!='b')
                       >    tfr 0,b
                       >  endif
2b06 : 8601            >  lda #FxTargetPod | (FxTypeDotShatter<<4)
2b08 : bd06bc          >  jsr EmitFx
                        
2b0b :                  exsNoPod:
                            mEmitFx FxTargetShip,FxTypeDotShatter,b
                       >  if ('b'!='0') && ('b'!='b')
                       >    tfr b,b
                       >  endif
2b0b : 8600            >  lda #FxTargetShip | (FxTypeDotShatter<<4)
2b0d : bd06bc          >  jsr EmitFx
                        
                            mSetFlag InactiveFlag       ;disable ship movement
                       >  if 255>InactiveFlag       
2b10 : 8610            >    lda #InactiveFlag       
2b12 : bac8e5          >    ora GameFlags1
2b15 : b7c8e5          >    sta GameFlags1
                       >  else
                       >    lda #(InactiveFlag       )>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
2b18 :                  exsExit:
                          endif
2b18 : 39                 rts
                        
                        
                        ;*****************
2b19 :                  RefreshDrawList:
                          direct $c8
                        
                          ;refresh DrawList-memory with lines from tiles in the current level
2b19 : 0dc5               tst NeedRefresh
2b1b : 2601               bne rdBegin
2b1d : 39                   rts ;quick exit if refresh not needed
                        
2b1e :                  rdBegin:
                         ; tileWX,tileWY
                         ; loop x until tileWX is larger than viewX+256
                         ;   if tileWX,tileWY is within screen (viewX/Y + 256)
                         ;     copy the lines directly
                         ;   else
                         ;     clip the lines
                          mDecLocals 2,4
                       >  nolist
                        
0006 =                  LocalViewY = LocalW3
0008 =                  LocalEndY = LocalW4             ;Highest world y coord that is on screen
                        
                          ;set up clipping region
2b20 : dcc6               ldd ViewX
2b22 : ddd2               std _clip_xmin
2b24 : c300ff             addd #255
2b27 : ddd6               std _clip_xmax
2b29 : dcc8               ldd ViewY
2b2b : ddd4               std _clip_ymin
2b2d : c300ff             addd #255
2b30 : ddd8               std _clip_ymax
                        
2b32 : dcc8               ldd ViewY                     ;setup y-coords, test for empty space (negative y)
2b34 : 2a20               bpl rdNoEmptySpace
2b36 : cc0000               ldd #0                      ;empty space at top of screen, adjust start coords
2b39 : ed66                 std LocalViewY,s
2b3b : 4c                   inca
2b3c : d3c8                 addd ViewY
2b3e : ed68                 std LocalEndY,s             ;end = 0 + 256 + viewY (viewY is negative)
2b40 : cc007f               ldd #127                    ;calc start screen y coord
2b43 : d3c8                 addd ViewY
2b45 : 1083ff80             cmpd #-128
2b49 : 2f04                 ble rdNothingToDraw
2b4b : d7a2                 stb TempPosY
2b4d : 2014                 bra rdYCoordsFin
2b4f :                  rdNothingToDraw:                ;no tiles are visible, only empty space
2b4f : 108ec946             ldy #DrawList
2b53 : 7e2c88               lbra rdEndList
2b56 :                  rdNoEmptySpace:                 ;normal case, no empty space
2b56 : ed66               std LocalViewY,s
2b58 : 4c                 inca
2b59 : ed68               std LocalEndY,s
2b5b : ec66               ldd LocalViewY,s              ;calc start screen y coord
2b5d : c41f               andb #TileH-1
2b5f : cb7f               addb #127
2b61 : d7a2               stb TempPosY
2b63 :                  rdYCoordsFin:
                        
2b63 : 10ae66             ldy LocalViewY,s
2b66 : 9ec6               ldx ViewX
                          mGetLevelTile
                       >  ;calc tile pointer: x = tiles + (CurLevelSizeX * (WorldY div TileH)) + (WorldX div TileW)
2b68 : 1f10            >  tfr x,d               ;x
                       >  mDivTileW
                       >  if TileW > 32
                       >    asra
                       >    rorb
                       >  endif
                       >  if TileW > 16
2b6a : 47              >    asra
2b6b : 56              >    rorb
                       >  endif
                       >  if TileW > 8
2b6c : 47              >    asra
2b6d : 56              >    rorb
                       >  endif
                       >  if TileW > 4
2b6e : 47              >    asra
2b6f : 56              >    rorb
                       >  endif
                       >  if TileW > 2
2b70 : 47              >    asra
2b71 : 56              >    rorb
                       >  endif
                       >  if TileW > 1
2b72 : 47              >    asra
2b73 : 56              >    rorb
                       >  endif
                       >
2b74 : 9eca            >  ldx CurLevelEntry
2b76 : ae02            >  ldx leTiles,x
2b78 : 3a              >  abx
2b79 : 1f20            >  tfr y,d               ;y
                       >  mDivTileH
                       >  if TileH > 32
                       >    asra
                       >    rorb
                       >  endif
                       >  if TileH > 16
2b7b : 47              >    asra
2b7c : 56              >    rorb
                       >  endif
                       >  if TileH > 8
2b7d : 47              >    asra
2b7e : 56              >    rorb
                       >  endif
                       >  if TileH > 4
2b7f : 47              >    asra
2b80 : 56              >    rorb
                       >  endif
                       >  if TileH > 2
2b81 : 47              >    asra
2b82 : 56              >    rorb
                       >  endif
                       >  if TileH > 1
2b83 : 47              >    asra
2b84 : 56              >    rorb
                       >  endif
                       >
2b85 : 96cc            >  lda CurLevelSizeX
2b87 : 3d              >  mul
2b88 : 308b            >  leax d,x
                        
                          ;x=tile pointer
2b8a : 9fa9               stx TempTilePtr
                        
                          ;see if view spans over right edge of level
2b8c : d6cc               ldb CurLevelSizeX
2b8e : 1d                 sex
2b8f : ede3               std ,--s
2b91 : dcc6               ldd ViewX
                          mDivTileW  ;optimize: this value is already calced
                       >  if TileW > 32
                       >    asra
                       >    rorb
                       >  endif
                       >  if TileW > 16
2b93 : 47              >    asra
2b94 : 56              >    rorb
                       >  endif
                       >  if TileW > 8
2b95 : 47              >    asra
2b96 : 56              >    rorb
                       >  endif
                       >  if TileW > 4
2b97 : 47              >    asra
2b98 : 56              >    rorb
                       >  endif
                       >  if TileW > 2
2b99 : 47              >    asra
2b9a : 56              >    rorb
                       >  endif
                       >  if TileW > 1
2b9b : 47              >    asra
2b9c : 56              >    rorb
                       >  endif
                        
2b9d : c30009             addd #TileCountX+1
2ba0 : a3e1               subd ,s++
2ba2 : 2a04               bpl rdNeedAdjust
2ba4 : 86ff                 lda #-1  ;no adjust needed
2ba6 : 2006                 bra rdStoreAdjust
2ba8 :                  rdNeedAdjust:
2ba8 : 8609                 lda #TileCountX+1
2baa : e7e2                 stb ,-s
2bac : a0e0                 suba ,s+
2bae :                  rdStoreAdjust:
                          ;TempAdjustX = nr of tiles on row before edge, -1 = no wrap
2bae : 97ab               sta TempAdjustX
                        
                          ;calc start world coords for first partly visible tile
2bb0 : ec66               ldd LocalViewY,s
2bb2 : c4e0               andb #~(TileH-1)
2bb4 : dda3               std TempTileWY
                        
2bb6 : dcc6               ldd ViewX
2bb8 : c4e0               andb #~(TileW-1)
2bba : dda5               std TempTileWX
2bbc : dda7               std TempTileWXStart
                        
                        
                        
                          ;0123456701234567
                          ;       X
                          ;calc screen x coord for first unclipped tile
2bbe : dcc6               ldd ViewX
2bc0 : c41f               andb #TileW-1
2bc2 : 2701               beq rdZeroX
2bc4 : 50                 negb
2bc5 :                  rdZeroX:
2bc5 : c080               subb #128
2bc7 : d7a1               stb TempPosX
2bc9 : d7a0               stb TempPosXStart
                        
2bcb : 108ec946           ldy #DrawList
                        
2bcf : c609               ldb #TileCountY+1
2bd1 :                  rsYLoop:
2bd1 : e7e4               stb LocalB1,s
                        
2bd3 : 96ab                 lda TempAdjustX
2bd5 : c609                 ldb #TileCountX+1
2bd7 :                  rsXLoop:
2bd7 : ed62                 std LocalW1,s
                        
2bd9 : e680                 ldb ,x+                     ;get tile
2bdb : 2765                 beq rdNextTile              ;0 = no tile
2bdd : c520                 bitb #32                    ;>=32 = special tiles without lines (solid, doorarea)
2bdf : 2661                 bne rdNextTile
                        
                            ;u = tilepointer
2be1 : 8606                 lda #TileEntry
2be3 : 3d                   mul
2be4 : ce2ec2               ldu #TileTable
2be7 : 33cb                 leau d,u
                        
                            ;test if tile needs clipping
2be9 : dca5                 ldd TempTileWX
2beb : 93c6                 subd ViewX
2bed : 2b3b                 bmi rdNeedClip              ;TileX < ViewX
2bef : 108300df             cmpd #255-TileW             ;TileXEnd > ViewX + 256
2bf3 : 2c35                 bge rdNeedClip
                        
2bf5 : dca3                 ldd TempTileWY
2bf7 : a366                 subd LocalViewY,s
2bf9 : 2b2f                 bmi rdNeedClip              ;TileY < ViewY
                        
2bfb : 96a2                 lda TempPosY
2bfd : 81a0                 cmpa #-(128 - TileH)
2bff : 2f29                 ble rdNeedClip              ;ScreenY >= end of screen - tileh
                        
                            ;unclipped tile
                            ;x = lines rel
2c01 : af64                 stx LocalW2,s
2c03 : aec4                 ldx teLinesRel,u
                        
                            ;set pen
2c05 : 86ff                 lda #-1
2c07 : a7a0                 sta ,y+
2c09 : 96a2                 lda TempPosY
2c0b : ab80                 adda ,x+
2c0d : a7a0                 sta ,y+                     ;write y coord
2c0f : 96a1                 lda TempPosX
2c11 : ab80                 adda ,x+
2c13 : a7a0                 sta ,y+                     ;write x coord
                        
2c15 : a680                 lda ,x+                     ;copy lines to drawlist
2c17 :                  rdLop1:
2c17 : a761                 sta LocalB2,s
2c19 : c601                 ldb #1
2c1b : e7a0                 stb ,y+
2c1d : ec81                 ldd ,x++
2c1f : eda1                 std ,y++
2c21 : a661                 lda LocalB2,s
2c23 : 4a                   deca
2c24 : 26f1                 bne rdLop1
                        
2c26 : ae64                 ldx LocalW2,s
2c28 : 2018                 bra rdNextTile
                        
2c2a :                  rdNeedClip:
                            ;clip tile
                            ;entry: y=drawlist, u=tile entry
2c2a : ec42                 ldd teLinesAbs,u
                        ;    beq  rdNextTile     ;**safety, remove when all tiles have abs lines
                        
2c2c : dca3                 ldd TempTileWY      ;offset y
2c2e : ede3                 std ,--s
2c30 : dca5                 ldd TempTileWX      ;offset x
2c32 : ede3                 std ,--s
2c34 : 10afe3               sty ,--s            ;pointer to drawlist
2c37 : ec42                 ldd teLinesAbs,u
2c39 : ede3                 std ,--s            ;pointer to lines
2c3b : bd00ba               jsr _CohenSutherlandClip
2c3e : 3268                 leas  8,s           ;Clean stack
2c40 : 31ab                 leay d,y            ;d = nr of bytes written, add to drawlist pointer
                        
2c42 :                  rdNextTile:
2c42 : dca5                 ldd TempTileWX              ;update tile world pos
2c44 : c30020               addd #TileW
2c47 : dda5                 std TempTileWX
                        
2c49 : 96a1                 lda TempPosX                ;update screen pos
2c4b : 8b20                 adda #TileW
2c4d : 97a1                 sta TempPosX
                        
2c4f : ec62                 ldd LocalW1,s
2c51 : 4a                   deca
2c52 : 2605                 bne rsNotYetAdjust
                              ;tileptr have crossed right edge of level
                              ;x = x - one row
2c54 : 96cc                   lda CurLevelSizeX
                              ;deca
2c56 : 40                     nega
2c57 : 3086                   leax a,x
                              ;leave a negative value in A, it will not adjust again in this row
2c59 :                  rsNotYetAdjust:
2c59 : 5a                   decb
2c5a : 1026ff79             bne rsXLoop
                        
                          ;next row
                        
2c5e : dca7               ldd TempTileWXStart           ;reset tile world x
2c60 : dda5               std TempTileWX
                        
2c62 : dca3               ldd TempTileWY                ;update tile world y
2c64 : c30020             addd #TileH
2c67 : dda3               std TempTileWY
                        
                        ;  cmpd CurLevelEndY             ;if tilewy is off-world then finish
                        ;  bgt rdEndList
                        
2c69 : ec68               ldd LocalEndY,s               ;if tilewy is offscreen then we are finished
2c6b : 1093a3             cmpd TempTileWY
2c6e : 2f18               ble rdEndList
                        
2c70 : 9ea9               ldx TempTilePtr               ;next row, update tile level pointer
                        
2c72 : d6cc               ldb CurLevelSizeX
2c74 : 3a                 abx                           ;x=x+b
2c75 : 9fa9               stx TempTilePtr
                        
2c77 : 96a2               lda TempPosY                  ;next row, update screen y pos
2c79 : 8020               suba #TileH
2c7b : 97a2               sta TempPosY
                        
2c7d : 96a0               lda TempPosXStart
2c7f : 97a1               sta TempPosX
                        
2c81 : e6e4               ldb LocalB1,s
2c83 : 5a                 decb
2c84 : 1026ff49           bne rsYLoop
                        
2c88 :                  rdEndList:
2c88 : 8600               lda #0                        ;write end of drawlist
2c8a : a7a0               sta ,y+
                        
                          mSetByte NeedRefresh,0
                       > if 0=0
2c8c : 0fc5            >   clr NeedRefresh
                       > else
                       >   lda #0
                       >   sta NeedRefresh
                       > endif
                        
                        
                          mFreeLocals
2c8e : 326a            >  leas FrameSize,s
                        
                        
                          direct -1
2c90 : 39                 rts
                        
                        
                        ;*****************
2c91 :                  DrawStars:                      ;draw stars in empty space
2c91 : fcc8c8             ldd ViewY
2c94 : 2b01               bmi dstOk
2c96 : 39                   rts                         ;no empty space is visible, exit
2c97 :                  dstOk:
                          mDecLocals 6,3,3
                       >  nolist
                        
0000 =                  LocalYRange = LocalB1           ;height of starfield visible from top of screen
0001 =                  LocalScreenX = LocalB2
0002 =                  LocalScreenY = LocalB3
0003 =                  LocalSave = LocalB4
0004 =                  LocalInt = LocalB5
0004 =                  LocalDist = LocalB5
0006 =                  LocalYAdd = LocalW1
0008 =                  LocalXAdd = LocalW2
000a =                  LocalSaveSeed = LocalW3
                        
0014 =                  StarDensity = 20                ;nr of stars to draw
                        
2c99 : 50                 negb
2c9a : e7e4               stb LocalYRange,s
                        
2c9c : b6c826             lda LoopCounterLow            ;distort starfield with value from loopcounter
2c9f : 84c0               anda #64 + 128                ;the distortion also hides the bug that stars jump when crossing world x-wraparound ;-)
2ca1 : a764               sta LocalDist,s
                        
2ca3 : f6c8c9             ldb ViewY + 1
2ca6 : eb64               addb LocalDist,s
2ca8 : 4f                 clra
2ca9 : 3406               pshs d
2cab : cc0100             ldd #256
2cae : a3e1               subd ,s++
2cb0 : ed66               std LocalYAdd,s
                        
2cb2 : f6c8c7             ldb ViewX + 1
2cb5 : eb64               addb LocalDist,s
2cb7 : 4f                 clra
2cb8 : 3406               pshs d
2cba : cc0100             ldd #256
2cbd : a3e1               subd ,s++
2cbf : ed68               std LocalXAdd,s
                        
2cc1 : cce077             ldd #$E077                    ;reset random seed
2cc4 : ed6c               std LocalBuffer,s
2cc6 : 86eb               lda #%11101011
2cc8 : a76e               sta LocalBuffer+2,s
2cca : 336c               leau LocalBuffer,s
                          mSetRandomSeedToU LocalSaveSeed
                       >  if 1=1
2ccc : fcc87b          >    ldd $c87b
2ccf : ed6a            >    std LocalSaveSeed,s
                       >  endif
2cd1 : ffc87b          >  stu $c87b
                        
                        
2cd4 : 8614               lda #StarDensity
2cd6 :                  dstLoop:
2cd6 : a763               sta LocalSave,s
                        
                          mRandomToA
2cd8 : bdf511          >  jsr random                    ;call rom
                        
2cdb : a063               suba LocalSave,s              ;Add loop index to coord to avoid overdraw (rom rnd is poor)
2cdd : 1f89               tfr a,b
2cdf : 4f                 clra
2ce0 : e368               addd LocalXAdd,s
2ce2 : e761               stb LocalScreenX,s
                        
                          mRandomToA
2ce4 : bdf511          >  jsr random                    ;call rom
                        
2ce7 : ab63               adda LocalSave,s              ;Add loop index to coord to avoid overdraw (rom rnd is poor)
2ce9 : 1f89               tfr a,b
2ceb : 4f                 clra
2cec : e366               addd LocalYAdd,s
2cee : e762               stb LocalScreenY,s
                        
                          mRandomToA                    ;random intensity
2cf0 : bdf511          >  jsr random                    ;call rom
                        
2cf3 : 843f               anda #63
2cf5 : 3402               pshs a
2cf7 : 8654               lda #64 + 20
2cf9 : a0e0               suba ,s+
2cfb : a764               sta LocalInt,s
                        
2cfd : e662               ldb LocalScreenY,s
2cff : e1e4               cmpb LocalYRange,s
2d01 : 2251               bhi dstNext
                        
2d03 : bdf354             jsr reset0ref
                        
2d06 : e661               ldb LocalScreenX,s            ;vectrex screen transform
2d08 : c080               subb #128
2d0a : a662               lda LocalScreenY,s
2d0c : 40                 nega
2d0d : 8b7f               adda #127
                        
2d0f : a77f               sta -1,s
                          mSetScale $7f
                       >  if 1=1
2d11 : 867f            >    lda #$7f                  ;if argument exists, load into a, otherwise use current a
                       >  endif
2d13 : 9704            >  sta <$04
                        
2d15 : a67f               lda -1,s
                          mMove_pen_d_Quick
2d17 : 9701            >  sta   <0x01
2d19 : 0f00            >  clr   <0x00
2d1b : 86ce            >  lda   #0xCE
2d1d : 970c            >  sta   <0x0C
2d1f : 0f0a            >  clr   <0x0A
2d21 : 0c00            >  inc   <0x00
2d23 : d701            >  stb   <0x01
2d25 : 0f05            >  clr   <0x05
2d27 : c640            >  ldb   #0x40
2d29 : d50d            >PF33D0849: bitb  <0x0D
2d2b : 27fc            >  beq   PF33D0849
                       >;PF33B0849: lda   #0x04
                       >;PF3410849: deca
                       >;  bne   PF3410849
                        
                        
2d2d : a664               lda LocalInt,s
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
2d2f : 9701            >  sta   <01
2d31 : cc0401          >  ldd   #$0401
2d34 : 9700            >  sta   <00
2d36 : d700            >  stb   <00
                        
                        
2d38 : a66c               lda LocalBuffer,s
2d3a : 8518               bita #8 + 16
2d3c : 2708               beq dstNiceStar
                          mDot_at_current_position
                       >  ; From vectrex.txt
                       >  ;    "(WARNING! high intensity and long Vec_Dot_Dwell might result in a burn in on
                       >  ;     your vectrex monitor, be carefull while experimenting with this!)"
2d3e : 86ff            >       lda   #0xFF
2d40 : 970a            >       sta   <0x0A
                       >;       ldb   #         ; is a value for how long the dot is lit
                       >;PF2CC0851: decb                     ;dwell is not the same as intensity
                       >;       bne   PF2CC0851
2d42 : 0f0a            >       clr   <0x0A
                        
2d44 : 200e               bra dstNext
2d46 :                  dstNiceStar:
2d46 : b6c826             lda LoopCounterLow
2d49 : 47                 asra
2d4a : 47                 asra
2d4b : 47                 asra
2d4c : ab6c               adda LocalBuffer,s
2d4e : 8407               anda #7
2d50 : 4c                 inca
2d51 : bd225f             jsr DrawPlusAtCurrentPosition
                        
2d54 :                  dstNext:
2d54 : a663               lda LocalSave,s
2d56 : 4a                 deca
2d57 : 1026ff7b           bne dstLoop
                        
                          ;    if viewy<0
                          ;      yrange=abs(viewy)
                          ;    else
                          ;      exit
                          ;    yadd=256 - (viewy lo)
                          ;    xoff=viewx lo byte
                          ;    xadd=256 - xoff
                          ;    for 0 to starcount
                          ;      starX=random
                          ;      screenX=lo(starX + xadd)
                          ;      starY=random
                          ;      screenY=lo(starY + yadd)
                          ;      if screenY>yrange
                          ;        skip
                          ;      else
                          ;        set random intensity
                          ;        draw dot
                        
2d5b : ee6a               ldu LocalSaveSeed,s           ;restore old random seed
                          mSetRandomSeedToU
                       >  if 0=1
                       >    ldd $c87b
                       >    std ,s
                       >  endif
2d5d : ffc87b          >  stu $c87b
                        
                        
                          mFreeLocals
2d60 : 326f            >  leas FrameSize,s
                        
2d62 : 39                 rts
                        
                        
                        ;*****************
2d63 :                  RectVsLevel:                    ;u=ptr to left,right,top,bottom
0000 =                  LocalLeft=0
0002 =                  LocalRight=2
0004 =                  LocalTop=4
0006 =                  LocalBottom=6
                        
                        _mRvL macro xx,yy,last
                          ldx xx,u
                          ldy yy,u
                          pshs u
                          bsr PointVsLevel
                          puls u
                          bcs rvlExit
                         endm
                        
                          _mRvL LocalLeft,LocalTop
2d63 : aec4            >  ldx LocalLeft,u
2d65 : 10ae44          >  ldy LocalTop,u
2d68 : 3440            >  pshs u
2d6a : 8d27            >  bsr PointVsLevel
2d6c : 3540            >  puls u
2d6e : 2522            >  bcs rvlExit
                        
                          _mRvL LocalRight,LocalTop
2d70 : ae42            >  ldx LocalRight,u
2d72 : 10ae44          >  ldy LocalTop,u
2d75 : 3440            >  pshs u
2d77 : 8d1a            >  bsr PointVsLevel
2d79 : 3540            >  puls u
2d7b : 2515            >  bcs rvlExit
                        
                          _mRvL LocalLeft,LocalBottom
2d7d : aec4            >  ldx LocalLeft,u
2d7f : 10ae46          >  ldy LocalBottom,u
2d82 : 3440            >  pshs u
2d84 : 8d0d            >  bsr PointVsLevel
2d86 : 3540            >  puls u
2d88 : 2508            >  bcs rvlExit
                        
                        
                          ;Last point does not need to save u or branch
2d8a : ae42               ldx LocalRight,u
2d8c : 10ae46             ldy LocalBottom,u
2d8f : 200212             jmp PointVsLevel
                        
2d92 :                  rvlExit:
2d92 : 39                 rts
                        
                        
                        
                        ;*****************
2d93 :                  PointVsLevel:
                          ;x and y are coords to test
                          ;returns carry set if collision
                        
                          direct $c8
                        
2d93 : 1f20               tfr y,d
2d95 : 8580               bita #128                     ;Test for empty space (negative coord)
2d97 : 263c               bne tcEmpty
2d99 : c41f               andb #TileH-1
2d9b : d7a2               stb TempPosY
                        
2d9d : 1f10               tfr x,d
2d9f : c41f               andb #TileW-1
2da1 : d7a1               stb TempPosX
                        
                          mGetLevelTile
                       >  ;calc tile pointer: x = tiles + (CurLevelSizeX * (WorldY div TileH)) + (WorldX div TileW)
2da3 : 1f10            >  tfr x,d               ;x
                       >  mDivTileW
                       >  if TileW > 32
                       >    asra
                       >    rorb
                       >  endif
                       >  if TileW > 16
2da5 : 47              >    asra
2da6 : 56              >    rorb
                       >  endif
                       >  if TileW > 8
2da7 : 47              >    asra
2da8 : 56              >    rorb
                       >  endif
                       >  if TileW > 4
2da9 : 47              >    asra
2daa : 56              >    rorb
                       >  endif
                       >  if TileW > 2
2dab : 47              >    asra
2dac : 56              >    rorb
                       >  endif
                       >  if TileW > 1
2dad : 47              >    asra
2dae : 56              >    rorb
                       >  endif
                       >
2daf : 9eca            >  ldx CurLevelEntry
2db1 : ae02            >  ldx leTiles,x
2db3 : 3a              >  abx
2db4 : 1f20            >  tfr y,d               ;y
                       >  mDivTileH
                       >  if TileH > 32
                       >    asra
                       >    rorb
                       >  endif
                       >  if TileH > 16
2db6 : 47              >    asra
2db7 : 56              >    rorb
                       >  endif
                       >  if TileH > 8
2db8 : 47              >    asra
2db9 : 56              >    rorb
                       >  endif
                       >  if TileH > 4
2dba : 47              >    asra
2dbb : 56              >    rorb
                       >  endif
                       >  if TileH > 2
2dbc : 47              >    asra
2dbd : 56              >    rorb
                       >  endif
                       >  if TileH > 1
2dbe : 47              >    asra
2dbf : 56              >    rorb
                       >  endif
                       >
2dc0 : 96cc            >  lda CurLevelSizeX
2dc2 : 3d              >  mul
2dc3 : 308b            >  leax d,x
                        
                        
2dc5 : e684               ldb ,x
2dc7 : 270c               beq tcEmpty  ;0 = no tile
                        
2dc9 : 8606               lda #TileEntry
2dcb : 3d                 mul
2dcc : 8e2ec6             ldx #TileTable + teCollisionSub
2dcf : 308b               leax d,x
                        
                          ;a,b = x,y coordinates within tile
2dd1 : dca1               ldd TempPosX
                        
2dd3 : 6e94               jmp [,x]
                          ;exit through subroutine
                        
                        
                        ;Tile collision routines, set carry if hit
2dd5 :                  tcEmpty:
2dd5 : 1cfe               andcc #$fe
2dd7 : 39                 rts
2dd8 :                  tcFull:
2dd8 : 1a01               orcc #1
2dda : 39                 rts
                        ;X.
                        ;XX
2ddb :                  tcTile02:
2ddb : c110               cmpb #TileH/2
2ddd : 2cf9               bge tcFull
2ddf : 47                 asra
2de0 : 91a2               cmpa TempPosY
2de2 : 2cf1               bge tcEmpty
2de4 : 1a01               orcc #1
2de6 : 39                 rts
                        ;..
                        ;X.
2de7 :                  tcTile03:
2de7 : c110               cmpb #TileH/2
2de9 : 2fea               ble tcEmpty
2deb : c010               subb #TileH/2
2ded : 58                 aslb
2dee : d1a1               cmpb TempPosX
2df0 : 2fe3               ble tcEmpty
2df2 : 1a01               orcc #1
2df4 : 39                 rts
                        ;..
                        ;.X
2df5 :                  tcTile04:
2df5 : c110               cmpb #TileH/2
2df7 : 2f10               ble tcMiss04
2df9 : c010               subb #TileH/2
2dfb : 8620               lda #TileW
2dfd : 90a1               suba TempPosX
2dff : 47                 asra
2e00 : a77f               sta -1,s
2e02 : e17f               cmpb -1,s
2e04 : 2f03               ble tcMiss04
2e06 :                  tcHit04:
2e06 : 1a01               orcc #1
2e08 : 39                 rts
2e09 :                  tcMiss04:
2e09 : 1cfe               andcc #$fe
2e0b : 39                 rts
                        ;.X
                        ;XX
2e0c :                  tcTile05:
2e0c : c110               cmpb #TileH/2
2e0e : 2c0e               bge tcHit05
2e10 : 8620               lda #TileW
2e12 : 90a1               suba TempPosX
2e14 : 47                 asra
2e15 : a77f               sta -1,s
2e17 : e17f               cmpb -1,s
2e19 : 2c03               bge tcHit05
2e1b :                  tcMiss05:
2e1b : 1cfe               andcc #$fe
2e1d : 39                 rts
2e1e :                  tcHit05:
2e1e : 1a01               orcc #1
2e20 : 39                 rts
                        ;XX
                        ;X.
2e21 :                  tcTile06:
2e21 : c110               cmpb #TileH/2
2e23 : 2fb3               lble tcFull
2e25 : c010               subb #TileH/2
2e27 : 8620               lda #TileW
2e29 : 90a1               suba TempPosX
2e2b : 47                 asra
2e2c : a77f               sta -1,s
2e2e : e17f               cmpb -1,s
2e30 : 25a6               lblo tcFull
2e32 : 1cfe               andcc #$fe
2e34 : 39                 rts
                        ;X.
                        ;..
2e35 :                  tcTile07:
2e35 : c110               cmpb #TileH/2
2e37 : 2c9c               lbge tcEmpty
2e39 : 8620               lda #TileW
2e3b : 90a1               suba TempPosX
2e3d : 47                 asra
2e3e : a77f               sta -1,s
2e40 : e17f               cmpb -1,s
2e42 : 2594               lblo tcFull
2e44 : 1cfe               andcc #$fe
2e46 : 39                 rts
                        ;.X
                        ;..
2e47 :                  tcTile08:
2e47 : c110               cmpb #TileH/2
2e49 : 2c8a               lbge tcEmpty
2e4b : 58                 aslb
2e4c : d1a1               cmpb TempPosX
2e4e : 2588               lblo tcFull
2e50 : 1cfe               andcc #$fe
2e52 : 39                 rts
                        ;XX
                        ;.X
2e53 :                  tcTile09:
2e53 : c010               subb #TileH/2
2e55 : 2b81               lbmi tcFull
2e57 : 58                 aslb
2e58 : d1a1               cmpb TempPosX
2e5a : 1025ff7a           lblo tcFull
2e5e : 1cfe               andcc #$fe
2e60 : 39                 rts
                        
                        ;Tiles for door collision
                        ;Test is adjusted with amount door is open
2e61 :                  tcTile33:       ;horiz door 1 of 2
2e61 : 96f2               lda DoorCounter
2e63 :                  tc33jumpin:
2e63 : 2722               beq tcHitDoor
                        
2e65 : 847f               anda #%01111111
2e67 : 40                 nega
2e68 : 8b20               adda #DoorSize
2e6a : 07a1               asr TempPosX
2e6c : 91a1               cmpa TempPosX
2e6e : 2c17               bge tcHitDoor
                        
2e70 : 1cfe               andcc #$fe
2e72 : 39                 rts
                        
2e73 :                  tcTile34:       ;horiz door 2 of 2
2e73 : 96f2               lda DoorCounter
2e75 :                  tc34jumpin:
2e75 : 2710               beq tcHitDoor
                        
2e77 : 847f               anda #%01111111
2e79 : 40                 nega
2e7a : 8b20               adda #DoorSize
2e7c : 8020               suba #TileW
2e7e : 07a1               asr TempPosX
2e80 : 91a1               cmpa TempPosX
2e82 : 2c03               bge tcHitDoor
                        
2e84 : 1cfe               andcc #$fe
2e86 : 39                 rts
2e87 :                  tcHitDoor:
2e87 : 1a01               orcc #1
2e89 : 39                 rts
                        
2e8a :                  tcTile35:       ;vert door 1 of 2
2e8a : 96f2               lda DoorCounter
2e8c : 847f               anda #%01111111
2e8e : 07a2               asr TempPosY
2e90 : 91a2               cmpa TempPosY
2e92 : 25f3               blo tcHitDoor
2e94 : 1cfe               andcc #$fe
2e96 : 39                 rts
                        
2e97 :                  tcTile36:       ;vert door 2 of 2
2e97 : 96f2               lda DoorCounter
2e99 : 847f               anda #%01111111
2e9b : 8110               cmpa #TileH/2
2e9d : 25e8               blo tcHitDoor
2e9f : 8010               suba #TileH/2
2ea1 : 07a2               asr TempPosY
2ea3 : 91a2               cmpa TempPosY
2ea5 : 25e0               blo tcHitDoor
2ea7 : 1cfe               andcc #$fe
2ea9 : 39                 rts
                        
2eaa :                  tcTile37:       ;inverted horiz door 1 of 2
                          ;invert door open value and call normal horiz door
2eaa : 96f2               lda DoorCounter
2eac : 847f               anda #%01111111
2eae : 40                 nega
2eaf : 8b20               adda #DoorSize
2eb1 : 2a01               bpl tc37_1
2eb3 : 4f                   clra
2eb4 :                  tc37_1:
2eb4 : 20ad               jmp tc33jumpin
                        
2eb6 :                  tcTile38:       ;inverted horiz door 2 of 2
                          ;invert door open value and call normal horiz door
2eb6 : 96f2               lda DoorCounter
2eb8 : 847f               anda #%01111111
2eba : 40                 nega
2ebb : 8b20               adda #DoorSize
2ebd : 2a01               bpl tc38_1
2ebf : 4f                   clra
2ec0 :                  tc38_1:
2ec0 : 20b3               jmp tc34jumpin
                        
                          direct -1
                        
                        
                        
                        ; Tiles, see struct TileEntry
2ec2 :                  TileTable:
2ec2 : 000000000000       dw 0,0,0    ;tile 0 is blank
2ec8 : 2fac2fb12dd8       dw Tile01_LinesRel,Tile01_LinesAbs,tcFull
2ece : 2fb72fbc2ddb       dw Tile02_LinesRel,Tile02_LinesAbs,tcTile02
2ed4 : 2fc22fc72de7       dw Tile03_LinesRel,Tile03_LinesAbs,tcTile03
2eda : 2fcd2fd22df5       dw Tile04_LinesRel,Tile04_LinesAbs,tcTile04
2ee0 : 2fd82fdd2e0c       dw Tile05_LinesRel,Tile05_LinesAbs,tcTile05
2ee6 : 2fe32fe82e21       dw Tile06_LinesRel,Tile06_LinesAbs,tcTile06
2eec : 2fee2ff32e35       dw Tile07_LinesRel,Tile07_LinesAbs,tcTile07
2ef2 : 2ff92ffe2e47       dw Tile08_LinesRel,Tile08_LinesAbs,tcTile08
2ef8 : 300430092e53       dw Tile09_LinesRel,Tile09_LinesAbs,tcTile09
2efe : 300f30142dd8       dw Tile10_LinesRel,Tile10_LinesAbs,tcFull
2f04 : 301a301f2dd8       dw Tile11_LinesRel,Tile11_LinesAbs,tcFull
2f0a : 3025302c2e47       dw Tile12_LinesRel,Tile12_LinesAbs,tcTile08
2f10 : 3037303e2e53       dw Tile13_LinesRel,Tile13_LinesAbs,tcTile09
2f16 : 304930502ddb       dw Tile14_LinesRel,Tile14_LinesAbs,tcTile02
2f1c : 305b30622dd8       dw Tile15_LinesRel,Tile15_LinesAbs,tcFull
2f22 : 306d30742dd8       dw Tile16_LinesRel,Tile16_LinesAbs,tcFull
2f28 : 307f30842dd8       dw Tile17_LinesRel,Tile17_LinesAbs,tcFull
2f2e : 308a30912dd8       dw Tile18_LinesRel,Tile18_LinesAbs,tcFull
2f34 : 309c30a32e35       dw Tile19_LinesRel,Tile19_LinesAbs,tcTile07
2f3a : 30ae30b52df5       dw Tile20_LinesRel,Tile20_LinesAbs,tcTile04
2f40 : 30c030c72dd8       dw Tile21_LinesRel,Tile21_LinesAbs,tcFull
2f46 : 30d230d92de7       dw Tile22_LinesRel,Tile22_LinesAbs,tcTile03
2f4c : 30e430eb2e21       dw Tile23_LinesRel,Tile23_LinesAbs,tcTile06
2f52 : 30f630fd2e0c       dw Tile24_LinesRel,Tile24_LinesAbs,tcTile05
                        
2f58 : 000000000000       dw 0,0,0   ;25 = not yet used
2f5e : 000000000000       dw 0,0,0   ;26 = not yet used
2f64 : 000000000000       dw 0,0,0   ;27 = not yet used
2f6a : 000000000000       dw 0,0,0   ;28 = not yet used
2f70 : 000000000000       dw 0,0,0   ;29 = not yet used
2f76 : 000000000000       dw 0,0,0   ;30 = not yet used
2f7c : 000000000000       dw 0,0,0   ;31 = not yet used
                        
2f82 : 000000002dd8       dw 0,0,tcFull               ;a 32 = empty solid
2f88 : 000000002e61       dw 0,0,tcTile33             ;b 33 = horiz door 1 of 2
2f8e : 000000002e73       dw 0,0,tcTile34             ;c 34 = horiz door 2 of 2
2f94 : 000000002e8a       dw 0,0,tcTile35             ;d 35 = vert door 1 of 2
2f9a : 000000002e97       dw 0,0,tcTile36             ;e 36 = vert door 2 of 2
2fa0 : 000000002eaa       dw 0,0,tcTile37             ;f 37 = horiz inverted door 1 of 2
2fa6 : 000000002eb6       dw 0,0,tcTile38             ;g 38 = horiz inverted door 2 of 2
                        
                        
                        
                        
0020 =                  FullW equ ((TileW))
0010 =                  HalfW equ ((TileW/2))
0020 =                  FullH equ ((TileH))
0010 =                  HalfH equ ((TileH/2))
                        
                        ;--
                        ;XX
                        ;XX
2fac :                  Tile01_LinesRel:
2fac : 0000               db 0,0  ;start pos
2fae : 01                 db 1    ;line count
2faf : 0020               db 0, FullW
2fb1 :                  Tile01_LinesAbs:
2fb1 : 01                 db 1  ;line count
2fb2 : 01                 db 1  ;linetype, 0=vert, 1=horiz, 2=slope
2fb3 : 0000               db 0,0      ;x0,y0
2fb5 : 2000               db FullW,0  ;x1,y1
                        
                        ;X.
                        ;XX
2fb7 :                  Tile02_LinesRel:
2fb7 : 0000               db 0,0  ;start pos
2fb9 : 01                 db 1    ;line count
2fba : f020               db -HalfH, FullW
2fbc :                  Tile02_LinesAbs:
2fbc : 01                 db 1  ;line count
2fbd : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
2fbe : 0000               db 0,0      ;x0,y0
2fc0 : 2010               db FullW,HalfH  ;x1,y1
                        
                        ;..
                        ;X.
2fc2 :                  Tile03_LinesRel:
2fc2 : f000               db -HalfH,0  ;start pos
2fc4 : 01                 db 1    ;line count
2fc5 : f020               db -HalfH, FullW
2fc7 :                  Tile03_LinesAbs:
2fc7 : 01                 db 1  ;line count
2fc8 : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
2fc9 : 0010               db 0,HalfH      ;x0,y0
2fcb : 2020               db FullW,FullH  ;x1,y1
                        
                        ;..
                        ;.X
2fcd :                  Tile04_LinesRel:
2fcd : e000               db -FullH,0  ;start pos
2fcf : 01                 db 1    ;line count
2fd0 : 1020               db HalfH, FullW
2fd2 :                  Tile04_LinesAbs:
2fd2 : 01                 db 1  ;line count
2fd3 : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
2fd4 : 0020               db 0,FullH      ;x0,y0
2fd6 : 2010               db FullW,HalfH  ;x1,y1
                        
                        
                        ;.X
                        ;XX
2fd8 :                  Tile05_LinesRel:
2fd8 : 0020               db 0,FullW  ;start pos
2fda : 01                 db 1    ;line count
2fdb : f0e0               db -HalfH, -FullW
2fdd :                  Tile05_LinesAbs:
2fdd : 01                 db 1  ;line count
2fde : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
2fdf : 2000               db FullW,0  ;x0,y0
2fe1 : 0010               db 0,HalfH  ;x1,y1
                        
                        ;XX
                        ;X.
2fe3 :                  Tile06_LinesRel:
2fe3 : e000               db -FullH,0  ;start pos
2fe5 : 01                 db 1    ;line count
2fe6 : 1020               db HalfH, FullW
2fe8 :                  Tile06_LinesAbs:
2fe8 : 01                 db 1  ;line count
2fe9 : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
2fea : 0020               db 0,FullH  ;x0,y0
2fec : 2010               db FullW,HalfH  ;x1,y1
                        
                        ;X.
                        ;..
2fee :                  Tile07_LinesRel:
2fee : f000               db -HalfH,0  ;start pos
2ff0 : 01                 db 1    ;line count
2ff1 : 1020               db HalfH, FullW
2ff3 :                  Tile07_LinesAbs:
2ff3 : 01                 db 1  ;line count
2ff4 : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
2ff5 : 0010               db 0,HalfH  ;x0,y0
2ff7 : 2000               db FullW,0  ;x1,y1
                        
                        ;.X
                        ;..
2ff9 :                  Tile08_LinesRel:
2ff9 : 0000               db 0,0  ;start pos
2ffb : 01                 db 1    ;line count
2ffc : f020               db -HalfH, FullW
2ffe :                  Tile08_LinesAbs:
2ffe : 01                 db 1  ;line count
2fff : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
3000 : 0000               db 0,0  ;x0,y0
3002 : 2010               db FullW,HalfH  ;x1,y1
                        
                        ;XX
                        ;.X
3004 :                  Tile09_LinesRel:
3004 : f000               db -HalfH,0  ;start pos
3006 : 01                 db 1    ;line count
3007 : f020               db -HalfH, FullW
3009 :                  Tile09_LinesAbs:
3009 : 01                 db 1  ;line count
300a : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
300b : 0010               db 0,HalfH  ;x0,y0
300d : 2020               db FullW,FullH  ;x1,y1
                        
                        ;|XX
                        ;|XX
300f :                  Tile10_LinesRel:  ;A
300f : 0000               db 0,0  ;start pos
3011 : 01                 db 1    ;line count
3012 : e000               db -FullH, 0
3014 :                  Tile10_LinesAbs:
3014 : 01                 db 1  ;line count
3015 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3016 : 0000               db 0,0  ;x0,y0
3018 : 0020               db 0,FullH  ;x1,y1
                        
                        ;XX|
                        ;XX|
301a :                  Tile11_LinesRel:  ;B
301a : 0020               db 0,FullW  ;start pos
301c : 01                 db 1    ;line count
301d : e000               db -FullH, 0
301f :                  Tile11_LinesAbs:
301f : 01                 db 1  ;line count
3020 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3021 : 2000               db FullW,0  ;x0,y0
3023 : 2020               db FullW,FullH  ;x1,y1
                        
                        ;.X
                        ;..|
3025 :                  Tile12_LinesRel:  ;C
3025 : 0000               db 0,0  ;start pos
3027 : 02                 db 2    ;line count
3028 : f020               db -HalfH, FullW
302a : f000               db -HalfH, 0
302c :                  Tile12_LinesAbs:
302c : 02                 db 2  ;line count
302d : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
302e : 0000               db 0,0  ;x0,y0
3030 : 2010               db FullW,HalfH  ;x1,y1
3032 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3033 : 2010               db FullW,HalfH  ;x0,y0
3035 : 2020               db FullW,FullH  ;x1,y1
                        
                        ;|XX
                        ; .X
3037 :                  Tile13_LinesRel:  ;D
3037 : 0000               db 0,0  ;start pos
3039 : 02                 db 2    ;line count
303a : f000               db -HalfH, 0
303c : f020               db -HalfH, FullW
303e :                  Tile13_LinesAbs:
303e : 02                 db 2  ;line count
303f : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3040 : 0000               db 0,0      ;x0,y0
3042 : 0010               db 0,HalfH  ;x1,y1
3044 : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
3045 : 0010               db 0,HalfH      ;x0,y0
3047 : 2020               db FullW,FullH  ;x1,y1
                        
                        ;X.
                        ;XX|
3049 :                  Tile14_LinesRel:  ;E
3049 : 0000               db 0,0  ;start pos
304b : 02                 db 2    ;line count
304c : f020               db -HalfH, FullW
304e : f000               db -HalfH, 0
3050 :                  Tile14_LinesAbs:
3050 : 02                 db 2  ;line count
3051 : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
3052 : 0000               db 0,0      ;x0,y0
3054 : 2010               db FullW,HalfH  ;x1,y1
3056 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3057 : 2010               db FullW,HalfH      ;x0,y0
3059 : 2020               db FullW,FullH  ;x1,y1
                        
                        ;--
                        ;XX|
                        ;XX|
305b :                  Tile15_LinesRel:  ;F
305b : 0000               db 0,0  ;start pos
305d : 02                 db 2    ;line count
305e : 0020               db 0, FullW
3060 : e000               db -FullH, 0
3062 :                  Tile15_LinesAbs:
3062 : 02                 db 2  ;line count
3063 : 01                 db 1  ;linetype, 0=vert, 1=horiz, 2=slope
3064 : 0000               db 0,0      ;x0,y0
3066 : 2000               db FullW,0  ;x1,y1
3068 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3069 : 2000               db FullW,0      ;x0,y0
306b : 2020               db FullW,FullH  ;x1,y1
                        
                        ; --
                        ;|XX
                        ;|XX
306d :                  Tile16_LinesRel:  ;G
306d : e000               db -FullH,0  ;start pos
306f : 02                 db 2    ;line count
3070 : 2000               db FullH, 0
3072 : 0020               db 0, FullW
3074 :                  Tile16_LinesAbs:
3074 : 02                 db 2  ;line count
3075 : 01                 db 1  ;linetype, 0=vert, 1=horiz, 2=slope
3076 : 0000               db 0,0      ;x0,y0
3078 : 2000               db FullW,0  ;x1,y1
307a : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
307b : 0000               db 0,0      ;x0,y0
307d : 0020               db 0,FullH  ;x1,y1
                        
                        ;XX
                        ;XX
                        ;--
307f :                  Tile17_LinesRel:  ;H
307f : e000               db -FullH,0  ;start pos
3081 : 01                 db 1    ;line count
3082 : 0020               db 0, FullW
3084 :                  Tile17_LinesAbs:
3084 : 01                 db 1  ;line count
3085 : 01                 db 1  ;linetype, 0=vert, 1=horiz, 2=slope
3086 : 0020               db 0,FullH      ;x0,y0
3088 : 2020               db FullW,FullH  ;x1,y1
                        
                        ;|XX
                        ;|XX
                        ; --
308a :                  Tile18_LinesRel:  ;I
308a : 0000               db 0,0  ;start pos
308c : 02                 db 2    ;line count
308d : e000               db -FullH, 0
308f : 0020               db 0, FullW
3091 :                  Tile18_LinesAbs:
3091 : 02                 db 2  ;line count
3092 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3093 : 0000               db 0,0      ;x0,y0
3095 : 0020               db 0,FullH  ;x1,y1
3097 : 01                 db 1  ;linetype, 0=vert, 1=horiz, 2=slope
3098 : 0020               db 0,FullH      ;x0,y0
309a : 2020               db FullW,FullH  ;x1,y1
                        
                        ; X.
                        ;|..
309c :                  Tile19_LinesRel:  ;J
309c : 0020               db 0,FullW   ;start pos
309e : 02                 db 2    ;line count
309f : f0e0               db -HalfH, -FullW
30a1 : f000               db -HalfH, 0
30a3 :                  Tile19_LinesAbs:
30a3 : 02                 db 2  ;line count
30a4 : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
30a5 : 2000               db FullW,0  ;x0,y0
30a7 : 0010               db 0,HalfH  ;x1,y1
30a9 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
30aa : 0010               db 0,HalfH  ;x0,y0
30ac : 0020               db 0,FullH  ;x1,y1
                        
                        ;..|
                        ;.X
30ae :                  Tile20_LinesRel:  ;K
30ae : 0020               db 0,FullW  ;start pos
30b0 : 02                 db 2    ;line count
30b1 : f000               db -HalfH,0
30b3 : f0e0               db -HalfH, -FullW
30b5 :                  Tile20_LinesAbs:
30b5 : 02                 db 2  ;line count
30b6 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
30b7 : 2000               db FullW,0      ;x0,y0
30b9 : 2010               db FullW,HalfH  ;x1,y1
30bb : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
30bc : 2010               db FullW,HalfH  ;x0,y0
30be : 0020               db 0,FullH      ;x1,y1
                        
                        ;XX|
                        ;XX|
                        ;--
30c0 :                  Tile21_LinesRel:  ;L
30c0 : 0020               db 0,FullW  ;start pos
30c2 : 02                 db 2    ;line count
30c3 : e000               db -FullH, 0
30c5 : 00e0               db 0, -FullW
30c7 :                  Tile21_LinesAbs:
30c7 : 02                 db 2  ;line count
30c8 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
30c9 : 2000               db FullW,0      ;x0,y0
30cb : 2020               db FullW,FullH  ;x1,y1
30cd : 01                 db 1  ;linetype, 0=vert, 1=horiz, 2=slope
30ce : 2020               db FullW,FullH      ;x0,y0
30d0 : 0020               db 0,FullH  ;x1,y1
                        
                        ;|..
                        ; X.
30d2 :                  Tile22_LinesRel:  ;M
30d2 : 0000               db 0,0  ;start pos
30d4 : 02                 db 2    ;line count
30d5 : f000               db -HalfH,0
30d7 : f020               db -HalfH, FullW
30d9 :                  Tile22_LinesAbs:
30d9 : 02                 db 2  ;line count
30da : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
30db : 0000               db 0,0      ;x0,y0
30dd : 0010               db 0,HalfH  ;x1,y1
30df : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
30e0 : 0010               db 0,HalfH  ;x0,y0
30e2 : 2020               db FullW,FullH      ;x1,y1
                        
                        ;XX|
                        ;X.
30e4 :                  Tile23_LinesRel:   ;N
30e4 : e000               db -FullH,0  ;start pos
30e6 : 02                 db 2    ;line count
30e7 : 1020               db HalfH, FullW
30e9 : 1000               db HalfH, 0
30eb :                  Tile23_LinesAbs:
30eb : 02                 db 2  ;line count
30ec : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
30ed : 0020               db 0,FullH  ;x0,y0
30ef : 2010               db FullW,HalfH  ;x1,y1
30f1 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
30f2 : 2010               db FullW,HalfH  ;x0,y0
30f4 : 2000               db FullW,0  ;x1,y1
                        
                        ; .X
                        ;|XX
30f6 :                  Tile24_LinesRel:   ;O
30f6 : 0020               db 0,FullW  ;start pos
30f8 : 02                 db 2    ;line count
30f9 : f0e0               db -HalfH, -FullW
30fb : f000               db -HalfH, 0
30fd :                  Tile24_LinesAbs:
30fd : 02                 db 2  ;line count
30fe : 02                 db 2  ;linetype, 0=vert, 1=horiz, 2=slope
30ff : 2000               db FullW,0  ;x0,y0
3101 : 0010               db 0,HalfH  ;x1,y1
3103 : 00                 db 0  ;linetype, 0=vert, 1=horiz, 2=slope
3104 : 0010               db 0,HalfH  ;x0,y0
3106 : 0020               db 0,FullH  ;x1,y1
                        
                        
                        ;-----------------
                        ;LEVELS
                        ;-----------------
                        
                          include "Thrust_Levels.asm"
                        ; Level-definitions
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        ;Macro for defining a level, see struct LevelEntry
                        LevelDef macro LevelNo, SizeX,SizeY, PodX, PodY, PowerX, PowerY
                          db SizeX,SizeY
                          dw Level\1_Tiles,Level\1_Guns,Level\1_Fuel
                          dw PodX * TileW + HalfW, PodY * TileH + HalfH + (HalfH/4) + 1
                          dw PowerX * TileW + HalfW, PowerY * TileH + HalfH + (HalfH/4) + 1
                          dw Level\1_Restart
                          dw Level\1_Doors
                          dw Level\1_Switches
                         endm
                        
0006 =                  LevelCountNormal = 6    ;6 levels in normal mode
0008 =                  LevelCount = 8          ;hard+ and timeattack modes
3108 :                  Levels:
                          LevelDef 1, 32,8 ,  16, 5,  19, 3
3108 : 2008            >  db  32,8 
310a : 31b832b832be    >  dw Level1_Tiles,Level1_Guns,Level1_Fuel
3110 : 021000b5        >  dw   16 * TileW + HalfW,  5 * TileH + HalfH + (HalfH/4) + 1
3114 : 02700075        >  dw   19 * TileW + HalfW,  3 * TileH + HalfH + (HalfH/4) + 1
3118 : 32c3            >  dw Level1_Restart
311a : 32c6            >  dw Level1_Doors
311c : 32c7            >  dw Level1_Switches
                        
                          if Level1Only!=1
                          LevelDef 2, 25,18,  8,15,   3, 3
311e : 1912            >  db  25,18
3120 : 32c8348a3495    >  dw Level2_Tiles,Level2_Guns,Level2_Fuel
3126 : 011001f5        >  dw   8 * TileW + HalfW, 15 * TileH + HalfH + (HalfH/4) + 1
312a : 00700075        >  dw    3 * TileW + HalfW,  3 * TileH + HalfH + (HalfH/4) + 1
312e : 349a            >  dw Level2_Restart
3130 : 349d            >  dw Level2_Doors
3132 : 349e            >  dw Level2_Switches
                        
                          LevelDef 3, 22,30,  2,27,   17, 5
3134 : 161e            >  db  22,30
3136 : 349f3733374d    >  dw Level3_Tiles,Level3_Guns,Level3_Fuel
313c : 00500375        >  dw   2 * TileW + HalfW, 27 * TileH + HalfH + (HalfH/4) + 1
3140 : 023000b5        >  dw    17 * TileW + HalfW,  5 * TileH + HalfH + (HalfH/4) + 1
3144 : 3766            >  dw Level3_Restart
3146 : 376d            >  dw Level3_Doors
3148 : 376e            >  dw Level3_Switches
                        
                          LevelDef 4, 24,34,  17,32,  7,19
314a : 1822            >  db  24,34
314c : 376f3a9f3ac3    >  dw Level4_Tiles,Level4_Guns,Level4_Fuel
3152 : 02300415        >  dw   17 * TileW + HalfW, 32 * TileH + HalfH + (HalfH/4) + 1
3156 : 00f00275        >  dw   7 * TileW + HalfW, 19 * TileH + HalfH + (HalfH/4) + 1
315a : 3ac8            >  dw Level4_Restart
315c : 3ad1            >  dw Level4_Doors
315e : 3ad7            >  dw Level4_Switches
                        
                          LevelDef 5, 22,43,  17,41,  11,11
3160 : 162b            >  db  22,43
3162 : 3ae23e943eb8    >  dw Level5_Tiles,Level5_Guns,Level5_Fuel
3168 : 02300535        >  dw   17 * TileW + HalfW, 41 * TileH + HalfH + (HalfH/4) + 1
316c : 01700175        >  dw   11 * TileW + HalfW, 11 * TileH + HalfH + (HalfH/4) + 1
3170 : 3ed9            >  dw Level5_Restart
3172 : 3ee4            >  dw Level5_Doors
3174 : 3eea            >  dw Level5_Switches
                        
                          LevelDef 6, 30,52,  22,50,  27,50
3176 : 1e34            >  db  30,52
3178 : 3ef5450d4540    >  dw Level6_Tiles,Level6_Guns,Level6_Fuel
317e : 02d00655        >  dw   22 * TileW + HalfW, 50 * TileH + HalfH + (HalfH/4) + 1
3182 : 03700655        >  dw   27 * TileW + HalfW, 50 * TileH + HalfH + (HalfH/4) + 1
3186 : 4549            >  dw Level6_Restart
3188 : 4554            >  dw Level6_Doors
318a : 455a            >  dw Level6_Switches
                        
                          LevelDef 7, 23,20,  13,15,  19,15
318c : 1714            >  db  23,20
318e : 456547314755    >  dw Level7_Tiles,Level7_Guns,Level7_Fuel
3194 : 01b001f5        >  dw   13 * TileW + HalfW, 15 * TileH + HalfH + (HalfH/4) + 1
3198 : 027001f5        >  dw   19 * TileW + HalfW, 15 * TileH + HalfH + (HalfH/4) + 1
319c : 4762            >  dw Level7_Restart
319e : 4769            >  dw Level7_Doors
31a0 : 4783            >  dw Level7_Switches
                        
                          LevelDef 8, 25,36,  8,34,   16,23
31a2 : 1924            >  db  25,36
31a4 : 47934b174b40    >  dw Level8_Tiles,Level8_Guns,Level8_Fuel
31aa : 01100455        >  dw   8 * TileW + HalfW, 34 * TileH + HalfH + (HalfH/4) + 1
31ae : 021002f5        >  dw    16 * TileW + HalfW, 23 * TileH + HalfH + (HalfH/4) + 1
31b2 : 4b45            >  dw Level8_Restart
31b4 : 4b54            >  dw Level8_Doors
31b6 : 4b5a            >  dw Level8_Switches
                        
                          endif
                        
                          cmap "0",0,1,2,3,4,5,6,7,8,9    ; decode ASCII digits to binary
                          cmap "A",10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26   ;normal tiles
                          cmap "a",32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48   ;special tiles without lines
                        
0015 =                  FuelY = HalfH + 5                       ;Fuel pod Y offset
0008 =                  GunY = (HalfH/2)                        ;Gun Y offset
                        
                        ;Off is 1 or -1, meaning to adjust Y quarter of a tile down or up respectively
                        ;0=NE,1=NW,2=SE,3=SW
                        GunDef macro Type,Off,X1,Y1             ;Gun definition macro
                           dw (TileW * X1) + HalfW, (TileH * Y1) + HalfH + (GunY*Off)
                           db Type
                         endm
                        
                        FuelDef macro X1,Y1                     ;Fuel pod definition macro
                           dw (TileW * X1) + HalfW, (TileH * Y1) + FuelY
                         endm
                        
                        RestartDef macro X1,Y1                  ;Restart point definition macro
                           db X1,Y1
                         endm
                        
                        DoorDef macro Type, X1,Y1               ;Door definition
                           db Type
                           dw (TileW * X1), (TileH * Y1)
                         endm
                        
                        SwitchDef macro Type, X1,Y1
                           if Type=0
                             dw (TileW * X1)                    ;left wall
                           else
                             dw (TileW * X1) + TileW            ;right wall
                           endif
                           dw (TileH * Y1) + HalfH
                           db Type
                         endm
                        
                        
                        ;**todo level data restrictions:
                        ; - level must be at least TileCountY high or RefreshDrawList won't work
                        ; - doors must have x > TileCountX or they won't be drawn correctly
                        
31b8 :                  Level1_Tiles:
31b8 : 00000000000000..   db "00000000000000000000000000000000"
31d8 : 00000000000000..   db "00000000000000000000000000000000"
31f8 : 00000000000000..   db "00000000000000000000000000000000"
3218 : 00000000000000..   db "00000000000000000000000000000000"
3238 : 01010101010203..   db "111112300000000000G1111111111111"
3258 : 20202020202020..   db "aaaaaaa11112300000Aaaaaaaaaaaaaa"
3278 : 00000000000020..   db "000000aaaaaaa11111aa000000000000"
3298 : 00000000000000..   db "000000000000aaaaaaaa000000000000"
32b8 :                  Level1_Guns:
32b8 : 01                 db 1  ;count
                          GunDef 0,1, 12,5
32b9 : 019000b8        >   dw (TileW *  12) + HalfW, (TileH * 5) + HalfH + (GunY*1)
32bd : 00              >   db 0
                        
32be :                  Level1_Fuel:
32be : 01                 db 1  ;count
                          FuelDef 9,4
32bf : 01300095        >   dw (TileW * 9) + HalfW, (TileH * 4) + FuelY
                        
32c3 :                  Level1_Restart:
32c3 : 01                 db 1  ;count
                          RestartDef 9,2
32c4 : 0902            >   db 9,2
                        
32c6 :                  Level1_Doors:   ;also need mapchange for collision, 'bc' for horiz door, 'de' for vert door
32c6 : 00                 db 0  ;count
                        ;  DoorDef 2, 10,2
32c7 :                  Level1_Switches:
32c7 : 00                 db 0  ;count
                        ;  SwitchDef 0, 13,2
                        
                         if Level1Only!=1
                        
32c8 :                  Level2_Tiles:
32c8 : 00000000000000..   db "0000000000000000000000000"
32e1 : 00000000000000..   db "0000000000000000000000000"
32fa : 00000000000000..   db "0000000000000000000000000"
3313 : 00000000000000..   db "0000000000000000045111123"
332c : 01010101010203..   db "11111230000000045aa000000"
3345 : 00000000000020..   db "000000a23000045aaa0000000"
335e : 00000000000020..   db "000000aaaE000Aaa000000000"
3377 : 00000000000000..   db "00000000aB000Aa0000000000"
3390 : 00000000000000..   db "00000000aB000Aa0000000000"
33a9 : 00000000000000..   db "00000000aB000Aa0000000000"
33c2 : 00000000000000..   db "00000000aB000Daaa00000000"
33db : 00000000000000..   db "0000000a67000089aa0000000"
33f4 : 00000000202006..   db "0000aa6700000000Aa0000000"
340d : 00000000200b00..   db "0000aB0000000000Aa0000000"
3426 : 00000000200b00..   db "0000aB0000000045aa0000000"
343f : 00000000202002..   db "0000aa23000045aaa00000000"
3458 : 00000000002020..   db "00000aaa1111aaaa000000000"
3471 : 00000000000000..   db "0000000000000000000000000"
348a :                  Level2_Guns:
348a : 02                 db 2  ;count
                          GunDef 2,-1, 7,12
348b : 00f00188        >   dw (TileW *  7) + HalfW, (TileH * 12) + HalfH + (GunY*-1)
348f : 02              >   db 2
                        
                          GunDef 3,-1, 14,11
3490 : 01d00168        >   dw (TileW *  14) + HalfW, (TileH * 11) + HalfH + (GunY*-1)
3494 : 03              >   db 3
                        
3495 :                  Level2_Fuel:
3495 : 01                 db 1  ;count
                          FuelDef 11,15
3496 : 017001f5        >   dw (TileW * 11) + HalfW, (TileH * 15) + FuelY
                        
349a :                  Level2_Restart:
349a : 01                 db 1  ;count
                          RestartDef 4,1
349b : 0401            >   db 4,1
                        
349d : 00               Level2_Doors:     db 0  ;count
349e : 00               Level2_Switches:  db 0  ;count
                        
                        
349f :                  Level3_Tiles:
349f : 00000000000000..   db "0000000000000000000000"
34b5 : 00000000000000..   db "0000000000000000000000"
34cb : 00000000000000..   db "0000000000000000000000"
34e1 : 00000000000000..   db "0000000000000000000000"
34f7 : 01010101010101..   db "111111111111F000000G11"
350d : 00000000000000..   db "00000000000aB000000Aa0"
3523 : 00000000000000..   db "00000000000aB000G11a00"
3539 : 00000000000000..   db "00000000000aB000Aa0000"
354f : 00000000000000..   db "00000000000aB000Aa0000"
3565 : 00000000000000..   db "00000000000aB000IHHHHa"
357b : 00000000000000..   db "00000000000aJ00000000A"
3591 : 00000000000000..   db "0000000000aB000000000A"
35a7 : 00000000000000..   db "0000000000aB00000000Ka"
35bd : 00000000000000..   db "0000000000aB000G1111a0"
35d3 : 00000000000000..   db "0000000000aB000Aa00000"
35e9 : 00000000000000..   db "0000000HHHHL000Aa00000"
35ff : 00201111110607..   db "0aHHH6700000000Aa00000"
3615 : 20130000000000..   db "aJ0000000000000Aa00000"
362b : 0b000000000000..   db "B00000000000000Aa00000"
3641 : 0b000000000000..   db "B0000000000G111a000000"
3657 : 0b000000000000..   db "B0000000000Aa000000000"
366d : 0b000000000000..   db "B0000000000Aa000000000"
3683 : 0b000000040501..   db "B0004511111a0000000000"
3699 : 0b0000000a2000..   db "B000Aa0000000000000000"
36af : 0b0000000a2000..   db "B000Aa0000000000000000"
36c5 : 0b0000000a2000..   db "B000Aa0000000000000000"
36db : 0b0000000a2000..   db "B000Aa0000000000000000"
36f1 : 201600000a2000..   db "aM00Aa0000000000000000"
3707 : 00200101200000..   db "0a11a00000000000000000"
371d : 00202020200000..   db "0aaaa00000000000000000"
3733 :                  Level3_Guns:
3733 : 05                 db 5  ;count
                          GunDef 1, 1, 20,12
3734 : 02900198        >   dw (TileW *  20) + HalfW, (TileH * 12) + HalfH + (GunY* 1)
3738 : 01              >   db 1
                        
                          GunDef 2,-1, 12,10
3739 : 01900148        >   dw (TileW *  12) + HalfW, (TileH * 10) + HalfH + (GunY*-1)
373d : 02              >   db 2
                        
                          GunDef 2,-1, 6,16
373e : 00d00208        >   dw (TileW *  6) + HalfW, (TileH * 16) + HalfH + (GunY*-1)
3742 : 02              >   db 2
                        
                          GunDef 2,-1, 1,17
3743 : 00300228        >   dw (TileW *  1) + HalfW, (TileH * 17) + HalfH + (GunY*-1)
3747 : 02              >   db 2
                        
                          GunDef 1,-1, 5,22
3748 : 00b002c8        >   dw (TileW *  5) + HalfW, (TileH * 22) + HalfH + (GunY*-1)
374c : 01              >   db 1
                        
374d :                  Level3_Fuel:
374d : 06                 db 6  ;count
                          FuelDef 10,3
374e : 01500075        >   dw (TileW * 10) + HalfW, (TileH * 3) + FuelY
                        
                          FuelDef 16,12
3752 : 02100195        >   dw (TileW * 16) + HalfW, (TileH * 12) + FuelY
                        
                          FuelDef 17,12
3756 : 02300195        >   dw (TileW * 17) + HalfW, (TileH * 12) + FuelY
                        
                          FuelDef 18,12
375a : 02500195        >   dw (TileW * 18) + HalfW, (TileH * 12) + FuelY
                        
                          FuelDef 12,18
375e : 01900255        >   dw (TileW * 12) + HalfW, (TileH * 18) + FuelY
                        
                          FuelDef 7,21
3762 : 00f002b5        >   dw (TileW * 7) + HalfW, (TileH * 21) + FuelY
                        
3766 :                  Level3_Restart:
3766 : 03                 db 3  ;count
                          RestartDef 9,0
3767 : 0900            >   db 9,0
                        
                          RestartDef 14,11
3769 : 0e0b            >   db 14,11
                        
                          RestartDef 4,19
376b : 0413            >   db 4,19
                        
376d : 00               Level3_Doors:     db 0  ;count
376e : 00               Level3_Switches:  db 0  ;count
                        
                        
376f :                  Level4_Tiles:
376f : 00000000000000..   db "000000000000000000000000"
3787 : 01010101010203..   db "11111230000000G111111111"
379f : 00000000000020..   db "000000a2300000Aa00000000"
37b7 : 00000000000000..   db "00000000a11F00Aa00000000"
37cf : 00000000000000..   db "0000000000aB00Aa00000000"
37e7 : 00000000000000..   db "0000000000aB00Aa00000000"
37ff : 00000000000000..   db "0000000000aB00Aa00000000"
3817 : 00000000000000..   db "000000000a6700Aa00000000"
382f : 00000000000000..   db "0000000a670000Aa00000000"
3847 : 00000000002006..   db "00000a67000000Aa00000000"
385f : 00000020060700..   db "000a6700000000Aa00000000"
3877 : 0000200b000000..   db "00aB0000000000Aa00000000"
388f : 0000200b000000..   db "00aB0000000000Aa00000000"
38a7 : 00000020010203..   db "000a12300G1111aa00000000"
38bf : 00000000002017..   db "00000aN00Aa0000000000000"
38d7 : 00000020060700..   db "000a6700089a000000000000"
38ef : 0000000b000000..   db "000B000000089a0000000000"
3907 : 0000000b000000..   db "000B00000000089HHHHHHHHa"
391f : 0000000b000000..   db "000B0000000000000000000A"
3937 : 0000000b000000..   db "000B0000000000000000000A"
394f : 00000020010101..   db "000a1111111230000000000A"
3967 : 00000000000000..   db "000000000000a2300000000A"
397f : 00000000000000..   db "00000000000000a11111F00A"
3997 : 00000000000000..   db "0000000000000000000aBbcA"
39af : 00000000000000..   db "0000000000000000000aB00A"
39c7 : 00000000000000..   db "000000000000000000a6700A"
39df : 00000000000000..   db "0000000000000000a670000A"
39f7 : 00000000000000..   db "00000000000000a67000000A"
3a0f : 00000000000000..   db "0000000000000aB00000000A"
3a27 : 00000000000000..   db "0000000000000aB00000045a"
3a3f : 00000000000000..   db "00000000000000a230045a00"
3a57 : 00000000000000..   db "000000000000000aB00Aa000"
3a6f : 00000000000000..   db "000000000000000aB00Aa000"
3a87 : 00000000000000..   db "0000000000000000a11a0000"
3a9f :                  Level4_Guns:
3a9f : 07                 db 7  ;count
                          GunDef 2,-1, 9,8
3aa0 : 01300108        >   dw (TileW *  9) + HalfW, (TileH * 8) + HalfH + (GunY*-1)
3aa4 : 02              >   db 2
                        
                          GunDef 2,-1, 5,15
3aa5 : 00b001e8        >   dw (TileW *  5) + HalfW, (TileH * 15) + HalfH + (GunY*-1)
3aa9 : 02              >   db 2
                        
                          GunDef 2,-1, 18,26
3aaa : 02500348        >   dw (TileW *  18) + HalfW, (TileH * 26) + HalfH + (GunY*-1)
3aae : 02              >   db 2
                        
                          GunDef 3,-1, 13,17
3aaf : 01b00228        >   dw (TileW *  13) + HalfW, (TileH * 17) + HalfH + (GunY*-1)
3ab3 : 03              >   db 3
                        
                          GunDef 1, 1, 21,29
3ab4 : 02b003b8        >   dw (TileW *  21) + HalfW, (TileH * 29) + HalfH + (GunY* 1)
3ab8 : 01              >   db 1
                        
                          GunDef 0, 1, 6,13
3ab9 : 00d001b8        >   dw (TileW *  6) + HalfW, (TileH * 13) + HalfH + (GunY* 1)
3abd : 00              >   db 0
                        
                          GunDef 0, 1, 12,20
3abe : 01900298        >   dw (TileW *  12) + HalfW, (TileH * 20) + HalfH + (GunY* 1)
3ac2 : 00              >   db 0
                        
3ac3 :                  Level4_Fuel:
3ac3 : 01                 db 1  ;count
                          FuelDef 19,21
3ac4 : 027002b5        >   dw (TileW * 19) + HalfW, (TileH * 21) + FuelY
                        
3ac8 :                  Level4_Restart:
3ac8 : 04                 db 4  ;count
                          RestartDef 11,0
3ac9 : 0b00            >   db 11,0
                        
                          RestartDef 10,10
3acb : 0a0a            >   db 10,10
                        
                          RestartDef 18,19
3acd : 1213            >   db 18,19
                        
                          RestartDef 18,28
3acf : 121c            >   db 18,28
                        
3ad1 :                  Level4_Doors:   ;also need mapchange for collision, 'bc' for horiz door, 'de' for vert door
3ad1 : 01                 db 1  ;count
                          DoorDef 0, 21,23
3ad2 : 00              >   db 0
3ad3 : 02a002e0        >   dw (TileW *  21), (TileH * 23)
                        
3ad7 :                  Level4_Switches:
3ad7 : 02                 db 2  ;count
                          SwitchDef 1, 22,25
                       >   if 1=0
                       >     dw (TileW *  22)                    ;left wall
                       >   else
3ad8 : 02e0            >     dw (TileW *  22) + TileW            ;right wall
                       >   endif
3ada : 0330            >   dw (TileH * 25) + HalfH
3adc : 01              >   db 1
                        
                          SwitchDef 1, 22,20
                       >   if 1=0
                       >     dw (TileW *  22)                    ;left wall
                       >   else
3add : 02e0            >     dw (TileW *  22) + TileW            ;right wall
                       >   endif
3adf : 0290            >   dw (TileH * 20) + HalfH
3ae1 : 01              >   db 1
                        
                        
                        
3ae2 :                  Level5_Tiles:
3ae2 : 00000000000000..  db "0000000000000000000000"
3af8 : 01010101020300..  db "111123000000G111111111"
3b0e : 0000000000200e..  db "00000aE00000A000000000"
3b24 : 0000000000200b..  db "00000aB00000A000000000"
3b3a : 00000000000020..  db "000000a11F00A000000000"
3b50 : 00000000000000..  db "000000000B00A000000000"
3b66 : 00000000000000..  db "000000000B00A000000000"
3b7c : 00000000000000..  db "000000000B00A000000000"
3b92 : 00000000000000..  db "00000000HL00IHa0000000"
3ba8 : 00000000000006..  db "0000006700000089a00000"
3bbe : 00000000000b00..  db "00000B0000000000A00000"
3bd4 : 00000000000b00..  db "00000B0000000000A00000"
3bea : 00000000002001..  db "00000a1F00G11111a00000"
3c00 : 00000000000000..  db "0000000B00A00000000000"
3c16 : 00000000000000..  db "0000000B00Ia0000000000"
3c2c : 00000000000020..  db "000000aN000A0000000000"
3c42 : 00201111110607..  db "0aHHH670000A0000000000"
3c58 : 000b0000000000..  db "0B000000000A0000000000"
3c6e : 000b0000000000..  db "0B000000000A0000000000"
3c84 : 000b0000000000..  db "0B00000000Ka0000000000"
3c9a : 000b0000001001..  db "0B000G1111a00000000000"
3cb0 : 000b0000000a00..  db "0B000A0000000000000000"
3cc6 : 000b0000000809..  db "0B00089a00000000000000"
3cdc : 000b0000000000..  db "0B0000089a000000000000"
3cf2 : 00200203000000..  db "0a230000089a0000000000"
3d08 : 00000020020300..  db "000a2300000A0000000000"
3d1e : 00000000001500..  db "00000L00000A0000000000"
3d34 : 000000000b0000..  db "0000B000000IHa00000000"
3d4a : 000000000b0000..  db "0000B0000000089a000000"
3d60 : 00000000200203..  db "0000a2300000000A000000"
3d76 : 00000000000020..  db "000000a11F00000IHHa000"
3d8c : 00000000000000..  db "000000000B00000000A000"
3da2 : 00000000000000..  db "000000000B00000000A000"
3db8 : 00000000000000..  db "000000000a23000000A000"
3dce : 00000000000000..  db "00000000000a111FddA000"
3de4 : 00000000000000..  db "000000000000000BeeA000"
3dfa : 00000000000000..  db "000000000000000B0089a0"
3e10 : 00000000000000..  db "000000000000000B0000Ca"
3e26 : 00000000000000..  db "000000000000000B00000A"
3e3c : 00000000000000..  db "000000000000000B00000A"
3e52 : 00000000000000..  db "000000000000000B0000Ka"
3e68 : 00000000000000..  db "000000000000000aM045a0"
3e7e : 00000000000000..  db "0000000000000000a1a000"
3e94 :                  Level5_Guns:
3e94 : 07                 db 7  ;count
                          GunDef 2,-1, 7,9
3e95 : 00f00128        >   dw (TileW *  7) + HalfW, (TileH * 9) + HalfH + (GunY*-1)
3e99 : 02              >   db 2
                        
                          GunDef 3,-1, 14,9
3e9a : 01d00128        >   dw (TileW *  14) + HalfW, (TileH * 9) + HalfH + (GunY*-1)
3e9e : 03              >   db 3
                        
                          GunDef 1, 1, 10,19
3e9f : 01500278        >   dw (TileW *  10) + HalfW, (TileH * 19) + HalfH + (GunY* 1)
3ea3 : 01              >   db 1
                        
                          GunDef 3,-1, 13,28
3ea4 : 01b00388        >   dw (TileW *  13) + HalfW, (TileH * 28) + HalfH + (GunY*-1)
3ea8 : 03              >   db 3
                        
                          GunDef 0, 1, 6,29
3ea9 : 00d003b8        >   dw (TileW *  6) + HalfW, (TileH * 29) + HalfH + (GunY* 1)
3ead : 00              >   db 0
                        
                          GunDef 0, 1, 11,33
3eae : 01700438        >   dw (TileW *  11) + HalfW, (TileH * 33) + HalfH + (GunY* 1)
3eb2 : 00              >   db 0
                        
                          GunDef 3,-1, 20,37
3eb3 : 029004a8        >   dw (TileW *  20) + HalfW, (TileH * 37) + HalfH + (GunY*-1)
3eb7 : 03              >   db 3
                        
3eb8 :                  Level5_Fuel:
3eb8 : 08                 db 8  ;count
                          FuelDef 8,3
3eb9 : 01100075        >   dw (TileW * 8) + HalfW, (TileH * 3) + FuelY
                        
                          FuelDef 13,11
3ebd : 01b00175        >   dw (TileW * 13) + HalfW, (TileH * 11) + FuelY
                        
                          FuelDef 14,11
3ec1 : 01d00175        >   dw (TileW * 14) + HalfW, (TileH * 11) + FuelY
                        
                          FuelDef 6,19
3ec5 : 00d00275        >   dw (TileW * 6) + HalfW, (TileH * 19) + FuelY
                        
                          FuelDef 8,29
3ec9 : 011003b5        >   dw (TileW * 8) + HalfW, (TileH * 29) + FuelY
                        
                          FuelDef 9,29
3ecd : 013003b5        >   dw (TileW * 9) + HalfW, (TileH * 29) + FuelY
                        
                          FuelDef 13,33
3ed1 : 01b00435        >   dw (TileW * 13) + HalfW, (TileH * 33) + FuelY
                        
                          FuelDef 14,33
3ed5 : 01d00435        >   dw (TileW * 14) + HalfW, (TileH * 33) + FuelY
                        
3ed9 :                  Level5_Restart:
3ed9 : 05                 db 5  ;count
                          RestartDef 8,0
3eda : 0800            >   db 8,0
                        
                          RestartDef 11,9
3edc : 0b09            >   db 11,9
                        
                          RestartDef 9,16
3ede : 0910            >   db 9,16
                        
                          RestartDef 8,26
3ee0 : 081a            >   db 8,26
                        
                          RestartDef 18,38
3ee2 : 1226            >   db 18,38
                        
3ee4 :                  Level5_Doors:   ;also need mapchange for collision, 'bc' for horiz door, 'de' for vert door
3ee4 : 01                 db 1  ;count
                          DoorDef 1, 16,34
3ee5 : 01              >   db 1
3ee6 : 02000440        >   dw (TileW *  16), (TileH * 34)
                        
3eea :                  Level5_Switches:
3eea : 02                 db 2  ;count
                          SwitchDef 1, 17,32
                       >   if 1=0
                       >     dw (TileW *  17)                    ;left wall
                       >   else
3eeb : 0240            >     dw (TileW *  17) + TileW            ;right wall
                       >   endif
3eed : 0410            >   dw (TileH * 32) + HalfH
3eef : 01              >   db 1
                        
                          SwitchDef 0, 16,39
                       >   if 0=0
3ef0 : 0200            >     dw (TileW *  16)                    ;left wall
                       >   else
                       >     dw (TileW *  16) + TileW            ;right wall
                       >   endif
3ef2 : 04f0            >   dw (TileH * 39) + HalfH
3ef4 : 00              >   db 0
                        
                        
                        
3ef5 :                  Level6_Tiles:
3ef5 : 00000000000000..  db "000000000000000000000000000000"
3f13 : 0f000000000000..  db "F00000000000000000451111111111"
3f31 : 0b000000000000..  db "B00000000000000045a00000000000"
3f4f : 0b000000000000..  db "B000000000000045a0000000000000"
3f6d : 20160000000000..  db "aM000000000000A000000000000000"
3f8b : 00200101010102..  db "0a11112300000089a0000000000000"
3fa9 : 00000000000000..  db "0000000a2300000089a00000000000"
3fc7 : 00000000000000..  db "000000000a2300000089a000000000"
3fe5 : 00000000000000..  db "00000000000a2300000089a0000000"
4003 : 00000000000000..  db "0000000000000a2300000089a00000"
4021 : 00000000000000..  db "000000000000000a2300000089a000"
403f : 00000000000000..  db "00000000000000000a23000000A000"
405d : 00000000000000..  db "0000000000000000000a230000A000"
407b : 00000000000000..  db "000000000000000000000a2300A000"
4099 : 00000000000000..  db "00000000000000000000000B00A000"
40b7 : 00000000000000..  db "00000000000000000000aHHL00Aa00"
40d5 : 00000000000000..  db "0000000000000000000aJ0000089a0"
40f3 : 00000000000000..  db "0000000000000000000B00000000Ca"
4111 : 00000000000000..  db "0000000000000000000B000000000A"
412f : 00000000000000..  db "0000000000000000000B000045111a"
414d : 00000000000000..  db "0000000000000000000B0045a00000"
416b : 00000000000000..  db "0000000000000000000B00A0000000"
4189 : 00000000000000..  db "0000000000000000000B00A0000000"
41a7 : 00000000000000..  db "0000000000000000000B00A0000000"
41c5 : 00000000000000..  db "0000000000000000000B00Da000000"
41e3 : 00000000000000..  db "0000000000000000000B000Ca00000"
4201 : 00000000000000..  db "0000000000000000000B0000A00000"
421f : 00000000000000..  db "0000000000000000000B000Ka00000"
423d : 00000000000000..  db "00000000000000000aHL000A000000"
425b : 00000000000000..  db "00000000000000000B00000A000000"
4279 : 00000000000000..  db "00000000000000000B00000A000000"
4297 : 00000000000000..  db "00000000000000000B00000A000000"
42b5 : 00000000000000..  db "00000000000000000B00G11a000000"
42d3 : 00000000000000..  db "0000000000000000aN00A000000000"
42f1 : 00000000000000..  db "00000000000000a67000A000000000"
430f : 00000000000000..  db "00000000000000B0000089a0000000"
432d : 00000000000000..  db "00000000000000aM00000089a00000"
434b : 00000000000000..  db "000000000000000a2300000089a000"
4369 : 00000000000000..  db "00000000000000000a23000000A000"
4387 : 00000000000000..  db "0000000000000000000a230000A000"
43a5 : 00000000000000..  db "000000000000000000000a2300A000"
43c3 : 00000000000000..  db "00000000000000000000000BbcA000"
43e1 : 00000000000000..  db "000000000000000000000a6700A000"
43ff : 00000000000000..  db "000000000000000000000B0000A000"
441d : 00000000000000..  db "000000000000000000000B0000A000"
443b : 00000000000000..  db "000000000000000000000B0000A000"
4459 : 00000000000000..  db "00000000000000000000aJ0000A000"
4477 : 00000000000000..  db "00000000000000000000B00045a000"
4495 : 00000000000000..  db "00000000000000000000B00Oa00000"
44b3 : 00000000000000..  db "00000000000000000000B00A00HHH0"
44d1 : 00000000000000..  db "00000000000000000000B00A0B000A"
44ef : 00000000000000..  db "00000000000000000000a11a001110"
450d :                  Level6_Guns:
450d : 0a                 db 10  ;count
                          ;0=NE,1=NW,2=SE,3=SW
                          GunDef 3,-1, 16,6
450e : 021000c8        >   dw (TileW *  16) + HalfW, (TileH * 6) + HalfH + (GunY*-1)
4512 : 03              >   db 3
                        
                          GunDef 2,-1, 20,16
4513 : 02900208        >   dw (TileW *  20) + HalfW, (TileH * 16) + HalfH + (GunY*-1)
4517 : 02              >   db 2
                        
                          GunDef 3,-1, 28,17
4518 : 03900228        >   dw (TileW *  28) + HalfW, (TileH * 17) + HalfH + (GunY*-1)
451c : 03              >   db 3
                        
                          GunDef 3,-1, 23,25
451d : 02f00328        >   dw (TileW *  23) + HalfW, (TileH * 25) + HalfH + (GunY*-1)
4521 : 03              >   db 3
                        
                          GunDef 1, 1, 23,27
4522 : 02f00378        >   dw (TileW *  23) + HalfW, (TileH * 27) + HalfH + (GunY* 1)
4526 : 01              >   db 1
                        
                          GunDef 2,-1, 16,34
4527 : 02100448        >   dw (TileW *  16) + HalfW, (TileH * 34) + HalfH + (GunY*-1)
452b : 02              >   db 2
                        
                          GunDef 3,-1, 22,36
452c : 02d00488        >   dw (TileW *  22) + HalfW, (TileH * 36) + HalfH + (GunY*-1)
4530 : 03              >   db 3
                        
                          GunDef 2,-1, 23,42
4531 : 02f00548        >   dw (TileW *  23) + HalfW, (TileH * 42) + HalfH + (GunY*-1)
4535 : 02              >   db 2
                        
                          GunDef 2,-1, 21,46
4536 : 02b005c8        >   dw (TileW *  21) + HalfW, (TileH * 46) + HalfH + (GunY*-1)
453a : 02              >   db 2
                        
                          GunDef 1, 1, 24,47
453b : 031005f8        >   dw (TileW *  24) + HalfW, (TileH * 47) + HalfH + (GunY* 1)
453f : 01              >   db 1
                        
4540 :                  Level6_Fuel:
4540 : 02                 db 2  ;count
                          FuelDef 26,18
4541 : 03500255        >   dw (TileW * 26) + HalfW, (TileH * 18) + FuelY
                        
                          FuelDef 21,31
4545 : 02b003f5        >   dw (TileW * 21) + HalfW, (TileH * 31) + FuelY
                        
4549 :                  Level6_Restart:
4549 : 05                 db 5  ;count
                          RestartDef 9,3
454a : 0903            >   db 9,3
                        
                          RestartDef 22,18
454c : 1612            >   db 22,18
                        
                          RestartDef 21,26
454e : 151a            >   db 21,26
                        
                          RestartDef 18,35
4550 : 1223            >   db 18,35
                        
                          RestartDef 24,44
4552 : 182c            >   db 24,44
                        
4554 :                  Level6_Doors:   ;also need mapchange for collision, 'bc' for horiz door, 'de' for vert door
4554 : 01                 db 1  ;count
                          DoorDef 0, 24,41
4555 : 00              >   db 0
4556 : 03000520        >   dw (TileW *  24), (TileH * 41)
                        
                          ;**todo horiz pointy -> door
455a :                  Level6_Switches:
455a : 02                 db 2  ;count
                          SwitchDef 1, 25,40
                       >   if 1=0
                       >     dw (TileW *  25)                    ;left wall
                       >   else
455b : 0340            >     dw (TileW *  25) + TileW            ;right wall
                       >   endif
455d : 0510            >   dw (TileH * 40) + HalfH
455f : 01              >   db 1
                        
                          SwitchDef 0, 22,44
                       >   if 0=0
4560 : 02c0            >     dw (TileW *  22)                    ;left wall
                       >   else
                       >     dw (TileW *  22) + TileW            ;right wall
                       >   endif
4562 : 0590            >   dw (TileH * 44) + HalfH
4564 : 00              >   db 0
                        
                        
4565 :                  Level7_Tiles:
4565 : 00000000000000..   db "00000000000000000000000"
457c : 00000000000000..   db "00000000045F00000000000"
4593 : 01010101010101..   db "111111111a0BbcG11111111"
45aa : 00000000000000..   db "00000000000BbcA00000000"
45c1 : 00000000000000..   db "00000000000B00A00000000"
45d8 : 00000000000000..   db "00000000000B00A00000000"
45ef : 00000000000000..   db "00000000000BfgA00000000"
4606 : 00000000000000..   db "00000000000BfgA00000000"
461d : 20000000000000..   db "a0000000000B00DHHHHHHHH"
4634 : 08092000000000..   db "89a00000000B00000000dd0"
464b : 00000809200000..   db "0089a000000B00000000ee0"
4662 : 03000000080920..   db "300089a0000a111E0G11112"
4679 : 2002030000000a..   db "a23000A0000000aN0Da0000"
4690 : 00200b0000000a..   db "0aB000A0000000B000A0000"
46a7 : 00000b0000000a..   db "00B000A00000aHN000DHa00"
46be : 00000b0000000a..   db "00B000A00000B0000000A00"
46d5 : 00000b0000000a..   db "00B000A00000a1230451a00"
46ec : 00000b0000000a..   db "00B000A00000000a1a00000"
4703 : 00002001010120..   db "00a111a0000000000000000"
471a : 00000000000000..   db "00000000000000000000000"
4731 :                  Level7_Guns: ;0=NE,1=NW,2=SE,3=SW
4731 : 07                 db 7  ;count
                          GunDef 3, 1, 14,8
4732 : 01d00118        >   dw (TileW *  14) + HalfW, (TileH * 8) + HalfH + (GunY* 1)
4736 : 03              >   db 3
                        
                          GunDef 2, 1, 14,14
4737 : 01d001d8        >   dw (TileW *  14) + HalfW, (TileH * 14) + HalfH + (GunY* 1)
473b : 02              >   db 2
                        
                          GunDef 3, 1, 18,14
473c : 025001d8        >   dw (TileW *  18) + HalfW, (TileH * 14) + HalfH + (GunY* 1)
4740 : 03              >   db 3
                        
                          GunDef 0,-1, 14,16
4741 : 01d00208        >   dw (TileW *  14) + HalfW, (TileH * 16) + HalfH + (GunY*-1)
4745 : 00              >   db 0
                        
                          GunDef 0, 1, 15,16
4746 : 01f00218        >   dw (TileW *  15) + HalfW, (TileH * 16) + HalfH + (GunY* 1)
474a : 00              >   db 0
                        
                          GunDef 1, 1, 17,16
474b : 02300218        >   dw (TileW *  17) + HalfW, (TileH * 16) + HalfH + (GunY* 1)
474f : 01              >   db 1
                        
                          GunDef 1,-1, 18,16
4750 : 02500208        >   dw (TileW *  18) + HalfW, (TileH * 16) + HalfH + (GunY*-1)
4754 : 01              >   db 1
                        
4755 :                  Level7_Fuel:
4755 : 03                 db 3  ;count
                          FuelDef 3,17
4756 : 00700235        >   dw (TileW * 3) + HalfW, (TileH * 17) + FuelY
                        
                          FuelDef 4,17
475a : 00900235        >   dw (TileW * 4) + HalfW, (TileH * 17) + FuelY
                        
                          FuelDef 5,17
475e : 00b00235        >   dw (TileW * 5) + HalfW, (TileH * 17) + FuelY
                        
4762 :                  Level7_Restart:
4762 : 03                 db 3  ;count
                          RestartDef 13,0
4763 : 0d00            >   db 13,0
                        
                          RestartDef 13,9
4765 : 0d09            >   db 13,9
                        
                          RestartDef 16,15
4767 : 100f            >   db 16,15
                        
4769 :                  Level7_Doors:   ;also need mapchange for collision, 'bc' for horiz door, 'de' for vert door
4769 : 05                 db 5  ;count
                          DoorDef 0, 12,2
476a : 00              >   db 0
476b : 01800040        >   dw (TileW *  12), (TileH * 2)
                        
                          DoorDef 0, 12,3
476f : 00              >   db 0
4770 : 01800060        >   dw (TileW *  12), (TileH * 3)
                        
                          DoorDef 2, 12,6
4774 : 02              >   db 2
4775 : 018000c0        >   dw (TileW *  12), (TileH * 6)
                        
                          DoorDef 2, 12,7
4779 : 02              >   db 2
477a : 018000e0        >   dw (TileW *  12), (TileH * 7)
                        
                          DoorDef 3, 20,9
477e : 03              >   db 3
477f : 02800120        >   dw (TileW *  20), (TileH * 9)
                        
4783 :                  Level7_Switches:
4783 : 03                 db 3  ;count
                          SwitchDef 0, 12,1
                       >   if 0=0
4784 : 0180            >     dw (TileW *  12)                    ;left wall
                       >   else
                       >     dw (TileW *  12) + TileW            ;right wall
                       >   endif
4786 : 0030            >   dw (TileH * 1) + HalfH
4788 : 00              >   db 0
                        
                          SwitchDef 1, 13,4
                       >   if 1=0
                       >     dw (TileW *  13)                    ;left wall
                       >   else
4789 : 01c0            >     dw (TileW *  13) + TileW            ;right wall
                       >   endif
478b : 0090            >   dw (TileH * 4) + HalfH
478d : 01              >   db 1
                        
                          SwitchDef 1, 5,16
                       >   if 1=0
                       >     dw (TileW *  5)                    ;left wall
                       >   else
478e : 00c0            >     dw (TileW *  5) + TileW            ;right wall
                       >   endif
4790 : 0210            >   dw (TileH * 16) + HalfH
4792 : 01              >   db 1
                        
                        
                        
4793 :                  Level8_Tiles:
4793 : 00000000000000..   db "0000000000000000000000000"
47ac : 01010101010f00..   db "11111F00G11111111FbcG1111"
47c5 : 00000000000b00..   db "00000B00A00000000B00A0000"
47de : 00000000000b00..   db "00000B00A00000000B30A0000"
47f7 : 00000000201304..   db "0000aJ43Ca0000000B70A0000"
4810 : 000000000b0008..   db "0000B0870A0000000B00A0000"
4829 : 000000000b0004..   db "0000B0430A0000000B00A0000"
4842 : 00000000201608..   db "0000aM87Ka0000000B00A0000"
485b : 00000000000b00..   db "00000B00A00000000B00A0000"
4874 : 00000000000b00..   db "00000B00A00000000B04A0000"
488d : 00000000000b00..   db "00000B00A00000000B08A0000"
48a6 : 00000000000b00..   db "00000B00A00000000B00A0000"
48bf : 00000000000b00..   db "00000B00D00000000B00A0000"
48d8 : 00000000000b00..   db "00000B00O00000000B00A0000"
48f1 : 00000000000b00..   db "00000B00A00000000B00A0000"
490a : 00000000000b00..   db "00000B00A00000000B30A0000"
4923 : 00000000200b00..   db "0000aB00Aa0000000B70A0000"
493c : 00000020060704..   db "000a674389a000000B00A0000"
4955 : 00200607040308..   db "0a6743874389a0000B00A0000"
496e : 00200203080704..   db "0a2387438745a0000B00A0000"
4987 : 00000020020308..   db "000a238745a000000B00A0000"
49a0 : 00000000200b00..   db "0000aB00Aa0000000B00A0000"
49b9 : 00000000000b00..   db "00000B00A00000aHHL00A0000"
49d2 : 00000000000b00..   db "00000B00A00000B00000A0000"
49eb : 00000000001700..   db "00000N00A00000a11F00A0000"
4a04 : 00000000000e00..   db "00000E00A0000000aB00Aa000"
4a1d : 00000000000b00..   db "00000B00A000000a670089a00"
4a36 : 00000000000b00..   db "00000B00A0000a6700430089a"
4a4f : 00000000000b00..   db "00000B00A0000a2300870045a"
4a68 : 00000000201300..   db "0000aJ00Ca00000a230045a00"
4a81 : 00000000201600..   db "0000aM00Ka00aa000B00Aa000"
4a9a : 00000000000b00..   db "00000B00DHHH69HHHN00A0000"
4ab3 : 00000000000b00..   db "00000B00000000000000A0000"
4acc : 00000000000b00..   db "00000B00000000000000A0000"
4ae5 : 00000000000b00..   db "00000B00000043000000A0000"
4afe : 00000000002001..   db "00000a111111aa111111a0000"
4b17 :                  Level8_Guns: ;0=NE,1=NW,2=SE,3=SW
4b17 : 08                 db 8  ;count
                          GunDef 1,-1,  8,13
4b18 : 011001a8        >   dw (TileW *   8) + HalfW, (TileH * 13) + HalfH + (GunY*-1)
4b1c : 01              >   db 1
                        
                          GunDef 0,-1,  5,25
4b1d : 00b00328        >   dw (TileW *   5) + HalfW, (TileH * 25) + HalfH + (GunY*-1)
4b21 : 00              >   db 0
                        
                          GunDef 1, 1,  8,30
4b22 : 011003d8        >   dw (TileW *   8) + HalfW, (TileH * 30) + HalfH + (GunY* 1)
4b26 : 01              >   db 1
                        
                          GunDef 2, 1, 17,31
4b27 : 023003f8        >   dw (TileW *  17) + HalfW, (TileH * 31) + HalfH + (GunY* 1)
4b2b : 02              >   db 2
                        
                          GunDef 2,-1, 19,28
4b2c : 02700388        >   dw (TileW *  19) + HalfW, (TileH * 28) + HalfH + (GunY*-1)
4b30 : 02              >   db 2
                        
                          GunDef 2,-1, 18,16
4b31 : 02500208        >   dw (TileW *  18) + HalfW, (TileH * 16) + HalfH + (GunY*-1)
4b35 : 02              >   db 2
                        
                          GunDef 2,-1, 17,26
4b36 : 02300348        >   dw (TileW *  17) + HalfW, (TileH * 26) + HalfH + (GunY*-1)
4b3a : 02              >   db 2
                        
                          GunDef 3,-1, 20,26
4b3b : 02900348        >   dw (TileW *  20) + HalfW, (TileH * 26) + HalfH + (GunY*-1)
4b3f : 03              >   db 3
                        
4b40 :                  Level8_Fuel:
4b40 : 01                 db 1  ;count
                          FuelDef 17,34
4b41 : 02300455        >   dw (TileW * 17) + HalfW, (TileH * 34) + FuelY
                        
4b45 :                  Level8_Restart:
4b45 : 07                 db 7  ;count
                          RestartDef 7,0
4b46 : 0700            >   db 7,0
                        
                          RestartDef 7,11
4b48 : 070b            >   db 7,11
                        
                          RestartDef 7,25
4b4a : 0719            >   db 7,25
                        
                          RestartDef 9,33
4b4c : 0921            >   db 9,33
                        
                          RestartDef 19,11
4b4e : 130b            >   db 19,11
                        
                          RestartDef 19,25
4b50 : 1319            >   db 19,25
                        
                          RestartDef 18,33
4b52 : 1221            >   db 18,33
                        
4b54 :                  Level8_Doors:   ;also need mapchange for collision, 'bc' for horiz door, 'de' for vert door
4b54 : 01                 db 1  ;count
                          DoorDef 0, 18,1
4b55 : 00              >   db 0
4b56 : 02400020        >   dw (TileW *  18), (TileH * 1)
                        
4b5a :                  Level8_Switches:
4b5a : 01                 db 1  ;count
                          SwitchDef 1, 19,4
                       >   if 1=0
                       >     dw (TileW *  19)                    ;left wall
                       >   else
4b5b : 0280            >     dw (TileW *  19) + TileW            ;right wall
                       >   endif
4b5d : 0090            >   dw (TileH * 4) + HalfH
4b5f : 01              >   db 1
                        
                        
                         endif ;if Level1Only
                        
                        
                          cmap ;reset mapping
                        
                        
                        ; END OF LEVELS
                        ;--------------
                        
                        
                        
000c =                  ShipUnit equ 12
4b60 :                  ShipVectorList:
                          ;rel y, rel x. first coord is not drawn, only moved.
                          ;negative y is down, negative x is left
4b60 : 3000               db  (ShipUnit * 4), (ShipUnit * 0)
4b62 : b8dc               db -(ShipUnit * 6),-(ShipUnit * 3)
4b64 : 00f4               db  (ShipUnit * 0),-(ShipUnit * 1)
4b66 : e818               db -(ShipUnit * 2), (ShipUnit * 2)
4b68 : 0c0c               db  (ShipUnit * 1), (ShipUnit * 1)
4b6a : 0018               db  (ShipUnit * 0), (ShipUnit * 2)
4b6c : f40c               db -(ShipUnit * 1), (ShipUnit * 1)
4b6e : 1818               db  (ShipUnit * 2), (ShipUnit * 2)
4b70 : 00f4               db  (ShipUnit * 0),-(ShipUnit * 1)
4b72 : 48dc               db  (ShipUnit * 6),-(ShipUnit * 3)
                          ;Extra points for thrust-effect at ships tail
                          ;\/
4b74 : acf7               db -(ShipUnit * 7),-(ShipUnit * 1 - 3) ;invisible line from ships tip to tail
4b76 : e809               db -(ShipUnit * 2), (ShipUnit * 1 - 3)
4b78 : 1809               db  (ShipUnit * 2), (ShipUnit * 1 - 3)
                        
                        
0008 =                  SU=8
4b7a :                  OrbVectorList:
4b7a : 08                 db  8                 ;count-1
4b7b : 20f0               db  (SU * 4),-(SU * 2)
4b7d : 0020               db  (SU * 0), (SU * 4)
4b7f : f010               db -(SU * 2), (SU * 2)
4b81 : e000               db -(SU * 4), (SU * 0)
4b83 : f0f0               db -(SU * 2),-(SU * 2)
4b85 : 00e0               db  (SU * 0),-(SU * 4)
4b87 : 10f0               db  (SU * 2),-(SU * 2)
4b89 : 2000               db  (SU * 4), (SU * 0)
4b8b : 1010               db  (SU * 2), (SU * 2)
                        
                        ;/\
                        ;\/
0018 =                  SU=24
4b8d :                  WarpVectorList:
4b8d : 04                 db  4                 ;count-1
4b8e : 3000               db  (SU * 2), (SU * 0)
4b90 : d0d0               db -(SU * 2),-(SU * 2)
4b92 : d030               db -(SU * 2), (SU * 2)
4b94 : 3030               db  (SU * 2), (SU * 2)
4b96 : 30d0               db  (SU * 2),-(SU * 2)
4b98 : ff                 db  $ff       ;end byte so it can be drawn with drawsprite also
                        
0011 =                  ShieldUnit = 17
4b99 :                  ShieldVectorList:
4b99 : 44de               db  (ShieldUnit * 4),-(ShieldUnit * 2)
4b9b : 0044               db  (ShieldUnit * 0), (ShieldUnit * 4)
4b9d : de22               db -(ShieldUnit * 2), (ShieldUnit * 2)
4b9f : bc00               db -(ShieldUnit * 4), (ShieldUnit * 0)
4ba1 : dede               db -(ShieldUnit * 2),-(ShieldUnit * 2)
4ba3 : 00bc               db  (ShieldUnit * 0),-(ShieldUnit * 4)
4ba5 : 22de               db  (ShieldUnit * 2),-(ShieldUnit * 2)
4ba7 : 4400               db  (ShieldUnit * 4), (ShieldUnit * 0)
4ba9 : 2222               db  (ShieldUnit * 2), (ShieldUnit * 2)
                        
000f =                  SU=15
4bab :                  RefuelVectorList:
4bab : 3cc4               db  (SU * 4),-(SU * 4)
4bad : 0078               db  (SU * 0), (SU * 8)
4baf : 8800               db -(SU * 8), (SU * 0)
4bb1 : 0088               db  (SU * 0),-(SU * 8)
4bb3 : 7800               db  (SU * 8), (SU * 0)
                        
                        
                        ;-----------------
                        ;Lines for sprites that use the DrawSprite-routine
                        ;-----------------
                        
                        ;Sprite scale factor. Set to a value that makes the sprites look good when drawn with scale DrawScale
0004 =                  SF set 4
                        
                        ;Sprite unit Height and Width. Relative to size of tiles.
                        ;The "-1" allows a 8x8 -128 -- 127 resolution without hitting 128
000f =                  SH set ((TileH/8) * SF)-1
000f =                  SW set ((TileW/8) * SF)-1
                        
4bb5 :                  SpriteGunNE:
4bb5 : 06                 db 6                  ;count-1
4bb6 : 1ec4               db  (SH*2),-(SW*4)    ;start pos
4bb8 : 003c               db  (SH*0), (SW*4)
4bba : f100               db -(SH*1), (SW*0)
4bbc : 001e               db  (SH*0), (SW*2)
4bbe : f100               db -(SH*1), (SW*0)
4bc0 : 001e               db  (SH*0), (SW*2)
4bc2 : e200               db -(SH*2), (SW*0)
4bc4 : ff                 db $FF                ;end
                        
4bc5 :                  SpriteGunNW:
4bc5 : 06                 db 6                  ;count-1
4bc6 : 1e3c               db  (SH*2), (SW*4)    ;start pos
4bc8 : 00c4               db  (SH*0),-(SW*4)
4bca : f100               db -(SH*1), (SW*0)
4bcc : 00e2               db  (SH*0),-(SW*2)
4bce : f100               db -(SH*1), (SW*0)
4bd0 : 00e2               db  (SH*0),-(SW*2)
4bd2 : e200               db -(SH*2), (SW*0)
4bd4 : ff                 db $FF                ;end
                        
4bd5 :                  SpriteGunSE:
4bd5 : 06                 db 6                  ;count-1
4bd6 : e2c4               db -(SH*2),-(SW*4)    ;start pos
4bd8 : 003c               db  (SH*0), (SW*4)
4bda : 0f00               db  (SH*1), (SW*0)
4bdc : 001e               db  (SH*0), (SW*2)
4bde : 0f00               db  (SH*1), (SW*0)
4be0 : 001e               db  (SH*0), (SW*2)
4be2 : 1e00               db  (SH*2), (SW*0)
4be4 : ff                 db $FF                ;end
                        
4be5 :                  SpriteGunSW:
4be5 : 06                 db 6                  ;count-1
4be6 : e23c               db -(SH*2), (SW*4)    ;start pos
4be8 : 00c4               db  (SH*0),-(SW*4)
4bea : 0f00               db  (SH*1), (SW*0)
4bec : 00e2               db  (SH*0),-(SW*2)
4bee : 0f00               db  (SH*1), (SW*0)
4bf0 : 00e2               db  (SH*0),-(SW*2)
4bf2 : 1e00               db  (SH*2), (SW*0)
4bf4 : ff                 db $FF                ;end
                        
                        
4bf5 :                  SpriteFuelCell:
4bf5 : 05                 db 5                  ;count-1
4bf6 : c4c4               db -(SH*4),-(SW*4)    ;start pos
4bf8 : 6900               db  (SH*7), (SW*0)
4bfa : 0f0f               db  (SH*1), (SW*1)
4bfc : 005a               db  (SH*0), (SW*6)
4bfe : f10f               db -(SH*1), (SW*1)
4c00 : 9700               db -(SH*7), (SW*0)
4c02 : 02                 db 2                  ;count-1
4c03 : 1eb5               db  (SH*2),-(SW*5)    ;start pos
4c05 : 2d00               db  (SH*3), (SW*0)
4c07 : 001e               db  (SH*0), (SW*2)
4c09 : 01                 db 1                  ;count-1
4c0a : f1f1               db -(SH*1),-(SW*1)    ;start pos
4c0c : 00f1               db  (SH*0),-(SW*1)
4c0e : ff                 db $FF                ;end
                        
                        
                        mVec macro yy,xx
                          db (yy*SH),(xx*SW)
                          endm
                        
                        
                        
                        ; /\
                        ; \/
                        ;|  |
                        ;|  |
4c0f :                  SpriteStationaryPod:
4c0f : 04                 db 4
                          mVec 0,0
4c10 : 0000            >  db (0*SH),(0*SW)
                        
                          mVec 2,2
4c12 : 1e1e            >  db (2*SH),(2*SW)
                        
                          mVec 2,-2
4c14 : 1ee2            >  db (2*SH),(-2*SW)
                        
                          mVec -2,-2
4c16 : e2e2            >  db (-2*SH),(-2*SW)
                        
                          mVec -2,2
4c18 : e21e            >  db (-2*SH),(2*SW)
                        
4c1a : 06                 db 6
                          mVec -4,-4
4c1b : c4c4            >  db (-4*SH),(-4*SW)
                        
                          mVec 4,0
4c1d : 3c00            >  db (4*SH),(0*SW)
                        
                          mVec 0,2
4c1f : 001e            >  db (0*SH),(2*SW)
                        
                          mVec -2,2
4c21 : e21e            >  db (-2*SH),(2*SW)
                        
                          mVec 2,2
4c23 : 1e1e            >  db (2*SH),(2*SW)
                        
                          mVec 0,2
4c25 : 001e            >  db (0*SH),(2*SW)
                        
                          mVec -4,0
4c27 : c400            >  db (-4*SH),(0*SW)
                        
4c29 : ff                 db $FF
                        
                        
4c2a :                  SpritePowerplant:
4c2a : 06                 db 6
                          mVec 4,3
4c2b : 3c2d            >  db (4*SH),(3*SW)
                        
                          mVec -6,0
4c2d : a600            >  db (-6*SH),(0*SW)
                        
                          mVec 0,-7
4c2f : 0097            >  db (0*SH),(-7*SW)
                        
                          mVec -2,0
4c31 : e200            >  db (-2*SH),(0*SW)
                        
                          mVec 0,8
4c33 : 0078            >  db (0*SH),(8*SW)
                        
                          mVec 8,0
4c35 : 7800            >  db (8*SH),(0*SW)
                        
                          mVec 0,-1
4c37 : 00f1            >  db (0*SH),(-1*SW)
                        
4c39 : 05                 db 5
                          mVec -1,0
4c3a : f100            >  db (-1*SH),(0*SW)
                        
                          mVec 1,-1
4c3c : 0ff1            >  db (1*SH),(-1*SW)
                        
                          mVec 0,-4
4c3e : 00c4            >  db (0*SH),(-4*SW)
                        
                          mVec -2,-2
4c40 : e2e2            >  db (-2*SH),(-2*SW)
                        
                          mVec -3,0
4c42 : d300            >  db (-3*SH),(0*SW)
                        
                          mVec -1,1
4c44 : f10f            >  db (-1*SH),(1*SW)
                        
4c46 : ff                 db $FF
                        
                        
                        ;\
                        ;/
4c47 :                  SpriteSwitchLeft:
4c47 : 02                 db 2
                          mVec -2,0
4c48 : e200            >  db (-2*SH),(0*SW)
                        
                          mVec 2,2
4c4a : 1e1e            >  db (2*SH),(2*SW)
                        
                          mVec 2,-2
4c4c : 1ee2            >  db (2*SH),(-2*SW)
                        
4c4e : ff                 db $FF
4c4f :                  SpriteSwitchRight:
4c4f : 02                 db 2
                          mVec -2,0
4c50 : e200            >  db (-2*SH),(0*SW)
                        
                          mVec 2,-2
4c52 : 1ee2            >  db (2*SH),(-2*SW)
                        
                          mVec 2,2
4c54 : 1e1e            >  db (2*SH),(2*SW)
                        
4c56 : ff                 db $FF
                        
                        
4c57 :                  Score150_Lines:
                          ;1
4c57 : 01                 db 1
                          mVec 2,-5
4c58 : 1eb5            >  db (2*SH),(-5*SW)
                        
                          mVec -4,0
4c5a : c400            >  db (-4*SH),(0*SW)
                        
                        
                          ;5
4c5c : 05                 db 5
                          mVec 4,6
4c5d : 3c5a            >  db (4*SH),(6*SW)
                        
                          mVec 0,-4
4c5f : 00c4            >  db (0*SH),(-4*SW)
                        
                          mVec -2,0
4c61 : e200            >  db (-2*SH),(0*SW)
                        
                          mVec 0,4
4c63 : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -2,0
4c65 : e200            >  db (-2*SH),(0*SW)
                        
                          mVec 0,-4
4c67 : 00c4            >  db (0*SH),(-4*SW)
                        
                        
                          ;0
4c69 : 04                 db 4
                          mVec 4,5
4c6a : 3c4b            >  db (4*SH),(5*SW)
                        
                          mVec 0,4
4c6c : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -4,0
4c6e : c400            >  db (-4*SH),(0*SW)
                        
                          mVec 0,-4
4c70 : 00c4            >  db (0*SH),(-4*SW)
                        
                          mVec 4,0
4c72 : 3c00            >  db (4*SH),(0*SW)
                        
                        
4c74 : ff                 db $ff
                        
4c75 :                  Score300_Lines:
                          ;3
4c75 : 03                 db 3
                          mVec 2,-6
4c76 : 1ea6            >  db (2*SH),(-6*SW)
                        
                          mVec 0,4
4c78 : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -4,0
4c7a : c400            >  db (-4*SH),(0*SW)
                        
                          mVec 0,-4
4c7c : 00c4            >  db (0*SH),(-4*SW)
                        
4c7e : 01                 db 1
                          mVec 2,0
4c7f : 1e00            >  db (2*SH),(0*SW)
                        
                          mVec 0,4
4c81 : 003c            >  db (0*SH),(4*SW)
                        
                        
                          ;0
4c83 : 04                 db 4
                          mVec 2,1
4c84 : 1e0f            >  db (2*SH),(1*SW)
                        
                          mVec 0,4
4c86 : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -4,0
4c88 : c400            >  db (-4*SH),(0*SW)
                        
                          mVec 0,-4
4c8a : 00c4            >  db (0*SH),(-4*SW)
                        
                          mVec 4,0
4c8c : 3c00            >  db (4*SH),(0*SW)
                        
                        
                          ;0
4c8e : 04                 db 4
                          mVec 0,5
4c8f : 004b            >  db (0*SH),(5*SW)
                        
                          mVec 0,4
4c91 : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -4,0
4c93 : c400            >  db (-4*SH),(0*SW)
                        
                          mVec 0,-4
4c95 : 00c4            >  db (0*SH),(-4*SW)
                        
                          mVec 4,0
4c97 : 3c00            >  db (4*SH),(0*SW)
                        
                        
4c99 : ff                 db $ff
                        
4c9a :                  Score750_Lines:
                          ;7
4c9a : 02                 db 2
                          mVec 2,-6
4c9b : 1ea6            >  db (2*SH),(-6*SW)
                        
                          mVec 0,4
4c9d : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -4,-4
4c9f : c4c4            >  db (-4*SH),(-4*SW)
                        
                        
                          ;5
4ca1 : 05                 db 5
                          mVec 4,7
4ca2 : 3c69            >  db (4*SH),(7*SW)
                        
                          mVec 0,-4
4ca4 : 00c4            >  db (0*SH),(-4*SW)
                        
                          mVec -2,0
4ca6 : e200            >  db (-2*SH),(0*SW)
                        
                          mVec 0,4
4ca8 : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -2,0
4caa : e200            >  db (-2*SH),(0*SW)
                        
                          mVec 0,-4
4cac : 00c4            >  db (0*SH),(-4*SW)
                        
                        
                          ;0
4cae : 04                 db 4
                          mVec 4,5
4caf : 3c4b            >  db (4*SH),(5*SW)
                        
                          mVec 0,4
4cb1 : 003c            >  db (0*SH),(4*SW)
                        
                          mVec -4,0
4cb3 : c400            >  db (-4*SH),(0*SW)
                        
                          mVec 0,-4
4cb5 : 00c4            >  db (0*SH),(-4*SW)
                        
                          mVec 4,0
4cb7 : 3c00            >  db (4*SH),(0*SW)
                        
                        
4cb9 : ff                 db $ff
                        
                        
                        ;END OF SPRITES
                        ;-----------------
                        
                        
                          include "Thrust_Text.asm"
                        ; Thrust text constants and text/menu display code.
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        mMakeTextCoord macro lineY,lengthX
                         mCombine d, (-(10*(lineY))), (0 - ((lengthX*8)/2))
                         endm
                        
                        
                        ;From x to u, until (and including) end byte
f8de =                  Text_CopyString = $F8DE
                        
                        
                        ;*****************
4cba :                  Text_Print:   ;x=string pointer, a/b screen coords
                          mDecLocals 0,2,0
                       >  nolist
                        
                        
4cbc : ede4               std LocalW1,s
4cbe : af62               stx LocalW2,s
                        
4cc0 : ccfc30             ldd   #0xFC30    ;#0xFC38
4cc3 : fdc82a             std   $C82A           ;Specify height and width
4cc6 : bdf354             jsr reset0ref
                          mSetScale $7f
                       >  if 1=1
4cc9 : 867f            >    lda #$7f                  ;if argument exists, load into a, otherwise use current a
                       >  endif
4ccb : 9704            >  sta <$04
                        
                          mSetIntensity $40
                       >  if 1=1
4ccd : 8640            >    lda   #$40            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
4ccf : 9701            >  sta   <01
4cd1 : cc0401          >  ldd   #$0401
4cd4 : 9700            >  sta   <00
4cd6 : d700            >  stb   <00
                        
4cd8 : ece4               ldd LocalW1,s
4cda : bdf312             jsr move_pen_d
                        
4cdd : ee62               ldu LocalW2,s
4cdf : bdf495             jsr display_string    ;rom struntar i scale
                        
                          mFreeLocals
4ce2 : 3264            >  leas FrameSize,s
                        
4ce4 : 39                 rts
                        
                        
                        ;*****************
4ce5 :                  Text_Print_Intensity:   ;x=string pointer, y screen coords, a intensity
                          mDecLocals 1,1,0
                       >  nolist
                        
                        
4ce7 : a7e4               sta LocalB1,s
4ce9 : af61               stx LocalW1,s
                        
4ceb : ccfc30             ldd   #0xFC30    ;#0xFC38
4cee : fdc82a             std   $C82A           ;Specify height and width
4cf1 : bdf354             jsr reset0ref
                          mSetScale $7f
                       >  if 1=1
4cf4 : 867f            >    lda #$7f                  ;if argument exists, load into a, otherwise use current a
                       >  endif
4cf6 : 9704            >  sta <$04
                        
4cf8 : a6e4               lda LocalB1,s
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
4cfa : 9701            >  sta   <01
4cfc : cc0401          >  ldd   #$0401
4cff : 9700            >  sta   <00
4d01 : d700            >  stb   <00
                        
4d03 : 1f20               tfr y,d
4d05 : bdf312             jsr move_pen_d
                        
4d08 : ee61               ldu LocalW1,s
4d0a : bdf495             jsr display_string    ;rom-code ignores current scale
                        
                          mFreeLocals
4d0d : 3263            >  leas FrameSize,s
                        
4d0f : 39                 rts
                        
                        
                        
                        ;*****************
4d10 :                  Text_PrintWait:   ;waits for one second
                        ;x = pointer to list: {1},coords,stringptr,coords,stringptr, ... , $0000
                        ;if first byte is 1, then wait for keypress
000a =                  MaxLines = 10
                          mDecLocals 3,4,MaxLines
                       >  nolist
                        
0001 =                  LocalExitType = LocalB2
0002 =                  LocalSaveDP = LocalB3
0009 =                  LocalCallback = LocalW4
                        
4d13 : 336b               leau LocalBuffer,s    ;init wait-buffer
4d15 : 86fe               lda #-2
4d17 : c60a               ldb #MaxLines
4d19 :                  tpwInitWait:
4d19 : a7c0               sta ,u+
4d1b : 801a               suba #26
4d1d : 5a                 decb
4d1e : 26f9               bne tpwInitWait
                        
4d20 : 5f                 clrb
4d21 : a684               lda ,x
4d23 : 8101               cmpa #1
4d25 : 2603               bne tpwNoMenu         ;check for first byte 1: 'menu' mode, return keypress
4d27 : 3001                 leax 1,x
4d29 : 5c                   incb
4d2a :                  tpwNoMenu:
4d2a : e761               stb LocalExitType,s
                        
4d2c : a684               lda ,x
4d2e : 8102               cmpa #2
4d30 : 260d               bne tpwNoQuick        ;check for first byte 2: skip animation
4d32 : 3001                 leax 1,x
4d34 : 8640                 lda #$40
4d36 : 336b                 leau LocalBuffer,s    ;init wait-buffer
4d38 : c60a                 ldb #MaxLines
4d3a :                  tpwInitQuick:
4d3a : a7c0                 sta ,u+
4d3c : 5a                   decb
4d3d : 26fb                 bne tpwInitQuick
4d3f :                  tpwNoQuick:
                        
4d3f : 4f                 clra
4d40 : 5f                 clrb
4d41 : ed69               std LocalCallback,s
4d43 : a684               lda ,x
4d45 : 8103               cmpa #3
4d47 : 2606               bne tpwNoCallback     ;check for first byte 3: callback
4d49 : ec01                 ldd 1,x
4d4b : ed69                 std LocalCallback,s
4d4d : 3003                 leax 3,x
4d4f :                  tpwNoCallback:
                        
4d4f : af63               stx LocalW1,s
                        
                          ;Save dp, meny is called from both title (d0) and game (c8)-code
4d51 : 1fb8               tfr dp,a
4d53 : a762               sta LocalSaveDP,s
                          mDptoD0
4d55 : 86d0            >  lda   #0xD0
4d57 : 1f8b            >  tfr   a,dp
                       >  direct -1
                        
                        
4d59 : 8678               lda #120
4d5b : a7e4               sta LocalB1,s
4d5d :                  tpwWait:
4d5d : bdf192             jsr waitrecal         ;Wait for screen sync
4d60 : bdf289             jsr UpdateSoundChip
                        
4d63 : ae69               ldx LocalCallback,s
4d65 : 2702               beq tpwNoCallCallback
4d67 : ad84                 jsr ,x
4d69 :                  tpwNoCallCallback:
                        
4d69 : 336b               leau LocalBuffer,s
4d6b : ef67               stu LocalW3,s
                        
4d6d : 10ae63             ldy LocalW1,s
4d70 :                  tpwNextLine:
4d70 : eca1               ldd ,y++
4d72 : 2737               beq tpwNoMoreLines
4d74 : aea1               ldx ,y++
4d76 : 10af65             sty LocalW2,s
4d79 : 1f02               tfr d,y
                        
4d7b : ee67               ldu LocalW3,s         ;update wait-buffer for each line
4d7d : a6c0               lda ,u+
4d7f : ef67               stu LocalW3,s
4d81 : 8140               cmpa #$40
4d83 : 2706               beq tpwSkipInc
4d85 : 4c                 inca
4d86 : 4c                 inca
4d87 : a75f               sta -1,u
4d89 : 2b1b               bmi tpwSkipLine
4d8b :                  tpwSkipInc:
                        
                          ;value from wait-buffer is used for intensity and coord-offsets
4d8b : a77f               sta -1,s
4d8d : 40                 nega
4d8e : 8b40               adda #$40
4d90 : ce6d3f             ldu #SineTable
4d93 : a6c6               lda a,u
                        ; asra
4d95 : a77e               sta -2,s
4d97 : 1f20               tfr y,d
4d99 : ab7e               adda -2,s
4d9b : eb7e               addb -2,s
4d9d : 1f02               tfr d,y
4d9f : a67f               lda -1,s
4da1 : 8b10               adda #$10
4da3 : bd4ce5             jsr Text_Print_Intensity
                        
4da6 :                  tpwSkipLine:
4da6 : 10ae65             ldy LocalW2,s
4da9 : 20c5               bra tpwNextLine
4dab :                  tpwNoMoreLines:
                        
4dab : bd049c             jsr UpdateSound
                        
4dae : 6d61               tst LocalExitType,s
4db0 : 2713               beq tpwTestDelayExit
                        
4db2 : 860f               lda #1 + 2 + 4 + 8    ;exit after keypress (menu)
4db4 : bdf1b4             jsr read_switches
                        
4db7 : 8ec812             ldx #$C812
4dba : c603               ldb #3
4dbc :                  tpwNextButton:
4dbc : 6d85               tst b,x
4dbe : 260b               bne tpwExit           ;exit with key in B
4dc0 : 5a                 decb
4dc1 : 2af9               bpl tpwNextButton
                        
4dc3 : 2098               bra tpwWait
                        
4dc5 :                  tpwTestDelayExit:       ;exit after 1 second
4dc5 : 6ae4               dec LocalB1,s
4dc7 : 2702               beq tpwExit
                        
4dc9 : 2092               bra tpwWait
                        
4dcb :                  tpwExit:
                          ;Restore dp
4dcb : a662               lda LocalSaveDP,s
4dcd : 1f8b               tfr a,dp
                        
                          mFreeLocals
4dcf : 32e815          >  leas FrameSize,s
                        
4dd2 : 39                 rts
                        
                        
                        ;*****************
4dd3 :                  Text_PrintX:            ;x holds value to be printed (max 9999), a/b screen coords
                          mDecLocals 0,1,5
                       >  nolist
                        
                        
4dd5 : ede4               std LocalW1,s
                        
4dd7 : 3362               leau LocalBuffer,s
4dd9 : 8d0e               bsr Text_ConvertX
                        
4ddb : c680               ldb #$80              ;add end byte
4ddd : e744               stb 4,u
                        
4ddf : ece4               ldd LocalW1,s
4de1 : 3062               leax LocalBuffer,s
4de3 : bd4cba             jsr Text_Print
                        
                          mFreeLocals
4de6 : 3267            >  leas FrameSize,s
                        
4de8 : 39                 rts
                        
                        
                        ;*****************
4de9 :                  Text_ConvertX           ;x holds value to be converted (max 9999), u = destination buffer (4 bytes needed)
                          ;NOTE: this subroutine has two entry-points, be careful with stack usage
4de9 : cc2020             ldd #'  '
4dec : edc4               std ,u
4dee : ed42               std 2,u
                        
4df0 : 8c0064             cmpx #100
4df3 : 10250118           lblo tlsBelow100
4df7 : 8c03e8             cmpx #1000
4dfa : 10250087           lblo tlsBelow1000
                        
                        m_1 macro max,digit
                          cmpx #max-1
                          bls tpd\1
                          leax -max,x
                          lda #'digit'
                          sta 0,u
                          bra tlsBelow1000
                        tpd\1:
                          endm
                        
                          m_1 9000,9
4dfe : 8c2327          >  cmpx #9000-1
4e01 : 230a            >  bls tpd9000
4e03 : 3089dcd8        >  leax -9000,x
4e07 : 8639            >  lda #'9'
4e09 : a7c4            >  sta 0,u
4e0b : 2078            >  bra tlsBelow1000
4e0d :                 >tpd9000:
                        
                          m_1 8000,8
4e0d : 8c1f3f          >  cmpx #8000-1
4e10 : 230a            >  bls tpd8000
4e12 : 3089e0c0        >  leax -8000,x
4e16 : 8638            >  lda #'8'
4e18 : a7c4            >  sta 0,u
4e1a : 2069            >  bra tlsBelow1000
4e1c :                 >tpd8000:
                        
                          m_1 7000,7
4e1c : 8c1b57          >  cmpx #7000-1
4e1f : 230a            >  bls tpd7000
4e21 : 3089e4a8        >  leax -7000,x
4e25 : 8637            >  lda #'7'
4e27 : a7c4            >  sta 0,u
4e29 : 205a            >  bra tlsBelow1000
4e2b :                 >tpd7000:
                        
                          m_1 6000,6
4e2b : 8c176f          >  cmpx #6000-1
4e2e : 230a            >  bls tpd6000
4e30 : 3089e890        >  leax -6000,x
4e34 : 8636            >  lda #'6'
4e36 : a7c4            >  sta 0,u
4e38 : 204b            >  bra tlsBelow1000
4e3a :                 >tpd6000:
                        
                          m_1 5000,5
4e3a : 8c1387          >  cmpx #5000-1
4e3d : 230a            >  bls tpd5000
4e3f : 3089ec78        >  leax -5000,x
4e43 : 8635            >  lda #'5'
4e45 : a7c4            >  sta 0,u
4e47 : 203c            >  bra tlsBelow1000
4e49 :                 >tpd5000:
                        
                          m_1 4000,4
4e49 : 8c0f9f          >  cmpx #4000-1
4e4c : 230a            >  bls tpd4000
4e4e : 3089f060        >  leax -4000,x
4e52 : 8634            >  lda #'4'
4e54 : a7c4            >  sta 0,u
4e56 : 202d            >  bra tlsBelow1000
4e58 :                 >tpd4000:
                        
                          m_1 3000,3
4e58 : 8c0bb7          >  cmpx #3000-1
4e5b : 230a            >  bls tpd3000
4e5d : 3089f448        >  leax -3000,x
4e61 : 8633            >  lda #'3'
4e63 : a7c4            >  sta 0,u
4e65 : 201e            >  bra tlsBelow1000
4e67 :                 >tpd3000:
                        
                          m_1 2000,2
4e67 : 8c07cf          >  cmpx #2000-1
4e6a : 230a            >  bls tpd2000
4e6c : 3089f830        >  leax -2000,x
4e70 : 8632            >  lda #'2'
4e72 : a7c4            >  sta 0,u
4e74 : 200f            >  bra tlsBelow1000
4e76 :                 >tpd2000:
                        
                          m_1 1000,1
4e76 : 8c03e7          >  cmpx #1000-1
4e79 : 230a            >  bls tpd1000
4e7b : 3089fc18        >  leax -1000,x
4e7f : 8631            >  lda #'1'
4e81 : a7c4            >  sta 0,u
4e83 : 2000            >  bra tlsBelow1000
4e85 :                 >tpd1000:
                        
                        
                        m_2 macro max,digit
                          cmpx #max-1
                          bls tpd\1
                          leax -max,x
                          lda #'digit'
                          sta 1,u
                          bra tlsBelow100
                        tpd\1:
                          endm
                        
4e85 :                  tlsBelow1000:
                          m_2 900,9
4e85 : 8c0383          >  cmpx #900-1
4e88 : 230a            >  bls tpd900
4e8a : 3089fc7c        >  leax -900,x
4e8e : 8639            >  lda #'9'
4e90 : a741            >  sta 1,u
4e92 : 207b            >  bra tlsBelow100
4e94 :                 >tpd900:
                        
                          m_2 800,8
4e94 : 8c031f          >  cmpx #800-1
4e97 : 230a            >  bls tpd800
4e99 : 3089fce0        >  leax -800,x
4e9d : 8638            >  lda #'8'
4e9f : a741            >  sta 1,u
4ea1 : 206c            >  bra tlsBelow100
4ea3 :                 >tpd800:
                        
                          m_2 700,7
4ea3 : 8c02bb          >  cmpx #700-1
4ea6 : 230a            >  bls tpd700
4ea8 : 3089fd44        >  leax -700,x
4eac : 8637            >  lda #'7'
4eae : a741            >  sta 1,u
4eb0 : 205d            >  bra tlsBelow100
4eb2 :                 >tpd700:
                        
                          m_2 600,6
4eb2 : 8c0257          >  cmpx #600-1
4eb5 : 230a            >  bls tpd600
4eb7 : 3089fda8        >  leax -600,x
4ebb : 8636            >  lda #'6'
4ebd : a741            >  sta 1,u
4ebf : 204e            >  bra tlsBelow100
4ec1 :                 >tpd600:
                        
                          m_2 500,5
4ec1 : 8c01f3          >  cmpx #500-1
4ec4 : 230a            >  bls tpd500
4ec6 : 3089fe0c        >  leax -500,x
4eca : 8635            >  lda #'5'
4ecc : a741            >  sta 1,u
4ece : 203f            >  bra tlsBelow100
4ed0 :                 >tpd500:
                        
                          m_2 400,4
4ed0 : 8c018f          >  cmpx #400-1
4ed3 : 230a            >  bls tpd400
4ed5 : 3089fe70        >  leax -400,x
4ed9 : 8634            >  lda #'4'
4edb : a741            >  sta 1,u
4edd : 2030            >  bra tlsBelow100
4edf :                 >tpd400:
                        
                          m_2 300,3
4edf : 8c012b          >  cmpx #300-1
4ee2 : 230a            >  bls tpd300
4ee4 : 3089fed4        >  leax -300,x
4ee8 : 8633            >  lda #'3'
4eea : a741            >  sta 1,u
4eec : 2021            >  bra tlsBelow100
4eee :                 >tpd300:
                        
                          m_2 200,2
4eee : 8c00c7          >  cmpx #200-1
4ef1 : 230a            >  bls tpd200
4ef3 : 3089ff38        >  leax -200,x
4ef7 : 8632            >  lda #'2'
4ef9 : a741            >  sta 1,u
4efb : 2012            >  bra tlsBelow100
4efd :                 >tpd200:
                        
                          m_2 100,1
4efd : 8c0063          >  cmpx #100-1
4f00 : 2309            >  bls tpd100
4f02 : 30889c          >  leax -100,x
4f05 : 8631            >  lda #'1'
4f07 : a741            >  sta 1,u
4f09 : 2004            >  bra tlsBelow100
4f0b :                 >tpd100:
                        
                        
4f0b : 8630               lda #'0'
4f0d : a741               sta 1,u
                        
                        m_3 macro max,digit
                          cmpb #max-1
                          bls tpd\1
                          subb #max
                          addb #'0'
                          lda #'digit'
                          std 2,u
                          bra tlsExit
                        tpd\1:
                          endm
                        
4f0f :                  Text_ConvertX2:           ;x holds value to be converted (max 99), u = destination buffer-2 (2 bytes needed)
                        
4f0f :                  tlsBelow100:
4f0f : 1f10               tfr x,d
                          m_3 90,9
4f11 : c159            >  cmpb #90-1
4f13 : 230a            >  bls tpd90
4f15 : c05a            >  subb #90
4f17 : cb30            >  addb #'0'
4f19 : 8639            >  lda #'9'
4f1b : ed42            >  std 2,u
4f1d : 2076            >  bra tlsExit
4f1f :                 >tpd90:
                        
                          m_3 80,8
4f1f : c14f            >  cmpb #80-1
4f21 : 230a            >  bls tpd80
4f23 : c050            >  subb #80
4f25 : cb30            >  addb #'0'
4f27 : 8638            >  lda #'8'
4f29 : ed42            >  std 2,u
4f2b : 2068            >  bra tlsExit
4f2d :                 >tpd80:
                        
                          m_3 70,7
4f2d : c145            >  cmpb #70-1
4f2f : 230a            >  bls tpd70
4f31 : c046            >  subb #70
4f33 : cb30            >  addb #'0'
4f35 : 8637            >  lda #'7'
4f37 : ed42            >  std 2,u
4f39 : 205a            >  bra tlsExit
4f3b :                 >tpd70:
                        
                          m_3 60,6
4f3b : c13b            >  cmpb #60-1
4f3d : 230a            >  bls tpd60
4f3f : c03c            >  subb #60
4f41 : cb30            >  addb #'0'
4f43 : 8636            >  lda #'6'
4f45 : ed42            >  std 2,u
4f47 : 204c            >  bra tlsExit
4f49 :                 >tpd60:
                        
                          m_3 50,5
4f49 : c131            >  cmpb #50-1
4f4b : 230a            >  bls tpd50
4f4d : c032            >  subb #50
4f4f : cb30            >  addb #'0'
4f51 : 8635            >  lda #'5'
4f53 : ed42            >  std 2,u
4f55 : 203e            >  bra tlsExit
4f57 :                 >tpd50:
                        
                          m_3 40,4
4f57 : c127            >  cmpb #40-1
4f59 : 230a            >  bls tpd40
4f5b : c028            >  subb #40
4f5d : cb30            >  addb #'0'
4f5f : 8634            >  lda #'4'
4f61 : ed42            >  std 2,u
4f63 : 2030            >  bra tlsExit
4f65 :                 >tpd40:
                        
                          m_3 30,3
4f65 : c11d            >  cmpb #30-1
4f67 : 230a            >  bls tpd30
4f69 : c01e            >  subb #30
4f6b : cb30            >  addb #'0'
4f6d : 8633            >  lda #'3'
4f6f : ed42            >  std 2,u
4f71 : 2022            >  bra tlsExit
4f73 :                 >tpd30:
                        
                          m_3 20,2
4f73 : c113            >  cmpb #20-1
4f75 : 230a            >  bls tpd20
4f77 : c014            >  subb #20
4f79 : cb30            >  addb #'0'
4f7b : 8632            >  lda #'2'
4f7d : ed42            >  std 2,u
4f7f : 2014            >  bra tlsExit
4f81 :                 >tpd20:
                        
                          m_3 10,1
4f81 : c109            >  cmpb #10-1
4f83 : 230a            >  bls tpd10
4f85 : c00a            >  subb #10
4f87 : cb30            >  addb #'0'
4f89 : 8631            >  lda #'1'
4f8b : ed42            >  std 2,u
4f8d : 2006            >  bra tlsExit
4f8f :                 >tpd10:
                        
                        
4f8f : 8630               lda #'0'
4f91 : cb30               addb #'0'
4f93 : ed42               std 2,u
                        
4f95 :                  tlsExit:
4f95 : 39                 rts
                        
                        
                        
                        ;*****************
4f96 :                  Text_LevelExit:         ;returns z set if level is finished
                          direct $c8
                          mDecLocals 1,1,50
                       >  nolist
                        
0015 =                  LocalString1 = LocalBuffer + 18
0029 =                  LocalString2 = LocalString1 + 20
0000 =                  LocalLevelFin = LocalB1
0001 =                  LocalBonus = LocalW1
                        
                        ;
                        ;  hasPod
                        ;    line 0: "planet destroyed" (if planteddestroyed)
                        ;    line 1: "mission 2 complete"
                        ;    line 2: "bonus xxx" (2000 + (400 * levelno)) + (2000 if planteddestroyed)
                        ;
                        ; level exit utan orb men planetdestroyed
                        ; samma ifall planet destroyed, ej exit
                        ;(vid loselife, testa destroyed, ta bort orb, och anropa onlevelexit)
                        ;          PLANET DESTROYED
                        ;          MISSION 1 FAILED
                        ;          NO BONUS
                        ;          (level++)
                        ;
                        
4f99 : 6fe4               clr LocalLevelFin,s           ;level completed as default
                        
                          mTestFlag HasOrbFlag
                       >  if 255>HasOrbFlag
4f9b : 96e5            >    lda GameFlags1
4f9d : 8504            >    bita #HasOrbFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(HasOrbFlag)>>8
                       >  endif
                        
4f9f : 102700d5           lbeq txlNoOrb
                        
4fa3 : 8e50cd             ldx #CompleteString
4fa6 : 33e815             leau LocalString1,s
4fa9 : bdf8de             jsr Text_CopyString
                        
4fac : d6d1               ldb CurLevel                  ;insert level no
4fae : 5c                 incb
4faf : 1d                 sex
4fb0 : 1f01               tfr d,x
4fb2 : 33e81b             leau LocalString1+8-2,s
4fb5 : bd4f0f             jsr Text_ConvertX2
                        
4fb8 : 3163               leay LocalBuffer,s
                          mCombine d,30,-70
4fba : cc1eba          >  ldd #(lo 30)<<8 | (lo -70)
                        
4fbd : eda1               std ,y++
4fbf : 30e815             leax LocalString1,s
4fc2 : afa1               stx ,y++
                        
4fc4 : cc07d0             ldd #2000
4fc7 : ed61               std LocalBonus,s
                        
4fc9 : 0df3               tst PowerLife
4fcb : 2a11               bpl txlPlanetAlive
                            mCombine d,50,-60
4fcd : cc32c4          >  ldd #(lo 50)<<8 | (lo -60)
                        
4fd0 : eda1                 std ,y++
4fd2 : 8e50f3               ldx #PlanetString
4fd5 : afa1                 stx ,y++
4fd7 : cc07d0               ldd #2000
4fda : e361                 addd LocalBonus,s
4fdc : ed61                 std LocalBonus,s
4fde :                  txlPlanetAlive:
                        
4fde : 8e5104             ldx #BonusString              ;bonus string
4fe1 : 33e829             leau LocalString2,s
4fe4 : bdf8de             jsr Text_CopyString
                        
                          ;detect 'perfect'
4fe7 : 967a               lda GameMode
4fe9 : 8100               cmpa #NormalGame
4feb : 273e               beq txlNoPerfect      ;no perfect for normal game
                        
4fed : 0df3               tst PowerLife
4fef : 2a3a               bpl txlNoPerfect
                        
4ff1 : deca               ldu CurLevelEntry     ;check all guns destroyed
4ff3 : ee44               ldu leGuns,u
4ff5 : a6c4               lda ,u
4ff7 : a77f               sta -1,s
4ff9 : dce7               ldd GunsActive
4ffb :                  txlGunLoop:
4ffb : 47                 asra
4ffc : 56                 rorb
4ffd : 252c               bcs txlNoPerfect
4fff : 6a7f               dec -1,s
5001 : 26f8               bne txlGunLoop
                        
5003 : deca               ldu CurLevelEntry     ;check all fuel collected/destroyed
5005 : ee46               ldu leFuel,u
5007 : a6c4               lda ,u
5009 : d6e9               ldb FuelActive
500b :                  txlFuelLoop:
500b : 57                 asrb
500c : 251d               bcs txlNoPerfect
500e : 4a                 deca
500f : 26fa               bne txlFuelLoop
                            ;perfect: all guns, all fuel, pod collected, planet destroyed, no lives lost
                            ;ldd #2000
5011 : 96f5                 lda PerfectBonus
5013 : 2716                 beq txlNoPerfect            ;no perfect, lost life
5015 : c664                 ldb #100
5017 : 3d                   mul
5018 : e361                 addd LocalBonus,s
501a : ed61                 std LocalBonus,s
                            mMakeTextCoord 6,8
                       > mCombine d, (-(10*(6))), (0 - ((8*8)/2))
501c : ccc4e0          >  ldd #(lo  (-(10*(6))))<<8 | (lo  (0 - ((8*8)/2)))
                       >
                        
501f : eda1                 std ,y++
5021 : cc5131               ldd #PerfectString
5024 : eda1                 std ,y++
                            mEmitSound PerfectBonusSoundId
                       >  if 1=1
5026 : 8635            >    lda #PerfectBonusSoundId
                       >  endif
5028 : bd0477          >  jsr EmitSound
                        
502b :                  txlNoPerfect:
                        
                        
                          ;levelno*400 = (levelno*2)*200
502b : bd2825             jsr SplitLevelNo              ;bonus is calced on level lo-nr
502e : 48                 lsla
502f : c6c8               ldb #200
5031 : 3d                 mul
5032 : e361               addd LocalBonus,s
5034 : ed61               std LocalBonus,s
                        
5036 : ae61               ldx LocalBonus,s
5038 : 33e82f             leau LocalString2+6,s
503b : bd4de9             jsr Text_ConvertX
                        
                          mCombine d,10,-40
503e : cc0ad8          >  ldd #(lo 10)<<8 | (lo -40)
                        
5041 : eda1               std ,y++
5043 : 30e829             leax LocalString2,s
5046 : afa1               stx ,y++
                        
5048 : 4f                 clra
5049 : 5f                 clrb
504a : eda4               std ,y                        ;end word
                        
                          ;Add bonus to player score
                          ;Givescore only handles 8-bit values so add the 16-bit bonus in 8-bit portions
                          ;Not pretty but it works
504c :                  txlGiveBonus:
504c : ec61               ldd LocalBonus,s
504e : 108307d0           cmpd #2000
5052 : 250c               blo txlRestBonus
5054 : 8307d0             subd #2000
5057 : ed61               std LocalBonus,s
                          mGiveScore 2000
5059 : 86c8            >  lda #2000 / 10
505b : bd1ad0          >  jsr GiveScoreA
                        
505e : 20ec               bra txlGiveBonus
5060 :                  txlRestBonus:
5060 : 10830064           cmpd #100
5064 : 250e               blo txlBonusFin
5066 : 830064             subd #100
5069 : 3406               pshs d
                          mGiveScore 100
506b : 860a            >  lda #100 / 10
506d : bd1ad0          >  jsr GiveScoreA
                        
5070 : 3506               puls d
5072 : 20ec               bra txlRestBonus
5074 :                  txlBonusFin:
                        
5074 : 3063               leax LocalBuffer,s
5076 : 2046               bra txlPrintAndExit
                        
                        
5078 :                  txlNoOrb:
5078 : 0df3               tst PowerLife
507a : 2a3d               bpl txlInComplete
                        
                          ;Planet destroyed, no orb: no bonus, advance mission
507c : 8e50e1             ldx #FailedString
507f : 33e815             leau LocalString1,s
5082 : bdf8de             jsr Text_CopyString
                        
5085 : d6d1               ldb CurLevel                  ;insert level no
5087 : 5c                 incb
5088 : 1d                 sex
5089 : 1f01               tfr d,x
508b : 33e81b             leau LocalString1+8-2,s
508e : bd4f0f             jsr Text_ConvertX2
                        
5091 : 3163               leay LocalBuffer,s
                          mCombine d,50,-60
5093 : cc32c4          >  ldd #(lo 50)<<8 | (lo -60)
                        
5096 : eda1               std ,y++
5098 : 8e50f3             ldx #PlanetString
509b : afa1               stx ,y++
                        
                          mCombine d,30,-70 + 6
509d : cc1ec0          >  ldd #(lo 30)<<8 | (lo -70 + 6)
                        
50a0 : eda1               std ,y++
50a2 : 30e815             leax LocalString1,s
50a5 : afa1               stx ,y++
                        
                          mCombine d,10,-40 + 6
50a7 : cc0ade          >  ldd #(lo 10)<<8 | (lo -40 + 6)
                        
50aa : eda1               std ,y++
50ac : 8e510f             ldx #NoBonusString
50af : afa1               stx ,y++
                        
50b1 : 4f                 clra
50b2 : 5f                 clrb
50b3 : eda4               std ,y
50b5 : 3063               leax LocalBuffer,s
50b7 : 2005               bra txlPrintAndExit
                        
50b9 :                  txlInComplete:
                          ;Exit without orb: stay on same mission
50b9 : 8e512b             ldx #InCompletePtr
50bc : 6ce4               inc LocalLevelFin,s           ;level incomplete
                        
50be :                  txlPrintAndExit:
                        
50be : 967a               lda GameMode
50c0 : 8102               cmpa #TimeAttackGame          ;skip text if time-attack
50c2 : 2703               beq txlSkipWait
50c4 : bd4d10               jsr Text_PrintWait
50c7 :                  txlSkipWait:
                        
50c7 :                  txlExit:
50c7 : 6de4               tst LocalLevelFin,s
                          mFreeLocals
50c9 : 32e835          >  leas FrameSize,s
                        
                          direct -1
50cc : 39                 rts
50cd :                  CompleteString:
50cd : 4d495353494f4e..   db "MISSION __ COMPLETE",$80
50e1 :                  FailedString:
50e1 : 4d495353494f4e..   db "MISSION __ FAILED",$80
50f3 :                  PlanetString:
50f3 : 504c414e455420..   db "PLANET DESTROYED",$80
5104 :                  BonusString:
5104 : 424f4e5553205f..   db "BONUS ____",$80
510f :                  NoBonusString:
510f : 4e4f20424f4e55..   db "NO BONUS",$80
5118 :                  InCompleteString:
5118 : 4d495353494f4e..   db "MISSION INCOMPLETE",$80
512b :                  InCompletePtr:
512b : 08ce               db 8,-50
512d : 5118               dw InCompleteString
512f : 0000               dw 0
5131 :                  PerfectString:
5131 : 50455246454354..   db "PERFECT!",$80
                        
                        ;*****************
513a :                  Text_GameOver:
                          direct $c8
                          mDecLocals 0,1,60
                       >  nolist
                        
001a =                  LocalString1 = LocalBuffer + 24
002e =                  LocalString2 = LocalString1 + 20
                        
                        ;   GAME OVER
                        ;
                        ;   HARD GAME
                        ;
                        ;FINAL SCORE 20000
                        ;    LEVEL 5
                        ;
                        ;  PRESS BUTTON
                        
                          ;test for highscore and bonusgame
513d : dc6a               ldd Cheat
513f : 262c               bne tgoNoHighscore    ;no test if cheating
                        
                          ;enable bonusgame
5141 : 0d81               tst BonusGameEnabled
5143 : 260c               bne tgoSkipBonusGame        ;skip if already enabled
5145 : 0d7a               tst GameMode
5147 : 2608               bne tgoSkipBonusGame        ;must be normal game
5149 : 96d1               lda CurLevel
514b : 8105               cmpa #LevelCountNormal-1    ;must have completed all levels
514d : 2f02               ble tgoSkipBonusGame
514f : 0c81                 inc BonusGameEnabled
5151 :                  tgoSkipBonusGame:
                        
5151 : cec882             ldu #Highscores
5154 : c607               ldb #HighscoreEntry
5156 : 967a               lda GameMode
5158 : 3d                 mul
5159 : 33cb               leau d,u
515b : 8ec8da             ldx #PlayerScore
515e : 8680               lda #$80              ;temporarily store an end-byte so that we can call rom
5160 : a706               sta DigitCount,x
                          ;check x vs u, copy to u if higher
5162 : bdf8d8             jsr check_4_new_hi_score
5165 : 4d                 tsta
5166 : 2a05               bpl tgoNoHighscore
                            ;new highscore
                            mEmitSound PerfectBonusSoundId
                       >  if 1=1
5168 : 8635            >    lda #PerfectBonusSoundId
                       >  endif
516a : bd0477          >  jsr EmitSound
                        
516d :                  tgoNoHighscore:
                        
516d : 8e51f1             ldx #FinalScoreString         ;'final score'
5170 : 33e81a             leau LocalString1,s
5173 : bdf8de             jsr Text_CopyString
                        
5176 : 8ec8da             ldx #PlayerScore              ;insert score
5179 : 31e826             leay LocalString1+12,s
517c : ec81               ldd ,x++
517e : eda1               std ,y++
5180 : ec81               ldd ,x++
5182 : eda1               std ,y++
5184 : ec81               ldd ,x++
5186 : eda1               std ,y++
                        
                        
5188 : 3162               leay LocalBuffer,s
518a : 8601               lda #1
518c : a7a0               sta ,y+                       ;wait for keypress flag
                        
                          mMakeTextCoord 1,19
                       > mCombine d, (-(10*(1))), (0 - ((19*8)/2))
518e : ccf6b4          >  ldd #(lo  (-(10*(1))))<<8 | (lo  (0 - ((19*8)/2)))
                       >
                        
                        ;  mCombine d,-12,-70
5191 : eda1               std ,y++
5193 : 30e81a             leax LocalString1,s
5196 : afa1               stx ,y++
                        
5198 : 8e5240             ldx #LevelReachedString       ;'level reached xx'
519b : 33e82e             leau LocalString2,s
519e : bdf8de             jsr Text_CopyString
51a1 : d6d1               ldb CurLevel                  ;insert level no
51a3 : 5c                 incb
51a4 : 1d                 sex
51a5 : 1f01               tfr d,x
51a7 : 33e832             leau LocalString2+6-2,s
51aa : bd4f0f             jsr Text_ConvertX2
                          mMakeTextCoord 2,8
                       > mCombine d, (-(10*(2))), (0 - ((8*8)/2))
51ad : ccece0          >  ldd #(lo  (-(10*(2))))<<8 | (lo  (0 - ((8*8)/2)))
                       >
                        
51b0 : eda1               std ,y++
51b2 : 30e82e             leax LocalString2,s
51b5 : afa1               stx ,y++
                        
                        ;  ldd ShipFuel
                        ;  bne tgoFuelOk
                        ;  mCombine d,-22,-39
                        ;  std ,y++
                        ;  ldd #FuelString
                        ;  std ,y++
                        ;tgoFuelOk:
                        
                        ;  mCombine d,8,-32
                          mMakeTextCoord -3,9
                       > mCombine d, (-(10*(-3))), (0 - ((9*8)/2))
51b7 : cc1edc          >  ldd #(lo  (-(10*(-3))))<<8 | (lo  (0 - ((9*8)/2)))
                       >
                        
51ba : eda1               std ,y++
51bc : cc51e7             ldd #GameOverString
51bf : eda1               std ,y++
                        
                        ;  mCombine d,-2,-40
                          mMakeTextCoord -1,11
                       > mCombine d, (-(10*(-1))), (0 - ((11*8)/2))
51c1 : cc0ad4          >  ldd #(lo  (-(10*(-1))))<<8 | (lo  (0 - ((11*8)/2)))
                       >
                        
51c4 : eda1               std ,y++                      ;display game mode
51c6 : 967a               lda GameMode
51c8 : 48                 asla
51c9 : 8e522b             ldx #GameModeStringList
51cc : ae86               ldx a,x
51ce : afa1               stx ,y++
                        
                        ;  mCombine d,-116,-50
                          mMakeTextCoord 10,12
                       > mCombine d, (-(10*(10))), (0 - ((12*8)/2))
51d0 : cc9cd0          >  ldd #(lo  (-(10*(10))))<<8 | (lo  (0 - ((12*8)/2)))
                       >
                        
51d3 : eda1               std ,y++
51d5 : cc5233             ldd #PressButtonString
51d8 : eda1               std ,y++
                        
51da : 6fa0               clr ,y+                       ;end word
51dc : 6fa0               clr ,y+
                        
51de : 3062               leax LocalBuffer,s
51e0 : bd4d10             jsr Text_PrintWait
                        
                          mFreeLocals
51e3 : 32e83e          >  leas FrameSize,s
                        
                          direct -1
51e6 : 39                 rts
51e7 : 47414d45204f56.. GameOverString:   db "GAME OVER",$80
                        ;FuelString:       db "OUT OF FUEL",$80
51f1 : 46494e414c2053.. FinalScoreString: db "FINAL SCORE ______0",$80
                        ;NOTE 11 chars strings assumed by display highscore
5205 : 4e4f524d414c20.. GameModeString1: db "NORMAL GAME",$80
5211 : 20484152442b20.. GameModeString2: db " HARD+ GAME",$80
521d : 54494d45204154.. GameModeString3: db "TIME ATTACK",$80
5229 : 2080             GameModeString4: db " ",$80     ;no title in bonusgame
522b :                  GameModeStringList:
522b : 52055211521d5229   dw GameModeString1,GameModeString2,GameModeString3,GameModeString4
5233 : 50524553532042.. PressButtonString: db "PRESS BUTTON",$80
5240 : 4c4556454c205f.. LevelReachedString: db "LEVEL __",$80
                        
                        
                        ;*****************
5249 :                  Text_Special:
                          mDecLocals 0,0,20
                       >  nolist
                        
524c : 31e4               leay LocalBuffer,s
                        
524e : 8e528f             ldx #SpecialStringsList
5251 : 48                 lsla
5252 : ae86               ldx a,x
                        
5254 : 8608               lda #8
5256 : e680               ldb ,x+
5258 : eda1               std ,y++
                        
525a : afa1               stx ,y++
525c : 6fa0               clr ,y+
525e : 6fa0               clr ,y+
5260 : 30e4               leax LocalBuffer,s
5262 : bd4d10             jsr Text_PrintWait
                        
                          mFreeLocals
5265 : 32e814          >  leas FrameSize,s
                        
5268 : 39                 rts
5269 : ce524556455253.. SpecialString1: db -50,'REVERSE GRAVITY',$80
527a : c2494e56495349.. SpecialString2: db -62,'INVISIBLE LANDSCAPE',$80
528f :                  SpecialStringsList:
528f : 5269527a           dw SpecialString1,SpecialString2
                        
                        
                        mLine macro yy,str,xx
                          db (-yy * 10)+30
                          if \0=3
                            db -60 + xx
                          else
                            db -60
                          endif
                          dw str
                          endm
                        
                        
                        ;*****************
5293 :                  Text_ShowDemoMenu:      ;dp=d0
5293 : 8e52ce             ldx #DemoMenuPtr
5296 : bd4d10             jsr Text_PrintWait
                          ;B holds key pressed
5299 : 39                 rts
                        
529a : 44454d4f80       DemoMenu0: db "DEMO",$80
529f : 312e204d495353.. DemoMenu1: db "1. MISSION 1",$80
52ac : 322e204d495353.. DemoMenu2: db "2. MISSION 2",$80
52b9 : 332e204d495353.. DemoMenu3: db "3. MISSION 3",$80
52c6 : 342e204558495480 DemoMenu4: db "4. EXIT",$80
52ce :                  DemoMenuPtr:
52ce : 01                 db 1
                          mLine 1,DemoMenu0
52cf : 14              >  db (-1 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
52d0 : c4              >    db -60
                       >  endif
52d1 : 529a            >  dw DemoMenu0
                        
                          mLine 2,DemoMenu1
52d3 : 0a              >  db (-2 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
52d4 : c4              >    db -60
                       >  endif
52d5 : 529f            >  dw DemoMenu1
                        
                          mLine 3,DemoMenu2
52d7 : 00              >  db (-3 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
52d8 : c4              >    db -60
                       >  endif
52d9 : 52ac            >  dw DemoMenu2
                        
                          mLine 4,DemoMenu3
52db : f6              >  db (-4 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
52dc : c4              >    db -60
                       >  endif
52dd : 52b9            >  dw DemoMenu3
                        
                          mLine 5,DemoMenu4
52df : ec              >  db (-5 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
52e0 : c4              >    db -60
                       >  endif
52e1 : 52c6            >  dw DemoMenu4
                        
52e3 : 0000               dw 0
                        
                        ;*****************
52e5 :                  Text_ShowOptionsMenu:      ;dp=d0
52e5 : 8e5324             ldx #OptionsMenuPtr
52e8 : bd4d10             jsr Text_PrintWait
                          ;B holds key pressed
52eb : 39                 rts
                        
52ec : 4f5054494f4e5380 OptionsMenu0: db "OPTIONS",$80
52f4 : 312e20434f4e54.. OptionsMenu1: db "1. CONTROLS",$80
5300 : 322e2044454d4f80 OptionsMenu2: db "2. DEMO",$80
5308 : 332e2052455345.. OptionsMenu3: db "3. RESET HIGHSCORES",$80
531c : 342e204558495480 OptionsMenu4: db "4. EXIT",$80
5324 :                  OptionsMenuPtr:
5324 : 0102               db 1,2
                          mLine 1,OptionsMenu0
5326 : 14              >  db (-1 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
5327 : c4              >    db -60
                       >  endif
5328 : 52ec            >  dw OptionsMenu0
                        
                          mLine 2,OptionsMenu1
532a : 0a              >  db (-2 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
532b : c4              >    db -60
                       >  endif
532c : 52f4            >  dw OptionsMenu1
                        
                          mLine 3,OptionsMenu2
532e : 00              >  db (-3 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
532f : c4              >    db -60
                       >  endif
5330 : 5300            >  dw OptionsMenu2
                        
                          mLine 4,OptionsMenu3
5332 : f6              >  db (-4 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
5333 : c4              >    db -60
                       >  endif
5334 : 5308            >  dw OptionsMenu3
                        
                          mLine 5,OptionsMenu4
5336 : ec              >  db (-5 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
5337 : c4              >    db -60
                       >  endif
5338 : 531c            >  dw OptionsMenu4
                        
533a : 0000               dw 0
                        
                        ;*****************
c8a0 =                  CheatTemp = TemporaryArea ;Temp memory used by menu
533c :                  Text_ShowCheatMenu:      ;dp=d0
                        
533c : cec8a0             ldu #CheatTemp
533f : 7dc86a             tst CheatLives
5342 : 2707               beq tcmOff
5344 : cc4f4e               ldd #'ON'
5347 : edc1                 std ,u++
5349 : 2007                 bra tcmLivesFin
534b :                  tcmOff:
534b : cc4f46               ldd #'OF'
534e : edc1                 std ,u++
5350 : e7c0                 stb ,u+
5352 :                  tcmLivesFin:
5352 : 8680               lda #$80
5354 : a7c0               sta ,u+
                        
5356 : cec8a2             ldu #CheatTemp+4-2
5359 : f6c86b             ldb CheatLevel
535c : 5c                 incb
535d : 1d                 sex
535e : 1f01               tfr d,x
5360 : bd4f0f             jsr Text_ConvertX2
5363 : c680               ldb #$80
5365 : e744               stb 4,u
                        
5367 : 8e5380             ldx #CheatMenuPtr
536a : bd4d10             jsr Text_PrintWait
                          ;B holds key pressed
536d : 39                 rts
                        
536e : 434845415480     CheatMenu0: db "CHEAT",$80
5374 : 5354415254204c.. CheatMenu1: db "START LEVEL",$80
5380 :                  CheatMenuPtr:
5380 : 0102               db 1,2
                          mLine 3,CheatMenu0
5382 : 00              >  db (-3 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
5383 : c4              >    db -60
                       >  endif
5384 : 536e            >  dw CheatMenu0
                        
                            mLine 3,CheatTemp,100
5386 : 00              >  db (-3 * 10)+30
                       >  if 3=3
5387 : 28              >    db -60 + 100
                       >  else
                       >    db -60
                       >  endif
5388 : c8a0            >  dw CheatTemp
                        
                          mLine 4,CheatMenu1
538a : f6              >  db (-4 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
538b : c4              >    db -60
                       >  endif
538c : 5374            >  dw CheatMenu1
                        
                            mLine 4,CheatTemp+4,100
538e : f6              >  db (-4 * 10)+30
                       >  if 3=3
538f : 28              >    db -60 + 100
                       >  else
                       >    db -60
                       >  endif
5390 : c8a4            >  dw CheatTemp+4
                        
5392 : 0000               dw 0
                        
                        ;*****************
5394 :                  Text_ShowGameMenu:      ;dp=d0
5394 : 8e541e             ldx #GameMenuPtr
5397 : bd4d10             jsr Text_PrintWait
                          ;B holds key pressed
539a : 39                 rts
                        
539b :                  GameMenuCallback:
                          mDecLocals 2,1,0
                       >  nolist
                        
                        
539d : 8ef0fd             ldx #$F0FD
53a0 : b6c826             lda LoopCounterLow
53a3 : 44                 lsra
53a4 : 8403               anda #3
53a6 : a686               lda a,x
53a8 : b7c829             sta Pattern
                        
53ab : b6c826             lda LoopCounterLow
53ae : 847f               anda #127
53b0 : a761               sta LocalB2,s
                        
53b2 : 8604               lda #4
53b4 : a7e4               sta LocalB1,s
53b6 :                  gmcLoop:
53b6 : bdf354             jsr reset0ref
                          mSetIntensity $40
                       >  if 1=1
53b9 : 8640            >    lda   #$40            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
53bb : 9701            >  sta   <01
53bd : cc0401          >  ldd   #$0401
53c0 : 9700            >  sta   <00
53c2 : d700            >  stb   <00
                        
                        
53c4 : a661               lda LocalB2,s
53c6 : 8e6d3f             ldx #SineTable
53c9 : a686               lda a,x
                        
53cb : 47                 asra
53cc : 8b1f               adda #31
53ce : 8b80               adda #128
                        
                          mSetScale
                       >  if 0=1
                       >    lda #                  ;if argument exists, load into a, otherwise use current a
                       >  endif
53d0 : 9704            >  sta <$04
                        
                        
53d2 : 8e4bab             ldx #RefuelVectorList
53d5 : 8603               lda #4-1
53d7 : bd0811             jsr FxMoveDrawPattern
                        
53da : a661               lda LocalB2,s
53dc : 8b04               adda #4
53de : 2a02               bpl gmcNoWrap
53e0 : 8080                 suba #128
53e2 :                  gmcNoWrap:
53e2 : a761               sta LocalB2,s
                        
53e4 : 6ae4               dec LocalB1,s
53e6 : 26ce               bne gmcLoop
                        
                          mFreeLocals
53e8 : 3264            >  leas FrameSize,s
                        
53ea : 39                 rts
                        
53eb : 53454c45435420.. GameMenu0: db "SELECT GAME MODE",$80
53fc : 312e204e4f524d.. GameMenu1: db "1. NORMAL",$80
5406 : 322e2048415244.. GameMenu2: db "2. HARD+",$80
540f : 332e2054494d45.. GameMenu3: db "3. TIME ATTACK",$80
541e :                  GameMenuPtr:
541e : 0102               db 1,2
5420 : 03                 db 3
5421 : 539b               dw GameMenuCallback
                          mLine 1,GameMenu0
5423 : 14              >  db (-1 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
5424 : c4              >    db -60
                       >  endif
5425 : 53eb            >  dw GameMenu0
                        
                          mLine 2,GameMenu1
5427 : 0a              >  db (-2 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
5428 : c4              >    db -60
                       >  endif
5429 : 53fc            >  dw GameMenu1
                        
                          mLine 3,GameMenu2
542b : 00              >  db (-3 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
542c : c4              >    db -60
                       >  endif
542d : 5406            >  dw GameMenu2
                        
                          mLine 4,GameMenu3
542f : f6              >  db (-4 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
5430 : c4              >    db -60
                       >  endif
5431 : 540f            >  dw GameMenu3
                        
5433 : 0000               dw 0
                        
                        
                        ;*****************
5435 :                  Text_ShowWellDone:      ;game completed
                          mEmitSound PerfectBonusSoundId
                       >  if 1=1
5435 : 8635            >    lda #PerfectBonusSoundId
                       >  endif
5437 : bd0477          >  jsr EmitSound
                        
543a : 8e545d             ldx #WellDonePtr
543d : bd4d10             jsr Text_PrintWait
5440 : 39                 rts
                        
5441 :                  WellDoneCallback:
5441 : 8664               lda #100
5443 : b7c8a0             sta TitleLogoY
5446 : bd622f             jsr DrawTitleLogo
5449 : 869c               lda #-100
544b : b7c8a0             sta TitleLogoY
544e : bd622f             jsr DrawTitleLogo
5451 : 39                 rts
                        
5452 : 57454c4c20444f.. WellDone0: db 'WELL DONE!',$80
545d :                  WellDonePtr:
545d : 0102               db 1,2
545f : 03                 db 3
5460 : 5441               dw WellDoneCallback
5462 : 08d8               db 8,-40
5464 : 5452               dw WellDone0
5466 : 0000               dw 0
                        
                        
                        ;*****************
5468 :                  Text_ShowControlMenu:      ;dp=d0, a=button to select
                          mDecLocals 1,0,20
                       >  nolist
                        
                        
546b : a7e4               sta LocalB1,s
                        
546d : 3061               leax LocalBuffer,s
546f : 8601               lda #1
5471 : a780               sta ,x+
                          mMakeTextCoord 0,32
                       > mCombine d, (-(10*(0))), (0 - ((32*8)/2))
5473 : cc0080          >  ldd #(lo  (-(10*(0))))<<8 | (lo  (0 - ((32*8)/2)))
                       >
                        
5476 : ed81               std ,x++
5478 : cc5499             ldd #ControlMenu0
547b : ed81               std ,x++
                        
                          mMakeTextCoord 0,1
                       > mCombine d, (-(10*(0))), (0 - ((1*8)/2))
547d : cc00fc          >  ldd #(lo  (-(10*(0))))<<8 | (lo  (0 - ((1*8)/2)))
                       >
                        
5480 : ed81               std ,x++
5482 : a6e4               lda LocalB1,s
5484 : 48                 asla
5485 : ce54cb             ldu #ControlStringList
5488 : ecc6               ldd a,u
548a : ed81               std ,x++
548c : 4f                 clra
548d : 5f                 clrb
548e : ed84               std ,x
                        
5490 : 3061               leax LocalBuffer,s
5492 : bd4d10             jsr Text_PrintWait
                          ;B holds key pressed
                          mFreeLocals
5495 : 32e815          >  leas FrameSize,s
                        
5498 : 39                 rts
                        
5499 : 50524553532042.. ControlMenu0: db "PRESS BUTTON FOR:",$80
54ab : 4649524580       ControlMenu1: db "FIRE",$80
54b0 : 534849454c442f.. ControlMenu2: db "SHIELD/TRACTOR",$80
54bf : 54485255535480   ControlMenu3: db "THRUST",$80
54c6 : 4c4f434b80       ControlMenu4: db "LOCK",$80
54cb :                  ControlStringList:
54cb : 54ab54b054bf54c6   dw ControlMenu1,ControlMenu2,ControlMenu3,ControlMenu4
                        
                        ;*****************
54d3 :                  Text_ShowResetMenu:      ;dp=d0
54d3 : 8e54eb             ldx #ResetMenuPtr
54d6 : bd4d10             jsr Text_PrintWait
                          ;B holds key pressed
54d9 : 39                 rts
                        
54da : 50524553532032.. ResetMenu0: db "PRESS 2 TO RESET",$80
54eb :                  ResetMenuPtr:
54eb : 0102               db 1,2
                          mLine 1,ResetMenu0
54ed : 14              >  db (-1 * 10)+30
                       >  if 2=3
                       >    db -60 + 
                       >  else
54ee : c4              >    db -60
                       >  endif
54ef : 54da            >  dw ResetMenu0
                        
54f1 : 0000               dw 0
                        
                          include "Thrust_BonusGame.asm"
                        ; Zzap Strikes Back - Bonusgame hidden inside Thrust.
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        ;todo optimize size
                        ;   skip all y-coords, assume 0?
                        ;   direct c9 instead?
                        ;   macros instead of subroutines
                        ;   gör subs av mMove_to_d i hela, mMove_to_d=jsr FxMoveToD
                        ;
                        ;fixlist
                        ;  coolare bullet for homing shots
                        ;  svårare
                        ;    1 extra headträff
                        ;    öka level every two walkers
                        ;    öka hitpoints baserat på levelhi?
                        ;  radar plot base
                        ;  thrust flame
                        ; *highscore visas /10
                        ;
                        ;  activate vid 50.000?
                        ;    har nått 93000 i normal game
                        ; --> testa:   har nått level 6 i normal game
                        ;  smalare huvud för varje round
                        ;  lägre intensity på bakre berg
                        ;  walker mer hitpoints
                        ;  kortare värld
                        ;  större diff på shotintensities
                        ;  walker fler shots
                        ;  walker lysande shots
                        ;  svårare att träffa head
                        ;
                        ;  skip ship vs walker collision?
                        ;  rewrite setview-code
                        ;    om ship right
                        ;      opt = shipx + velocx - edge
                        ;      diff=opt-view
                        ;      om diff<>0
                        ;        asr diff, minst 1
                        ;        öka view med diff
                        ;  defender style control: flip dir med button? accelerate med button?
                        ;  öka shipshot speed efter tid, så att man inte kan åka ikapp sina egna skott
                        ;  gameover, öka shipy tills utanför skärm, gameover
                        ;  roligt ljud vid explode walker
                        ;  pulse-sound
                        ;  jump-sound
                        ;  score
                        ;    score för headshot
                        ;    score för bodyshot
                        ;    blinka weakspot i ryggen, om hit döda direkt
                        ;  radar
                        ;    world length 8192 / 64 = 0..128
                        ;    loop walkers
                        ;    screenx=walkerx >> 6
                        ;      lo rol2 in i ny byte
                        ;      b|=hi shl2
                        ;    screeny=walkery >> 3
                        ;    RadarGetScreenCoords x,y
                        ; *eget gamemode
                        ;    titlescreen
                        ;    save highscore
                        ;    egen text i gameover
                        ; *collision ship är inte centrerad
                        ; *slide left/right ska bara påverka viewx, ej shipx
                        ;
                        ;optimize speed
                        ;  mountain och ship ritas i scale $7f
                        ;
                        ;tillåt att skepp åker ovan skärmen 32 koords
                        ;  och under 32 koords
                        ;  då måste viewy följa
                        ;  drawstars
                        ;  flytta ship,mountains och stjärnor separat? parallax effekt?
                        ;
                        ;title
                        ;  'ZZAP STRIKES BACK'
                        ;  'PRESS FIRE'
                        ;  HIGHSCORE
                        ;
                        ;activate
                        ;  om cheatactive visa som alternativ 4 i modeselect
                        ;  alt vid highscore i normal game
                        ;  tst BonusGameActivated (eeprom)
                        ;    sätts efter nytt highscore
                        ;    samt vid enable cheat
                        ;  alt
                        ;    som nu helt hidden
                        ;  GameMode = 3 BonusGame
                        ;    save highscore also
                        ;    hur visa highscore?
                        ;      egen titlescreen
                        ;  1 start, 2 options, 3 zzgf
                        ;    3 visar ny titlescreen
                        ;
                        ;walker
                        ;  dela upp i body och huvud
                        ;  animera ben och huvud
                        ;  hittest mod body och huvud, mer sårbar på huvud
                        ;    gör först generellt hittest, sedan på separat yta
                        ;
                        ;  WalkerWidth
                        ;    WalkerBaseW = (WalkerWidth/4)*3
                        ;    WalkerLegW = (WalkerBaseW/6) * 2
                        ;
                        ;  WalkerBaseW = 128
                        ;  WalkerNeckW = 32
                        ;  WalkerHeadW = 32
                        ;
                        ;  WalkerTotalWidth = WalkerBaseW + WalkerNeckW + WalkerHeadW
                        ;  CopyLinesAddY
                        ;  DrawLeg offsetx,length
                        ;
                        ;  /------\
                        ;  |      |-/\
                        ;  |      |-\/
                        ;  --------
                        ;  | |  | |
                        ;  |_|  |_|
                        ;
                        ; 6 bytes stack per line, 18 lines, 108 bytes stack space needed by clipdraw
                        ;  ;positive y is down, positive x is right
                        ;  ;  db 1  ;line count
                        ;  ;  db 1  ;linetype, 0=vert, 1=horiz, 2=slope
                        ;  ;  db FullW,0  ;x0,y0
                        ;  ;  db 0,HalfH  ;x1,y1
                        ;
                        ;  hotspot
                        ;    träffar man denna så dör walker direkt
                        ;
                        ;  explode
                        ;    FxTargetWalker index, obs ny emit får ej ske innan shatter är klar
                        ;    sänk walker långsamt genom att öka dess y
                        ;
                        ;walker damage
                        ;  inital life 64
                        ;  headshot minska med 8
                        ;    emit explosion i head vart 32:e
                        ;  base minska med 2
                        ;  flash if low?
                        ;
                        ;difficulty
                        ;  zzappace är 32-0, börjar på 32, minskar 1 vart 16:e sekund
                        ;  zzappace är 255-0, börjar på 255, shr 1 vart 16:e sekund
                        ;  både Pace och PaceMask?
                        ;  alt.
                        ;    öka pace för varje dödad walker
                        ;    ha en klocka för varje behov
                        ;    återgå till långsamt tempo efter snabbaste
                        ;      flytta fram walkeremitpoint vid varje varv
                        ;    WalkerSpeed mask8frame,6,4,3,2,1
                        ;    ShootDelay 8,7,6,5,4,3,2,1 (multipliceras med random 4)
                        ;    JumpDelay
                        ;    JumpHeight
                        ;    ShotYSpread, ShotXSpeed
                        ;    ZzapIncDifficulty, ZzapResetDifficulty
                        ;  IncreaseDifficulty()
                        ;    anropa flera ggr för att testa
                        ;    ZzapShotDelay
                        ;    inc ZzapLevelNo
                        ;      om mod 8=0
                        ;      InitDifficulty()
                        ;      IncreaseDifficulty() för att inte börja på noll
                        ;      move forward walker emitpoint
                        ;    lsr ZzapShotDelay
                        ;  ZzapLevel
                        ;  ZzapDifficultyEntry
                        ;    zdShotDelay
                        ;  InitDifficulty
                        ;    allt noll
                        ;    mSetByte ZzapShotDelay,$ff
                        ;    mSetByte ZzapWalkerSpeed,0
                        ;  updatewalkers
                        ;    updatera x med två ifall framecounter and (4-bytetabell) är 0
                        ;
                        ;    lda zzapshotdelay
                        ;    anda loopcounterlow
                        ;    bne skipshots
                        ;
                        ;    om jumping
                        ;      updatera y
                        ;      använd jumpscale för att öka y
                        ;    annars
                        ;      lda jumpdelay
                        ;      anda framecounter
                        ;      bne nojump
                        ;      set jumping
                        ;      jumpscale -2 -- 2
                        ;
                        ;    walkerentry
                        ;      jumpIndex 0--63, -1=not jumping
                        ;      jumpScale init med rnd * zdconfig.jumpscaleRange
                        ;    zdconfig
                        ;      jumpIndex 0--64, -1=not jumping
                        ;      jumpIndexIncrease 1--4
                        ;      jumpIndexIncreaseRange 2
                        ;      jumpScale
                        ;      jumpScaleRange
                        ;      jumpDelay only randomize jumpdelay
                        ;      för scale ta walkerindex
                        ;
                        ;
                        ;move walkers
                        ;  loopcounter and (zzappace and 15)
                        ;
                        ;sound
                        ;  "puls" ljud när walkers rör sig
                        ;  ökar i takt med zzapclock
                        ;  zc=zzappace shl 4
                        ;  (loopcounter and (255 shl zc))
                        ;
                        ;draw walker
                        ;  walkervisible-flag
                        ;    då ritas ej score och radar
                        ;  sätt upp headrect och baserect
                        ;  shots vs walkers
                        ;    endast om visible
                        ;    testa mot head och base
                        ;
                        ;
                        ;walker-shots
                        ;  klocka styr hur ofta walker skjuter, samt dess homingness
                        ;  träff med skepp, drain energy vänd riktning och velocity
                        ;    ZzapClock ds ökar med 1 varje sekund
                        ;      alt ZzapPace ökar med 1 vart 8:e sekund, stannar på 8
                        ;    WalkerShotTimer (dec vart 8:e frame) 8=1 sekund, 4=1/2 sekund
                        ;      max 5 sekunder, min 1 sekund
                        ;      rnd +/- 1 sekund
                        ;      (8-zzapPace)*4 + (rnd and 15 - 7)
                        ;      alt span 1 skott vart 4:e sekund -- 1 vart 0.2 sekund
                        ;        timer range 1 -- (4*8)
                        ;        timer = 33 - (zzappace<<1)
                        ;    homingness
                        ;      mask = 32 - zzappace<<1
                        ;      mask = zzappace-1
                        ;  emit
                        ;    om !walkerVisible exit
                        ;    emit ifrån headrect
                        ;    xveloc=fast speed * zzapclock
                        ;    WalkerShotEntry
                        ;      wsActive
                        ;      wsVelocX +/-
                        ;      wsWalkerShotX
                        ;      wsWalkerShotY
                        ;  DrawWalkerShots
                        ;    remove ifall utanför skärm
                        ;  UpdateWalkerShot
                        ;    loop
                        ;      om active
                        ;        flytta
                        ;        remove ifall utanför skärm
                        ;        collision vs ship
                        ;      annars lagra i ledig slot
                        ;    om ledig slot
                        ;      och timer=0
                        ;      och walkervisible
                        ;      emit
                        ;        origin HeadX
                        ;        sätt wsVelocX i riktning mot skepp
                        ;
                        ;
                        ;base
                        ;  rita stationarypod som base
                        ;  ifall walker når pod, gameover
                        ;    sätt viewx till base, loop med waitcalc, emit planetexplode ljud
                        ;
                        ;score
                        ;  använd samma rutiner som vanliga spelet? eget gamemode?
                        ;
                        ;radar
                        ;  display med radar o score, fadas bort när walker är visible
                        ;
                        
                          code
                        
                        ; Relative coordinates for mountain.
54f3 :                  Zzap_MountainYCoords:
54f3 : 050af6fb14030405   db 5,10,-10,-5,20,3,4,5
54fb : f600f600140000e0   db -10,0,-10,0,20,0,0,-32
                        
                        
                        ; For each of the values in MountainYCoords there is a y-coordinate
                        ; saying where to start drawing. This could be calculated using the
                        ; relative values, but it's easier having a list.
5503 :                  Zzap_MountainABSYCoords:
5503 : 00050f050014171b   db 0,5,15,5,0,20,23,27
550b : 2016160c0c202020   db 32,22,22,12,12,32,32,32
                        
                        
                        
                        
                        ; Vectors for ship facing left.
5513 :                  Zzap_ShipLeftVectorList:
5513 : e7ce               db  -25,-50
5515 : 3264               db  50,100
5517 : ddd8               db  -35,-40
5519 : f114               db  -15,20
551b : 00ab               db  0,-85
                          ;thrust flame
551d : 0852               db 8,82
551f : 0818               db 8,24
5521 : 08e8               db 8,-24
                        
                        
                        ; Vectors for ship facing right.
5523 :                  Zzap_ShipRightVectorList:
5523 : e732               db  -25,50
5525 : 329c               db  50,-100
5527 : dd28               db  -35,40
5529 : f1ec               db  -15,-20
552b : 0055               db  0,85
                          ;thrust flame
552d : 08ae               db 8,-82
552f : 08e8               db 8,-24
5531 : 0818               db 8,24
                        
0064 =                  ZzShipWidth = 100
                        
                        
                          bss
                        
                        ;Start memory in drawlist to avoid collisions with main game
c946 =                  Zzap_RamStart = DrawList
c946 =                    org Zzap_RamStart
                        
                        ; Ship coordinates.
                        ; The Y values is a direct Vectrex coordinate used in drawing.
                        ; The X value is a position in game world.
c8bd =                  Zzap_ShipY = ShipY
c8bb =                  Zzap_ShipX = ShipX
                        
c8b7 =                  Zzap_ShipVelocX = ShipSpeedX
c8b9 =                  Zzap_ShipVelocY = ShipSpeedY
                        
                        ; Direction ship is facing.
c8b6 =                  Zzap_ShipDir = ShipAngle        ;1=left, -1=right
                        
                        
                        ; X coordinate in game world for left edge of screen.
                        ; This value is subtracted from ship and shot x coord to produce screen coord.
c8c6 =                  Zzap_LeftOffsetX = ViewX
                        
                        
                        ; Ship shots.
                        
                        ; Max nr of shots visible at one time. This value can be increased.
0004 =                  Zzap_ShipShotCount = 4
                        
                        ; A shot is growing from the nose of the ship until reaching a length of this value.
0032 =                  Zzap_ShipShotMaxLength = 50
                        
                        ; Structure holding info about one shot.
0000 =                    struct Zzap_ShipShotEntry
0000 =                      db Zzap_ssShotActive       ;Flag: is shot active?
0001 =                      db Zzap_ssShotDir          ;Direction for shot.
0002 =                      dw Zzap_ssShotY            ;Y game world coordinate.
0004 =                      dw Zzap_ssShotX            ;X game world coordinate.
0006 =                      db Zzap_ssShotLength       ;Current length of shot.
                          end struct
                        
                        ; Array with shots.
c946 =                  Zzap_ShipShotList: ds Zzap_ShipShotEntry * Zzap_ShipShotCount
                        
c8f2 =                  ZzapShipTookDamage=DoorCounter
c8e0 =                  ZzapShipLives=ShipLives
                        
                        
                        ;8192 is the length the radar assumes
0100 =                  ZzapWorldStartX = 256
2100 =                  ZzapWorldEndX = ZzapWorldStartX + 8192
                        ;ViewX for new game
2000 =                  ZzapViewStartX = ZzapWorldEndX - 256
                        
ff80 =                  ZzapWorldTopY = 0-128
00ff =                  ZzapWorldEndY = 255
                        
00df =                  WalkerFloorY = ZzapWorldEndY - 32
                        
                        
                        ;Walkers (enemies)
0008 =                  WalkerCount = 8
                        
0000 =                    struct WalkerEntry
0000 =                      db weWalkerActive           ;-1=active, 0=dead, 1 dying
0001 =                      db weWalkerLife
0002 =                      dw weWalkerX
0004 =                      dw weWalkerY                ;sprite center coords in world-space
0006 =                      db weJumpIndex              ;-1=not jumping, 0..63 index to sinetable
                          end struct
                        
c962 =                  WalkerList: ds WalkerEntry * WalkerCount
                        
                        ;Walker measurements
0030 =                  WalkerBaseH=48
0054 =                  WalkerBaseW=84 ;120-32
0030 =                  WalkerLegH=64-16
0010 =                  WalkerLegW=(WalkerBaseW/7)*1 + 4
0020 =                  HeadW = 32
                        ;Default head height, shrinks for each level
0018 =                  DefaultHeadH = 32-8
                        ;Total width/height of walker sprite
0074 =                  WalkerWidth=WalkerBaseW+HeadW
0060 =                  WalkerHeight=WalkerBaseH + WalkerLegH
                        
02ee =                  WalkerDistance = 750            ;Distance between each walker
                        
                        ;Walker shots
0005 =                  WalkerShotCount=5
0000 =                   struct WalkerShotEntry
0000 =                     db wsActive
0001 =                     db wsVelocX
0002 =                     db wsVelocY
0003 =                     dw wsWalkerShotX
0005 =                     dw wsWalkerShotY
                         end struct
                        
c99a =                  WalkerShotList: ds WalkerShotEntry * WalkerShotCount
                        
                        ;Coordinates for base
2080 =                  BaseX = ZzapWorldEndX - 128
00d5 =                  BaseY = WalkerFloorY - 10
                        
0010 =                  ZzapShipH = 16
0020 =                  ZzapShipW = 32
                        
0008 =                  ZzapShipArea = 8                    ;Hit area for ship
                        
                        ; 0 = no walker visible, else points to visible walkerentry
c8c3 =                  WalkerVisible = ScrollX  ;2 bytes
c9bd =                  WalkerVisibleI: ds 1    ;index of visible walker
c9be =                  VisibleHeadX: ds 2
c9c0 =                  VisibleHeadY: ds 2
c9c2 =                  VisibleBaseX: ds 2
c9c4 =                  VisibleBaseY: ds 2
                        
                        ;Game difficulty configuration, increased by each walker shot
0000 =                   struct ZzapConfigEntry
0000 =                     db zcShotDelay
0001 =                     db zcShotYSpread
0002 =                     db zcWalkerSpeedMask
0003 =                     db zcJumpDelay
0004 =                     db zcJumping
0005 =                     db zcJumpScale
0006 =                     db zcHeadH
0007 =                     db zcHalfHeadH
0008 =                     db zcWalkerLife
                         end struct
c9c6 =                  ZzapConfig: ds ZzapConfigEntry
                        
                        ; Use same level as maingame, levelno is displayed in gameover
c8d1 =                  ZzapLevel = CurLevel
                        
                        ; Dynamic length, keep at end of BSS-section
c9cf =                  WalkerDrawList:
                        
                        
                        ;*******************
                          code
                        
5533 :                  Zzap_Start:
5533 : 8ec946             ldx #Zzap_RamStart
5536 : bdf545             jsr clear_256_bytes   ;Clear buffer
                        
                          mDptoC8
5539 : 86c8            >  lda   #0xC8
553b : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
553d : bd57d8             jsr Zzap_InitNewGame
                        
                        ; jsr Text_ShowWellDone
5540 : bd5589             jsr ZzapTitleScreen
                        
5543 :                  Zzap_MainLoop:
                          mDptoC8
5543 : 86c8            >  lda   #0xC8
5545 : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
5547 : bd59b9             jsr Zzap_ControlShip
554a : bd58e6             jsr Zzap_UpdateShipShots
554d : bd1a0f             jsr UpdateFrameCounter
5550 : bd049c             jsr UpdateSound
5553 : bd5c42             jsr UpdateWalkers
5556 : bd56bf             jsr UpdateWalkerShots
5559 : bd074f             jsr UpdateFx
                        
                          mTestFlag GameOverFlag
                       >  if 255>GameOverFlag
555c : 96e5            >    lda GameFlags1
555e : 8540            >    bita #GameOverFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(GameOverFlag)>>8
                       >  endif
                        
5560 : 2623               bne ZzapGameOver
                        
5562 : bdf192             jsr waitrecal         ;Wait for screen sync
                          ;DP is now D0
                        
5565 : bdf289             jsr UpdateSoundChip
                        
5568 : bd5b86             jsr Zzap_DrawMountain
556b : bd5839             jsr Zzap_DrawShip
556e : bd589a             jsr Zzap_DrawShipShots
5571 : bd5d1f             jsr DrawWalkers
5574 : bd57a7             jsr DrawWalkerShots
5577 : bd5ef3             jsr DrawBase
557a : bd070d             jsr DrawFx
557d : bd1a28             jsr DrawDisplay
5580 : bd55df             jsr DrawRadar
                        ;  jsr DrawStars
                        
5583 : 20be               bra Zzap_MainLoop
                        
5585 :                  ZzapGameOver:
5585 : bd513a             jsr Text_GameOver
5588 : 39                 rts
                        
5589 :                  ZzapTitleScreen:
                          mDecLocals 0,0,40
                       >  nolist
                        
                        
558c : 30e4               leax LocalBuffer,s
                          mCombine d,1,2
558e : cc0102          >  ldd #(lo 1)<<8 | (lo 2)
                        
5591 : ed81               std ,x++
                        
5593 : 8603               lda #3
5595 : a780               sta ,x+
5597 : cc539b             ldd #GameMenuCallback
559a : ed81               std ,x++
                        
                          mMakeTextCoord -2,4
                       > mCombine d, (-(10*(-2))), (0 - ((4*8)/2))
559c : cc14f0          >  ldd #(lo  (-(10*(-2))))<<8 | (lo  (0 - ((4*8)/2)))
                       >
                        
559f : ed81               std ,x++
55a1 : cc55cf             ldd #ZzapGameText1
55a4 : ed81               std ,x++
                        
                          mMakeTextCoord 0,16
                       > mCombine d, (-(10*(0))), (0 - ((16*8)/2))
55a6 : cc00c0          >  ldd #(lo  (-(10*(0))))<<8 | (lo  (0 - ((16*8)/2)))
                       >
                        
55a9 : ed81               std ,x++
55ab : cc55d4             ldd #ZzapGameText2
55ae : ed81               std ,x++
                        
                          mMakeTextCoord 0,-2
                       > mCombine d, (-(10*(0))), (0 - ((-2*8)/2))
55b0 : cc0008          >  ldd #(lo  (-(10*(0))))<<8 | (lo  (0 - ((-2*8)/2)))
                       >
                        
55b3 : ed81               std ,x++
55b5 : 3304               leau 4,x
55b7 : ef81               stu ,x++
                        
55b9 : cc0000             ldd #0
55bc : ed84               std ,x
                        
55be : 8ec897             ldx #Highscores + (HighscoreEntry * 3)
55c1 : c680               ldb #$80
55c3 : bd1abb             jsr CopyScoreFromXtoU
                        
55c6 : 30e4               leax LocalBuffer,s
55c8 : bd4d10             jsr Text_PrintWait
                        
                          mFreeLocals
55cb : 32e828          >  leas FrameSize,s
                        
55ce : 39                 rts
55cf : 5a53422180       ZzapGameText1: db "ZSB!",$80
55d4 : 4849474853434f.. ZzapGameText2: db "HIGHSCORE:",$80
                        
                        
                        ;*****************
55df :                  DrawRadar:
                          direct -1
                          mDecLocals 1,1,4
                       >  nolist
                        
55e1 : cec962             ldu #WalkerList
55e4 : 8608               lda #WalkerCount
55e6 : a7e4               sta LocalB1,s
55e8 :                  zdrLoop:
55e8 : a6c4               lda weWalkerActive,u
55ea : 270b               beq zdrNext
                        
55ec : 3042               leax weWalkerX,u
55ee : 866f               lda #$7f-16
55f0 : 8d2e               bsr RadarPlotCoords
55f2 : 8605               lda #5
55f4 : bd225f             jsr DrawPlusAtCurrentPosition
                        
55f7 :                  zdrNext:
55f7 : 3347               leau WalkerEntry,u
55f9 : 6ae4               dec LocalB1,s
55fb : 26eb               bne zdrLoop
                        
55fd : 8ec8bb             ldx #Zzap_ShipX
5600 : 866f               lda #$7f-16
5602 : 8d1c               bsr RadarPlotCoords
                          mDot_at_current_position
                       >  ; From vectrex.txt
                       >  ;    "(WARNING! high intensity and long Vec_Dot_Dwell might result in a burn in on
                       >  ;     your vectrex monitor, be carefull while experimenting with this!)"
5604 : 86ff            >       lda   #0xFF
5606 : 970a            >       sta   <0x0A
                       >;       ldb   #         ; is a value for how long the dot is lit
                       >;PF2CC1304: decb                     ;dwell is not the same as intensity
                       >;       bne   PF2CC1304
5608 : 0f0a            >       clr   <0x0A
                        
                        
560a : 3063               leax LocalBuffer,s
560c : cc2080             ldd #BaseX
560f : ed84               std ,x
5611 : cc00d5             ldd #BaseY
5614 : ed02               std 2,x
5616 : 865f               lda #$7f-32
5618 : 8d06               bsr RadarPlotCoords
                        ;  lda #3
561a : bd21df             jsr DrawBulletAtCurrentPosition
                        ;  mDot_at_current_position
                        
                          mFreeLocals
561d : 3267            >  leas FrameSize,s
                        
561f : 39                 rts
                        
5620 :                  RadarPlotCoords: ;x points to world coords X,Y, a=intensity
5620 : 3402               pshs a
5622 : bdf354             jsr reset0ref
                        
5625 : ec84               ldd ,x
                        
                          ;div 8192
5627 : 59                 rolb
5628 : 49                 rola
5629 : 59                 rolb
562a : 49                 rola
562b : 8040               suba #64
562d : a77f               sta -1,s
                        
562f : ec02               ldd 2,x
5631 : 47                 asra
5632 : 56                 rorb
5633 : 47                 asra
5634 : 56                 rorb
5635 : 47                 asra
5636 : 56                 rorb
5637 : 47                 asra
5638 : 56                 rorb
5639 : 1f98               tfr b,a
563b : 40                 nega
563c : 8b64               adda #100
                        
563e : e67f               ldb -1,s
                        
5640 : bdf2fc             jsr move_pen7f_to_d
5643 : 3502               puls a
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
5645 : 9701            >  sta   <01
5647 : cc0401          >  ldd   #$0401
564a : 9700            >  sta   <00
564c : d700            >  stb   <00
                        
564e : 39                 rts
                        ;  mDot_at_current_position
                        ;  lda #3
                        ;  jmp DrawPlusAtCurrentPosition
                        ;  rts
                        
                        ;*****************
564f :                  SetDifficulty:  ;set difficulty based on value in zzaplevel (0--7)
                          direct $c8
                          mDecLocals 2,0,0
                       >  nolist
                        
0000 =                  LocalLevelLo = LocalB1
0001 =                  LocalLevelHi = LocalB2
                        
5651 : 96d1               lda ZzapLevel
5653 : 44                lsra          ;increase difficulty every two walkers
5654 : 1f89               tfr a,b
5656 : 8407               anda #7
5658 : a7e4               sta LocalLevelLo,s
565a : 54                 lsrb
565b : 54                 lsrb
565c : 54                 lsrb
                          ;b=level high
                          ;locallevelo is never lower than hi
                          ;this makes the base difficulty increase after each round (one round=8 walkers)
565d : c107               cmpb #7
565f : 2f02               ble *+4
5661 : c607                 ldb #7      ;level 64 = difficulty at max
5663 : e761               stb LocalLevelHi,s
5665 : e1e4               cmpb LocalLevelLo,s
5667 : 2f02               ble *+4
5669 : e7e4                 stb LocalLevelLo,s
                        
566b : 8ec9c6             ldx #ZzapConfig
                        
566e : a6e4               lda LocalLevelLo,s
5670 : ce56b3             ldu #WalkerShotDelayTable
5673 : e6c6               ldb a,u
5675 : e784               stb zcShotDelay,x
                        
5677 : ce56bb             ldu #WalkerJumpDelayTable
567a : a6e4               lda LocalLevelLo,s
567c : 44                 lsra
567d : e6c6               ldb a,u
567f : e703               stb zcJumpDelay,x
                        
5681 : a6e4               lda LocalLevelLo,s
5683 : 44                 lsra
5684 : ce56af             ldu #WalkerSpreadTable
5687 : a6c6               lda a,u
5689 : a701               sta zcShotYSpread,x
                        
568b : ce56ab             ldu #WalkerSpeedTable
568e : a6e4               lda LocalLevelLo,s
5690 : 44                 lsra
5691 : a6c6               lda a,u
5693 : a702               sta zcWalkerSpeedMask,x
                        
5695 : a661               lda LocalLevelHi,s
5697 : 48                 lsla
5698 : 40                 nega
5699 : 8b18               adda #DefaultHeadH
569b : a706               sta zcHeadH,x
569d : 47                 asra
569e : a707               sta zcHalfHeadH,x
                        
                          ;Walker life
56a0 : a661               lda LocalLevelHi,s
56a2 : 48                 lsla
56a3 : 48                 lsla
56a4 : 8b3a               adda #58
56a6 : a708               sta zcWalkerLife,x
                        
                          mFreeLocals
56a8 : 3262            >  leas FrameSize,s
                        
                          direct -1
56aa : 39                 rts
56ab : 03c00100         WalkerSpeedTable: db FRAME4MASK,FRAME3MASK,FRAME2MASK,0
56af : 01020408         WalkerSpreadTable: db 1,2,4,8
56b3 :                  WalkerShotDelayTable:
56b3 : ffdf3fcf           db FRAME192MASK,FRAME96MASK,FRAME64MASK,FRAME48MASK
56b7 : 1f0fc3c1           db FRAME32MASK,FRAME16MASK,FRAME12MASK,FRAME6MASK
56bb :                  WalkerJumpDelayTable:
56bb : 00ff3f07           db 0,FRAME192MASK,FRAME64MASK,FRAME8MASK
                        
                        ;*****************
56bf :                  UpdateWalkerShots:
                        ;  UpdateWalkerShot
                        ;    loop
                        ;      active?
                        ;        move
                        ;        collision vs ship
                        ;      else save free slot index
                        ;    if free slot
                        ;      and timer=0
                        ;      and walkervisible
                        ;      emit
                        ;        origin HeadX
                        ;        set wsVelocX in direction towards ship
                          direct $c8
                          mDecLocals 1,1,0
                       >  nolist
                        
0001 =                  LocalFree=LocalW1
                        
56c1 : 6f61               clr LocalFree,s
                        
56c3 : cec99a             ldu #WalkerShotList
56c6 : 8605               lda #WalkerShotCount
56c8 : a7e4               sta LocalB1,s
56ca :                  zuwsLoop:
56ca : 6dc4               tst wsActive,u
56cc : 10270082           lbeq zuwsInactive
                        
56d0 : e641               ldb wsVelocX,u      ;update x
56d2 : 1d                 sex
56d3 : e343               addd wsWalkerShotX,u
56d5 : ed43               std wsWalkerShotX,u
                        
56d7 : 9626               lda LoopCounterLow
56d9 : 840f               anda #15
56db : 2605               bne zuwsSkipIncVelocX
56dd : e641                 ldb wsVelocX,u
56df : 58                   aslb
56e0 : e741                 stb wsVelocX,u
56e2 :                  zuwsSkipIncVelocX:
                        
0174 =                  ZuwsMaxDistance = 256 + WalkerWidth
56e2 : dcbb               ldd Zzap_ShipX
56e4 : c30174             addd #ZuwsMaxDistance
56e7 : 10a343             cmpd wsWalkerShotX,u
56ea : 2f64               ble zuwsRemove
56ec : 8302e8             subd #ZuwsMaxDistance*2
56ef : 10a343             cmpd wsWalkerShotX,u
56f2 : 2c5c               bge zuwsRemove
                        
56f4 : ae45               ldx wsWalkerShotY,u
                        
56f6 : e642               ldb wsVelocY,u
56f8 : 3085               leax b,x
                        
56fa : a6e4               lda LocalB1,s
56fc : 8401               anda #1
56fe : 2713               beq zuwsNoHome
5700 : 96e4               lda FrameCounter
5702 : 84c0               anda #FRAME3MASK
5704 : 260d               bne zuwsNoHome
5706 : c601                 ldb #1      ;slightly homing shots
5708 : 9cbd                 cmpx Zzap_ShipY
570a : 2707                 beq zuwsNoHome
570c : 2501                   bcs *+3
570e : 50                       negb
570f : eb42                   addb wsVelocY,u
5711 : e742                   stb wsVelocY,u
5713 :                  zuwsNoHome:
                        
5713 : 9626               lda LoopCounterLow
5715 : 8401               anda #1
5717 : 2602               bne zuwsSkipY
                        
5719 : af45               stx wsWalkerShotY,u
571b :                  zuwsSkipY:
                        
                            ;collision vs ship
571b : 108ec8bb             ldy #Zzap_ShipX
                            mPointVsRect ZzapShipArea,ZzapShipArea,zuwsMiss,wsWalkerShotX,wsWalkerShotY,0,2
571f : ae43            >  ldx     wsWalkerShotX,u
5721 : eca4            >  ldd     0,y
5723 : 830004          >  subd    #ZzapShipArea/2
5726 : ed7e            >  std -2,s
5728 : ac7e            >  cmpx -2,s
572a : 2d22            >  blt    zuwsMiss
572c : c30008          >  addd    #ZzapShipArea
572f : ed7e            >  std -2,s
5731 : ac7e            >  cmpx -2,s
5733 : 2e19            >  bgt    zuwsMiss
5735 : ae45            >  ldx     wsWalkerShotY,u
5737 : ec22            >  ldd     2,y
5739 : 830004          >  subd    #ZzapShipArea/2
573c : ed7e            >  std -2,s
573e : ac7e            >  cmpx -2,s
5740 : 2d0c            >  blt    zuwsMiss
5742 : c30008          >  addd    #ZzapShipArea
5745 : ed7e            >  std -2,s
5747 : ac7e            >  cmpx -2,s
5749 : 2e03            >  bgt    zuwsMiss
                        
574b : bd5b68                 jsr ZzapShipTakeDamage
574e :                  zuwsMiss:
574e : 2004                 bra zuwsNext
5750 :                  zuwsRemove:
5750 : 6fc4                 clr wsActive,u
5752 :                  zuwsInactive:
5752 : ef61                 stu LocalFree,s
5754 :                  zuwsNext:
5754 : 3347               leau WalkerShotEntry,u
5756 : 6ae4               dec LocalB1,s
5758 : 1026ff6e           bne zuwsLoop
                        
                          ;test if emit
575c : cec9c6             ldu #ZzapConfig
575f : a6c4               lda zcShotDelay,u
5761 : 94e4               anda FrameCounter
5763 : 263f               bne zuwsNoEmit
5765 : 6d61               tst LocalFree,s
5767 : 273b               beq zuwsNoEmit
5769 : 0dc3               tst WalkerVisible
576b : 2737               beq zuwsNoEmit
576d : 10ae61               ldy LocalFree,s
5770 : 8601                 lda #1
5772 : a7a4                 sta wsActive,y
5774 : 8ec9be               ldx #VisibleHeadX
5777 : ec02                 ldd 2,x
5779 : eb47                 addb zcHalfHeadH,u
577b : ed25                 std wsWalkerShotY,y
577d : ae84                 ldx ,x
577f : 308810               leax HeadW/2,x
5782 : af23                 stx wsWalkerShotX,y
5784 : 9cbb                 cmpx Zzap_ShipX
5786 : 8603                 lda #3
5788 : 2501                 bcs *+3
578a : 40                     nega
578b : a721                 sta wsVelocX,y
                            mRandomToA
578d : bdf511          >  jsr random                    ;call rom
                        
                        
5790 : e641                 ldb zcShotYSpread,u
5792 : 5a                   decb
5793 : e77f                 stb -1,s
5795 : a47f                 anda -1,s
5797 : 5c                   incb
5798 : 54                   lsrb
5799 : e77f                 stb -1,s
579b : a07f                 suba -1,s
                        
                        ;    anda #7
                        ;    suba #4
579d : a722                 sta wsVelocY,y
                            mEmitSound GunFireSoundId
                       >  if 1=1
579f : 8608            >    lda #GunFireSoundId
                       >  endif
57a1 : bd0477          >  jsr EmitSound
                        
57a4 :                  zuwsNoEmit:
                        
                          mFreeLocals
57a4 : 3263            >  leas FrameSize,s
                        
                          direct -1
57a6 : 39                 rts
                        
                        ;*****************
57a7 :                  DrawWalkerShots:
                          ;DP must be D0
                          mDecLocals 1,0,4
                       >  nolist
                        
                        
                          mSetScale $7f                 ;Scale $7f is required for move_pen_d to reach whole screen
                       >  if 1=1
57a9 : 867f            >    lda #$7f                                   ;if argument exists, load into a, otherwise use current a
                       >  endif
57ab : 9704            >  sta <$04
                        
                        
57ad : 8ec99a             ldx #WalkerShotList
57b0 : 8605               lda #WalkerShotCount
57b2 : a7e4               sta LocalB1,s
57b4 :                  zdwsLoop:
57b4 : 6d84               tst wsActive,x
57b6 : 2717               beq zdwsNotActive
                        
57b8 : 3361               leau LocalBuffer,s
57ba : ec03               ldd wsWalkerShotX,x
57bc : edc4               std ,u
57be : ec05               ldd wsWalkerShotY,x
57c0 : ed42               std 2,u
57c2 : 3410               pshs x
57c4 : 8e4b8d             ldx #WarpVectorList
                          mCombine d,6,$7f
57c7 : cc067f          >  ldd #(lo 6)<<8 | (lo $7f)
                        
57ca : bd07c4             jsr FxDrawSpriteVL                 ;Draw a single sprite  u=pointer to x,y  x=vectorlist a=scale b=intensity
57cd : 3510               puls x
                        
                        ;  tsta
                        ;  beq zdwsNotOnScreen
                        ;    jsr DrawBulletAtCurrentPosition
                        ;    jsr DrawBulletAtCurrentPosition
                        ;    jsr DrawBulletAtCurrentPosition
                        ;zdwsNotOnScreen:
                        
57cf :                  zdwsNotActive:
57cf : 3007               leax WalkerShotEntry,x
57d1 : 6ae4               dec LocalB1,s
57d3 : 26df               bne zdwsLoop
                        
                          mFreeLocals
57d5 : 3265            >  leas FrameSize,s
                        
57d7 : 39                 rts
                        
                        ;*****************
57d8 :                  Zzap_InitNewGame:
                          direct $c8
                        
                          mSetByte GameMode,BonusGame
                       > if 0=BonusGame
                       >   clr GameMode
                       > else
57d8 : 8603            >   lda #BonusGame
57da : 977a            >   sta GameMode
                       > endif
                        
                        
57dc : 4f                 clra
57dd : bd296b             jsr InitNewGame
57e0 : 0ce0               inc ShipLives
57e2 : bd283e             jsr PrepareLevel
                        
                          mSetByte ZzapLevel,0
                       > if 0=0
57e5 : 0fd1            >   clr ZzapLevel
                       > else
                       >   lda #0
                       >   sta ZzapLevel
                       > endif
                        
57e7 : bd564f             jsr SetDifficulty
                        
57ea : cc7d00             ldd #32000
57ed : ddcd               std CurLevelEndX              ;CurLevelEndX = (CurLevelSizeX * TileW)
57ef : cc0000             ldd #0
57f2 : ddcf               std CurLevelEndY              ;CurLevelEndY = largest View Y
                        
57f4 : 8e2000             ldx #ZzapViewStartX
57f7 : 9fc6               stx Zzap_LeftOffsetX
57f9 : 30890080           leax 128,x
57fd : 9fbb               stx Zzap_ShipX
                        
57ff : ccffe0             ldd #WalkerFloorY-255
5802 : ddc8               std ViewY
                        
5804 : cc0032             ldd #50
5807 : ddbd               std Zzap_ShipY
                        
5809 : 8601               lda #1
580b : 97b6               sta Zzap_ShipDir
                        
                          ;Init walkers
580d : 8e2000             ldx #ZzapViewStartX
5810 : cec962             ldu #WalkerList
5813 : c608               ldb #WalkerCount
5815 :                  zngWLoop:
5815 : 3404               pshs b
5817 : 3089fd12           leax -WalkerDistance,x
581b : 8d08               bsr InitOneWalker
581d : 3347               leau WalkerEntry,u
581f : 3504               puls b
5821 : 5a                 decb
5822 : 26f1               bne zngWLoop
                        
                        ;  jsr clear_sound_chip
                          direct -1
5824 : 39                 rts
                        
5825 :                  InitOneWalker: ;x=X coord, u=entry
5825 : 86ff               lda #-1
5827 : a7c4               sta weWalkerActive,u
                        ;  lda #100 + 16
5829 : 108ec9c6           ldy #ZzapConfig
582d : a628               lda zcWalkerLife,y
582f : a741               sta weWalkerLife,u
5831 : cc00af             ldd #WalkerFloorY - (WalkerHeight/2)
5834 : ed44               std weWalkerY,u
5836 : af42               stx weWalkerX,u
5838 : 39                 rts
                        
                        ;*****************
5839 :                  Zzap_DrawShip:
                          direct -1
                        
                          mTestFlag InactiveFlag
                       >  if 255>InactiveFlag
5839 : b6c8e5          >    lda GameFlags1
583c : 8510            >    bita #InactiveFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(InactiveFlag)>>8
                       >  endif
                        
583e : 2701               beq *+3
5840 : 39                   rts
                        
5841 : 7dc8f2             tst ZzapShipTookDamage
5844 : 270a               beq zdsShipOk
5846 : 7ac8f2               dec ZzapShipTookDamage
5849 : b6c826               lda LoopCounterLow
584c : 8402                 anda #2
584e : 2649                 bne zdsNoDraw
5850 :                  zdsShipOk:
                        
                          ;DP must be D0
5850 : bdf354             jsr reset0ref         ;Reset pen
                        
5853 : bec8bb             ldx Zzap_ShipX
5856 : 10bec8bd           ldy Zzap_ShipY
585a : bd078d             jsr FxGetScreenCoords
585d : bdf2fc             jsr  move_pen7f_to_d    ;Set pen position to value of d register
                        
                          mSetIntensity $5f
                       >  if 1=1
5860 : 865f            >    lda   #$5f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
5862 : 9701            >  sta   <01
5864 : cc0401          >  ldd   #$0401
5867 : 9700            >  sta   <00
5869 : d700            >  stb   <00
                        
                        
586b : 7dc8b6             tst  Zzap_ShipDir
586e : 2b05               bmi  Zzap_dsSkip1
5870 : 8e5513             ldx  #Zzap_ShipLeftVectorList
5873 : 2003               bra  Zzap_dsSkip2
5875 :                  Zzap_dsSkip1:
5875 : 8e5523             ldx  #Zzap_ShipRightVectorList
5878 :                  Zzap_dsSkip2:
                        
5878 : 8604               lda   #4              ;Nr of vectors in list
587a : c620               ldb   #32             ;Scale
587c : bdf3b7             jsr   move_draw_VL4   ;Draw list
                        
587f : 7dc814             tst stick1_button3
5882 : 2715               beq zdsNoThrust
                            mRandomToA
5884 : bdf511          >  jsr random                    ;call rom
                        
5887 : 847f                 anda #127
5889 : 8a20                 ora #32
                            mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
588b : 9701            >  sta   <01
588d : cc0401          >  ldd   #$0401
5890 : 9700            >  sta   <00
5892 : d700            >  stb   <00
                        
5894 : 8602                 lda #2
5896 : bdf3b9               jsr $F3B9   ;move draw, use current scale
5899 :                  zdsNoThrust:
5899 :                  zdsNoDraw:
5899 : 39                 rts
                        
                        
                        
                        ;*****************
589a :                  Zzap_DrawShipShots:
                          direct -1
                        
589a : 7fc823             clr $c823     ;set up draw with pattern
                        ;  lda #%10101010
                        ;  sta Pattern
                        
                          ;DP must be D0
                        ;  mSetIntensity $4f
                        
                          ;Draw all active shots.
589d : cec946             ldu #Zzap_ShipShotList
58a0 : 8604               lda #Zzap_ShipShotCount
58a2 :                  Zzap_dssLoop:
58a2 : 3406               pshs d
                        
58a4 : 6dc4               tst Zzap_ssShotActive,u
58a6 : 2736               beq Zzap_dssNext
                        
                          ;vary pattern and intensity for each shot
58a8 : 8ef00b             ldx #$F00B
58ab : a686               lda a,x
58ad : b7c829             sta Pattern
58b0 : 847f               anda #127
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
58b2 : 9701            >  sta   <01
58b4 : cc0401          >  ldd   #$0401
58b7 : 9700            >  sta   <00
58b9 : d700            >  stb   <00
                        
                        
58bb : ae44               ldx Zzap_ssShotX,u
58bd : 10ae42             ldy Zzap_ssShotY,u
58c0 : bd078d             jsr FxGetScreenCoords
58c3 : 2717               beq Zzap_dssRemove    ;remove if offscreen
                        
58c5 : 3406               pshs d
58c7 : bdf354             jsr reset0ref
58ca : 3506               puls d
58cc : bdf2fc             jsr move_pen7f_to_d
58cf : e646               ldb Zzap_ssShotLength,u
58d1 : 6d41               tst Zzap_ssShotDir,u
58d3 : 2a01               bpl *+3
58d5 : 50                   negb
58d6 : 4f                 clra
58d7 : bdf439             jsr $F439 ;draw pattern
                        
58da : 2002               bra Zzap_dssNext
                        
58dc :                  Zzap_dssRemove:
58dc : 6fc4               clr Zzap_ssShotActive,u
                        
58de :                  Zzap_dssNext:
58de : 3506               puls d
58e0 : 3347               leau Zzap_ShipShotEntry,u
58e2 : 4a                 deca
58e3 : 26bd               bne Zzap_dssLoop
58e5 : 39                 rts
                        
                        
                        ;*****************
58e6 :                  Zzap_UpdateShipShots:
                          direct $c8
                          mDecLocals 2,0,0
                       >  nolist
                        
                        
                          ;Move all active shots.
                          ;Increase length of shots that haven't reached full length.
                          ;Remove shots that have left screen.
                        
58e8 : cec946             ldu #Zzap_ShipShotList
58eb : 8604               lda #Zzap_ShipShotCount
58ed : a7e4               sta LocalB1,s
58ef :                  Zzap_ussLoop:
58ef : 6dc4               tst Zzap_ssShotActive,u
58f1 : 102700b9           lbeq Zzap_ussNext
                        
                          ;Update x and length
58f5 : c632               ldb #Zzap_ShipShotMaxLength
58f7 : e146               cmpb Zzap_ssShotLength,u
58f9 : 2506               blo Zzap_ussLenMax
58fb : e646                 ldb Zzap_ssShotLength,u
58fd : cb10                 addb #16
58ff : e746                 stb Zzap_ssShotLength,u
5901 :                  Zzap_ussLenMax:
5901 : ae44               ldx Zzap_ssShotX,u
5903 : 8611               lda #17
5905 : 6d41               tst Zzap_ssShotDir,u
5907 : 2b01               bmi *+3
5909 : 40                   nega
590a : 3086               leax a,x
590c : af44               stx Zzap_ssShotX,u
590e :                  zussXFin:
                        
                          ;Collision vs enemies
590e : 0dc3               tst WalkerVisible
5910 : 1027009a           lbeq zussSkipWalkers
                        
5914 : 108ec9c6           ldy #ZzapConfig
                          ;  mPointVsRect HeadW,HeadH,zussWalkerHeadMiss,Zzap_ssShotX,Zzap_ssShotY, 0,2
5918 : ae44               ldx     Zzap_ssShotX,u
591a : fcc9be             ldd     VisibleHeadX
591d : 830010             subd    #HeadW/2
5920 : ed7e               std -2,s
5922 : ac7e               cmpx -2,s
5924 : 2d2c               blt    zussWalkerHeadMiss
5926 : c30020             addd    #HeadW
5929 : ed7e               std -2,s
592b : ac7e               cmpx -2,s
592d : 2e23               bgt    zussWalkerHeadMiss
592f : ae42               ldx     Zzap_ssShotY,u
5931 : fcc9c0             ldd     VisibleHeadY
5934 : e027               subb    zcHalfHeadH,y
5936 : ed7e               std -2,s
5938 : ac7e               cmpx -2,s
593a : 2d16               blt    zussWalkerHeadMiss
593c : eb26               addb    zcHeadH,y
593e : ed7e               std -2,s
5940 : ac7e               cmpx -2,s
5942 : 2e0e               bgt    zussWalkerHeadMiss
                        
                        
                          ;walker has been hit by head-shot
                            mEmitSound WarpOutSoundId
                       >  if 1=1
5944 : 861d            >    lda #WarpOutSoundId
                       >  endif
5946 : bd0477          >  jsr EmitSound
                        
                            mGiveScore 30
5949 : 8603            >  lda #30 / 10
594b : bd1ad0          >  jsr GiveScoreA
                        
594e : 86fb                 lda #-5
5950 : 2039                 bra zussWalkerTakeDamage
5952 :                  zussWalkerHeadMiss:
                        
5952 : 108ec9c2           ldy #VisibleBaseX
                          mPointVsRect WalkerBaseW,WalkerBaseH,zussWalkerBaseMiss,Zzap_ssShotX,Zzap_ssShotY, 0,2
5956 : ae44            >  ldx     Zzap_ssShotX,u
5958 : eca4            >  ldd      0,y
595a : 83002a          >  subd    #WalkerBaseW/2
595d : ed7e            >  std -2,s
595f : ac7e            >  cmpx -2,s
5961 : 2d4b            >  blt    zussWalkerBaseMiss
5963 : c30054          >  addd    #WalkerBaseW
5966 : ed7e            >  std -2,s
5968 : ac7e            >  cmpx -2,s
596a : 2e42            >  bgt    zussWalkerBaseMiss
596c : ae42            >  ldx     Zzap_ssShotY,u
596e : ec22            >  ldd     2,y
5970 : 830018          >  subd    #WalkerBaseH/2
5973 : ed7e            >  std -2,s
5975 : ac7e            >  cmpx -2,s
5977 : 2d35            >  blt    zussWalkerBaseMiss
5979 : c30030          >  addd    #WalkerBaseH
597c : ed7e            >  std -2,s
597e : ac7e            >  cmpx -2,s
5980 : 2e2c            >  bgt    zussWalkerBaseMiss
                        
                            mGiveScore 10
5982 : 8601            >  lda #10 / 10
5984 : bd1ad0          >  jsr GiveScoreA
                        
5987 : 86ff                 lda #-1
5989 : 2000                 bra zussWalkerTakeDamage
                        
598b :                  zussWalkerTakeDamage:
598b : 9ec3               ldx WalkerVisible
598d : ab01               adda weWalkerLife,x
598f : a701               sta weWalkerLife,x
5991 : 2a19               bpl zussWalkerAlive
                        ;    lda #1
                        ;    sta weWalkerActive,x        ;start death animation
5993 : 6084                 neg weWalkerActive,x        ;-1 becomes 1, start death animation
5995 : f6c9bd               ldb WalkerVisibleI
                            mEmitFx FxTargetWalker,FxTypeDotShatter,b
                       >  if ('b'!='0') && ('b'!='b')
                       >    tfr b,b
                       >  endif
5998 : 8606            >  lda #FxTargetWalker | (FxTypeDotShatter<<4)
599a : bd06bc          >  jsr EmitFx
                        
                            mGiveScore 100
599d : 860a            >  lda #100 / 10
599f : bd1ad0          >  jsr GiveScoreA
                        
                            mEmitSound WalkerDestroyedSoundId
                       >  if 1=1
59a2 : 863a            >    lda #WalkerDestroyedSoundId
                       >  endif
59a4 : bd0477          >  jsr EmitSound
                        
59a7 : 0cd1                 inc ZzapLevel
59a9 : bd564f               jsr SetDifficulty
59ac :                  zussWalkerAlive:
                        
                          ;Remove shot
59ac : 6fc4               clr Zzap_ssShotActive,u
                        
59ae :                  zussWalkerBaseMiss:
                        
59ae :                  zussSkipWalkers:
                        
59ae :                  Zzap_ussNext:
59ae : 3347               leau Zzap_ShipShotEntry,u
59b0 : 6ae4               dec LocalB1,s
59b2 : 1026ff39           bne Zzap_ussLoop
                        
                          mFreeLocals
59b6 : 3262            >  leas FrameSize,s
                        
59b8 : 39                 rts
                        
                        
                        
                        
                        ;*****************
59b9 :                  Zzap_ControlShip:
                          direct $c8
                        
                          mTestFlag InactiveFlag
                       >  if 255>InactiveFlag
59b9 : 96e5            >    lda GameFlags1
59bb : 8510            >    bita #InactiveFlag
                       >  else
                       >    lda GameFlags2
                       >    bita #(InactiveFlag)>>8
                       >  endif
                        
59bd : 2701               beq *+3
59bf : 39                   rts
                        
                        ;  mDecLocals 0,0,0
                        
                          ;Read input from joystick.
                          ;Update ship velocity values and move ship.
                          ;Emit new shot if fired.
                        
                          ;DP must be D0
59c0 : 3408               pshs dp
                          mDptoD0
59c2 : 86d0            >  lda   #0xD0
59c4 : 1f8b            >  tfr   a,dp
                       >  direct -1
                        
59c6 : bdf1f8             jsr read_joystick
59c9 : 860a               lda #$8 + 2
59cb : bdf1b4             jsr read_switches
59ce : 3508               puls dp
                          direct $c8
                        
0004 =                  ZzapShipMaxY=4
59d0 : d6b9               ldb Zzap_ShipVelocY
59d2 : 0d1c               tst $c81c
59d4 : 2710               beq Zzap_csUDMoveCentered
59d6 : 2d07               blt Zzap_csMoveDown
                          ;MoveUp
59d8 : c1fc                 cmpb #-ZzapShipMaxY
59da : 2f12                 ble Zzap_csUDApplyVeloc
                        ;    decb
59dc : 5a                   decb
59dd : 200f                 bra Zzap_csUDApplyVeloc
59df :                  Zzap_csMoveDown:
59df : c104                 cmpb #ZzapShipMaxY
59e1 : 2c0b                 bge Zzap_csUDApplyVeloc
                        ;    incb
59e3 : 5c                   incb
59e4 : 2008                 bra Zzap_csUDApplyVeloc
59e6 :                  Zzap_csUDMoveCentered:
                            ;dampen when centered
59e6 : 5d                  tstb
59e7 : 2705                beq Zzap_csUDApplyVeloc
59e9 : 2a02                bpl *+4
59eb : 5c                    incb
59ec : 86                    db $86 ;eat next byte
59ed : 5a                    decb
59ee :                  Zzap_csUDApplyVeloc:
59ee : d7b9               stb Zzap_ShipVelocY
                        ;  asrb
                        ;  asrb
                        ;  asrb
59f0 : 1d                 sex
59f1 : d3bd               addd Zzap_ShipY
59f3 : 1083ff88           cmpd #ZzapWorldTopY+(ZzapShipH/2)
59f7 : 2c07               bge Zzap_csTestFloor
59f9 : 0fb9                 clr Zzap_ShipVelocY
59fb : ccff88               ldd #ZzapWorldTopY+(ZzapShipH/2)
59fe : 200b                 bra Zzap_csStoreY
5a00 :                  Zzap_csTestFloor:
5a00 : 108300f7           cmpd #ZzapWorldEndY-(ZzapShipH/2)
5a04 : 2f05               ble Zzap_csStoreY
5a06 : 0fb9                 clr Zzap_ShipVelocY
5a08 : cc00f7               ldd #ZzapWorldEndY-(ZzapShipH/2)
5a0b :                  Zzap_csStoreY:
5a0b : ddbd               std Zzap_ShipY
                        
5a0d : 8ec8c8             ldx #ViewY
5a10 : 10a384             cmpd ,x
5a13 : 2e04               bgt Zzap_csViewTopOk
5a15 : ed84                 std ,x
5a17 : 200a                 bra Zzap_csViewYFin
5a19 :                  Zzap_csViewTopOk:
5a19 : 8300ff             subd #255
5a1c : 10a384             cmpd ,x
5a1f : 2f02               ble Zzap_csViewYFin
5a21 : ed84                 std ,x
5a23 :                  Zzap_csViewYFin:
                        
                          ;inc Zzap_ShipVelocY ;todo more gravity?
                        
                        ; lda LoopCounterLow
                        ; anda #1
                        ; beq Zzap_csLRMoveFinished
                        
0030 =                  ZzapShipMaxX=48
                        
5a23 : 0d14               tst stick1_button3
5a25 : 2721               beq Zzap_csLRMoveCentered
5a27 : 8602               lda #2
5a29 : c630               ldb #ZzapShipMaxX
5a2b : 0db6               tst Zzap_ShipDir
5a2d : 2b02               bmi *+4
5a2f : 40                   nega
5a30 : 50                   negb
5a31 : 9bb7               adda Zzap_ShipVelocX
5a33 : 8130               cmpa #ZzapShipMaxX
5a35 : 2f02               ble *+4
5a37 : 1f98                 tfr b,a
5a39 : 81d0               cmpa #-ZzapShipMaxX
5a3b : 2c02               bge *+4
5a3d : 1f98                 tfr b,a
5a3f :                  zcsLRMoveStore:
                        ;    stb Zzap_ShipDir
5a3f : 97b7                 sta Zzap_ShipVelocX
                            mEmitSound ThrustSoundId
                       >  if 1=1
5a41 : 8606            >    lda #ThrustSoundId
                       >  endif
5a43 : bd0477          >  jsr EmitSound
                        
5a46 : 200b                 bra Zzap_csLRMoveFinished
5a48 :                  Zzap_csLRMoveCentered:
5a48 : 96b7               lda Zzap_ShipVelocX  ;dampen veloc x
5a4a : 2707               beq Zzap_csLRMoveFinished
5a4c : 2a02               bpl *+4
5a4e : 4c                   inca
5a4f : c6                   db $c6 ;eat next byte
5a50 : 4a                   deca
5a51 : 97b7               sta Zzap_ShipVelocX
5a53 :                  Zzap_csLRMoveFinished:
                        
5a53 : 0d13               tst stick1_button2
5a55 : 2702               beq zcsNoFlip
5a57 : 00b6                 neg Zzap_ShipDir
5a59 :                  zcsNoFlip:
                        
5a59 : 0d15               tst stick1_button4
5a5b : 2727               beq Zzap_csFireFinish
                            ;Find free
5a5d : cec946               ldu #Zzap_ShipShotList
5a60 : 8604                 lda #Zzap_ShipShotCount
5a62 :                  Zzap_csFire1:
5a62 : 6dc4                 tst Zzap_ssShotActive,u
5a64 : 2707                 beq Zzap_csFreeFound
5a66 : 3347                 leau Zzap_ShipShotEntry,u
5a68 : 4a                   deca
5a69 : 26f7                 bne Zzap_csFire1
5a6b : 2017                 bra Zzap_csFireFinish  ;No free found
5a6d :                  Zzap_csFreeFound:
                            ;lda #1
5a6d : 63c4                 com Zzap_ssShotActive,u
5a6f : 96b6                 lda Zzap_ShipDir
5a71 : a741                 sta Zzap_ssShotDir,u
5a73 : 9ebb                 ldx Zzap_ShipX
5a75 : af44                 stx Zzap_ssShotX,u
5a77 : 9ebd                 ldx Zzap_ShipY
5a79 : 3006                 leax 6,x
5a7b : af42                 stx Zzap_ssShotY,u
5a7d : 6f46                 clr Zzap_ssShotLength,u
                        ;    mEmitSound WalkerDestroyedSoundId
                            mEmitSound ShipFireSoundId
                       >  if 1=1
5a7f : 860c            >    lda #ShipFireSoundId
                       >  endif
5a81 : bd0477          >  jsr EmitSound
                        
5a84 :                  Zzap_csFireFinish:
                        
5a84 : 96b7               lda Zzap_ShipVelocX
5a86 : 47                 asra
5a87 : 47                 asra
                        
                          ;Move ship X
5a88 : 9ebb               ldx Zzap_ShipX
5a8a : 3086               leax a,x
                        
5a8c : 8c20ce             cmpx #ZzapWorldEndX-(ZzShipWidth/2)
5a8f : 2d03               blt *+5
5a91 : 8e20ce               ldx #ZzapWorldEndX-(ZzShipWidth/2)
5a94 : 8c0132             cmpx #ZzapWorldStartX+(ZzShipWidth/2)
5a97 : 2e03               bgt *+5
5a99 : 8e0132               ldx #ZzapWorldStartX+(ZzShipWidth/2)
                        
5a9c : 9fbb               stx Zzap_ShipX
                        
                          ;Update view coordinate
                          ;Add ship velocity and test for world ends
5a9e : 9ec6               ldx Zzap_LeftOffsetX
5aa0 : 3086               leax a,x
5aa2 : 8c2000             cmpx #ZzapWorldEndX-256
5aa5 : 2d03               blt *+5
5aa7 : 8e2000               ldx #ZzapWorldEndX-256
5aaa : 8c0100             cmpx #ZzapWorldStartX
5aad : 2e03               bgt *+5
5aaf : 8e0100               ldx #ZzapWorldStartX
                        
                          ;slide viewx to left or right edge depending on ship direction
5ab2 : debb               ldu Zzap_ShipX
5ab4 : 96b7               lda Zzap_ShipVelocX
5ab6 : 40                 nega
5ab7 : 33c6               leau a,u
5ab9 : af7e               stx -2,s
5abb : 0db6               tst Zzap_ShipDir
5abd : 2a0c               bpl zcsSlideLeft
5abf : 33c8c0               leau -64,u
5ac2 : 11a37e               cmpu -2,s
5ac5 : 2f11                 ble zcsSlideMax
5ac7 : 3002                   leax 2,x
5ac9 : 200f                   bra zcsSlideStoreX
5acb :                  zcsSlideLeft:
5acb : 33c9ff20             leau -(256-32),u
5acf : 11a37e               cmpu -2,s
5ad2 : 2c04                 bge zcsSlideMax
5ad4 : 301e                   leax -2,x
5ad6 : 2002                   bra zcsSlideStoreX
5ad8 :                  zcsSlideMax:
5ad8 : 1f31               tfr u,x
5ada :                  zcsSlideStoreX:
5ada : 9fc6               stx Zzap_LeftOffsetX
                        
5adc : 8d6e               bsr ZzapUpdateClipView
                        
                          ;Collision ship vs walkers
5ade : 0dc3               tst WalkerVisible
5ae0 : 2769               beq zcsWalkerFinish
5ae2 : cec8bb               ldu #ShipX
5ae5 : 108ec9c6             ldy #ZzapConfig
                        ;    mPointVsRect HeadW,HeadH,zcsWalkerHeadMiss,0,2, 0,2
5ae9 : aec4                 ldx     0,u
5aeb : fcc9be               ldd     VisibleHeadX
5aee : 830010               subd    #HeadW/2
5af1 : ed7e                 std -2,s
5af3 : ac7e                 cmpx -2,s
5af5 : 2d22                 blt    zcsWalkerHeadMiss
5af7 : c30020               addd    #HeadW
5afa : ed7e                 std -2,s
5afc : ac7e                 cmpx -2,s
5afe : 2e19                 bgt    zcsWalkerHeadMiss
5b00 : ae42                 ldx     2,u
5b02 : fcc9c0               ldd     VisibleHeadY
5b05 : e027                 subb    zcHalfHeadH,y
5b07 : ed7e                 std -2,s
5b09 : ac7e                 cmpx -2,s
5b0b : 2d0c                 blt    zcsWalkerHeadMiss
5b0d : eb26                 addb    zcHeadH,y
5b0f : ed7e                 std -2,s
5b11 : ac7e                 cmpx -2,s
5b13 : 2e04                 bgt    zcsWalkerHeadMiss
5b15 : 8d51                   bsr ZzapShipTakeDamage
5b17 : 2032                   bra zcsWalkerFinish
5b19 :                  zcsWalkerHeadMiss:
5b19 : 108ec9c2             ldy #VisibleBaseX
                            mPointVsRect WalkerBaseW,WalkerBaseH,zcsWalkerFinish,0,2, 0,2
5b1d : aec4            >  ldx     0,u
5b1f : eca4            >  ldd      0,y
5b21 : 83002a          >  subd    #WalkerBaseW/2
5b24 : ed7e            >  std -2,s
5b26 : ac7e            >  cmpx -2,s
5b28 : 2d21            >  blt    zcsWalkerFinish
5b2a : c30054          >  addd    #WalkerBaseW
5b2d : ed7e            >  std -2,s
5b2f : ac7e            >  cmpx -2,s
5b31 : 2e18            >  bgt    zcsWalkerFinish
5b33 : ae42            >  ldx     2,u
5b35 : ec22            >  ldd     2,y
5b37 : 830018          >  subd    #WalkerBaseH/2
5b3a : ed7e            >  std -2,s
5b3c : ac7e            >  cmpx -2,s
5b3e : 2d0b            >  blt    zcsWalkerFinish
5b40 : c30030          >  addd    #WalkerBaseH
5b43 : ed7e            >  std -2,s
5b45 : ac7e            >  cmpx -2,s
5b47 : 2e02            >  bgt    zcsWalkerFinish
                        
5b49 : 8d1d                   bsr ZzapShipTakeDamage
5b4b :                  zcsWalkerFinish:
                        
                        ;  mFreeLocals
                          direct -1
5b4b : 39                 rts
                        
5b4c :                  ZzapUpdateClipView:
                          ;Update clip-region used by drawenemies
                          direct $c8
5b4c : c6ff               ldb #255
5b4e : 9ec6               ldx ViewX
5b50 : cec8d2             ldu #_clip_xmin
5b53 : afc4               stx ,u
5b55 : 3a                 abx
5b56 : af44               stx 4,u
5b58 : 9ec8               ldx ViewY
5b5a : af42               stx 2,u
5b5c : 3a                 abx
                          ;clip walkers at floor level, makes their death-animation looks nice
5b5d : 8c00df             cmpx #WalkerFloorY
5b60 : 2f03               ble *+5
5b62 : 8e00df               ldx #WalkerFloorY
5b65 : af46               stx 6,u
                          direct -1
5b67 : 39                 rts
                        
                        ;*****************
5b68 :                  ZzapShipTakeDamage:
                          direct $c8
                        
5b68 : 0df2               tst ZzapShipTookDamage        ;skip if already damaged
5b6a : 2619               bne zstNotGameOver
                        
5b6c : 8632               lda #50
5b6e : 00b6               neg Zzap_ShipDir
5b70 : 2b01               bmi *+3
5b72 : 40                   nega
5b73 : 97b7               sta Zzap_ShipVelocX
                        
                          mEmitSound ExplosionSoundId
                       >  if 1=1
5b75 : 8621            >    lda #ExplosionSoundId
                       >  endif
5b77 : bd0477          >  jsr EmitSound
                        
                          mSetByte ZzapShipTookDamage,255
                       > if 0=255
                       >   clr ZzapShipTookDamage
                       > else
5b7a : 86ff            >   lda #255
5b7c : 97f2            >   sta ZzapShipTookDamage
                       > endif
                        
5b7e : 0ae0               dec ZzapShipLives
5b80 : 2603               bne zstNotGameOver
5b82 : bd2af8               jsr ExplodeShip
5b85 :                  zstNotGameOver:
                          direct -1
5b85 : 39                 rts
                        
                        ;*****************
5b86 :                  Zzap_DrawMountain:
                          ;Draw background mountain.
                          ;The mountain is drawn twice at different height and intensity.
                          mDecLocals 2,0,0
                       >  nolist
                        
0001 =                  LocalOffset = LocalB2
                        
                          ;DP must be D0
                          mSetIntensity $3f
                       >  if 1=1
5b88 : 863f            >    lda   #$3f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
5b8a : 9701            >  sta   <01
5b8c : cc0401          >  ldd   #$0401
5b8f : 9700            >  sta   <00
5b91 : d700            >  stb   <00
                        
                        
                          ;Calc start in ycoord table.
5b93 : 108e54f3           ldy  #Zzap_MountainYCoords
                        
5b97 : b6c8c7             lda  Zzap_LeftOffsetX+1
5b9a : 44                 lsra
5b9b : 44                 lsra
5b9c : 44                 lsra
5b9d : 44                 lsra
5b9e : 840f               anda #15
5ba0 : a761               sta LocalOffset,s
                        
5ba2 : 8e5503             ldx  #Zzap_MountainABSYCoords
5ba5 : a686               lda  a,x
5ba7 : f6c8c9             ldb ViewY+1
                        ;  asrb
                        ;  asrb
5baa : 57                 asrb
5bab : e77f               stb -1,s
5bad : ab7f               adda -1,s
5baf : 8b14               adda #20
                        
5bb1 : f6c8c7             ldb  Zzap_LeftOffsetX+1
5bb4 : c40f               andb #15
5bb6 : 50                 negb
5bb7 : c06f               subb #111
5bb9 : bdf2fc             jsr  move_pen7f_to_d
                        
5bbc : 8610               lda  #16    ;Nr of segments to draw
5bbe : a7e4               sta LocalB1,s
5bc0 : a661               lda LocalOffset,s
5bc2 :                  Zzap_dmLoop1:
5bc2 : 3402               pshs a
5bc4 : c610               ldb  #16    ;X increment
5bc6 : a6a6               lda  a,y
                          mDrawToD
5bc8 : 9701            >  sta   <$01
5bca : 0f00            >  clr   <$00
                       >;  leax  2,x
                       >  ;Ev. måste flera nop läggas till här för att kompensera att föregående rad
                       >  ;kommenterats bort
                       >;  nop
5bcc : 0c00            >  inc   <$00
5bce : d701            >  stb   <$01
5bd0 : ccff00          >  ldd   #$FF00
5bd3 : 970a            >  sta   <$0A
5bd5 : d705            >  stb   <$05
5bd7 : 8640            >  lda   #$40
5bd9 :                 >wait11403:
5bd9 : 950d            >  bita  <$0D
5bdb : 27fc            >  beq   wait11403
                       >;  nop
5bdd : d70a            >  stb   <$0A
                        
5bdf : 3502               puls a
5be1 : 4c                 inca
5be2 : 840f               anda #15      ;keep index within table-size
5be4 : 6ae4               dec LocalB1,s
5be6 : 26da               bne Zzap_dmLoop1
                        
                          ;****
                        
                        
                        
                        
5be8 : bdf354             jsr   reset0ref             ;Reset pen
                          mSetIntensity $10
                       >  if 1=1
5beb : 8610            >    lda   #$10            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
5bed : 9701            >  sta   <01
5bef : cc0401          >  ldd   #$0401
5bf2 : 9700            >  sta   <00
5bf4 : d700            >  stb   <00
                        
                        
5bf6 : a661               lda LocalOffset,s
5bf8 : 8e5503             ldx  #Zzap_MountainABSYCoords
5bfb : a686               lda  a,x
5bfd : f6c8c9             ldb ViewY+1
                        ;  asrb
                        ;  asrb
                        ;  asrb
5c00 : 57                 asrb
5c01 : e77f               stb -1,s
5c03 : ab7f               adda -1,s
5c05 : 8b50               adda #80
                        
5c07 : f6c8c7             ldb  Zzap_LeftOffsetX+1
5c0a : c40f               andb #15
5c0c : 54                 lsrb
5c0d : 50                 negb
5c0e : c06f               subb #111
5c10 : bdf2fc             jsr  move_pen7f_to_d
                        
                        ;  mSetScale $3f
                        
5c13 : 8620               lda  #32    ;Nr of segments to draw
5c15 : a7e4               sta LocalB1,s
5c17 : a661               lda LocalOffset,s
5c19 :                  Zzap_dmLoop11:
5c19 : 3402               pshs a
5c1b : a6a6               lda  a,y
5c1d : c608               ldb  #8     ;X increment
                          mDrawToD
5c1f : 9701            >  sta   <$01
5c21 : 0f00            >  clr   <$00
                       >;  leax  2,x
                       >  ;Ev. måste flera nop läggas till här för att kompensera att föregående rad
                       >  ;kommenterats bort
                       >;  nop
5c23 : 0c00            >  inc   <$00
5c25 : d701            >  stb   <$01
5c27 : ccff00          >  ldd   #$FF00
5c2a : 970a            >  sta   <$0A
5c2c : d705            >  stb   <$05
5c2e : 8640            >  lda   #$40
5c30 :                 >wait11405:
5c30 : 950d            >  bita  <$0D
5c32 : 27fc            >  beq   wait11405
                       >;  nop
5c34 : d70a            >  stb   <$0A
                        
5c36 : 3502               puls a
5c38 : 4c                 inca
5c39 : 840f               anda #15      ;keep index within table-size
5c3b : 6ae4               dec LocalB1,s
5c3d : 26da               bne Zzap_dmLoop11
                        
                          mFreeLocals
5c3f : 3262            >  leas FrameSize,s
                        
5c41 : 39                 rts
                        
                        
                        
                        ;*****************
5c42 :                  UpdateWalkers:
                          direct $c8
                          mDecLocals 2,2,0
                       >  nolist
                        
0001 =                  LocalJumpY = LocalB2
0002 =                  LocalFree = LocalW1
0004 =                  LocalMinX = LocalW2
                        
                        ;   loop walkers
                        ;     move right
                        ;     game over if reached right edge
                        ;     keep track of walker with lowest x
                        ;   if lowest x<threshold
                        ;     emit new walker at left edge
                        
                        
5c44 : 108ec9c6           ldy #ZzapConfig
                        
                        ;  lda zcWalkerSpeedMask,y
                        ;  anda FrameCounter
                        ;  bne zuwNoPulse
                        ;  lda LoopCounterLow
                        ;  anda #7
                        ;  bne zuwNoPulse
                        ;    mEmitSound GunFireSoundId
                        ;zuwNoPulse:
                        
5c48 : a624               lda zcJumping,y
5c4a : 2b1f               bmi zuwNoJumping
5c4c : 1f89                 tfr a,b
5c4e : 4c                   inca
5c4f : 8140                 cmpa #64
5c51 : 2602                 bne *+4
5c53 : 86ff                   lda #-1
5c55 : a724                 sta zcJumping,y
5c57 : 8e6d3f               ldx #SineTable
5c5a : e685                 ldb b,x
5c5c : 57                   asrb
5c5d : 57                   asrb
                        
5c5e : a625                 lda zcJumpScale,y
5c60 : 3d                   mul
                        
5c61 : 50                   negb
                        
5c62 : e761                 stb LocalJumpY,s
                            mEmitSound WalkerBounceSoundId
                       >  if 1=1
5c64 : 8615            >    lda #WalkerBounceSoundId
                       >  endif
5c66 : bd0477          >  jsr EmitSound
                        
5c69 : 2016                 bra zuwJumpFin
5c6b :                  zuwNoJumping:
5c6b : 6f61                 clr LocalJumpY,s
5c6d : a623                 lda zcJumpDelay,y
5c6f : 2710                 beq zuwJumpFin
5c71 : 94e4                 anda FrameCounter
5c73 : 260c                 bne zuwJumpFin
                              mRandomToA
5c75 : bdf511          >  jsr random                    ;call rom
                        
5c78 : 8407                   anda #7
5c7a : 2705                   beq zuwJumpFin
                              ;Range: 1..8
5c7c : 4c                     inca
5c7d : a725                   sta zcJumpScale,y
5c7f : 6f24                   clr zcJumping,y
5c81 :                  zuwJumpFin:
                        
5c81 : 6f62               clr LocalFree,s
5c83 : 867f               lda #$7F      ;high signed value
5c85 : a764               sta LocalMinX,s
                        
5c87 : cec962             ldu #WalkerList
5c8a : 8608               lda #WalkerCount
5c8c : a7e4               sta LocalB1,s
5c8e :                  zuwLoop:
5c8e : a6c4               lda weWalkerActive,u
5c90 : 2737               beq zuwInactive
5c92 : 2b0f               bmi zuwNotDying
5c94 : ae44                 ldx weWalkerY,u
5c96 : 3002                 leax 2,x
5c98 : af44                 stx weWalkerY,u
5c9a : 8c010f               cmpx #WalkerFloorY + (WalkerHeight/2)       ;remove when fallen under floor
5c9d : 2f02                 ble *+4
5c9f : 6fc4                   clr weWalkerActive,u
5ca1 : 2028                 bra zuwNext
5ca3 :                  zuwNotDying:
                        
                          ;Move X-coord
5ca3 : ae42               ldx weWalkerX,u
                        
5ca5 : a622               lda zcWalkerSpeedMask,y
5ca7 : 94e4               anda FrameCounter
5ca9 : 260d               bne zuwDontWalk
                        
5cab : 3003               leax 3,x
5cad : af42               stx weWalkerX,u
5caf : 8c2046             cmpx #BaseX - WalkerWidth/2
5cb2 : 2504               blo zuwNotReachedBase
5cb4 : 8d31                 bsr WalkerHitBase
5cb6 : 202c                 bra zuwExit
5cb8 :                  zuwNotReachedBase:
                        
5cb8 :                  zuwDontWalk:
                        
5cb8 : ac64               cmpx LocalMinX,s
5cba : 2c02               bge zuwNotLowest
5cbc : af64                 stx LocalMinX,s
5cbe :                  zuwNotLowest:
                        
                        
                          ;Update Y
5cbe : e661               ldb LocalJumpY,s
5cc0 : 8e00af             ldx #WalkerFloorY - (WalkerHeight/2)
5cc3 : 3085               leax b,x
5cc5 : af44               stx weWalkerY,u
                        
5cc7 : 2002               bra zuwNext
                        
5cc9 :                  zuwInactive:
5cc9 : ef62               stu LocalFree,s
                        
5ccb :                  zuwNext:
5ccb : 3347               leau WalkerEntry,u
5ccd : 6ae4               dec LocalB1,s
5ccf : 26bd               bne zuwLoop
                        
                          ;emit new if free and minx<threshold
5cd1 : 6d62               tst LocalFree,s
5cd3 : 270f               beq zuwNoEmit
5cd5 : ae64               ldx LocalMinX,s
5cd7 : 8c037a             cmpx #ZzapWorldStartX-WalkerWidth+WalkerDistance
5cda : 2f08               ble zuwNoEmit
5cdc : ee62                 ldu LocalFree,s
5cde : 8e008c               ldx #ZzapWorldStartX-WalkerWidth
5ce1 : bd5825               jsr InitOneWalker
5ce4 :                  zuwNoEmit:
                        
5ce4 :                  zuwExit:
                        
                          mFreeLocals
5ce4 : 3266            >  leas FrameSize,s
                        
                          direct -1
5ce6 : 39                 rts
                        
5ce7 :                  WalkerHitBase:
                          direct $c8
5ce7 : 8664               lda #100
5ce9 : 340a               pshs a,dp
5ceb : cc2000             ldd #BaseX - 128
5cee : ddc6               std ViewX
5cf0 : ccffe0             ldd #WalkerFloorY-255
5cf3 : ddc8               std ViewY
5cf5 : bd5b4c             bsr ZzapUpdateClipView
                          mEmitSound PlanetExplodeSoundId
                       >  if 1=1
5cf8 : 8631            >    lda #PlanetExplodeSoundId
                       >  endif
5cfa : bd0477          >  jsr EmitSound
                        
                          mSetFlag GameOverFlag
                       >  if 255>GameOverFlag
5cfd : 8640            >    lda #GameOverFlag
5cff : 9ae5            >    ora GameFlags1
5d01 : 97e5            >    sta GameFlags1
                       >  else
                       >    lda #(GameOverFlag)>>8
                       >    ora GameFlags2
                       >    sta GameFlags2
                       >  endif
                        
5d03 :                  whsMainLoop:
                          mDptoC8
5d03 : 86c8            >  lda   #0xC8
5d05 : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
5d07 : bd049c             jsr UpdateSound
5d0a : bdf192             jsr waitrecal         ;Wait for screen sync
                          ;DP is now D0
5d0d : bdf289             jsr UpdateSoundChip
5d10 : bd5b86             jsr Zzap_DrawMountain
5d13 : bd5d1f             jsr DrawWalkers
5d16 : bd5ef3             jsr DrawBase
5d19 : 6ae4               dec ,s
5d1b : 26e6               bne whsMainLoop
5d1d : 358a               puls a,dp,pc
                          direct -1
                        
                        ;*****************
0012 =                  WalkerLineCount = 18
5d1f :                  DrawWalkers:
                          mDecLocals 2,2,WalkerLineCount * 5
                       >  nolist
                        
0006 =                  LocalLines = LocalBuffer
0000 =                  LocalDist = LocalB1
0001 =                  LocalInt = LocalB2
0002 =                  LocalXMin = LocalW1
0004 =                  LocalXMax = LocalW2
                          direct -1
                        
                        ;    loop enemies
                        ;      check if on screen
                        ;        clip and draw
                        ;        break (only one can be visible at a time)
                        
                          ;No walker is visible as default
                          mSetByte WalkerVisible,0
                       > if 0=0
5d22 : 7fc8c3          >   clr WalkerVisible
                       > else
                       >   lda #0
                       >   sta WalkerVisible
                       > endif
                        
                        
5d25 : fcc8c6             ldd ViewX
5d28 : 83003a             subd #WalkerWidth/2
5d2b : ed62               std LocalXMin,s
5d2d : c30174             addd #256 + WalkerWidth
5d30 : ed64               std LocalXMax,s
                        
5d32 : cec962             ldu #WalkerList
5d35 : 8608               lda #WalkerCount
5d37 : a7e4               sta LocalB1,s
5d39 :                  zdwLoop:
5d39 : 6dc4               tst weWalkerActive,u
5d3b : 271c               beq zdwNext
                        
5d3d : ec42               ldd weWalkerX,u
5d3f : 10a362             cmpd LocalXMin,s
5d42 : 2d15               blt zdwNext
5d44 : 10a364             cmpd LocalXMax,s
5d47 : 2e10               bgt zdwNext
                        
                          ;Store info about visible walker, if not dying
5d49 : 6dc4               tst weWalkerActive,u
5d4b : 2a03               bpl zdwVisibleIsDying
5d4d : ffc8c3               stu WalkerVisible
5d50 :                  zdwVisibleIsDying:
5d50 : 8608               lda #WalkerCount
5d52 : a0e4               suba LocalB1,s
5d54 : b7c9bd             sta WalkerVisibleI
                        
5d57 : 2009               bra dwDraw
                        
5d59 :                  zdwNext:
5d59 : 3347               leau WalkerEntry,u
5d5b : 6ae4               dec LocalB1,s
5d5d : 26da               bne zdwLoop
                        
5d5f : 7e5eef             jmp dwExit
                        
5d62 :                  dwDraw:
                        
                        
0000 =                  _off=0
                        mWa macro value
                         if \0=1
                           lda #value
                         endif
                         sta _off,x
                        _off=_off+1
                         endm
                        mWd macro
                         if \0=2
                           mCombine d,\1,\2
                         endif
                         std _off,x
                        _off=_off+2
                         if _off>$e
                           ;Avoid extra byte for offsets>$f
                           ;Accumulate offset to x, reset offset
                           leax _off,x
                        _off=0
                         endif
                         endm
                        
5d62 : 8660               lda #$60              ;intensity
5d64 : 6dc4               tst weWalkerActive,u
5d66 : 2b03               bmi zdwAliveInt
                            mRandomToA
5d68 : bdf511          >  jsr random                    ;call rom
                        
5d6b :                  zdwAliveInt:
5d6b : a761               sta LocalInt,s
                        
                          ;Leg and head animation
                          mTicToc 64
5d6d : b6c826          >  lda LoopCounterLow
5d70 : 843f            >  anda #64-1
5d72 : 8120            >  cmpa #64/2
5d74 : 2402            >  bcc l11441
5d76 : 883f            >  eora #64-1
5d78 :                 >l11441:
                        
5d78 : 47                 asra
5d79 : 47                 asra
5d7a : a7e4               sta LocalDist,s
                        
5d7c : 3066               leax LocalLines,s
5d7e : ccc9cf             ldd #WalkerDrawList   ;write result buffer
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5d81 : ed84            > std _off,x
0002 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
5d83 : ec44               ldd weWalkerY,u       ;write top-left coords
5d85 : 830030             subd #WalkerHeight/2
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5d88 : ed02            > std _off,x
0004 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
5d8a : c30018             addd #WalkerBaseH/2   ;also store visible base coords for hittests
5d8d : fdc9c4             std VisibleBaseY
5d90 : ec42               ldd weWalkerX,u
5d92 : 83003a             subd #WalkerWidth/2
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5d95 : ed04            > std _off,x
0006 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
5d97 : c3002a             addd #WalkerBaseW/2   ;also store visible base coords for hittests
5d9a : fdc9c2             std VisibleBaseX
                        
                        
                          ;Linecount
                          mWa 12
                       > if 1=1
5d9d : 860c            >   lda #12
                       > endif
5d9f : a706            > sta _off,x
0007 =                 >_off=_off+1
                        
                        
                          ;Base top
                          mWa 2
                       > if 1=1
5da1 : 8602            >   lda #2
                       > endif
5da3 : a707            > sta _off,x
0008 =                 >_off=_off+1
                        
                          mWd 0,WalkerBaseH/8
                       > if 2=2
                       >   mCombine d,0,WalkerBaseH/8
5da5 : cc0006          >  ldd #(lo 0)<<8 | (lo WalkerBaseH/8)
                       >
                       > endif
5da8 : ed08            > std _off,x
000a =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mWd WalkerBaseW/7,0
                       > if 2=2
                       >   mCombine d,WalkerBaseW/7,0
5daa : cc0c00          >  ldd #(lo WalkerBaseW/7)<<8 | (lo 0)
                       >
                       > endif
5dad : ed0a            > std _off,x
000c =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 1
                       > if 1=1
5daf : 8601            >   lda #1
                       > endif
5db1 : a70c            > sta _off,x
000d =                 >_off=_off+1
                        
                          mWd WalkerBaseW/7,0
                       > if 2=2
                       >   mCombine d,WalkerBaseW/7,0
5db3 : cc0c00          >  ldd #(lo WalkerBaseW/7)<<8 | (lo 0)
                       >
                       > endif
5db6 : ed0d            > std _off,x
000f =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
5db8 : 300f            >   leax _off,x
0000 =                 >_off=0
                       > endif
                        
                          mWd (WalkerBaseW/7)*6,0
                       > if 2=2
                       >   mCombine d,(WalkerBaseW/7)*6,0
5dba : cc4800          >  ldd #(lo (WalkerBaseW/7)*6)<<8 | (lo 0)
                       >
                       > endif
5dbd : ed84            > std _off,x
0002 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 2
                       > if 1=1
5dbf : 8602            >   lda #2
                       > endif
5dc1 : a702            > sta _off,x
0003 =                 >_off=_off+1
                        
                          mWd (WalkerBaseW/7)*6,0
                       > if 2=2
                       >   mCombine d,(WalkerBaseW/7)*6,0
5dc3 : cc4800          >  ldd #(lo (WalkerBaseW/7)*6)<<8 | (lo 0)
                       >
                       > endif
5dc6 : ed03            > std _off,x
0005 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mWd (WalkerBaseW/7)*7,WalkerBaseH/8
                       > if 2=2
                       >   mCombine d,(WalkerBaseW/7)*7,WalkerBaseH/8
5dc8 : cc5406          >  ldd #(lo (WalkerBaseW/7)*7)<<8 | (lo WalkerBaseH/8)
                       >
                       > endif
5dcb : ed05            > std _off,x
0007 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          ;Base lower
                          mWa 0
                       > if 1=1
5dcd : 8600            >   lda #0
                       > endif
5dcf : a707            > sta _off,x
0008 =                 >_off=_off+1
                        
                          mWd 0,WalkerBaseH/8
                       > if 2=2
                       >   mCombine d,0,WalkerBaseH/8
5dd1 : cc0006          >  ldd #(lo 0)<<8 | (lo WalkerBaseH/8)
                       >
                       > endif
5dd4 : ed08            > std _off,x
000a =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mWd 0,WalkerBaseH
                       > if 2=2
                       >   mCombine d,0,WalkerBaseH
5dd6 : cc0030          >  ldd #(lo 0)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5dd9 : ed0a            > std _off,x
000c =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 1
                       > if 1=1
5ddb : 8601            >   lda #1
                       > endif
5ddd : a70c            > sta _off,x
000d =                 >_off=_off+1
                        
                          mWd 0,WalkerBaseH
                       > if 2=2
                       >   mCombine d,0,WalkerBaseH
5ddf : cc0030          >  ldd #(lo 0)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5de2 : ed0d            > std _off,x
000f =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
5de4 : 300f            >   leax _off,x
0000 =                 >_off=0
                       > endif
                        
                          mWd WalkerBaseW,WalkerBaseH
                       > if 2=2
                       >   mCombine d,WalkerBaseW,WalkerBaseH
5de6 : cc5430          >  ldd #(lo WalkerBaseW)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5de9 : ed84            > std _off,x
0002 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 0
                       > if 1=1
5deb : 8600            >   lda #0
                       > endif
5ded : a702            > sta _off,x
0003 =                 >_off=_off+1
                        
                          mWd WalkerBaseW,WalkerBaseH/8
                       > if 2=2
                       >   mCombine d,WalkerBaseW,WalkerBaseH/8
5def : cc5406          >  ldd #(lo WalkerBaseW)<<8 | (lo WalkerBaseH/8)
                       >
                       > endif
5df2 : ed03            > std _off,x
0005 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mWd WalkerBaseW,WalkerBaseH
                       > if 2=2
                       >   mCombine d,WalkerBaseW,WalkerBaseH
5df4 : cc5430          >  ldd #(lo WalkerBaseW)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5df7 : ed05            > std _off,x
0007 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          ;Legs
0004 =                  LegX=4  ;Offset X from WalkerBase that leg is attached
                        
                          ;Left leg
                        
                          mWa 0
                       > if 1=1
5df9 : 8600            >   lda #0
                       > endif
5dfb : a707            > sta _off,x
0008 =                 >_off=_off+1
                        
                          mWd LegX,WalkerBaseH
                       > if 2=2
                       >   mCombine d,LegX,WalkerBaseH
5dfd : cc0430          >  ldd #(lo LegX)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5e00 : ed08            > std _off,x
000a =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mCombine d,LegX,WalkerBaseH+WalkerLegH
5e02 : cc0460          >  ldd #(lo LegX)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e05 : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e07 : ed0a            > std _off,x
000c =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 1
                       > if 1=1
5e09 : 8601            >   lda #1
                       > endif
5e0b : a70c            > sta _off,x
000d =                 >_off=_off+1
                        
                          mCombine d,LegX,WalkerBaseH+WalkerLegH
5e0d : cc0460          >  ldd #(lo LegX)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e10 : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e12 : ed0d            > std _off,x
000f =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
5e14 : 300f            >   leax _off,x
0000 =                 >_off=0
                       > endif
                        
                          mCombine d,LegX+WalkerLegW,WalkerBaseH+WalkerLegH
5e16 : cc1460          >  ldd #(lo LegX+WalkerLegW)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e19 : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e1b : ed84            > std _off,x
0002 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 0
                       > if 1=1
5e1d : 8600            >   lda #0
                       > endif
5e1f : a702            > sta _off,x
0003 =                 >_off=_off+1
                        
                          mWd LegX+WalkerLegW,WalkerBaseH
                       > if 2=2
                       >   mCombine d,LegX+WalkerLegW,WalkerBaseH
5e21 : cc1430          >  ldd #(lo LegX+WalkerLegW)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5e24 : ed03            > std _off,x
0005 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mCombine d,LegX+WalkerLegW,WalkerBaseH+WalkerLegH
5e26 : cc1460          >  ldd #(lo LegX+WalkerLegW)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e29 : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e2b : ed05            > std _off,x
0007 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          ;Right leg
5e2d : 8610               lda #16
5e2f : a0e4               suba LocalDist,s
5e31 : a7e4               sta LocalDist,s
                        
                          mWa 0
                       > if 1=1
5e33 : 8600            >   lda #0
                       > endif
5e35 : a707            > sta _off,x
0008 =                 >_off=_off+1
                        
                          mWd WalkerBaseW-WalkerLegW-LegX,WalkerBaseH
                       > if 2=2
                       >   mCombine d,WalkerBaseW-WalkerLegW-LegX,WalkerBaseH
5e37 : cc4030          >  ldd #(lo WalkerBaseW-WalkerLegW-LegX)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5e3a : ed08            > std _off,x
000a =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mCombine d,WalkerBaseW-WalkerLegW-LegX,WalkerBaseH+WalkerLegH
5e3c : cc4060          >  ldd #(lo WalkerBaseW-WalkerLegW-LegX)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e3f : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e41 : ed0a            > std _off,x
000c =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 1
                       > if 1=1
5e43 : 8601            >   lda #1
                       > endif
5e45 : a70c            > sta _off,x
000d =                 >_off=_off+1
                        
                          mCombine d,WalkerBaseW-WalkerLegW-LegX,WalkerBaseH+WalkerLegH
5e47 : cc4060          >  ldd #(lo WalkerBaseW-WalkerLegW-LegX)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e4a : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e4c : ed0d            > std _off,x
000f =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
5e4e : 300f            >   leax _off,x
0000 =                 >_off=0
                       > endif
                        
                          mCombine d,WalkerBaseW-LegX,WalkerBaseH+WalkerLegH
5e50 : cc5060          >  ldd #(lo WalkerBaseW-LegX)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e53 : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e55 : ed84            > std _off,x
0002 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 0
                       > if 1=1
5e57 : 8600            >   lda #0
                       > endif
5e59 : a702            > sta _off,x
0003 =                 >_off=_off+1
                        
                          mWd WalkerBaseW-LegX,WalkerBaseH
                       > if 2=2
                       >   mCombine d,WalkerBaseW-LegX,WalkerBaseH
5e5b : cc5030          >  ldd #(lo WalkerBaseW-LegX)<<8 | (lo WalkerBaseH)
                       >
                       > endif
5e5e : ed03            > std _off,x
0005 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mCombine d,WalkerBaseW-LegX,WalkerBaseH+WalkerLegH
5e60 : cc5060          >  ldd #(lo WalkerBaseW-LegX)<<8 | (lo WalkerBaseH+WalkerLegH)
                        
5e63 : e0e4               subb LocalDist,s
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e65 : ed05            > std _off,x
0007 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
5e67 : 3166               leay LocalLines,s
5e69 : a661               lda LocalInt,s      ;intensity
5e6b : bd20ec             jsr ClipDraw
                        
                        
                          ;Neck and head are drawn separately
                        
                          ;This is needed because a single clipdraw call only handles x +- 128 and
                          ;total width of a walker is >128
                        
                          ;Head
5e6e : 3066               leax LocalLines,s
0002 =                  _off=2                  ;skip write result buffer, it's already valid
                        
5e70 : 108ec9c6           ldy #ZzapConfig
                        
5e74 : e6e4               ldb LocalDist,s       ;animate head Y
5e76 : cb04               addb #4
5e78 : e7e4               stb LocalDist,s
                        
5e7a : ec44               ldd weWalkerY,u       ;write top-left coords, offset x with BaseW, offset y with dist
5e7c : 830030             subd #WalkerHeight/2
5e7f : ebe4               addb LocalDist,s      ;add bounce
5e81 : cb06               addb #WalkerBaseH/8   ;add an offset from base top
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e83 : ed02            > std _off,x
0004 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
5e85 : eb27               addb zcHalfHeadH,y
5e87 : fdc9c0             std VisibleHeadY      ;also store visible head center coords for hittests
5e8a : ec42               ldd weWalkerX,u
5e8c : 83003a             subd #WalkerWidth/2
5e8f : c30054             addd #WalkerBaseW
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5e92 : ed04            > std _off,x
0006 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
5e94 : c30010             addd #HeadW/2
5e97 : fdc9be             std VisibleHeadX      ;also store visible head center coords for hittests
                        
                          ;Linecount for head
                          mWa 5
                       > if 1=1
5e9a : 8605            >   lda #5
                       > endif
5e9c : a706            > sta _off,x
0007 =                 >_off=_off+1
                        
                        
0007 =                  HeadSlopeH = 7
000e =                  HeadSlopeW = HeadSlopeH*2
                          mWa 1
                       > if 1=1
5e9e : 8601            >   lda #1
                       > endif
5ea0 : a707            > sta _off,x
0008 =                 >_off=_off+1
                        
                          mWd 0,0
                       > if 2=2
                       >   mCombine d,0,0
5ea2 : cc0000          >  ldd #(lo 0)<<8 | (lo 0)
                       >
                       > endif
5ea5 : ed08            > std _off,x
000a =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mWd HeadW-HeadSlopeW,0
                       > if 2=2
                       >   mCombine d,HeadW-HeadSlopeW,0
5ea7 : cc1200          >  ldd #(lo HeadW-HeadSlopeW)<<8 | (lo 0)
                       >
                       > endif
5eaa : ed0a            > std _off,x
000c =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 2
                       > if 1=1
5eac : 8602            >   lda #2
                       > endif
5eae : a70c            > sta _off,x
000d =                 >_off=_off+1
                        
5eb0 : 4f                 clra
5eb1 : e626               ldb zcHeadH,y
5eb3 : c007               subb #HeadSlopeH
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5eb5 : ed0d            > std _off,x
000f =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
5eb7 : 300f            >   leax _off,x
0000 =                 >_off=0
                       > endif
                        
                        
5eb9 : e626               ldb zcHeadH,y
5ebb : 860e               lda #HeadSlopeW
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5ebd : ed84            > std _off,x
0002 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 1
                       > if 1=1
5ebf : 8601            >   lda #1
                       > endif
5ec1 : a702            > sta _off,x
0003 =                 >_off=_off+1
                        
5ec3 : 860e               lda #HeadSlopeW
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5ec5 : ed03            > std _off,x
0005 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
5ec7 : 8620               lda #HeadW
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5ec9 : ed05            > std _off,x
0007 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 0
                       > if 1=1
5ecb : 8600            >   lda #0
                       > endif
5ecd : a707            > sta _off,x
0008 =                 >_off=_off+1
                        
5ecf : 8620               lda #HeadW
                          mWd
                       > if 0=2
                       >   mCombine d,,
                       > endif
5ed1 : ed08            > std _off,x
000a =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                          mWd HeadW,HeadSlopeH
                       > if 2=2
                       >   mCombine d,HeadW,HeadSlopeH
5ed3 : cc2007          >  ldd #(lo HeadW)<<8 | (lo HeadSlopeH)
                       >
                       > endif
5ed6 : ed0a            > std _off,x
000c =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
                          mWa 2
                       > if 1=1
5ed8 : 8602            >   lda #2
                       > endif
5eda : a70c            > sta _off,x
000d =                 >_off=_off+1
                        
                          mWd HeadW-HeadSlopeW,0
                       > if 2=2
                       >   mCombine d,HeadW-HeadSlopeW,0
5edc : cc1200          >  ldd #(lo HeadW-HeadSlopeW)<<8 | (lo 0)
                       >
                       > endif
5edf : ed0d            > std _off,x
000f =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
5ee1 : 300f            >   leax _off,x
0000 =                 >_off=0
                       > endif
                        
                          mWd HeadW,HeadSlopeH
                       > if 2=2
                       >   mCombine d,HeadW,HeadSlopeH
5ee3 : cc2007          >  ldd #(lo HeadW)<<8 | (lo HeadSlopeH)
                       >
                       > endif
5ee6 : ed84            > std _off,x
0002 =                 >_off=_off+2
                       > if _off>$e
                       >   ;Avoid extra byte for offsets>$f
                       >   ;Accumulate offset to x, reset offset
                       >   leax _off,x
                       >_off=0
                       > endif
                        
                        
5ee8 : 3166               leay LocalLines,s
5eea : a661               lda LocalInt,s      ;intensity
5eec : bd20ec             jsr ClipDraw
                        
5eef :                  dwExit:
                          mFreeLocals
5eef : 32e860          >  leas FrameSize,s
                        
5ef2 : 39                 rts
                        
                        
                        ;*****************
5ef3 :                  DrawBase:
                          mDecLocals 0,0,4
                       >  nolist
                        
                          ;DP must be D0
                          mSetIntensity $5f
                       >  if 1=1
5ef5 : 865f            >    lda   #$5f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
5ef7 : 9701            >  sta   <01
5ef9 : cc0401          >  ldd   #$0401
5efc : 9700            >  sta   <00
5efe : d700            >  stb   <00
                        
                        
                          ;Draw base
5f00 : 33e4               leau LocalBuffer,s
5f02 : cc2080             ldd #BaseX
5f05 : edc4               std ,u
5f07 : cc00d5             ldd #BaseY
5f0a : ed42               std 2,u
5f0c : 8e4c0f             ldx #SpriteStationaryPod
5f0f : bd2379             jsr DrawSprite
                        
                          ;Draw floor
5f12 : bec8c6             ldx ViewX
5f15 : 3004               leax 4,x
5f17 : 108e00df           ldy #WalkerFloorY
5f1b : bd078d             jsr FxGetScreenCoords
5f1e : 2714               beq dbFloorOffscreen
5f20 : ede4                 std LocalBuffer,s
5f22 : bdf354               jsr reset0ref
5f25 : ece4                 ldd LocalBuffer,s
5f27 : bdf2fc               jsr move_pen7f_to_d
                            ;scale $ff to draw full width
                            mSetScale $ff
                       >  if 1=1
5f2a : 86ff            >    lda #$ff                  ;if argument exists, load into a, otherwise use current a
                       >  endif
5f2c : 9704            >  sta <$04
                        
                            mCombine d,0,127
5f2e : cc007f          >  ldd #(lo 0)<<8 | (lo 127)
                        
5f31 : bdf3df               jsr draw_to_d
5f34 :                  dbFloorOffscreen:
                        
                          mFreeLocals
5f34 : 3264            >  leas FrameSize,s
                        
5f36 : 39                 rts
                        
                          include "Thrust_Title.asm"
                        ; Thrust title screen
                        ; Copyright (C) 2004  Ville Krumlinde
                        
                        mSine macro index,freq,amp,first
                         local ok
                         if first=1
                           ldx #SineTable
                         endif
                         ldb index
                         addb #freq
                         bpl ok
                           subb #128
                        ok:
                         stb index
                         ldb b,x
                         if amp>2
                           asrb
                         endif
                         if amp>1
                           asrb
                         endif
                         if amp>0
                           asrb
                         endif
                         if first=1
                           tfr b,a
                         else
                           stb -1,s
                           adda -1,s
                         endif
                         endm
                        
                        
                        ;*****************
5f37 :                  ShowTitleScreen:                ;dp=d0
                          mDecLocals 7,0,0
                       >  nolist
                        
0000 =                  LocalTextTimer = LocalB1
0001 =                  LocalTextInt = LocalB2
0002 =                  LocalMusicTimer = LocalB3
0003 =                  LocalVolumeTimer = LocalB4
0004 =                  LocalMode = LocalB5
0005 =                  LocalModeClock = LocalB6
0006 =                  LocalBonusGame = LocalB7
                        
5f39 :                  tiReset:
5f39 : bdf272             jsr clear_sound_chip
                        
5f3c : bd6dbf             jsr InitMusic
                        
5f3f : 866e               lda #110
5f41 : b7c8a0             sta TitleLogoY
                        
5f44 : 8664               lda #100
5f46 : a7e4               sta LocalTextTimer,s
5f48 : 4f                 clra
5f49 : a761               sta LocalTextInt,s
                        
5f4b : 8664               lda #100
5f4d : a762               sta LocalMusicTimer,s
                        
5f4f : 8664               lda #100
5f51 : a763               sta LocalVolumeTimer,s
                        
5f53 : 6f64               clr LocalMode,s
5f55 : 8696               lda #150
5f57 : a765               sta LocalModeClock,s
                        
                          ;test if bonusgame is enabled
5f59 : b6c881             lda BonusGameEnabled
5f5c : bbc86a             adda Cheat
5f5f : a766               sta LocalBonusGame,s
                        
5f61 :                  tiMain:
5f61 : bdf192             jsr waitrecal
                        
5f64 : 6d62               tst LocalMusicTimer,s
5f66 : 2704               beq tiGoMusic
5f68 : 6a62                 dec LocalMusicTimer,s
5f6a : 2003                 bra tiSkipMusic
5f6c :                  tiGoMusic:
5f6c : bd6e60             jsr UpdateMusic
5f6f :                  tiSkipMusic:
                        
5f6f : b6c826             lda LoopCounterLow
5f72 : 8401               anda #1
5f74 : 2702               beq tiNoDecClock
5f76 : 6a65                 dec LocalModeClock,s
5f78 :                  tiNoDecClock:
                        
5f78 : a664               lda LocalMode,s
5f7a : 273f               beq tiModeLogo        ;0
5f7c : 4a                 deca
5f7d : 272d               beq tiModeLevel       ;1
5f7f : 4a                 deca
5f80 : 2714               beq tiModeHighscores  ;2
                        
                          ;ModeCredits          ;3
5f82 : bd62d3             jsr DrawCreditsScroller
5f85 : fcc8a3             ldd ScrollTextPtr
5f88 : 108363ef           cmpd #CreditsTextEnd - Chars - 1
5f8c : 2606               bne tiKeepCreditsMode
                            ;Switch to logo + volume mode
5f8e : 6f64                 clr LocalMode,s
5f90 : 86fa                 lda #250
5f92 : a765                 sta LocalModeClock,s
5f94 :                  tiKeepCreditsMode:
5f94 : 207c               bra tiModeFin
                        
5f96 :                  tiModeHighscores:
                          ;Mode highscores
5f96 : bd60ce             jsr DisplayHighscores
5f99 : 6d65               tst LocalModeClock,s
5f9b : 2675               bne tiModeFin
                            ;Switch to credits mode
5f9d : 8603                 lda #3
5f9f : a764                 sta LocalMode,s
5fa1 : cc6343               ldd #CreditsText
5fa4 : fdc8a3               std ScrollTextPtr
5fa7 : 7fc8a2               clr ScrollInt
5faa : 2066                 bra tiModeFin
                        
5fac :                  tiModeLevel:
5fac : bd613b             jsr TitleDrawLevel
5faf : 6d65               tst LocalModeClock,s
5fb1 : 265f               bne tiModeFin
                            ;Switch mode to highscores
5fb3 : 6c64                 inc LocalMode,s
5fb5 : 86fa                 lda #250
5fb7 : a765                 sta LocalModeClock,s
5fb9 : 2057                 bra tiModeFin
                        
5fbb :                  tiModeLogo:
5fbb : 6d65               tst LocalModeClock,s
5fbd : 2645               bne tiKeepLogoMode
                            ;Switch to level mode
                            mDptoC8
5fbf : 86c8            >  lda   #0xC8
5fc1 : 1f8b            >  tfr   a,dp
                       >  direct $c8
                        
                        
5fc3 : 8601                 lda #1
5fc5 : bd296b               jsr InitNewGame     ;call init game, keep values for random and clock
                        
                            mRandomToA
5fc8 : bdf511          >  jsr random                    ;call rom
                        
5fcb : 8403                 anda #3
5fcd : 97d1                 sta CurLevel
5fcf : bd283e               jsr PrepareLevel
5fd2 : 8601                 lda #1
5fd4 : a764                 sta LocalMode,s
5fd6 : 86fa                 lda #250
5fd8 : a765                 sta LocalModeClock,s
                        
5fda : deca                 ldu CurLevelEntry ;center view around pod
5fdc : ec4a                 ldd leOrbY,u
5fde : 830080               subd #ScreenH / 2
5fe1 : 1093cf               cmpd CurLevelEndY
5fe4 : 2d03                 blt *+5
5fe6 : dccf                   ldd CurLevelEndY
5fe8 : ddc8                 std ViewY
5fea : ec48                 ldd leOrbX,u
5fec : 830080               subd #ScreenW / 2
5fef : cec8c6               ldu #ViewX
5ff2 : edc4                 std ,u
5ff4 : bd12a6               jsr ValidateX
                        
                            mSetByte NeedRefresh,1
                       > if 0=1
                       >   clr NeedRefresh
                       > else
5ff7 : 8601            >   lda #1
5ff9 : 97c5            >   sta NeedRefresh
                       > endif
                        
5ffb : bd2b19               jsr RefreshDrawList
                        
                            mDptoD0
5ffe : 86d0            >  lda   #0xD0
6000 : 1f8b            >  tfr   a,dp
                       >  direct -1
                        
                        
6002 : 200e                 bra tiModeFin
6004 :                  tiKeepLogoMode:
6004 : bd622f             jsr DrawTitleLogo
                        
6007 : 6d63               tst LocalVolumeTimer,s
6009 : 2605               bne tiVolumeNotYet
600b : bd61dc             jsr DrawTitleVolume
600e : 2002               bra tiVolumeFin
6010 :                  tiVolumeNotYet:
6010 : 6a63               dec LocalVolumeTimer,s
6012 :                  tiVolumeFin:
                        
6012 :                  tiModeFin:
                        
6012 : a6e4               lda LocalTextTimer,s
6014 : 2705               beq tiShowText
6016 : 4a                   deca
6017 : a7e4                 sta LocalTextTimer,s
6019 : 2039                 bra tiSkipText
601b :                  tiShowText
601b : 8e60c6               ldx #TitleStringsList
                        
601e : 5f                   clrb
601f : b6c825               lda LoopCounterHigh
6022 : 47                   asra
6023 : 59                   rolb
6024 : 6d66                 tst LocalBonusGame,s
6026 : 2705                 beq tiNoBonusText
6028 : b6c826               lda LoopCounterLow
602b : 48                   asla
602c : 59                   rolb
602d :                  tiNoBonusText:
602d : 58                   lslb
602e : ae85                 ldx b,x
                        
6030 : b6c826               lda LoopCounterLow
6033 : 44                   lsra
6034 : 44                   lsra
6035 : 108e6d3f             ldy #SineTable
6039 : a6a6                 lda a,y
603b : 47                   asra
603c : 47                   asra
603d : 47                   asra
603e : 8b8c                 adda #-116
                        
                        ;    lda #-116
6040 : e680                 ldb ,x+
6042 : 1f02                 tfr d,y
                        
                            mTicToc 32
6044 : b6c826          >  lda LoopCounterLow
6047 : 841f            >  anda #32-1
6049 : 8110            >  cmpa #32/2
604b : 2402            >  bcc l11564
604d : 881f            >  eora #32-1
604f :                 >l11564:
                        
604f : 48                   lsla
6050 : 48                   lsla
6051 : bd4ce5               jsr Text_Print_Intensity
                            ;Text_Print_Intensity:   ;x=string pointer, y screen coords, a intensity
6054 :                  tiSkipText:
                        
6054 : 860f               lda #1 + 2 + 4 + 8
6056 : bdf1b4             jsr read_switches
6059 : 8ec812             ldx #$C812
605c : 8601               lda #1
605e : 6d66               tst LocalBonusGame,s
6060 : 2701               beq *+3
6062 : 4c                   inca
6063 :                  tiNextButton:
6063 : 6d86               tst a,x
6065 : 260d               bne tiExit
6067 : 4a                 deca
6068 : 2af9               bpl tiNextButton
                        
606a : b6c87a             lda GameMode  ;test if music has set demogame (music end)
606d : 8104               cmpa #DemoGame
606f : 2734               beq tiFin
                        
6071 : 7e5f61             bra tiMain
                        
6074 :                  tiExit:
                        
                          ;Exit with key pressed in A (0=button1 etc)
                        
                          ;need to clear soundworks-buffer because updatesound is called from
                          ;textwait, and that memory may have been written by music
6074 : 3402               pshs a
6076 : 8ec8e5             ldx #LevelClearLabel
6079 : bdf545             jsr clear_256_bytes
607c : 3502               puls a
                        
607e : 8101               cmpa #1
6080 : 260d               bne tiNoOptions
6082 : bd615b               jsr OptionsMenu
6085 : b6c87a               lda GameMode
6088 : 8104                 cmpa #DemoGame
608a : 2719                 beq tiFin
608c : 7e5f39               bra tiReset
608f :                  tiNoOptions:
                        
608f : 8102               cmpa #2
6091 : 2606               bne tiNoBonusGame
6093 : bd5533               jsr Zzap_Start
6096 : 7e5f39               bra tiReset
6099 :                  tiNoBonusGame
                        
6099 : bd5394             jsr Text_ShowGameMenu
609c : c103               cmpb #3
609e : 1027fe97           beq tiReset
60a2 : f7c87a             stb GameMode          ;Menu return selected GameMode
                        
60a5 :                  tiFin:
                        
                          mFreeLocals
60a5 : 3267            >  leas FrameSize,s
                        
60a7 : 39                 rts
                        
60a8 : e0313a20535441.. TitleString1: db -32,'1: START',$80
60b2 : d8323a204f5054.. TitleString2: db -40,'2: OPTIONS',$80
60be : e8333a205a534280 TitleString3: db -24,'3: ZSB',$80
60c6 :                  TitleStringsList:
60c6 : 60a860b260be60be   dw TitleString1,TitleString2,TitleString3,TitleString3
                        
                        
                        ;*****************
60ce :                  DisplayHighscores:
                        ;   text_write med fixed list
                        ;   text_write med scores
                        ;
                        ;   stackspace
                        ;   x+y sine offset
                        ;
                        ;   display 'highscores'
                        ;   x=gamemodestringlist
                        ;   u=highscorelist
                        ;   get start sineoffset
                        ;   loop gamemodes
                        ;     copy to stack gamemodestring + highscore + extra '0'
                        ;     calc x,y with sineoffset
                        ;     call displaystring
                        ;     inc sineoffset
                        ;   set viewy till -255
                        ;   call drawstars
                        ;
                        ; Stars and 'highscore' string causes framedrop and slows the music down...
                        ; Skip them for now.
                        ;
                          mDecLocals 4,2,11 + 1 + HighscoreEntry + 1
                       >  nolist
                        
0002 =                  LocalSineY = LocalB3
0003 =                  LocalSineX = LocalB4
                        
                        ;  ldx #HighscoreString
                        ;  mCombine d,80,-40
                        ;  jsr Text_Print
                        
60d1 : 8e522b             ldx #GameModeStringList
60d4 : cec882             ldu #Highscores
60d7 : 8628               lda #40
60d9 : a761               sta LocalB2,s
60db : 8603               lda #3
60dd : a7e4               sta LocalB1,s
60df : b6c826             lda LoopCounterLow
60e2 : a762               sta LocalSineY,s
60e4 : bbc825             adda LoopCounterHigh
60e7 : 8b1e               adda #30
60e9 : a763               sta LocalSineX,s
60eb :                  dhsLoop:
60eb : af64               stx LocalW1,s
60ed : ef66               stu LocalW2,s
                        
60ef : ae84               ldx ,x
60f1 : 3368               leau LocalBuffer,s
60f3 : bdf8de             jsr Text_CopyString
60f6 : ae66               ldx LocalW2,s
60f8 : c680               ldb #$80
60fa : bd1abb             jsr CopyScoreFromXtoU
                        ;  jsr Text_CopyString
                        
60fd : 3068               leax LocalBuffer,s
60ff : 8620               lda #' '
6101 : a70b               sta 11,x
                        ;  mCombine d,'0',$80
                        ;  std 18,x
                        
6103 : ce6d3f             ldu #SineTable
6106 : a662               lda LocalSineY,s
6108 : 44                 lsra
6109 : a6c6               lda a,u
610b : 47                 asra
610c : ab61               adda LocalB2,s
                        
610e : e663               ldb LocalSineX,s
6110 : 54                 lsrb
6111 : e6c5               ldb b,u
6113 : 57                 asrb
6114 : cbc4               addb #-60
6116 : bd4cba             jsr Text_Print
                        
6119 : a661               lda LocalB2,s ;move y
611b : 801e               suba #30
611d : a761               sta LocalB2,s
                        
611f : a662               lda LocalSineY,s
6121 : 8b0a               adda #10
6123 : a762               sta LocalSineY,s
                        
6125 : a663               lda LocalSineX,s
6127 : 8b11               adda #17
6129 : a763               sta LocalSineX,s
                        
612b : ae64               ldx LocalW1,s
612d : ee66               ldu LocalW2,s
612f : 3002               leax 2,x
6131 : 3347               leau HighscoreEntry,u
                        
6133 : 6ae4               dec LocalB1,s
6135 : 26b4               bne dhsLoop
                        
                        ;  ldd #-255
                        ;  std ViewY
                        ;  jsr DrawStars
                        
                          mFreeLocals
6137 : 32e81c          >  leas FrameSize,s
                        
613a : 39                 rts
                        ;HighscoreString: db 'HIGHSCORES',$80
                        
                        ;*****************
613b :                  TitleDrawLevel:
613b : bd2a7b             jsr DrawLevel
613e : bd1dfb             jsr DrawFuel
6141 : bd1f0d             jsr DrawGuns
6144 : bd1e29             jsr DrawOrb
6147 : 7e1e47             jmp DrawPowerplant
                        
                        ;*****************
614a :                  DemoMenu:               ;returns with Z set, and GameMode=DemoGame if exit
                          direct $d0
                        
614a : bd5293             jsr Text_ShowDemoMenu
614d : c103               cmpb #3
614f : 2709               beq dmExit
                        
6151 : 8604               lda #DemoGame
6153 : b7c87a             sta GameMode
                        
6156 : f7c86c             stb DemoSelected
6159 : 53                 comb
                        
615a :                  dmExit:
                          direct -1
615a : 39                 rts
                        
                        ;*****************
615b :                  OptionsMenu:
                        
615b : bd52e5             jsr Text_ShowOptionsMenu
                        
615e : 5d                 tstb
615f : 2604               bne omNoControls
6161 : 8d55                 bsr ControlsMenu
6163 : 202a                 bra omExit
6165 :                  omNoControls:
                        
6165 : 5a                 decb
6166 : 2604               bne omNoDemo
6168 : 8de0                 bsr DemoMenu
616a : 2023                 bra omExit
616c :                  omNoDemo:
                        
616c : 5a                decb
616d : 260c              bne omNoResetHi
616f : bd54d3              jsr Text_ShowResetMenu
6172 : c101                cmpb #1
6174 : 2619                bne omExit
6176 : bd7ec5                jsr eeprom_format
6179 : 2014                bra omExit
617b :                  omNoResetHi:
                        
617b : 5a                decb
617c : 2611              bne omNoCheat
                           ;Hidden cheat menu
617e : bdf1f8              jsr read_joystick
6181 : 7dc81c              tst $c81c
6184 : 2a09                bpl omNoCheat
                           mEmitSound WarpInSoundId
                       >  if 1=1
6186 : 8629            >    lda #WarpInSoundId
                       >  endif
6188 : bd0477          >  jsr EmitSound
                        
618b : 8d03                bsr CheatMenu
618d : 2000                bra omExit
618f :                  omNoCheat:
                        
618f :                  omExit:
618f : 39                 rts
                        
                        ;*****************
6190 :                  CheatMenu:
6190 :                  cmShow:
6190 : bd533c             jsr Text_ShowCheatMenu
                        
6193 : 5d                 tstb
6194 : 260a               bne cmNoLives
6196 : 73c86a               com CheatLives
                            mEmitSound ShipFireSoundId
                       >  if 1=1
6199 : 860c            >    lda #ShipFireSoundId
                       >  endif
619b : bd0477          >  jsr EmitSound
                        
619e : 20f0                 bra cmShow
61a0 :                  cmNoLives:
                        
61a0 : 5a                 decb
61a1 : 2614               bne cmNoLevel
61a3 : b6c86b               lda CheatLevel
61a6 : 8117                 cmpa #(LevelCountNormal*4)-1
61a8 : 2602                 bne cmIncLevel
61aa : 86ff                   lda #-1
61ac :                  cmIncLevel:
61ac : 4c                   inca
61ad : b7c86b               sta CheatLevel
                            mEmitSound GunFireSoundId
                       >  if 1=1
61b0 : 8608            >    lda #GunFireSoundId
                       >  endif
61b2 : bd0477          >  jsr EmitSound
                        
61b5 : 20d9                 bra cmShow
61b7 :                  cmNoLevel
                        
61b7 : 39                 rts
                        
                        ;*****************
61b8 :                  ControlsMenu:
                          mDecLocals 2,0,0
                       >  nolist
                        
                          direct $d0
                        
61ba : 4f                 clra
61bb : a7e4               sta LocalB1,s
61bd : a761               sta LocalB2,s
61bf :                  cmLoop:
61bf : bd5468             jsr Text_ShowControlMenu
61c2 : a6e4               lda LocalB1,s
61c4 : 48                 lsla
61c5 : 48                 lsla
61c6 : e77f               stb -1,s
61c8 : aa7f               ora -1,s
61ca : a7e4               sta LocalB1,s
61cc : 6c61               inc LocalB2,s
61ce : a661               lda LocalB2,s
61d0 : 8104               cmpa #4
61d2 : 26eb               bne cmLoop
                        
61d4 : a6e4               lda LocalB1,s
61d6 : b7c880             sta ButtonConfig
                        
                          direct -1
                          mFreeLocals
61d9 : 3262            >  leas FrameSize,s
                        
61db : 39                 rts
                        
                        
                        ;*****************
61dc :                  DrawTitleVolume:
                          mDecLocals 3,1,(ShipVectorCount*2)
                       >  nolist
                        
0001 =                  LocalX = LocalB2
0002 =                  LocalMod = LocalB3
0003 =                  LocalVol = LocalW1
                        
61df : 8681               lda #-127  ;start x
61e1 : a761               sta LocalX,s
                        
61e3 : 8ec800             ldx #$c800 + 0
61e6 : af63               stx LocalVol,s
                        
61e8 : 8603               lda #3
61ea : a7e4               sta LocalB1,s
61ec :                  dtvLoop:
61ec : 10ae63             ldy LocalVol,s
61ef : a6a0               lda ,y+  ;fine (lo)
61f1 : e6a0               ldb ,y+  ;course (hi)
61f3 : 44                 lsra
61f4 : 44                 lsra
61f5 : 44                 lsra
61f6 : 44                 lsra
61f7 : 10af63             sty LocalVol,s
61fa : a762               sta LocalMod,s
                        
61fc : bdf354             jsr reset0ref                 ;Reset pen
                        
                          mSetScale 16
                       >  if 1=1
61ff : 8610            >    lda #16                  ;if argument exists, load into a, otherwise use current a
                       >  endif
6201 : 9704            >  sta <$04
                        
6203 : e661               ldb LocalX,s
6205 : 8681               lda #-127 ;y
                        ;  mMove_pen_d
6207 : bdf312             jsr move_pen_d
                        ;  mMove_pen_d_Quick
                        ;  jsr move_pen7f_to_d           ;Set pen position to value of d register
                        
                          mSetIntensity $4f
                       >  if 1=1
620a : 864f            >    lda   #$4f            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
620c : 9701            >  sta   <01
620e : cc0401          >  ldd   #$0401
6211 : 9700            >  sta   <00
6213 : d700            >  stb   <00
                        
                        
6215 : 8e4b60             ldx #ShipVectorList
6218 : 8609               lda   #ShipVectorCount-1      ;Nr of vectors in list
621a : c608               ldb   #8                      ;Scale
621c : eb62               addb LocalMod,s
621e : bdf3b7             jsr   move_draw_VL4           ;Draw list
                        
6221 : a661               lda LocalX,s
6223 : 8b7f               adda #127
6225 : a761               sta LocalX,s
                        
6227 : 6ae4               dec LocalB1,s
6229 : 26c1               bne dtvLoop
                        
                          mFreeLocals
622b : 32e819          >  leas FrameSize,s
                        
622e : 39                 rts
                        
                        
                        ;*****************
622f :                  DrawTitleLogo:
                        ;   att testa
                        ;     gör verktyg som genererar kod ifrån bmp
                        ;       mPattern, mRow
                        ;       PacmanLines: dw Pacman_DrawLine01,Pacman_DrawLine02
                        ;       subs anropas av generell drawrutin
                        ;       generar intensity change vid behov
                        ;     dela upp line i två horizontella, då kan scale $7f användas
                        ;     kan man bumpa upp x-length innan den är klar? då blir det inget glapp.
                        ;
                        ;     läs igenom "SHIFT REGISTER OPERATION" i vectrex.txt
                        ;     skriv $18 till 0B för att stänga av andra interrupt
                        ;     se rom DISPLAY_STRING
                          mDecLocals 2,1,0
                       >  nolist
                        
0008 =                  LocalLine=8             ;
001c =                  LocalH=28               ;these were local, but changed to constants to save some code size
0001 =                  LocalRepeat = LocalB2
0002 =                  LocalBitmap = LocalW1
                        
6231 : 8e6cb8             ldx #TitleBitmap
                        
6234 : a680               lda ,x+               ;load repeat
6236 : a761               sta LocalRepeat,s
                        
6238 : af62               stx LocalBitmap,s
                        
623a : 4f                 clra                  ;for a=0 to height-1
623b :                  dbiLoop:
623b : a7e4               sta LocalB1,s
                        
                          ;Set intensity
                          ;lda #$60
                          ;Increase/decrease intensity for this line
623d : b6c826             lda LoopCounterLow
6240 : 2a01               bpl dbiIntOk
6242 : 40                 nega
6243 :                  dbiIntOk:
6243 : e6e4               ldb LocalB1,s         ;öka varannan rad, minska varannan
6245 : c501               bitb #1
6247 : 2706               beq dbiInt1
6249 : a0e4                 suba LocalB1,s
624b : a0e4                 suba LocalB1,s
624d : 2002                 bra dbiIntSet
624f :                  dbiInt1:
624f : abe4                 adda LocalB1,s
6251 :                  dbiIntSet:
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
6251 : 9701            >  sta   <01
6253 : cc0401          >  ldd   #$0401
6256 : 9700            >  sta   <00
6258 : d700            >  stb   <00
                        
                        
625a : bdf354             jsr reset0ref
                        
625d : 8602               lda #2                ;loop twice
625f : a77f               sta -1,s
                        
                          ;Scale 64 for positioning, otherwise y skips every other line
                          mSetScale 64
                       >  if 1=1
6261 : 8640            >    lda #64                  ;if argument exists, load into a, otherwise use current a
                       >  endif
6263 : 9704            >  sta <$04
                        
                        
6265 : c681               ldb #-127
6267 : 860e               lda #LocalH/2          ;set y to vertical center
6269 : a0e4               suba LocalB1,s
626b : bbc8a0             adda TitleLogoY
                        
626e :                  dbiMoveLine:
                          mMove_pen_d_Quick
626e : 9701            >  sta   <0x01
6270 : 0f00            >  clr   <0x00
6272 : 86ce            >  lda   #0xCE
6274 : 970c            >  sta   <0x0C
6276 : 0f0a            >  clr   <0x0A
6278 : 0c00            >  inc   <0x00
627a : d701            >  stb   <0x01
627c : 0f05            >  clr   <0x05
627e : c640            >  ldb   #0x40
6280 : d50d            >PF33D1628: bitb  <0x0D
6282 : 27fc            >  beq   PF33D1628
                       >;PF33B1628: lda   #0x04
                       >;PF3411628: deca
                       >;  bne   PF3411628
                        
                          ;to reach left edge, another x move is needed. loop to avoid inlining twice.
                          mCombine d,0,-24
6284 : cc00e8          >  ldd #(lo 0)<<8 | (lo -24)
                        
6287 : 6a7f               dec -1,s
6289 : 26e3               bne dbiMoveLine
                        
                          ;Max scale for drawing
                          mSetScale 255
                       >  if 1=1
628b : 86ff            >    lda #255                  ;if argument exists, load into a, otherwise use current a
                       >  endif
628d : 9704            >  sta <$04
                        
                        
                        
628f : ae62               ldx LocalBitmap,s
                        
6291 : 867f               lda #127              ;line length
6293 : 1f89               tfr a,b               ;init hw for line drawing
6295 : 4f                 clra
6296 : 9701               sta   <0x01
6298 : 0f00               clr   <0x00
629a : 0c00               inc   <0x00
629c : d701               stb   <0x01
629e : 0f05               clr   <0x05
                        
                          ;rom inner loop
                        ;37c0 :    PF4C7:
                        ;37c0 : a686             [ 5]   lda   a,x
                        ;37c2 : 970a             [ 4]   sta   <0x0A
                        ;37c4 : a6c0             [ 6]   lda   ,u+
                        ;37c6 : 2af8             [ 3]   bpl   PF4C7
                        ;Total 18 cycles
                        
62a0 : c608               ldb #LocalLine
62a2 :                  dbiLineLoop:
62a2 : a680               lda ,x+    ;6
62a4 : 970a               sta <0x0A  ;4
62a6 : 1a00               orcc #0 ;3
62a8 : 5a                 decb ;2
62a9 : 26f7               bne dbiLineLoop  ;3
                        
62ab : 12                 nop 1                         ;wait for the last pattern in line to appear before clearing
                        
62ac : 0f0a               clr <0x0a                     ;clear pattern
                        
                        ;No need to wait, line is drawn
                        ;**todo: keep this delay if possible, MESS cannot display logo otherwise
                        ;  ldb   #0x40                   ;wait timer finish
                        ;dbiWait
                        ;  bitb  <$0D
                        ;  beq   dbiWait
                        
                        
62ae : ae62               ldx LocalBitmap,s             ;next row
62b0 : 6a61               dec LocalRepeat,s
62b2 : 2606               bne dbiKeepRepeating
62b4 : 3008                 leax LocalLine,x
62b6 : a680                 lda ,x+
62b8 : a761                 sta LocalRepeat,s
62ba :                  dbiKeepRepeating:
62ba : af62               stx LocalBitmap,s
                        
62bc : a6e4               lda LocalB1,s
62be : 4c                 inca
62bf : 811c               cmpa #LocalH
62c1 : 1026ff76           bne dbiLoop
                        
62c5 : b6c8a0             lda TitleLogoY                ;move logo down
62c8 : 8114               cmpa #20
62ca : 2704               beq dbiNoAdjustY
62cc : 4a                   deca
62cd : b7c8a0               sta TitleLogoY
62d0 :                  dbiNoAdjustY:
                        
                          mFreeLocals
62d0 : 3264            >  leas FrameSize,s
                        
62d2 : 39                 rts
                        
                        
                        
                        
                        ;   custom typsnitt där varje bokstav är två tecken (=16 pixels)
                        ;   scrolla pixels genom att flytta x och maska första/sista pattern byte
                        ;
                        ;   skapa sträng på stacken
                        ;     skriv start and-mask
                        ;     get char
                        ;     konvertera till två tecken
                        ;       eller ett tecken två pekare
                        ;       x=fonttable1, y=fonttable2
                        ;       om loopcounterlow 8..15
                        ;         börja med y öka 1, x sen y sen öka 1, sluta med x
                        ;       0..7
                        ;         x sen y sen öka 1
                        ;       börja med vanlig loop, dista x 0..15
                        ;       gör hela draw till macro, anropa två ggr olika konfad
                        ;     skriv till stack
                        ;     ev loopa text
                        ;     skriv slut and-mask
                        ;   display_rom
                        ;     unroll char-loop
                        ;     gör till macro och anropa så många ggr som antal samtidigt synliga tecken
                        ;
                        ;   hämta fatfont.dat
                        ;     räkna hur många tecken den innehåller
                        ;     writebyte(char,value)
                        
                        ;*****************
62d3 :                  DrawCreditsScroller:
0010 =                  Chars = 16  ;Chars visible at the same time
                          mDecLocals 1,0,Chars
                       >  nolist
                        
                        
62d6 : b6c826             lda LoopCounterLow
62d9 : 8403               anda #3
62db : 2608               bne dcsNoNewChar
62dd : bec8a3               ldx ScrollTextPtr
62e0 : 3001                 leax 1,x
                        ;    cmpx #CreditsTextEnd - Chars
                        ;    bne dcsNoWrap
                        ;      ldx #CreditsText
                        ;dcsNoWrap:
62e2 : bfc8a3               stx ScrollTextPtr
62e5 :                  dcsNoNewChar:
62e5 : 48                 lsla
62e6 : 48                 lsla
62e7 : a7e4               sta LocalB1,s
                        
                          ;FC = one space line, FB = one every 4 lines, FD = no space
62e9 : ccfa38             ldd   #0xFA38
62ec : fdc82a             std   $C82A           ;Specify height and width
62ef : bdf354             jsr reset0ref
                          mSetScale $7f
                       >  if 1=1
62f2 : 867f            >    lda #$7f                  ;if argument exists, load into a, otherwise use current a
                       >  endif
62f4 : 9704            >  sta <$04
                        
                        
62f6 : b6c8a2             lda ScrollInt
62f9 : 817f               cmpa #$7f
62fb : 2704               beq dcsNoIncInt
62fd : 4c                   inca
62fe : b7c8a2               sta ScrollInt
6301 :                  dcsNoIncInt:
                          mSetIntensity
                       >  if 0=1
                       >    lda   #            ;if argument exists, load into a, otherwise use current a
                       >  endif
                       >  if false
                       >    sta   <01
                       >    ;sta   $C827
                       >    ldd   #$0504
                       >    sta   <00
                       >    stb   <00
                       >    stb   <00
                       >    ldb   #01
                       >    stb   <00
                       >  endif
6301 : 9701            >  sta   <01
6303 : cc0401          >  ldd   #$0401
6306 : 9700            >  sta   <00
6308 : d700            >  stb   <00
                        
                        
                          ;index,freq,amp,first
                          mSine SineIndex1,2,1,1
                       > if 1=1
630a : 8e6d3f          >   ldx #SineTable
                       > endif
630d : f6c8a5          > ldb SineIndex1
6310 : cb02            > addb #2
6312 : 2a02            > bpl ok1647
6314 : c080            >   subb #128
6316 :                 >ok1647:
6316 : f7c8a5          > stb SineIndex1
6319 : e685            > ldb b,x
                       > if 1>2
                       >   asrb
                       > endif
                       > if 1>1
                       >   asrb
                       > endif
                       > if 1>0
631b : 57              >   asrb
                       > endif
                       > if 1=1
631c : 1f98            >   tfr b,a
                       > else
                       >   stb -1,s
                       >   adda -1,s
                       > endif
                        
                          mSine SineIndex2,1,2,0
                       > if 0=1
                       >   ldx #SineTable
                       > endif
631e : f6c8a6          > ldb SineIndex2
6321 : cb01            > addb #1
6323 : 2a02            > bpl ok1648
6325 : c080            >   subb #128
6327 :                 >ok1648:
6327 : f7c8a6          > stb SineIndex2
632a : e685            > ldb b,x
                       > if 2>2
                       >   asrb
                       > endif
                       > if 2>1
632c : 57              >   asrb
                       > endif
                       > if 2>0
632d : 57              >   asrb
                       > endif
                       > if 0=1
                       >   tfr b,a
                       > else
632e : e77f            >   stb -1,s
6330 : ab7f            >   adda -1,s
                       > endif
                        
                        
6332 : c691               ldb #-127 + 16
                        
6334 : e0e4               subb LocalB1,s
6336 : bdf312             jsr move_pen_d
                        
6339 : fec8a3             ldu ScrollTextPtr
633c : bd6400             jsr Credits_Draw_display_string
                        
                          mFreeLocals
633f : 32e811          >  leas FrameSize,s
                        
6342 : 39                 rts
                        
                        
                        
                        
6343 :                  CreditsText:
6343 : 20202020202020..   db '                VECTREX THRUST BY VILLE KRUMLINDE 2004. MUSIC BY ROB HUBBARD. ORIGINAL C64 THRUST BY JEREMY C SMITH 1985. THIS GAME IS FREEWARE. VISIT WWW.ELDEAN.SE/VECT
6400 :                  CreditsTextEnd:
                        
                        ;Copied from ROM: display_string
                        ;Modified to draw 16*16 pixel font
6400 :                  Credits_Draw_display_string:
6400 : ffc82c                  stu   $C82C     ;/* Save pointer to start of string. */
                        
                        ;       ldx   #0xF9D4
6403 : 8e6554            ldx #FontTable1-32
6406 : 108e68f6          ldy #FontTable2-32
                        
640a : cc1883                  ldd   #0x1883
640d : 0f01                    clr   <0x01
640f : 970b                    sta   <0x0B
                        ;       ldx   #0xF9D4
6411 : 1a00               orcc #0  ;wait 3 cycles
6413 : d700             PF4A5: stb   <0x00
6415 : 0a00                    dec   <0x00
6417 : cc8081                  ldd   #0x8081
641a : 12                      nop
641b : 0c00                    inc   <0x00
641d : d700                    stb   <0x00
641f : 9700                    sta   <0x00
6421 : 7dc800                  tst   $C800
6424 : 0c00                    inc   <0x00
6426 : b6c82b                  lda   $C82B    ;/* Get the string width. */
6429 : 9701                    sta   <0x01
642b : cc0100                  ldd   #0x0100
642e : fec82c                  ldu   $C82C
6431 : 9700                    sta   <0x00
                        
                        
                        ;[ 3]        bra   PF4CB
                        ;[ 5] PF4C7: lda   a,x
                        ;[ 4]        sta   <0x0A
                        ;[ 6] PF4CB: lda   ,u+
                        ;[ 3]        bpl   PF4C7
                        
6433 : 1a00               orcc #0  ;wait 3 cycles
                        
                        _m macro
                          lda   ,u+
                          orcc #0  ;wait 3 cycles
                          ldb   a,x
                          stb   <0x0A
                          orcc #0  ;wait 3 cycles
                          tst ,x   ;wait 6 cycles
                          ldb   a,y
                          stb   <0x0A
                         endm
                        
                        ;**todo behövs unroll? om inte, byt tillbaka till loop
                        
                         _m
6435 : a6c0            >  lda   ,u+
6437 : 1a00            >  orcc #0  ;wait 3 cycles
6439 : e686            >  ldb   a,x
643b : d70a            >  stb   <0x0A
643d : 1a00            >  orcc #0  ;wait 3 cycles
643f : 6d84            >  tst ,x   ;wait 6 cycles
6441 : e6a6            >  ldb   a,y
6443 : d70a            >  stb   <0x0A
                        
                         _m
6445 : a6c0            >  lda   ,u+
6447 : 1a00            >  orcc #0  ;wait 3 cycles
6449 : e686            >  ldb   a,x
644b : d70a            >  stb   <0x0A
644d : 1a00            >  orcc #0  ;wait 3 cycles
644f : 6d84            >  tst ,x   ;wait 6 cycles
6451 : e6a6            >  ldb   a,y
6453 : d70a            >  stb   <0x0A
                        
                         _m
6455 : a6c0            >  lda   ,u+
6457 : 1a00            >  orcc #0  ;wait 3 cycles
6459 : e686            >  ldb   a,x
645b : d70a            >  stb   <0x0A
645d : 1a00            >  orcc #0  ;wait 3 cycles
645f : 6d84            >  tst ,x   ;wait 6 cycles
6461 : e6a6            >  ldb   a,y
6463 : d70a            >  stb   <0x0A
                        
                         _m
6465 : a6c0            >  lda   ,u+
6467 : 1a00            >  orcc #0  ;wait 3 cycles
6469 : e686            >  ldb   a,x
646b : d70a            >  stb   <0x0A
646d : 1a00            >  orcc #0  ;wait 3 cycles
646f : 6d84            >  tst ,x   ;wait 6 cycles
6471 : e6a6            >  ldb   a,y
6473 : d70a            >  stb   <0x0A
                        
                         _m
6475 : a6c0            >  lda   ,u+
6477 : 1a00            >  orcc #0  ;wait 3 cycles
6479 : e686            >  ldb   a,x
647b : d70a            >  stb   <0x0A
647d : 1a00            >  orcc #0  ;wait 3 cycles
647f : 6d84            >  tst ,x   ;wait 6 cycles
6481 : e6a6            >  ldb   a,y
6483 : d70a            >  stb   <0x0A
                        
                         _m
6485 : a6c0            >  lda   ,u+
6487 : 1a00            >  orcc #0  ;wait 3 cycles
6489 : e686            >  ldb   a,x
648b : d70a            >  stb   <0x0A
648d : 1a00            >  orcc #0  ;wait 3 cycles
648f : 6d84            >  tst ,x   ;wait 6 cycles
6491 : e6a6            >  ldb   a,y
6493 : d70a            >  stb   <0x0A
                        
                         _m
6495 : a6c0            >  lda   ,u+
6497 : 1a00            >  orcc #0  ;wait 3 cycles
6499 : e686            >  ldb   a,x
649b : d70a            >  stb   <0x0A
649d : 1a00            >  orcc #0  ;wait 3 cycles
649f : 6d84            >  tst ,x   ;wait 6 cycles
64a1 : e6a6            >  ldb   a,y
64a3 : d70a            >  stb   <0x0A
                        
                         _m
64a5 : a6c0            >  lda   ,u+
64a7 : 1a00            >  orcc #0  ;wait 3 cycles
64a9 : e686            >  ldb   a,x
64ab : d70a            >  stb   <0x0A
64ad : 1a00            >  orcc #0  ;wait 3 cycles
64af : 6d84            >  tst ,x   ;wait 6 cycles
64b1 : e6a6            >  ldb   a,y
64b3 : d70a            >  stb   <0x0A
                        
                        
                         _m
64b5 : a6c0            >  lda   ,u+
64b7 : 1a00            >  orcc #0  ;wait 3 cycles
64b9 : e686            >  ldb   a,x
64bb : d70a            >  stb   <0x0A
64bd : 1a00            >  orcc #0  ;wait 3 cycles
64bf : 6d84            >  tst ,x   ;wait 6 cycles
64c1 : e6a6            >  ldb   a,y
64c3 : d70a            >  stb   <0x0A
                        
                         _m
64c5 : a6c0            >  lda   ,u+
64c7 : 1a00            >  orcc #0  ;wait 3 cycles
64c9 : e686            >  ldb   a,x
64cb : d70a            >  stb   <0x0A
64cd : 1a00            >  orcc #0  ;wait 3 cycles
64cf : 6d84            >  tst ,x   ;wait 6 cycles
64d1 : e6a6            >  ldb   a,y
64d3 : d70a            >  stb   <0x0A
                        
                         _m
64d5 : a6c0            >  lda   ,u+
64d7 : 1a00            >  orcc #0  ;wait 3 cycles
64d9 : e686            >  ldb   a,x
64db : d70a            >  stb   <0x0A
64dd : 1a00            >  orcc #0  ;wait 3 cycles
64df : 6d84            >  tst ,x   ;wait 6 cycles
64e1 : e6a6            >  ldb   a,y
64e3 : d70a            >  stb   <0x0A
                        
                         _m
64e5 : a6c0            >  lda   ,u+
64e7 : 1a00            >  orcc #0  ;wait 3 cycles
64e9 : e686            >  ldb   a,x
64eb : d70a            >  stb   <0x0A
64ed : 1a00            >  orcc #0  ;wait 3 cycles
64ef : 6d84            >  tst ,x   ;wait 6 cycles
64f1 : e6a6            >  ldb   a,y
64f3 : d70a            >  stb   <0x0A
                        
                         _m
64f5 : a6c0            >  lda   ,u+
64f7 : 1a00            >  orcc #0  ;wait 3 cycles
64f9 : e686            >  ldb   a,x
64fb : d70a            >  stb   <0x0A
64fd : 1a00            >  orcc #0  ;wait 3 cycles
64ff : 6d84            >  tst ,x   ;wait 6 cycles
6501 : e6a6            >  ldb   a,y
6503 : d70a            >  stb   <0x0A
                        
                         _m
6505 : a6c0            >  lda   ,u+
6507 : 1a00            >  orcc #0  ;wait 3 cycles
6509 : e686            >  ldb   a,x
650b : d70a            >  stb   <0x0A
650d : 1a00            >  orcc #0  ;wait 3 cycles
650f : 6d84            >  tst ,x   ;wait 6 cycles
6511 : e6a6            >  ldb   a,y
6513 : d70a            >  stb   <0x0A
                        
                         _m
6515 : a6c0            >  lda   ,u+
6517 : 1a00            >  orcc #0  ;wait 3 cycles
6519 : e686            >  ldb   a,x
651b : d70a            >  stb   <0x0A
651d : 1a00            >  orcc #0  ;wait 3 cycles
651f : 6d84            >  tst ,x   ;wait 6 cycles
6521 : e6a6            >  ldb   a,y
6523 : d70a            >  stb   <0x0A
                        
                        
6525 : a6c0               lda ,u+       ;6 cycles, increase u to printed chars + 1
6527 : 1a00               orcc #0  ;wait 3 cycles
                        
6529 : 8681                    lda   #0x81
652b : 9700                    sta   <0x00
652d : 0001                    neg   <0x01
652f : 8601                    lda   #0x01
6531 : 9700                    sta   <0x00
                        
                        ;       cmpx  #0xFBB4  ;/* If not at end of char table, then */
6533 : 8c68b8             cmpx #(FontTable1-32) + (14*62)
6536 : 2737                    beq   PF50A    ;/* proceed to next row of pixels.    */
                        
                        ;       leax  0x50,x     ;add to font definition pointer, $50=one row
6538 : 30883e             leax 62,x
653b : 31a83e             leay 62,y
                        
653e : 1f30                    tfr   u,d
6540 : b3c82c                  subd  $C82C    ;/* Point back to first character. */
6543 : c002                    subb  #0x02      ;waitloop, depending on string length
6545 : 58                      aslb
                          ;wait*2 because we now use width*2 font
6546 : 58                 aslb
6547 : 121212121212       nop 6
654d : 2100                    brn   PF4EB
654f : 8681             PF4EB: lda   #0x81
6551 : 12                      nop
6552 : 5a                      decb
6553 : 26fa                    bne   PF4EB
                        
6555 : 9700                    sta   <0x00
6557 : f6c82a                  ldb   $C82A      ;height
655a : d701                    stb   <0x01
655c : 0a00                    dec   <0x00
                        
655e : cc8101                  ldd   #0x8101
6561 : 12                      nop
6562 : 9700                    sta   <0x00
6564 : 0f01                    clr   <0x01
6566 : d700                    stb   <0x00
6568 : 9700                    sta   <0x00
656a : c603                    ldb   #0x03
656c : 7e6413                  bra   PF4A5
656f : 8698             PF50A: lda   #0x98
6571 : 970b                    sta   <0x0B
6573 : 39                rts
                        ;       jmp reset0ref
                        
                        
                        ;todo: many unused letters, save memory by having a char-translation table?
6574 :                  FontTable1:
                        ; db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,96,224
6574 : 0003060606181f..  db 0,3,6,6,6,24,31,0,3,3,0,0,0,0,0,0,15,7,15,15,248,255,0,255,31,15,0,0,0,0,14,15,31,15,255,15,255,15,15,15,248,6,0,24,24,248,240,15,255,15,255,15,255,192,224,192,48,240,255,
65b2 : 00070f0e3f3c7f..  db 0,7,15,14,63,60,127,1,7,3,1,3,0,0,0,0,63,15,63,63,248,255,1,255,127,63,3,3,1,0,31,63,127,63,255,63,255,63,63,63,248,7,0,56,56,252,248,63,255,63,255,63,255,224,240,224,120,
65f0 : 00071e0e7f66f9..  db 0,7,30,14,127,102,249,3,15,1,25,3,0,0,0,0,127,31,127,127,248,255,3,255,252,127,7,7,3,63,31,127,112,127,255,127,255,127,127,127,248,7,0,120,120,255,252,127,255,127,255,127,
662e : 00073c3f7f66f0..  db 0,7,60,63,127,102,240,7,14,0,29,3,0,0,0,0,127,31,124,124,248,255,7,255,248,124,7,7,7,63,15,124,224,127,255,127,255,127,127,127,248,7,0,249,248,255,254,127,248,127,248,127,
666c : 0007187f763c79..  db 0,7,24,127,118,60,121,3,30,0,15,3,0,0,0,0,252,3,56,56,248,248,15,0,252,248,3,3,15,63,7,56,207,252,248,255,255,255,255,252,248,7,0,251,248,255,255,255,248,255,248,252,7,248
66aa : 0007007f7f193f..  db 0,7,0,127,127,25,63,0,28,0,7,63,0,63,0,1,248,3,0,0,248,255,31,0,127,248,0,0,31,0,3,0,223,248,248,254,248,252,252,249,248,7,0,255,248,251,255,252,248,252,248,127,7,248,124,
66e8 : 0007000e7f031f..  db 0,7,0,14,127,3,31,0,28,0,63,63,0,63,0,3,248,3,0,0,252,255,63,1,31,124,0,0,63,0,1,0,216,248,248,252,248,255,252,249,255,7,0,255,248,248,255,248,255,248,255,127,7,248,124,24
6726 : 0007000e3f071f..  db 0,7,0,14,63,7,31,0,28,0,63,63,0,63,0,7,248,3,1,0,127,255,127,3,127,127,0,0,62,0,0,3,216,255,248,252,248,255,255,248,255,7,0,255,248,248,255,248,255,248,255,63,7,248,62,251
6764 : 0003003f060f3f..  db 0,3,0,63,6,15,63,0,28,0,7,3,0,0,0,15,248,3,3,0,127,127,252,7,252,63,0,0,63,63,1,7,220,255,248,252,248,255,255,248,255,7,248,255,248,248,255,248,255,248,255,15,7,248,62,255
67a2 : 0000007f061f79..  db 0,0,0,127,6,31,121,0,28,0,15,3,0,0,0,31,248,3,7,56,63,0,248,15,248,15,0,0,31,63,3,7,207,255,248,254,248,252,255,252,248,7,248,255,252,248,251,252,248,252,255,0,7,248,31,25
67e0 : 0000007f7f3ef0..  db 0,0,0,127,127,62,240,0,30,0,29,3,0,0,0,62,252,3,15,124,15,0,248,31,248,15,3,0,15,63,7,7,231,248,248,255,255,255,252,255,248,7,252,251,255,248,249,255,248,254,249,0,7,252,3
681e : 0003000e7f7cf8..  db 0,3,0,14,127,124,248,0,14,0,25,3,3,0,3,124,127,15,31,127,0,255,124,63,252,31,7,3,7,0,15,0,96,248,255,127,255,127,252,127,248,7,127,249,127,248,248,127,248,127,248,31,7,127
685c : 0007000e7f787f..  db 0,7,0,14,127,120,127,0,15,1,1,0,7,0,7,248,127,15,63,127,0,255,127,126,255,63,7,7,3,0,31,7,120,240,255,127,255,127,252,127,240,7,127,248,127,240,248,127,120,127,120,63,3,12
689a : 0007000c06307f..  db 0,7,0,12,6,48,127,0,7,3,0,0,15,0,7,240,63,15,127,63,0,255,63,252,127,127,3,15,1,0,31,15,63,224,255,63,255,63,252,63,224,7,63,248,63,224,248,63,56,63,56,127,1,63,7,60,120,1
68d8 : 0003000000001f..  db 0,3,0,0,0,0,31,0,3,3,0,0,30,0,3,96,15,15,127,15,0,255,15,248,31,126,0,30,0,0,14,7,15,192,255,15,255,15,252,15,192,7,15,248,15,192,248,15,24,15,24,255,0,15,7,24,48,0,255,19
6916 :                  FontTable2:
                        ; db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,6,14
6916 : 00801830600c80..  db 0,128,24,48,96,12,128,192,128,128,0,0,0,0,0,12,224,224,224,224,248,254,252,252,240,224,0,0,224,0,0,224,240,224,224,254,224,254,254,254,6,0,48,60,0,62,6,224,224,224,224,254
6954 : 00c03c70fc1ee0..  db 0,192,60,112,252,30,224,224,128,192,128,128,0,0,0,30,248,224,248,248,248,254,252,254,252,248,128,128,240,0,0,248,252,248,248,254,248,254,254,254,14,0,56,126,0,126,14,248,2
6992 : 00c07870fc3ef0..  db 0,192,120,112,252,62,240,192,0,224,152,128,0,0,0,62,252,224,252,252,248,254,248,254,126,252,192,192,240,248,128,252,28,252,252,252,252,252,252,252,30,128,60,252,0,254,30,2
69d0 : 00c0f0fefc7cf0..  db 0,192,240,254,252,124,240,128,0,224,184,128,0,0,0,124,252,224,126,126,248,254,240,254,62,124,192,192,224,248,192,126,14,252,252,248,252,248,248,248,62,192,62,248,0,254,62,
6a0e : 00c060fe60f8e0..  db 0,192,96,254,96,248,224,0,0,240,240,128,0,0,0,248,126,224,62,62,248,0,224,126,126,62,128,128,192,248,224,62,102,126,124,240,254,240,240,0,62,192,62,240,0,254,62,254,62,254
6a4c : 00c000fcfcf0c0..  db 0,192,0,252,252,240,192,0,0,112,224,248,0,248,0,240,62,224,126,126,248,224,224,252,252,62,0,0,128,0,240,126,230,62,124,0,126,0,0,252,62,192,62,224,0,190,190,126,124,126,12
6a8a : 00c00070fee080..  db 0,192,0,112,254,224,128,0,0,112,252,248,0,248,0,224,62,224,252,252,248,248,248,248,240,126,0,0,0,0,248,252,102,62,248,0,62,192,0,254,254,192,62,192,0,62,254,62,252,62,252,
6ac8 : 00c00070fec08c..  db 0,192,0,112,254,192,140,0,0,112,252,248,0,248,0,192,62,224,248,248,254,252,252,240,252,252,0,0,0,0,248,248,102,254,248,0,62,192,192,254,254,192,62,192,0,62,254,62,248,62,2
6b06 : 008000fe6e98de..  db 0,128,0,254,110,152,222,0,0,112,224,128,0,0,0,128,62,224,240,124,254,252,124,224,126,248,0,0,0,248,248,224,102,254,124,0,62,192,128,126,254,192,62,192,0,62,254,62,224,30,2
6b44 : 000000fe6e3cfc..  db 0,0,0,254,110,60,252,0,0,112,240,128,0,0,0,0,62,224,224,62,254,126,62,192,62,240,0,0,128,248,240,192,252,254,62,0,126,0,0,30,62,192,62,224,0,62,254,126,0,110,224,126,192,6
6b82 : 000000fcfe66f8..  db 0,0,0,252,254,102,248,0,0,240,184,128,0,0,0,0,126,224,192,126,254,126,62,128,62,224,128,0,192,248,224,192,184,62,126,240,254,240,0,254,62,192,126,240,254,62,254,254,0,246,
6bc0 : 00800070fe66f8..  db 0,128,0,112,254,102,248,0,0,224,152,128,192,0,128,0,252,248,254,254,248,252,124,0,126,192,192,192,224,0,192,0,0,62,252,248,252,248,0,254,62,192,252,248,254,62,254,252,0,12
6bfe : 00c00070fc3cfc..  db 0,192,0,112,252,60,252,0,0,224,128,0,192,0,192,0,252,248,254,252,248,252,252,0,254,128,192,192,240,0,128,192,6,30,252,252,252,252,0,252,62,192,252,252,254,30,126,252,0,188
6c3c : 00c000606018de..  db 0,192,0,96,96,24,222,0,128,192,0,0,128,0,192,0,248,248,254,248,248,248,248,0,252,0,128,128,240,0,0,224,254,14,248,254,248,254,0,248,62,192,248,126,254,14,62,248,0,222,62,2
6c7a : 0080000000008c..  db 0,128,0,0,0,0,140,0,128,128,0,0,0,0,128,0,224,248,254,224,248,224,224,0,240,0,0,0,224,0,0,192,248,6,224,254,224,254,0,224,62,192,224,60,254,6,30,224,0,236,30,224,192,224,1
                        
                        
6cb8 :                  TitleBitmap:
                         ;thrust 64*28
                         ;repeatvalue, bitmap
6cb8 : 07ffffffffffff..  db 7, $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
6cc1 : 03000000000000..  db 3, $00,$00,$00,$00,$00,$00,$00,$00
6cca : 011e1e39ff78e7..  db 1, $1E,$1E,$39,$FF,$78,$E7,$FC,$FF
6cd3 : 021e1e39ff78ef..  db 2, $1E,$1E,$39,$FF,$78,$EF,$FC,$FF
6cdc : 011e1e39c778ef..  db 1, $1E,$1E,$39,$C7,$78,$EF,$FC,$FF
6ce5 : 021e1e39c778ef..  db 2, $1E,$1E,$39,$C7,$78,$EF,$00,$3C
6cee : 011e1ff9c778ef..  db 1, $1E,$1F,$F9,$C7,$78,$EF,$00,$3C
6cf7 : 021e1ff9c778ef..  db 2, $1E,$1F,$F9,$C7,$78,$EF,$FC,$3C
6d00 : 011e1ff9ff78e7..  db 1, $1E,$1F,$F9,$FF,$78,$E7,$FC,$3C
6d09 : 011e1ff9ff78e0..  db 1, $1E,$1F,$F9,$FF,$78,$E0,$1C,$3C
6d12 : 011e1e39ff78e0..  db 1, $1E,$1E,$39,$FF,$78,$E0,$1C,$3C
6d1b : 021e1e39fc7fe0..  db 2, $1E,$1E,$39,$FC,$7F,$E0,$1C,$3C
6d24 : 021e1e39de7fef..  db 2, $1E,$1E,$39,$DE,$7F,$EF,$FC,$3C
6d2d : 011e1e39cf3fef..  db 1, $1E,$1E,$39,$CF,$3F,$EF,$FC,$3C
6d36 : 011e1e39cf3fcf..  db 1, $1E,$1E,$39,$CF,$3F,$CF,$FC,$3C
                        
                        ;128 values, range -63 -- +63
6d3f :                  SineTable:
6d3f : 000306090c0f12..  db 0,3,6,9,12,15,18,21,24,27,30,32,35,38,40,42,45,47,49,51,52,54,56,57,58,59,60
6d5a : 3d3e3e3f3f3f3f..  db 61,62,62,63,63,63,63,63,62,62,61,60,59,58,57,56,54,52,51,49,47,45,42,40,38,35
6d74 : 201e1b1815120f..  db 32,30,27,24,21,18,15,12,9,6,3,0,-3,-6,-9,-12,-15,-18,-21,-24,-27,-30,-32,-35
6d8c : dad8d6d3d1cfcd..  db -38,-40,-42,-45,-47,-49,-51,-52,-54,-56,-57,-58,-59,-60,-61,-62,-62,-63,-63
6d9f : c1c1c1c2c2c3c4..  db -63,-63,-63,-62,-62,-61,-60,-59,-58,-57,-56,-54,-52,-51,-49,-47,-45,-42,-40
6db2 : dadde0e2e5e8eb..  db -38,-35,-32,-30,-27,-24,-21,-18,-15,-12,-9,-6,-3
                        
                        
                        
                        
                        ;Music_RAM_Size = 400                  ;Reserve memory for music player
                         include "Thrust_music.asm"
                        ; Music player
                        ; Copyright (C) 2004  Ville Krumlinde
                        ;
                        ; Translated from original 68000 code and music data by Rob Hubbard
                        ;
                        
                        ;-----------------
                        ;Vectrex RAM section
                          bss
c880 =                    org $c880
                        
                        ;Uncomment to make music use top of ram
c880 =                    ds 1024 - 392 - $80 - 100
                        
ca14 =                  TEMP_D0: ds 2
ca16 =                  TEMP_D1: ds 2
ca18 =                  TEMP_D4: ds 2
ca1a =                  TEMP_D5: ds 2
ca1c =                  TEMP_D6: ds 2
                        
                          ;Work memory for soundplayer, data is copied from rom into these addresses in init
ca1e =                  LA5_BASE: ds 76
ca6a =                  L0596E6:  ds 102
cad0 =                  L05974C:  ds 102
cb36 =                  L0597B2:  ds 102
                        
                          code
                        
                        
                        ;----------------------
                        ; Music player
6dbf :                  InitMusic:
6dbf : bdf1aa             jsr dptoD0
                        
                          ;6809: copy work-data from rom to ram
6dc2 : ce7c26             ldu #LA5_BASE_ROM
6dc5 : 8eca4c             ldx #LA5_BASE+46  ;offset 46 is the first one used, save rom-space
6dc8 : 864c               lda #76
6dca : bdf683             jsr move_block2
                        
6dcd : ce7c44             ldu #L0596E6_ROM
6dd0 : 8eca6a             ldx #L0596E6
6dd3 : 8666               lda #102
6dd5 : bdf683             jsr move_block2
                        
6dd8 : ce7caa             ldu #L05974C_ROM
6ddb : 8ecad0             ldx #L05974C
6dde : 8666               lda #102
6de0 : bdf683             jsr move_block2
                        
6de3 : ce7d10             ldu #L0597B2_ROM
6de6 : 8ecb36             ldx #L0597B2
6de9 : 8666               lda #102
6deb : bdf683             jsr move_block2
                        
                        
                        
                                ; LEA LA5_BASE,A5
                                ; CLR.W $2E(A5)
                                ; MOVEQ #$D,D1
                                ;L059100:
                                ; MOVE.B D1,$FF8800
                                ; CLR.B $FF8802
                                ; DBRA D1,L059100
6dee : 108eca1e           ldy #LA5_BASE
6df2 : cc0000             ldd #0
6df5 : eda82e             std $2e,y
6df8 : bdf272             jsr clear_sound_chip
                        
                                ; MOVE.B #7,$FF8800
                                ; MOVE.B #-1,$FF8802
                                ; MOVE.B #-1,$41(A5)
                                ; NOP
                                ; LEA LA5_BASE,A5
                                ; CLR.W $2E(A5)
                          ;set mixer register
6dfb : 8607               lda #7
6dfd : c63f               ldb #%00111111  ;init mixer register, notes off, io enabled
6dff : 108eca1e           ldy #LA5_BASE
6e03 : e7a841             stb $41,y
6e06 : bdf256             jsr byte_2_sound_chip
                        
                                ; MOVE.B #-8,$38(A5)
                                ; LEA L0596E6,A1
                                ; MULU #$C,D0
                                ; CLR.L D0
                                ; MOVEQ #2,D7
6e09 : 86f8               lda #-8
6e0b : a7a838             sta $38,y
6e0e : ceca6a             ldu #L0596E6
6e11 : 8603               lda #3  ;nr of channels
6e13 : c600               ldb #0
6e15 :                  L059142:                ;init channel loop
                                ; LEA L059818,A0
                                ; MOVEA.L A0,A2
                                ; ADDA.L 0(A0,D0.W),A2
                                ; MOVE.L A2,8(A1)
                                ; MOVE.W #1,$28(A1)
                                ; CLR.W 0(A1)
                                ; CLR.B $5C(A1)
                                ; MOVE.L #4,$C(A1)
6e15 : 3406               pshs d
                        
6e17 : 8e739e             ldx #L059818
6e1a : 10ae85             ldy b,x
                        
6e1d : 1f10               tfr x,d
6e1f : 3420               pshs y
6e21 : e3e1               addd ,s++
6e23 : 1f01               tfr d,x
                        
6e25 : af4a               stx 8+2,u
6e27 : cc0001             ldd #1
6e2a : edc828             std $28,u
6e2d : cc0000             ldd #0
6e30 : edc4               std ,u
6e32 : a7c85c             sta $5c,u
6e35 : cc0002             ldd #4-2
6e38 : ed4e               std $c+2,u
                        
                          ; set up pointer to first pattern
                                ; LEA L059818,A3
                                ; ADDA.L (A2),A3
                                ; MOVE.L A3,4(A1)
6e3a : 108e739e           ldy #L059818
6e3e : ec84               ldd ,x
6e40 : 31ab               leay d,y
6e42 : 10af46             sty 4+2,u
                        
                                ; ADDQ.W #4,D0
                                ; ADDA.L #$66,A1         ;+102 = next channel data
                                ; DBRA D7,L059142
6e45 : 8666               lda #102
6e47 : 33c6               leau a,u
6e49 : 3506               puls d
6e4b : 5c                 incb
6e4c : 5c                 incb
6e4d : 4a                 deca
6e4e : 26c5               bne L059142
                        
                                ; MOVE.W #1,$32(A5)
                                ; ST.B $2E(A5)
6e50 : 108eca1e           ldy #LA5_BASE
6e54 : cc0001             ldd #1
6e57 : eda832             std $32,y
6e5a : 86ff               lda #$ff
6e5c : a7a82e             sta $2e,y
                        
                                ; this label is only used to jump directly to rts from update
                                ; L059186:
                                ; RTS
6e5f : 39                 rts
                        
                        
6e60 :                  UpdateMusic:  ;call each vbl
                                ; LEA LA5_BASE,A5
                                ; TST.W $2E(A5)
                                ; BEQ.S L059186
6e60 : 108eca1e           ldy #LA5_BASE
6e64 : eca82e             ldd $2e,y
6e67 : 10270093           lbeq EXIT_UPDATE
                        
                                ; MOVE.B $34(A5),D0
                                ; MOVE.B D0,$36(A5)
6e6b : a6a834             lda $34,y
6e6e : a7a836             sta $36,y
                        
                                ; SUBQ.W #1,$32(A5)
                                ; BNE.S L0591C0
6e71 : eca832             ldd $32,y
6e74 : 830001             subd #1
6e77 : eda832             std $32,y
6e7a : 261c               bne L0591C0
                        
                                ; LEA L0596E6,A1
                                ; BSR L059228
                                ; LEA L05974C,A1
                                ; BSR L059228
                                ; LEA L0597B2,A1
                                ; BSR L059228
6e7c : 8eca6a             ldx #L0596E6
6e7f : bd6eff             jsr L059228
6e82 : 8ecad0             ldx #L05974C
6e85 : bd6eff             jsr L059228
6e88 : 8ecb36             ldx #L0597B2
6e8b : bd6eff             jsr L059228
                        
                                ; MOVE.W $30(A5),D0
                                ; MOVE.W D0,$32(A5)
6e8e : 108eca1e           ldy #LA5_BASE
6e92 : eca830             ldd $30,y
6e95 : eda832             std $32,y
                        
6e98 :                  L0591C0:
                          ;L059418 returns three bytes, two bytes in d5, one byte in d4
                          ;d5 holds channel pitch hi/lo, d4 holds channel volume
                          ;these values are written to LA5_BASE register buffer after each call
                                ; LEA L0596E6,A1
                                ; BSR L059418
                                ; MOVE.B D5,$3A(A5)
                                ; LSR.W #8,D5
                                ; MOVE.B D5,$3B(A5)
                                ; MOVE.B D4,$42(A5)
6e98 : 8eca6a             ldx #L0596E6
6e9b : bd70d4             jsr L059418
6e9e : 108eca1e           ldy #LA5_BASE
6ea2 : fcca1a             ldd TEMP_D5
6ea5 : e7a83a             stb $3a,y
6ea8 : a7a83b             sta $3b,y
6eab : fcca18             ldd TEMP_D4
                        ; ldb #0        ;uncomment to mute channel 1
6eae : e7a842             stb $42,y
                                ; LEA L05974C,A1
                                ; BSR L059418
                                ; MOVE.B D5,$3C(A5)
                                ; LSR.W #8,D5
                                ; MOVE.B D5,$3D(A5)
                                ; MOVE.B D4,$43(A5)
6eb1 : 8ecad0             ldx #L05974C
6eb4 : bd70d4             jsr L059418
6eb7 : 108eca1e           ldy #LA5_BASE
6ebb : fcca1a             ldd TEMP_D5
6ebe : e7a83c             stb $3c,y
6ec1 : a7a83d             sta $3d,y
6ec4 : fcca18             ldd TEMP_D4
                        ; ldb #0        ;uncomment to mute channel 2
6ec7 : e7a843             stb $43,y
                                ; LEA L0597B2,A1
                                ; BSR L059418
                                ; MOVE.B D5,$3E(A5)
                                ; LSR.W #8,D5
                                ; MOVE.B D5,$3F(A5)
                                ; MOVE.B D4,$44(A5)
6eca : 8ecb36             ldx #L0597B2
6ecd : bd70d4             jsr L059418
6ed0 : 108eca1e           ldy #LA5_BASE
6ed4 : fcca1a             ldd TEMP_D5
6ed7 : e7a83e             stb $3e,y
6eda : a7a83f             sta $3f,y
6edd : fcca18             ldd TEMP_D4
                        ; ldb #0        ;uncomment to mute channel 3
6ee0 : e7a844             stb $44,y
                        
                                ; MOVE.B $36(A5),D0
                                ; MOVE.B D0,$40(A5)
6ee3 : 108eca1e           ldy #LA5_BASE
6ee7 : a6a836             lda $36,y
6eea : a7a840             sta $40,y    ;noise pitch
                        
                         ;**debug, force mixer register
                        ; ldb $41,y
                        ; andb #%00000111 ;keep tone
                        ; orb  #%00010000 ;noise off
                        ; stb $41,y
                        
                        
                          ;write all sound chip registers at once
                                ; MOVEQ #$D,D1
                                ; MOVEA.L A5,A0
                                ; ADDA.L #$48,A0  ;a5_offset
                                ;L059214:
                                ; MOVE.B D1,$FF8800
                                ; MOVE.B -(A0),D0
                                ; MOVE.B D0,$FF8802
                                ; DBRA D1,L059214
6eed : 860d               lda #$d
6eef : 30a848             leax $48,y
6ef2 :                  L059214:
6ef2 : e682               ldb ,-x
6ef4 : 3416               pshs x,d
6ef6 : bdf256             jsr byte_2_sound_chip
6ef9 : 3516               puls x,d
6efb : 4a                 deca
6efc : 2af4               bpl L059214
                        
6efe :                  EXIT_UPDATE:
                                ; RTS
6efe : 39                 rts
                        
                        
                        
                         ; First update channel routine
                         ; Read pattern data and updates channel info at x/A1
                         ; x holds pointer to current channel data (A1)
6eff :                  L059228:
                                ; SUBQ.W #1,$28(A1)
                                ; BNE L059282
6eff : ec8828             ldd $28,x
6f02 : 830001             subd #1
6f05 : ed8828             std $28,x
6f08 : 2640               bne L059282
                        
                                ; CLR.W 0(A1)
                                ; BCLR #0,$60(A1)
6f0a : cc0000             ldd #0
6f0d : ed84               std ,x
6f0f : a68860             lda $60,x
6f12 : 84fe               anda #~(1<<0)
6f14 : a78860             sta $60,x
                        
                         ; read data from current pattern
                         ; this is a variable length structure
                                ; MOVEA.L 4(A1),A6
                                ;L05923E:
                                ; MOVE.B (A6)+,D0
                                ; EXT.W D0
                                ; BMI L0592A0
6f17 : ee06               ldu 4+2,x
6f19 :                  L05923E:
6f19 : e6c0               ldb ,u+
6f1b : 1d                 sex
6f1c : 2b4a               bmi L0592A0
                        
                                ; MOVE.W D0,$30(A1)
                                ; BTST #4,0(A1)
                                ; BNE.S L059276
6f1e : ed8830             std $30,x
6f21 : a684               lda ,x
6f23 : 8510               bita #1<<4
6f25 : 261a               bne L059276
                        
                                ; MOVE.B $4C(A1),$34(A1)
6f27 : a6884c             lda $4c,x
6f2a : a78834             sta $34,x
                        
                                ; BSET #5,0(A1)
                                ; BSET #6,0(A1)
                                ; BCLR #4,0(A1)
6f2d : a684               lda ,x
6f2f : 8a60               ora #(1<<5) | (1<<6)
6f31 : 84ef               anda #~(1<<4)
6f33 : a784               sta ,x
                        
                                ; MOVE.B $38(A1),$40(A1)
                                ; MOVE.B $44(A1),$48(A1)
6f35 : a68838             lda $38,x
6f38 : a78840             sta $40,x
6f3b : a68844             lda $44,x
6f3e : a78848             sta $48,x
                        
6f41 :                  L059276:
                                ; MOVE.W $2C(A1),$28(A1)
                                ; MOVE.L A6,4(A1)
6f41 : ec882c             ldd $2c,x
6f44 : ed8828             std $28,x
6f47 : ef06               stu 4+2,x             ;write back pattern pointer
                        
                                ; RTS
6f49 : 39                 rts
                        
                        
                         ; $28(a1) > 0
                         ; x holds pointer to current channel data (A1)
6f4a :                  L059282:
                                ; BTST #3,0(A1)
                                ; BEQ L059186
                                ; BTST #7,0(A1)
                                ; BEQ.S L05929A
6f4a : a684               lda ,x
6f4c : 8508               bita #1<<3
6f4e : 270d               beq Exit_L059282
6f50 : 8580               bita #1<<7
6f52 : 270a               beq L05929A
                        
                                ; ADDQ.W #1,$30(A1)
                                ; RTS
6f54 : ec8830             ldd $30,x
6f57 : c30001             addd #1
6f5a : ed8830             std $30,x
6f5d :                  Exit_L059282:
6f5d : 39                 rts
                        
6f5e :                  L05929A:
                                ; SUBQ.W #1,$30(A1)
                                ; RTS
6f5e : ec8830             ldd $30,x
6f61 : 830001             subd #1
6f64 : ed8830             std $30,x
6f67 : 39                 rts
                        
                        
                         ; negative value in pattern: register d/D0
                         ; x holds pointer to current channel data (A1)
6f68 :                  L0592A0:
                                ; CMP.B #-$49,D0
                                ; BLS L059306
6f68 : c1b7               cmpb #-$49
6f6a : 234d               bls L059306
                        
                          ;add until overflow (d becomes positive)
                                ; ADDI.W #$20,D0
                                ; BCS L0592E2
                                ; ADDI.W #$10,D0
                                ; BCS L0592EC
                                ; ADDI.W #$10,D0
                                ; BCC L0592D6
6f6c : c30020             addd #$20
6f6f : 252a               bcs L0592E2
6f71 : c30010             addd #$10
6f74 : 252e               bcs L0592EC
6f76 : c30010             addd #$10
6f79 : 2413               bcc L0592D6
                        
                         ; d is index to L059642-table
                                ; LEA L059642,A0
                                ; LSL.W #2,D0
                                ; ADDA.L 0(A0,D0.W),A0
6f7b : 108e7334           ldy #L059642
6f7f : 58                 lslb  ;*2
6f80 : eca5               ldd b,y
6f82 : 31ab               leay d,y
                        
                                ; MOVE.L A0,$18(A1)
                                ; MOVE.L A0,$14(A1)
                                ; BRA L05923E
6f84 : 10af881a           sty $18+2,x
6f88 : 10af8816           sty $14+2,x
6f8c : 208b               bra L05923E
                        
6f8e :                  L0592D6:
                                ; ADDI.W #9,D0
                                ; MOVE.W D0,$30(A5)
                                ; BRA L05923E
6f8e : c30009             addd #9
6f91 : 108eca1e           ldy #LA5_BASE
6f95 : eda830             std $30,y
6f98 : 7e6f19             bra L05923E
                        
6f9b :                  L0592E2:
                                ; ADDQ.W #1,D0
                                ; MOVE.W D0,$2C(A1)
                                ; BRA L05923E
6f9b : c30001             addd #1
6f9e : ed882c             std $2c,x
6fa1 : 7e6f19             bra L05923E
                        
6fa4 :                  L0592EC:
                                ; MOVE.B D0,$4C(A1)
                                ; MOVE.B (A6)+,D0
                                ; MOVE.B D0,$38(A1)
                                ; MOVE.B (A6)+,D0
                                ; MOVE.B D0,$3C(A1)
                                ; MOVE.B (A6)+,D0
                                ; MOVE.B D0,$44(A1)
                                ; BRA L05923E
6fa4 : e7884c             stb $4c,x
6fa7 : a6c0               lda ,u+
6fa9 : a78838             sta $38,x
6fac : a6c0               lda ,u+
6fae : a7883c             sta $3c,x
6fb1 : a6c0               lda ,u+
6fb3 : a78844             sta $44,x
6fb6 : 7e6f19             bra L05923E
                        
6fb9 :                  L059306:
                          ;b is index into jumptable L05969E
                                ; LEA L05969E,A0
                                ; ANDI.L #$3F,D0
                                ; LSL.W #2,D0
                                ;; ADDA.L 0(A0,D0.W),A0
                                ; move.l (a0,d0.w),a0    ;jumptable now holds absolute adresses
                                ; JMP (A0)
6fb9 : 108e737a           ldy #L05969E
6fbd : c43f               andb #$3f
6fbf : 8602               lda #2
6fc1 : 3d                 mul
6fc2 : 6ebb               jmp [d,y]
                        
6fc4 :                  L_CMD8:
                          ;New track
                                ; MOVEA.L 8(A1),A0
                                ; ADDA.L $C(A1),A0
6fc4 : 10ae0a             ldy 8+2,x
6fc7 : ec0e               ldd $c+2,x
6fc9 : 31ab               leay d,y
                                ; ADDQ.L #4,$C(A1)
6fcb : c30002             addd #4-2
6fce : ed0e               std $c+2,x
                                ; MOVE.L (A0),D0
                                ; BNE.S L059336
6fd0 : eca4               ldd (0),y
6fd2 : 2615               bne L059336
                          ;End of tracks, loop
                                ; MOVEA.L 8(A1),A0
                                ; MOVE.L #4,$C(A1)
                                ; MOVE.L (A0),D0
                        
                         ;we do not loop, instead trigger demo game
                        ;  ldy 8+2,x
                        ;  ldd #4-2
                        ;  std $c+2,x
                        ;  ldd (0),y
                        
6fd4 : 8604               lda #DemoGame ;trigger demo game
6fd6 : b7c87a             sta GameMode
6fd9 : b6c86c             lda DemoSelected
6fdc : 4c                 inca
6fdd : 8403               anda #3
6fdf : 8103               cmpa #3
6fe1 : 2601               bne *+3
6fe3 : 4f                   clra
6fe4 : b7c86c             sta DemoSelected
6fe7 : 3586               puls d,pc      ;hack, return from music to title, otherwise two more channels will call this
                        
6fe9 :                  L059336:
                                ; LEA L059818,A6
                                ; ADDA.L D0,A6
                                ; BRA L05923E
6fe9 : ce739e             ldu #L059818
6fec : 33cb               leau d,u
6fee : 7e6f19             bra L05923E
                        
6ff1 :                  L_CMD12:
                                ; MOVE.B $64(A1),D0
                                ; ANDI.B #7,D0
6ff1 : a68864             lda $64,x
6ff4 : 8407               anda #7
                                ; OR.B D0,$38(A5)
6ff6 : 1f89               tfr a,b
6ff8 : 108eca1e           ldy #LA5_BASE
6ffc : eaa838             orb $38,y
6fff : e7a838             stb $38,y
                                ; LSL.B #3,D0
7002 : 48                 lsla
7003 : 48                 lsla
7004 : 48                 lsla
                                ; NOT.B D0
7005 : 43                 coma
                                ; AND.B D0,$38(A5)
7006 : e6a838             ldb $38,y
7009 : 3402               pshs a
700b : e4e0               andb ,s+
700d : e7a838             stb $38,y
                                ; BRA L05923E
7010 : 7e6f19             bra L05923E
                        
                        
7013 :                  L_CMD11:
                                ; MOVE.B $64(A1),D0
                                ; ANDI.B #$38,D0
                                ; OR.B D0,$38(A5)
7013 : a68864             lda $64,x
7016 : 8438               anda #$38
7018 : 1f89               tfr a,b
701a : 108eca1e           ldy #LA5_BASE
701e : eaa838             orb $38,y
7021 : e7a838             stb $38,y
                                ; LSR.B #3,D0
                                ; NOT.B D0
7024 : 44                 lsra
7025 : 44                 lsra
7026 : 44                 lsra
7027 : 43                 coma
                                ; AND.B D0,$38(A5)
                                ; BRA L05923E
7028 : e6a838             ldb $38,y
702b : 3402               pshs a
702d : e4e0               andb ,s+
702f : e7a838             stb $38,y
7032 : 7e6f19             bra L05923E
                        
7035 :                  L_CMD13:
                                ; MOVE.B $64(A1),D0
                                ; NOT.B D0
7035 : a68864             lda $64,x
7038 : 43                 coma
                                ; AND.B D0,$38(A5)
                                ; BRA L05923E
7039 : 108eca1e           ldy #LA5_BASE
703d : e6a838             ldb $38,y
7040 : 3402               pshs a
7042 : e4e0               andb ,s+
7044 : e7a838             stb $38,y
7047 : 7e6f19             bra L05923E
                        
704a :                  L_CMD5:
                                ; MOVE.B (A6)+,D0
                                ; EXT.W D0
                                ; CLR.W $10(A1)
                                ; MOVE.W D0,$1C(A1)
704a : e6c0               ldb ,u+
704c : 1d                 sex
704d : ed881c             std $1c,x
7050 : cc0000             ldd #0
7053 : ed8810             std $10,x
                                ; CLR.W D0
                                ; MOVE.B (A6)+,D0
                                ; MOVE.W D0,$20(A1)
7056 : e6c0               ldb ,u+
7058 : ed8820             std $20,x
                                ; BSET #2,0(A1)
                                ; BRA L05923E
705b : a684               lda ,x
705d : 8a04               ora #1<<2
705f : a784               sta ,x
7061 : 7e6f19             bra L05923E
                        
7064 :                  L_CMD10:
                                ; CLR.W D0
                                ; MOVE.B (A6)+,D0
                                ; MOVE.B D0,$34(A5)
                                ; BRA L05923E
7064 : a6c0               lda ,u+
7066 : 108eca1e           ldy #LA5_BASE
706a : a7a834             sta $34,y
706d : 7e6f19             bra L05923E
                        
7070 :                  L_CMD9:
                                ; CLR.W D0
                                ; MOVE.B (A6)+,D0
                                ; MOVE.W D0,$54(A1)
7070 : 8600               lda #0
7072 : e6c0               ldb ,u+
7074 : ed8854             std $54,x
                                ; CLR.W D0
                                ; MOVE.B (A6)+,D0
                                ; MOVE.W D0,$50(A1)
                                ; MOVE.W D0,$58(A1)
                                ; BRA L05923E
7077 : e6c0               ldb ,u+
7079 : ed8850             std $50,x
707c : ed8858             std $58,x
707f : 7e6f19             bra L05923E
                        
7082 :                  L_CMD7:
                                ; BSET #7,0(A1)
7082 : a684               lda ,x
7084 : 8a80               ora #1<<7
7086 : a784               sta ,x
7088 :                  L_CMD6:
                                ; BSET #3,0(A1)
                                ; BRA L05923E
7088 : a684               lda ,x
708a : 8a08               ora #1<<3
708c : a784               sta ,x
708e : 7e6f19             bra L05923E
                        
7091 :                  L_CMD2:
                                ; CLR.B $5C(A1)
                                ; BRA L05923E
7091 : 8600               lda #0
7093 : a7885c             sta $5c,x
7096 : 7e6f19             bra L05923E
                        
7099 :                  L_CMD3:
                                ; MOVE.B #$40,$5C(A1)
                                ; BRA L05923E
7099 : 8640               lda #$40
709b : a7885c             sta $5c,x
709e : 7e6f19             bra L05923E
                        
70a1 :                  L_CMD4:
                                ; MOVE.B #-$40,$5C(A1)
                                ; BRA L05923E
70a1 : 86c0               lda #-$40
70a3 : a7885c             sta $5c,x
70a6 : 7e6f19             bra L05923E
                        
70a9 :                  L_CMD14:
                                ; BSET #1,0(A1)
                                ; BRA L05923E
70a9 : a684               lda ,x
70ab : 8a02               ora #1<<1
70ad : a784               sta ,x
70af : 7e6f19             bra L05923E
                        
70b2 :                  L_CMD1:
                                ; CLR.B $34(A1)
70b2 : 8600               lda #0
70b4 : a78834             sta $34,x
70b7 :                  L_CMD16:
                                ; BCLR #5,0(A1)
                                ; BRA L059276
70b7 : a684               lda ,x
70b9 : 84df               anda #~(1<<5)
70bb : a784               sta ,x
70bd : 7e6f41             bra L059276
                        
70c0 :                  L_CMD17:
                                ; BSET #4,0(A1)
                                ; BRA L05923E
70c0 : a684               lda ,x
70c2 : 8a10               ora #1<<4
70c4 : a784               sta ,x
70c6 : 7e6f19             bra L05923E
                        
70c9 :                  L_CMD18:
                                ; BSET #0,$60(A1)
                                ; BRA L05923E
70c9 : a68860             lda $60,x
70cc : 8a01               ora #1<<0
70ce : a78860             sta $60,x
70d1 : 7e6f19             bra L05923E
                        
                        
                         ; Second update channel routine
                         ; Calculate sound register output based on current channel data
                         ; x holds pointer to current channel data (A1)
                         ; returns values in d4,d5
70d4 :                  L059418:
                         ; D6 is an alias for 0(A1). It is modified and written back at end of routine.
                        
                          ;TEMP_D0 - D6 globals are used many times, set up dp to save size and speed
70d4 : 3408               pshs dp
70d6 : 86ca               lda #hi TEMP_D0
70d8 : 1f8b               tfr a,dp
                          direct hi TEMP_D0
                        
                                ; MOVE.B 0(A1),D6
                                ; BTST #5,D6
                                ; BEQ L059484
70da : e684               ldb ,x
70dc : d71c               stb TEMP_D6
70de : c520               bitb #1<<5
70e0 : 2758               beq L059484
                                ; MOVE.B $40(A1),D0
                                ; ADDI.B #-$10,D0
                                ; BCS.S L059464
70e2 : a68840             lda $40,x
70e5 : 8bf0               adda #-$10
70e7 : 252a               bcs L059464
                                ; BTST #6,D6
                                ; BEQ.S L05946C
70e9 : c540               bitb #1<<6
70eb : 272b               beq L05946C
                                ; ADD.B $34(A1),D0
                                ; BCC.S L05943C
                                ; MOVEQ #-1,D0
70ed : ab8834             adda $34,x
70f0 : 2402               bcc L05943C
70f2 : 86ff               lda #-1
70f4 :                  L05943C:
                                ; ADDI.B #$10,D0
                                ; MOVE.B D0,$34(A1)
70f4 : 8b10               adda #$10
70f6 : a78834             sta $34,x
                                ; MOVE.B $48(A1),D0
                                ; ADDI.B #-$10,D0
                                ; BCS.S L05945C
70f9 : a68848             lda $48,x
70fc : 8bf0               adda #-$10
70fe : 250e               bcs L05945C
                                ; BCLR #6,D6
7100 : d61c               ldb TEMP_D6
7102 : c4bf               andb #~(1<<6)
7104 : d71c               stb TEMP_D6
                                ; MOVE.B $3C(A1),$40(A1)
                                ; BRA L059484
7106 : a6883c             lda $3c,x
7109 : a78840             sta $40,x
710c : 202c               bra L059484
710e :                  L05945C:
                                ; MOVE.B D0,$48(A1)
                                ; BRA L059484
710e : a78848             sta $48,x
7111 : 2027               bra L059484
7113 :                  L059464:
                                ; MOVE.B D0,$40(A1)
                                ; BRA L059484
7113 : a78840             sta $40,x
7116 : 2022               bra L059484
7118 :                  L05946C:
                                ; ANDI.B #$F,D0
                                ; SUB.B D0,$34(A1)
                                ; BPL.S L05947A
7118 : 840f               anda #$f
711a : e68834             ldb $34,x
711d : 3402               pshs a
711f : e0e0               subb ,s+
7121 : e78834             stb $34,x
7124 : 2a05               bpl L05947A
                                ; CLR.B $34(A1)
7126 : 8600               lda #0
7128 : a78834             sta $34,x
712b :                  L05947A:
                                ; SUBQ.B #1,$48(A1)
                                ; BNE.S L059484
712b : a68848             lda $48,x
712e : 4a                 deca
712f : a78848             sta $48,x
7132 : 2606               bne L059484
                                ; BCLR #5,D6
7134 : d61c               ldb TEMP_D6
7136 : c4df               andb #~(1<<5)
7138 : d71c               stb TEMP_D6
713a :                  L059484:
                                ; MOVEA.L $18(A1),A0
                                ; CLR.W D0
                                ; MOVE.B (A0)+,D0
713a : 10ae881a           ldy $18+2,x
713e : 8600               lda #0
7140 : e6a0               ldb ,y+
                                ; CMP.B #-$79,D0
                                ; BNE.S L05949E
7142 : c187               cmpb #-$79
7144 : 260c               bne L05949E
                                ; MOVE.L $14(A1),$18(A1)
7146 : ee8816             ldu $14+2,x
7149 : ef881a             stu $18+2,x
                                ; MOVEA.L $18(A1),A0
                                ; MOVE.B (A0)+,D0
714c : 10ae881a           ldy $18+2,x
7150 : e6a0               ldb ,y+
7152 :                  L05949E:
                                ; MOVE.L A0,$18(A1)
                                ; ADD.W $30(A1),D0
7152 : 10af881a           sty $18+2,x
7156 : e38830             addd $30,x
                                ; LEA L059582,A0
                                ; ADD.W D0,D0
                                ; MOVE.W D0,D4
7159 : 108e7274           ldy #L059582
715d : 3406               pshs d
715f : e3e1               addd ,s++
7161 : dd18               std TEMP_D4
                                ; MOVE.W 0(A0,D0.W),D5
7163 : 31ab               leay d,y
7165 : eca4               ldd ,y
7167 : dd1a               std TEMP_D5
                                ; BTST #6,$5C(A1)
                                ; BEQ L059514
7169 : a6885c             lda $5c,x
716c : 8540               bita #1<<6
716e : 10270081           lbeq L059514
                                ; MOVE.W $50(A1),D1
                                ; ADD.W D1,D1
7172 : ec8850             ldd $50,x
7175 : 3406               pshs d
7177 : e3e1               addd ,s++
7179 : dd16               std TEMP_D1
                                ; MOVE.W $58(A1),D0
                                ; BTST #7,$5C(A1)
                                ; BEQ.S L0594D4
717b : ec8858             ldd $58,x
717e : dd14               std TEMP_D0
7180 : a6885c             lda $5c,x
7183 : 8580               bita #1<<7
7185 : 2706               beq L0594D4
                                ; BTST #0,D6
                                ; BNE.S L059500
7187 : d61c               ldb TEMP_D6
7189 : c501               bitb #1<<0
718b : 263c               bne L059500
718d :                  L0594D4:
                                ; BTST #5,$5C(A1)
                                ; BNE.S L0594EC
718d : a6885c             lda $5c,x
7190 : 8520               bita #1<<5
7192 : 2618               bne L0594EC
                                ; SUB.W $54(A1),D0
                                ; BPL.S L0594FC
7194 : dc14               ldd TEMP_D0
7196 : a38854             subd $54,x
7199 : dd14               std TEMP_D0
719b : 2a27               bpl L0594FC
                                ; BSET #5,$5C(A1)
                                ; MOVEQ #0,D0
                                ; BRA.S L0594FC
719d : a6885c             lda $5C,x
71a0 : 8a20               ora #1<<5
71a2 : a7885c             sta $5c,x
71a5 : cc0000             ldd #0
71a8 : dd14               std TEMP_D0
71aa : 2018               bra L0594FC
71ac :                  L0594EC:
                                ; ADD.W $54(A1),D0
                                ; CMP.W D1,D0
                                ; BLS.S L0594FC
71ac : dc14               ldd TEMP_D0
71ae : e38854             addd $54,x
71b1 : dd14               std TEMP_D0
71b3 : 109316             cmpd TEMP_D1
71b6 : 230c               bls L0594FC
                                ; BCLR #5,$5C(A1)
                                ; MOVE.W D1,D0
71b8 : a6885c             lda $5c,x
71bb : 84df               anda #~(1<<5)
71bd : a7885c             sta $5c,x
71c0 : dc16               ldd TEMP_D1
71c2 : dd14               std TEMP_D0
71c4 :                  L0594FC:
                                ; MOVE.W D0,$58(A1)
71c4 : dc14               ldd TEMP_D0
71c6 : ed8858             std $58,x
71c9 :                  L059500:
                                ; LSR.W #1,D1
71c9 : dc16               ldd TEMP_D1
71cb : 44                 lsra
71cc : 56                 rorb
71cd : dd16               std TEMP_D1
                                ; SUB.W D1,D0
71cf : dc14               ldd TEMP_D0
71d1 : 9316               subd TEMP_D1
71d3 : dd14               std TEMP_D0
                                ; SUBI.W #$60,D4
                                ; BPL.S L059512
71d5 : dc18               ldd TEMP_D4
71d7 : 830060             subd #$60
71da : dd18               std TEMP_D4
71dc : 2a0f               bpl L059512
71de :                  L05950A:
                                ; LSL.W #1,D0
71de : dc14               ldd TEMP_D0
71e0 : 58                 lslb
71e1 : 49                 rola
71e2 : dd14               std TEMP_D0
                                ; ADDI.W #$18,D4
                                ; BCC.S L05950A
71e4 : dc18               ldd TEMP_D4
71e6 : c30018             addd #$18
71e9 : dd18               std TEMP_D4
71eb : 24f1               bcc L05950A
71ed :                  L059512:
                                ; ADD.W D0,D5
71ed : dc1a               ldd TEMP_D5
71ef : d314               addd TEMP_D0
                          ;TEMP_D0 becomes inactive here
71f1 : dd1a               std TEMP_D5
71f3 :                  L059514:
                                ; BCHG #0,D6
                                ; MOVE.B D6,0(A1)
71f3 : 961c               lda TEMP_D6
71f5 : 8801               eora #1<<0  ;?
71f7 : 971c               sta TEMP_D6
71f9 : a784               sta ,x
                                ; BTST #2,D6
                                ; BEQ.S L05953C
71fb : 8504               bita #1<<2
71fd : 271d               beq L05953C
                                ; MOVE.W $20(A1),D0
                                ; SUBQ.W #1,D0
                                ; BNE.S L059538
71ff : ec8820             ldd $20,x
7202 : 830001             subd #1
7205 : 2612               bne L059538
                                ; MOVE.W $1C(A1),D0
                                ; ADD.W D0,$10(A1)
7207 : ec881c             ldd $1c,x
720a : e38810             addd $10,x
720d : ed8810             std $10,x
                                ; ADD.W $10(A1),D5
                                ; BRA.S L05953C`
7210 : dc1a               ldd TEMP_D5
7212 : e38810             addd $10,x
7215 : dd1a               std TEMP_D5
7217 : 2003               bra L05953C
7219 :                  L059538:
                                ; MOVE.W D0,$20(A1)
7219 : ed8820             std $20,x
721c :                  L05953C:
                                ; BTST #0,$60(A1)
                                ; BEQ.S L059552
721c : a68860             lda $60,x
721f : 8501               bita #1<<0
7221 : 2716               beq L059552
                                ; BCLR #0,$60(A1)
                                ; CLR.B $36(A5)
                                ; MOVEQ #7,D0
                                ; BRA.S L05956C
7223 : a68860             lda $60,x
7226 : 84fe               anda #~(1<<0)
7228 : a78860             sta $60,x
722b : 108eca1e           ldy #LA5_BASE
722f : 8600               lda #0
7231 : a7a836             sta $36,y
7234 : cc0007             ldd #7
7237 : 2022               bra L05956C
7239 :                  L059552:
                                ; MOVE.B $38(A5),D0
                                ; NOT.W D6
                                ; ANDI.W #3,D6
                                ; BNE.S L05956C
7239 : d61c               ldb TEMP_D6
723b : 53                 comb
723c : c403               andb #3
723e : 8600               lda #0
7240 : 1f02               tfr d,y
7242 : ceca1e             ldu #LA5_BASE
7245 : e6c838             ldb $38,u
7248 : 31a4               leay ,y
724a : 260f               bne L05956C
                        
                                ; MOVE.B $34(A5),D0
                                ; BCHG #3,D0
                                ; MOVE.B D0,$36(A5)
724c : 108eca1e           ldy #LA5_BASE
7250 : a6a834             lda $34,y
7253 : 8808               eora #1<<3
7255 : a7a836             sta $36,y
                                ; MOVEQ #7,D0
7258 : cc0007             ldd #7
725b :                  L05956C:
                                ; MOVE.B $41(A5),D1
                                ; EOR.W D1,D0
725b : 108eca1e           ldy #LA5_BASE
725f : e8a841             eorb $41,y
                                ; AND.B $64(A1),D0
                                ; EOR.W D1,D0
7262 : e48864             andb $64,x
7265 : e8a841             eorb $41,y
                                ; MOVE.B D0,$41(A5)
                                ; MOVE.B $34(A1),D4
                                ; RTS
7268 : e7a841             stb $41,y
726b : e68834             ldb $34,x
726e : 8600               lda #0
7270 : dd18               std TEMP_D4
                          ;return values in TEMP_D4, TEMP_D5
7272 : 3588               puls dp,pc
                          direct -1
                        ;  rts
                        
                        ;Data
                        
7274 :                  L059582:  ;word-tabell, readonly. Frequenzies.
7274 : 0eee              dw $EEE
7276 : 0e17              dw $E17
7278 : 0d4d              dw $D4D
727a : 0c8e              dw $C8E
727c : 0bd9              dw $BD9
727e : 0b2f              dw $B2F
7280 : 0a8e              dw $A8E
7282 : 09f7              dw $9F7
7284 : 0967              dw $967
7286 : 08e0              dw $8E0
7288 : 0861              dw $861
728a : 07e8              dw $7E8
728c : 0777              dw $777
728e : 070b              dw $70B
7290 : 06a6              dw $6A6
7292 : 0647              dw $647
7294 : 05ec              dw $5EC
7296 : 0597              dw $597
7298 : 0547              dw $547
729a : 04fb              dw $4FB
729c : 04b3              dw $4B3
729e : 0470              dw $470
72a0 : 0430              dw $430
72a2 : 03f4              dw $3F4
72a4 : 03bb              dw $3BB
72a6 : 0385              dw $385
72a8 : 0353              dw $353
72aa : 0323              dw $323
72ac : 02f6              dw $2F6
72ae : 02cb              dw $2CB
72b0 : 02a3              dw $2A3
72b2 : 027d              dw $27D
72b4 : 0259              dw $259
72b6 : 0238              dw $238
72b8 : 0218              dw $218
72ba : 01fa              dw $1FA
72bc : 01dd              dw $1DD
72be : 01c2              dw $1C2
72c0 : 01a9              dw $1A9
72c2 : 0191              dw $191
72c4 : 017b              dw $17B
72c6 : 0165              dw $165
72c8 : 0151              dw $151
72ca : 013e              dw $13E
72cc : 012c              dw $12C
72ce : 011c              dw $11C
72d0 : 010c              dw $10C
72d2 : 00fd              dw $FD
72d4 : 00ee              dw $EE
72d6 : 00e1              dw $E1
72d8 : 00d4              dw $D4
72da : 00c8              dw $C8
72dc : 00bd              dw $BD
72de : 00b2              dw $B2
72e0 : 00a8              dw $A8
72e2 : 009f              dw $9F
72e4 : 0096              dw $96
72e6 : 008e              dw $8E
72e8 : 0086              dw $86
72ea : 007e              dw $7E
72ec : 0077              dw $77
72ee : 0070              dw $70
72f0 : 006a              dw $6A
72f2 : 0064              dw $64
72f4 : 005e              dw $5E
72f6 : 0059              dw $59
72f8 : 0054              dw $54
72fa : 004f              dw $4F
72fc : 004b              dw $4B
72fe : 0047              dw $47
7300 : 0043              dw $43
7302 : 003f              dw $3F
7304 : 003b              dw $3B
7306 : 0038              dw $38
7308 : 0035              dw $35
730a : 0032              dw $32
730c : 002f              dw $2F
730e : 002c              dw $2C
7310 : 002a              dw $2A
7312 : 0027              dw $27
7314 : 0025              dw $25
7316 : 0023              dw $23
7318 : 0021              dw $21
731a : 001f              dw $1F
731c : 001d              dw $1D
731e : 001c              dw $1C
7320 : 001a              dw $1A
7322 : 0019              dw $19
7324 : 0017              dw $17
7326 : 0016              dw $16
7328 : 0015              dw $15
732a : 0013              dw $13
732c : 0012              dw $12
732e : 0011              dw $11
7330 : 0010              dw $10
7332 : 000f              dw $F
                        
                        
7334 :                  L059642:  ;longword-table, readonly
                         ;Offsets from L059642 to data below
                         if false
                         dw 0,$2C
                         dw 0,$2E
                         dw 0,$32
                         dw 0,$35
                         dw 0,$38
                         dw 0,$3B
                         dw 0,$3E
                         dw 0,$41
                         dw 0,$46
                         dw 0,$4A
                         dw 0,$53
                         endif
                        
                         ;Converted to word-table, saved 22-bytes
7334 : 0016              dw $2C-22
7336 : 0018              dw $2E-22
7338 : 001c              dw $32-22
733a : 001f              dw $35-22
733c : 0022              dw $38-22
733e : 0025              dw $3B-22
7340 : 0028              dw $3E-22
7342 : 002b              dw $41-22
7344 : 0030              dw $46-22
7346 : 0034              dw $4A-22
7348 : 003d              dw $53-22
                        
                         ;Offset $2c
734a : 0087              dw $87
734c : 0007              dw 7
734e : 0c87              dw $C87
7350 : 0004              dw 4
7352 : 8700              dw $8700
7354 : 0287              dw $287
7356 : 0003              dw 3
7358 : 8700              dw $8700
735a : 0587              dw $587
735c : 000e              dw $E
735e : 870c              dw $870C
7360 : 0c0c              dw $C0C
7362 : 1887              dw $1887
7364 : 0004              dw 4
7366 : 0787              dw $787
7368 : 0000              dw 0
736a : 0505              dw $505
736c : 0707              dw $707
736e : 0c0c              dw $C0C
7370 : 8700              dw $8700
7372 : 0006              dw 6
7374 : 0608              dw $608
7376 : 080c              dw $80C
7378 : 0c87              dw $C87
                        
                        
737a :                  L05969E:    ;Jumptable, readonly
                                ; dc.l L_CMD1
                                ; dc.l L_CMD2
                                ; dc.l L_CMD3
                                ; dc.l L_CMD4
                                ; dc.l L_CMD5
                                ; dc.l L_CMD6
                                ; dc.l L_CMD7
                                ; dc.l L_CMD8
                                ; dc.l L_CMD9
                                ; dc.l L_CMD10
                                ; dc.l L_CMD11
                                ; dc.l L_CMD12
                                ; dc.l L_CMD13
                                ; dc.l L_CMD14
                                ; ;dw $FFFF ;-1454
                                ; ;dw $FA52
                                ; ;$590F0
                                ; dc.l L0590F0     ;Används denna?
                                ; dc.l L_CMD16
                                ; dc.l L_CMD17
                                ; dc.l L_CMD18
737a : 70b27091709970..   dw L_CMD1,L_CMD2,L_CMD3,L_CMD4,L_CMD5,L_CMD6,L_CMD7,L_CMD8,L_CMD9,L_CMD10
738e : 70136ff1703570..   dw L_CMD11,L_CMD12,L_CMD13,L_CMD14,0,L_CMD16,L_CMD17,L_CMD18
                        
                        
739e :                  L059818:        ;music-data, readonly
                                ;Song 1, track offsets for each channel
                                ; dc.l TRACK_DATA_CHANNEL1-L059818
                                ; dc.l TRACK_DATA_CHANNEL2-L059818
                                ; dc.l TRACK_DATA_CHANNEL3-L059818
                        
                          ;6809: converted to 16-bit offsets
739e : 000c               dw TRACK_DATA_CHANNEL1-L059818
73a0 : 0056               dw TRACK_DATA_CHANNEL2-L059818
73a2 : 016c               dw TRACK_DATA_CHANNEL3-L059818
                        
                          ;make sure offsets stays the same
73a4 : 000000000000       ds 6
                        
                        ;Track data has been converted to 16-offsets from 32-bits.
                        ;About 600 bytes were saved.
                        ;Offsets modifed to oldvalue-savedspace.
                        
                        ;Define track. 319 is the sum of entries. 0 is end of tracks.
                        mDt macro value
                         if 0=value
                           dw 0
                         else
                           dw value - (319*2)
                         endif
                         endm
                        
                         ;Channel 1 track, offset $C, 37 entries
                         ;Longword offsets to patterns
73aa :                  TRACK_DATA_CHANNEL1:
                         mDt $8E5
                       > if 0=$8E5
                       >   dw 0
                       > else
73aa : 0667            >   dw $8E5 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73ac : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73ae : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73b0 : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73b2 : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73b4 : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73b6 : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73b8 : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73ba : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $87E
                       > if 0=$87E
                       >   dw 0
                       > else
73bc : 0600            >   dw $87E - (319*2)
                       > endif
                        
                         mDt $55F
                       > if 0=$55F
                       >   dw 0
                       > else
73be : 02e1            >   dw $55F - (319*2)
                       > endif
                        
                         mDt $50E
                       > if 0=$50E
                       >   dw 0
                       > else
73c0 : 0290            >   dw $50E - (319*2)
                       > endif
                        
                         mDt $50E
                       > if 0=$50E
                       >   dw 0
                       > else
73c2 : 0290            >   dw $50E - (319*2)
                       > endif
                        
                         mDt $592
                       > if 0=$592
                       >   dw 0
                       > else
73c4 : 0314            >   dw $592 - (319*2)
                       > endif
                        
                         mDt $5F1
                       > if 0=$5F1
                       >   dw 0
                       > else
73c6 : 0373            >   dw $5F1 - (319*2)
                       > endif
                        
                         mDt $87E
                       > if 0=$87E
                       >   dw 0
                       > else
73c8 : 0600            >   dw $87E - (319*2)
                       > endif
                        
                         mDt $55F
                       > if 0=$55F
                       >   dw 0
                       > else
73ca : 02e1            >   dw $55F - (319*2)
                       > endif
                        
                         mDt $50E
                       > if 0=$50E
                       >   dw 0
                       > else
73cc : 0290            >   dw $50E - (319*2)
                       > endif
                        
                         mDt $50E
                       > if 0=$50E
                       >   dw 0
                       > else
73ce : 0290            >   dw $50E - (319*2)
                       > endif
                        
                         mDt $87E
                       > if 0=$87E
                       >   dw 0
                       > else
73d0 : 0600            >   dw $87E - (319*2)
                       > endif
                        
                         mDt $8CC
                       > if 0=$8CC
                       >   dw 0
                       > else
73d2 : 064e            >   dw $8CC - (319*2)
                       > endif
                        
                         mDt $8CC
                       > if 0=$8CC
                       >   dw 0
                       > else
73d4 : 064e            >   dw $8CC - (319*2)
                       > endif
                        
                         mDt $8DA
                       > if 0=$8DA
                       >   dw 0
                       > else
73d6 : 065c            >   dw $8DA - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73d8 : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73da : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73dc : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $9B6
                       > if 0=$9B6
                       >   dw 0
                       > else
73de : 0738            >   dw $9B6 - (319*2)
                       > endif
                        
                         mDt $87E
                       > if 0=$87E
                       >   dw 0
                       > else
73e0 : 0600            >   dw $87E - (319*2)
                       > endif
                        
                         mDt $592
                       > if 0=$592
                       >   dw 0
                       > else
73e2 : 0314            >   dw $592 - (319*2)
                       > endif
                        
                         mDt $5F1
                       > if 0=$5F1
                       >   dw 0
                       > else
73e4 : 0373            >   dw $5F1 - (319*2)
                       > endif
                        
                         mDt $87E
                       > if 0=$87E
                       >   dw 0
                       > else
73e6 : 0600            >   dw $87E - (319*2)
                       > endif
                        
                         mDt $55F
                       > if 0=$55F
                       >   dw 0
                       > else
73e8 : 02e1            >   dw $55F - (319*2)
                       > endif
                        
                         mDt $508
                       > if 0=$508
                       >   dw 0
                       > else
73ea : 028a            >   dw $508 - (319*2)
                       > endif
                        
                         mDt $568
                       > if 0=$568
                       >   dw 0
                       > else
73ec : 02ea            >   dw $568 - (319*2)
                       > endif
                        
                         mDt $568
                       > if 0=$568
                       >   dw 0
                       > else
73ee : 02ea            >   dw $568 - (319*2)
                       > endif
                        
                         mDt $87E
                       > if 0=$87E
                       >   dw 0
                       > else
73f0 : 0600            >   dw $87E - (319*2)
                       > endif
                        
                         mDt 0
                       > if 0=0
73f2 : 0000            >   dw 0
                       > else
                       >   dw 0 - (319*2)
                       > endif
                        
                        
                         ;Channel 2 track, offset $A0, 139 entries
73f4 :                  TRACK_DATA_CHANNEL2:
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
73f4 : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
73f6 : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
73f8 : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
73fa : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
73fc : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
73fe : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
7400 : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $65A
                       > if 0=$65A
                       >   dw 0
                       > else
7402 : 03dc            >   dw $65A - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7404 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7406 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7408 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
740a : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
740c : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
740e : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7410 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7412 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7414 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7416 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7418 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
741a : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $83F
                       > if 0=$83F
                       >   dw 0
                       > else
741c : 05c1            >   dw $83F - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
741e : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7420 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7422 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7424 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7426 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7428 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
742a : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
742c : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
742e : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7430 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7432 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7434 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7436 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7438 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
743a : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
743c : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
743e : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
7440 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
7442 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
7444 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
7446 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
7448 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
744a : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
744c : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
744e : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
7450 : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $6EA
                       > if 0=$6EA
                       >   dw 0
                       > else
7452 : 046c            >   dw $6EA - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
7454 : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
7456 : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $74B
                       > if 0=$74B
                       >   dw 0
                       > else
7458 : 04cd            >   dw $74B - (319*2)
                       > endif
                        
                         mDt $74B
                       > if 0=$74B
                       >   dw 0
                       > else
745a : 04cd            >   dw $74B - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
745c : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
745e : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $7AD
                       > if 0=$7AD
                       >   dw 0
                       > else
7460 : 052f            >   dw $7AD - (319*2)
                       > endif
                        
                         mDt $7AD
                       > if 0=$7AD
                       >   dw 0
                       > else
7462 : 052f            >   dw $7AD - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
7464 : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
7466 : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $7DE
                       > if 0=$7DE
                       >   dw 0
                       > else
7468 : 0560            >   dw $7DE - (319*2)
                       > endif
                        
                         mDt $83F
                       > if 0=$83F
                       >   dw 0
                       > else
746a : 05c1            >   dw $83F - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
746c : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
746e : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7470 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7472 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7474 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7476 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7478 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
747a : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
747c : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
747e : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7480 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7482 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7484 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7486 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7488 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
748a : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $83F
                       > if 0=$83F
                       >   dw 0
                       > else
748c : 05c1            >   dw $83F - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
748e : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
7490 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
7492 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
7494 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
7496 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
7498 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
749a : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
749c : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
749e : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
74a0 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
74a2 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $8F8
                       > if 0=$8F8
                       >   dw 0
                       > else
74a4 : 067a            >   dw $8F8 - (319*2)
                       > endif
                        
                         mDt $83F
                       > if 0=$83F
                       >   dw 0
                       > else
74a6 : 05c1            >   dw $83F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74a8 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74aa : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74ac : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74ae : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74b0 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74b2 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74b4 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $67F
                       > if 0=$67F
                       >   dw 0
                       > else
74b6 : 0401            >   dw $67F - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
74b8 : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
74ba : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $6EA
                       > if 0=$6EA
                       >   dw 0
                       > else
74bc : 046c            >   dw $6EA - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
74be : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $6B5
                       > if 0=$6B5
                       >   dw 0
                       > else
74c0 : 0437            >   dw $6B5 - (319*2)
                       > endif
                        
                         mDt $74B
                       > if 0=$74B
                       >   dw 0
                       > else
74c2 : 04cd            >   dw $74B - (319*2)
                       > endif
                        
                         mDt $74B
                       > if 0=$74B
                       >   dw 0
                       > else
74c4 : 04cd            >   dw $74B - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
74c6 : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
74c8 : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $7AD
                       > if 0=$7AD
                       >   dw 0
                       > else
74ca : 052f            >   dw $7AD - (319*2)
                       > endif
                        
                         mDt $7AD
                       > if 0=$7AD
                       >   dw 0
                       > else
74cc : 052f            >   dw $7AD - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
74ce : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $77C
                       > if 0=$77C
                       >   dw 0
                       > else
74d0 : 04fe            >   dw $77C - (319*2)
                       > endif
                        
                         mDt $7DE
                       > if 0=$7DE
                       >   dw 0
                       > else
74d2 : 0560            >   dw $7DE - (319*2)
                       > endif
                        
                         mDt $83F
                       > if 0=$83F
                       >   dw 0
                       > else
74d4 : 05c1            >   dw $83F - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74d6 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74d8 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74da : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74dc : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74de : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74e0 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74e2 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74e4 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74e6 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74e8 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74ea : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74ec : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74ee : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74f0 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74f2 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74f4 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74f6 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74f8 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74fa : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74fc : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
74fe : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7500 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7502 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $624
                       > if 0=$624
                       >   dw 0
                       > else
7504 : 03a6            >   dw $624 - (319*2)
                       > endif
                        
                         mDt $83F
                       > if 0=$83F
                       >   dw 0
                       > else
7506 : 05c1            >   dw $83F - (319*2)
                       > endif
                        
                         mDt 0
                       > if 0=0
7508 : 0000            >   dw 0
                       > else
                       >   dw 0 - (319*2)
                       > endif
                        
                        
                         ;Channel 3 track, offset $2CC, 143 entries
750a :                  TRACK_DATA_CHANNEL3:
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
750a : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
750c : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
750e : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7510 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7512 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7514 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7516 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7518 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
751a : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
751c : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
751e : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7520 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7522 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7524 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7526 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A76
                       > if 0=$A76
                       >   dw 0
                       > else
7528 : 07f8            >   dw $A76 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
752a : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
752c : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
752e : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
7530 : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $8A1
                       > if 0=$8A1
                       >   dw 0
                       > else
7532 : 0623            >   dw $8A1 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
7534 : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
7536 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7538 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
753a : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
753c : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
753e : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7540 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
7542 : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
7544 : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
7546 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7548 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
754a : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
754c : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
754e : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7550 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
7552 : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
7554 : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
7556 : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
7558 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
755a : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
755c : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
755e : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
7560 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
7562 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
7564 : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
7566 : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
7568 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
756a : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
756c : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
756e : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
7570 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
7572 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
7574 : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
7576 : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
7578 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
757a : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
757c : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
757e : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
7580 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
7582 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $8A1
                       > if 0=$8A1
                       >   dw 0
                       > else
7584 : 0623            >   dw $8A1 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
7586 : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
7588 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
758a : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
758c : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
758e : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
7590 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7592 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
7594 : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
7596 : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
7598 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
759a : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
759c : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
759e : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
75a0 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
75a2 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
75a4 : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $8A1
                       > if 0=$8A1
                       >   dw 0
                       > else
75a6 : 0623            >   dw $8A1 - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75a8 : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75aa : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75ac : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75ae : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75b0 : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75b2 : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75b4 : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75b6 : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75b8 : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75ba : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75bc : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $96C
                       > if 0=$96C
                       >   dw 0
                       > else
75be : 06ee            >   dw $96C - (319*2)
                       > endif
                        
                         mDt $8A1
                       > if 0=$8A1
                       >   dw 0
                       > else
75c0 : 0623            >   dw $8A1 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
75c2 : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
75c4 : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
75c6 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
75c8 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
75ca : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
75cc : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
75ce : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
75d0 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
75d2 : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $AE3
                       > if 0=$AE3
                       >   dw 0
                       > else
75d4 : 0865            >   dw $AE3 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
75d6 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
75d8 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
75da : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
75dc : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
75de : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
75e0 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
75e2 : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $A51
                       > if 0=$A51
                       >   dw 0
                       > else
75e4 : 07d3            >   dw $A51 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
75e6 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AC8
                       > if 0=$AC8
                       >   dw 0
                       > else
75e8 : 084a            >   dw $AC8 - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
75ea : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $AAD
                       > if 0=$AAD
                       >   dw 0
                       > else
75ec : 082f            >   dw $AAD - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
75ee : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $A92
                       > if 0=$A92
                       >   dw 0
                       > else
75f0 : 0814            >   dw $A92 - (319*2)
                       > endif
                        
                         mDt $8A1
                       > if 0=$8A1
                       >   dw 0
                       > else
75f2 : 0623            >   dw $8A1 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
75f4 : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
75f6 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
75f8 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
75fa : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
75fc : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
75fe : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7600 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
7602 : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
7604 : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
7606 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7608 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
760a : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
760c : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
760e : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7610 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
7612 : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
7614 : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
7616 : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7618 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
761a : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $9DF
                       > if 0=$9DF
                       >   dw 0
                       > else
761c : 0761            >   dw $9DF - (319*2)
                       > endif
                        
                         mDt $A1D
                       > if 0=$A1D
                       >   dw 0
                       > else
761e : 079f            >   dw $A1D - (319*2)
                       > endif
                        
                         mDt $A37
                       > if 0=$A37
                       >   dw 0
                       > else
7620 : 07b9            >   dw $A37 - (319*2)
                       > endif
                        
                         mDt $A03
                       > if 0=$A03
                       >   dw 0
                       > else
7622 : 0785            >   dw $A03 - (319*2)
                       > endif
                        
                         mDt $8A1
                       > if 0=$8A1
                       >   dw 0
                       > else
7624 : 0623            >   dw $8A1 - (319*2)
                       > endif
                        
                         mDt 0
                       > if 0=0
7626 : 0000            >   dw 0
                       > else
                       >   dw 0 - (319*2)
                       > endif
                        
                        
                         ;Patterns
7628 : c781              dw $C781
762a : 87ff              dw $87FF
762c : 8087              dw $8087
762e : c18a              dw $C18A
7630 : 8801              dw $8801
7632 : 0281              dw $281
7634 : df00              dw $DF00
7636 : 1104              dw $1104
7638 : e02d              dw $E02D
763a : 2d2d              dw $2D2D
763c : 2d34              dw $2D34
763e : 342d              dw $342D
7640 : 2d30              dw $2D30
7642 : 30e0              dw $30E0
7644 : 3434              dw $3434
7646 : 2d2d              dw $2D2D
7648 : 3434              dw $3434
764a : 3737              dw $3737
764c : 3737              dw $3737
764e : e037              dw $E037
7650 : 3735              dw $3735
7652 : 3535              dw $3535
7654 : 3535              dw $3535
7656 : 3534              dw $3534
7658 : 3434              dw $3434
765a : 34e0              dw $34E0
765c : 3030              dw $3030
765e : 3030              dw $3030
7660 : 3535              dw $3535
7662 : 2d2d              dw $2D2D
7664 : 3030              dw $3030
7666 : 3535              dw $3535
7668 : e02d              dw $E02D
766a : 2d35              dw $2D35
766c : 3532              dw $3532
766e : 3232              dw $3232
7670 : 3232              dw $3232
7672 : 3230              dw $3230
7674 : 30e0              dw $30E0
7676 : 3030              dw $3030
7678 : 3030              dw $3030
767a : 3232              dw $3232
767c : 3232              dw $3232
767e : 87c0              dw $87C0
7680 : df00              dw $DF00
7682 : 6102              dw $6102
7684 : 8801              dw $8801
7686 : 0283              dw $283
7688 : e52d              dw $E52D
768a : 2fe3              dw $2FE3
768c : 30e5              dw $30E5
768e : 3432              dw $3432
7690 : e330              dw $E330
7692 : e52d              dw $E52D
7694 : 30e3              dw $30E3
7696 : 3532              dw $3532
7698 : 32e1              dw $32E1
769a : 30e5              dw $30E5
769c : 2f2d              dw $2F2D
769e : 30e3              dw $30E3
76a0 : 34e5              dw $34E5
76a2 : 3735              dw $3735
76a4 : e334              dw $E334
76a6 : e530              dw $E530
76a8 : 34e3              dw $34E3
76aa : 3532              dw $3532
76ac : 32e1              dw $32E1
76ae : 30e5              dw $30E5
76b0 : 2f87              dw $2F87
76b2 : c08a              dw $C08A
76b4 : 8801              dw $8801
76b6 : 0282              dw $282
76b8 : df00              dw $DF00
76ba : 6102              dw $6102
76bc : e180              dw $E180
76be : e134              dw $E134
76c0 : e032              dw $E032
76c2 : e130              dw $E130
76c4 : e42d              dw $E42D
76c6 : e12b              dw $E12B
76c8 : 2de1              dw $2DE1
76ca : 80e1              dw $80E1
76cc : 34e0              dw $34E0
76ce : 32e1              dw $32E1
76d0 : 30e0              dw $30E0
76d2 : 32e3              dw $32E3
76d4 : 8080              dw $8080
76d6 : e180              dw $E180
76d8 : e132              dw $E132
76da : e030              dw $E030
76dc : e12f              dw $E12F
76de : e430              dw $E430
76e0 : e12f              dw $E12F
76e2 : 2def              dw $2DEF
76e4 : 2be1              dw $2BE1
76e6 : 80e1              dw $80E1
76e8 : 34e0              dw $34E0
76ea : 32e1              dw $32E1
76ec : 30e4              dw $30E4
76ee : 2de1              dw $2DE1
76f0 : 3034              dw $3034
76f2 : e180              dw $E180
76f4 : e139              dw $E139
76f6 : e037              dw $E037
76f8 : e135              dw $E135
76fa : e232              dw $E232
76fc : e180              dw $E180
76fe : e380              dw $E380
7700 : e180              dw $E180
7702 : e137              dw $E137
7704 : e035              dw $E035
7706 : e134              dw $E134
7708 : e435              dw $E435
770a : e337              dw $E337
770c : e635              dw $E635
770e : e834              dw $E834
7710 : 87c0              dw $87C0
7712 : 8a88              dw $8A88
7714 : 0102              dw $102
7716 : 83df              dw $83DF
7718 : 00f1              dw $F1
771a : 02f7              dw $2F7
771c : 32e3              dw $32E3
771e : 3435              dw $3435
7720 : f730              dw $F730
7722 : e380              dw $E380
7724 : 80f7              dw $80F7
7726 : 30e3              dw $30E3
7728 : 3234              dw $3234
772a : ef2f              dw $EF2F
772c : efc6              dw $EFC6
772e : 861d              dw $861D
7730 : c0f7              dw $C0F7
7732 : 30e3              dw $30E3
7734 : 3435              dw $3435
7736 : ff34              dw $FF34
7738 : f735              dw $F735
773a : e337              dw $E337
773c : 39ef              dw $39EF
773e : 37ef              dw $37EF
7740 : c686              dw $C686
7742 : 1d87              dw $1D87
7744 : c0df              dw $C0DF
7746 : 0011              dw $11
7748 : 0fe1              dw $FE1
774a : 8b89              dw $8B89
774c : 1f8d              dw $1F8D
774e : 00e0              dw $E0
7750 : 8a91              dw $8A91
7752 : 2891              dw $2891
7754 : 2d8b              dw $2D8B
7756 : 8907              dw $8907
7758 : 8d00              dw $8D00
775a : 8a91              dw $8A91
775c : 3091              dw $3091
775e : 348b              dw $348B
7760 : 891f              dw $891F
7762 : 8d00              dw $8D00
7764 : e18d              dw $E18D
7766 : 00e0              dw $E0
7768 : 8a91              dw $8A91
776a : 2d91              dw $2D91
776c : 2d8b              dw $2D8B
776e : 8907              dw $8907
7770 : 8d00              dw $8D00
7772 : 8a91              dw $8A91
7774 : 3491              dw $3491
7776 : 3291              dw $3291
7778 : 3087              dw $3087
777a : c0df              dw $C0DF
777c : 0011              dw $11
777e : 0fe1              dw $FE1
7780 : 8b89              dw $8B89
7782 : 1f8d              dw $1F8D
7784 : 0080              dw $80
7786 : e089              dw $E089
7788 : 078d              dw $78D
778a : 0080              dw $80
778c : 8089              dw $8089
778e : 1f8d              dw $1F8D
7790 : 00e1              dw $E1
7792 : 8d00              dw $8D00
7794 : e080              dw $E080
7796 : 8089              dw $8089
7798 : 078d              dw $78D
779a : 0080              dw $80
779c : 8080              dw $8080
779e : 87c0              dw $87C0
77a0 : df00              dw $DF00
77a2 : 110f              dw $110F
77a4 : e18b              dw $E18B
77a6 : 891f              dw $891F
77a8 : 8d00              dw $8D00
77aa : e08a              dw $E08A
77ac : 911c              dw $911C
77ae : 911f              dw $911F
77b0 : 8b89              dw $8B89
77b2 : 078d              dw $78D
77b4 : 008a              dw $8A
77b6 : 9124              dw $9124
77b8 : 9121              dw $9121
77ba : 8b89              dw $8B89
77bc : 1f8d              dw $1F8D
77be : 00e1              dw $E1
77c0 : 8d00              dw $8D00
77c2 : e08a              dw $E08A
77c4 : 911f              dw $911F
77c6 : 9121              dw $9121
77c8 : 8b89              dw $8B89
77ca : 078d              dw $78D
77cc : 008a              dw $8A
77ce : 9124              dw $9124
77d0 : 9121              dw $9121
77d2 : 911f              dw $911F
77d4 : 87c2              dw $87C2
77d6 : df00              dw $DF00
77d8 : 2108              dw $2108
77da : e18b              dw $E18B
77dc : 891f              dw $891F
77de : 8d00              dw $8D00
77e0 : e18a              dw $E18A
77e2 : 9129              dw $9129
77e4 : e08b              dw $E08B
77e6 : 8907              dw $8907
77e8 : 8d00              dw $8D00
77ea : e18a              dw $E18A
77ec : 9129              dw $9129
77ee : e08b              dw $E08B
77f0 : 891f              dw $891F
77f2 : 8d00              dw $8D00
77f4 : e18d              dw $E18D
77f6 : 00e0              dw $E0
77f8 : 8a91              dw $8A91
77fa : 2991              dw $2991
77fc : 1d8b              dw $1D8B
77fe : 8907              dw $8907
7800 : 8d00              dw $8D00
7802 : e18a              dw $E18A
7804 : 9129              dw $9129
7806 : e091              dw $E091
7808 : 2987              dw $2987
780a : c3e1              dw $C3E1
780c : 8b89              dw $8B89
780e : 1f8d              dw $1F8D
7810 : 00e1              dw $E1
7812 : 8a91              dw $8A91
7814 : 29e0              dw $29E0
7816 : 8b89              dw $8B89
7818 : 078d              dw $78D
781a : 00e1              dw $E1
781c : 8a91              dw $8A91
781e : 29e0              dw $29E0
7820 : 8b89              dw $8B89
7822 : 1f8d              dw $1F8D
7824 : 00e1              dw $E1
7826 : 8d00              dw $8D00
7828 : e08a              dw $E08A
782a : 9129              dw $9129
782c : 911d              dw $911D
782e : 8b89              dw $8B89
7830 : 078d              dw $78D
7832 : 00e1              dw $E1
7834 : 8a91              dw $8A91
7836 : 29e0              dw $29E0
7838 : 9129              dw $9129
783a : c4e1              dw $C4E1
783c : 8b89              dw $8B89
783e : 1f8d              dw $1F8D
7840 : 00e1              dw $E1
7842 : 8a91              dw $8A91
7844 : 28e0              dw $28E0
7846 : 8b89              dw $8B89
7848 : 078d              dw $78D
784a : 00e1              dw $E1
784c : 8a91              dw $8A91
784e : 28e0              dw $28E0
7850 : 8b89              dw $8B89
7852 : 1f8d              dw $1F8D
7854 : 00e1              dw $E1
7856 : 8d00              dw $8D00
7858 : e08a              dw $E08A
785a : 9128              dw $9128
785c : 911c              dw $911C
785e : 8b89              dw $8B89
7860 : 078d              dw $78D
7862 : 00e1              dw $E1
7864 : 8a91              dw $8A91
7866 : 28e0              dw $28E0
7868 : 9128              dw $9128
786a : 87c2              dw $87C2
786c : e18b              dw $E18B
786e : 891f              dw $891F
7870 : 8d00              dw $8D00
7872 : e18a              dw $E18A
7874 : 912b              dw $912B
7876 : e08b              dw $E08B
7878 : 8907              dw $8907
787a : 8d00              dw $8D00
787c : e18a              dw $E18A
787e : 912b              dw $912B
7880 : e08b              dw $E08B
7882 : 891f              dw $891F
7884 : 8d00              dw $8D00
7886 : e18d              dw $E18D
7888 : 00e0              dw $E0
788a : 8a91              dw $8A91
788c : 2b91              dw $2B91
788e : 1f8b              dw $1F8B
7890 : 8907              dw $8907
7892 : 8d00              dw $8D00
7894 : e18a              dw $E18A
7896 : 912b              dw $912B
7898 : e091              dw $E091
789a : 2b87              dw $2B87
789c : c4e1              dw $C4E1
789e : 8b89              dw $8B89
78a0 : 1f8d              dw $1F8D
78a2 : 00e1              dw $E1
78a4 : 8a91              dw $8A91
78a6 : 2de0              dw $2DE0
78a8 : 8b89              dw $8B89
78aa : 078d              dw $78D
78ac : 00e1              dw $E1
78ae : 8a91              dw $8A91
78b0 : 2de0              dw $2DE0
78b2 : 8b89              dw $8B89
78b4 : 1f8d              dw $1F8D
78b6 : 00e1              dw $E1
78b8 : 8d00              dw $8D00
78ba : e08a              dw $E08A
78bc : 912d              dw $912D
78be : 9121              dw $9121
78c0 : 8b89              dw $8B89
78c2 : 078d              dw $78D
78c4 : 00e1              dw $E1
78c6 : 8a91              dw $8A91
78c8 : 2de0              dw $2DE0
78ca : 912d              dw $912D
78cc : 87c5              dw $87C5
78ce : e18b              dw $E18B
78d0 : 891f              dw $891F
78d2 : 8d00              dw $8D00
78d4 : e18a              dw $E18A
78d6 : 912b              dw $912B
78d8 : e08b              dw $E08B
78da : 8907              dw $8907
78dc : 8d00              dw $8D00
78de : e18a              dw $E18A
78e0 : 912b              dw $912B
78e2 : e08b              dw $E08B
78e4 : 891f              dw $891F
78e6 : 8d00              dw $8D00
78e8 : e18d              dw $E18D
78ea : 00e0              dw $E0
78ec : 8a91              dw $8A91
78ee : 2b91              dw $2B91
78f0 : 1f8b              dw $1F8B
78f2 : 8907              dw $8907
78f4 : 8d00              dw $8D00
78f6 : e18a              dw $E18A
78f8 : 912b              dw $912B
78fa : e091              dw $E091
78fc : 2b87              dw $2B87
78fe : c3e1              dw $C3E1
7900 : 8b89              dw $8B89
7902 : 1f8d              dw $1F8D
7904 : 00e1              dw $E1
7906 : 8a91              dw $8A91
7908 : 30e0              dw $30E0
790a : 8b89              dw $8B89
790c : 078d              dw $78D
790e : 00e1              dw $E1
7910 : 8a91              dw $8A91
7912 : 30e0              dw $30E0
7914 : 8b89              dw $8B89
7916 : 1f8d              dw $1F8D
7918 : 00e1              dw $E1
791a : 8d00              dw $8D00
791c : e08a              dw $E08A
791e : 9130              dw $9130
7920 : 9124              dw $9124
7922 : 8b89              dw $8B89
7924 : 078d              dw $78D
7926 : 00e1              dw $E1
7928 : 8a91              dw $8A91
792a : 30e0              dw $30E0
792c : 9130              dw $9130
792e : c4e1              dw $C4E1
7930 : 8b89              dw $8B89
7932 : 1f8d              dw $1F8D
7934 : 00e1              dw $E1
7936 : 8a91              dw $8A91
7938 : 2fe0              dw $2FE0
793a : 8b89              dw $8B89
793c : 078d              dw $78D
793e : 00e1              dw $E1
7940 : 8a91              dw $8A91
7942 : 2fe0              dw $2FE0
7944 : 8b89              dw $8B89
7946 : 1f8d              dw $1F8D
7948 : 00e1              dw $E1
794a : 8d00              dw $8D00
794c : e08a              dw $E08A
794e : 912f              dw $912F
7950 : 9123              dw $9123
7952 : 8b89              dw $8B89
7954 : 078d              dw $78D
7956 : 00e1              dw $E1
7958 : 8a91              dw $8A91
795a : 2fe0              dw $2FE0
795c : 912f              dw $912F
795e : 87e1              dw $87E1
7960 : 8b89              dw $8B89
7962 : 1f8d              dw $1F8D
7964 : 0089              dw $89
7966 : 0c8d              dw $C8D
7968 : 008d              dw $8D
796a : 0089              dw $89
796c : 1f8d              dw $1F8D
796e : 00e0              dw $E0
7970 : 8d00              dw $8D00
7972 : 890c              dw $890C
7974 : 8d00              dw $8D00
7976 : e18d              dw $E18D
7978 : 008d              dw $8D
797a : 00e0              dw $E0
797c : 891f              dw $891F
797e : 8d00              dw $8D00
7980 : e18d              dw $E18D
7982 : 00e0              dw $E0
7984 : 890c              dw $890C
7986 : 8d00              dw $8D00
7988 : e18d              dw $E18D
798a : 008d              dw $8D
798c : 008d              dw $8D
798e : 00e3              dw $E3
7990 : 8d00              dw $8D00
7992 : e089              dw $E089
7994 : 1f8d              dw $1F8D
7996 : 008d              dw $8D
7998 : 008d              dw $8D
799a : 008d              dw $8D
799c : 0087              dw $87
799e : c581              dw $C581
79a0 : df00              dw $DF00
79a2 : 1104              dw $1104
79a4 : e128              dw $E128
79a6 : 2828              dw $2828
79a8 : 28e0              dw $28E0
79aa : 2828              dw $2828
79ac : e128              dw $E128
79ae : 28e0              dw $28E0
79b0 : 28e1              dw $28E1
79b2 : 28e0              dw $28E0
79b4 : 28e1              dw $28E1
79b6 : 2828              dw $2828
79b8 : 28e3              dw $28E3
79ba : 28e0              dw $28E0
79bc : 3430              dw $3430
79be : 2d28              dw $2D28
79c0 : 87df              dw $87DF
79c2 : 0061              dw $61
79c4 : 02e1              dw $2E1
79c6 : 9115              dw $9115
79c8 : 9115              dw $9115
79ca : 9115              dw $9115
79cc : 9115              dw $9115
79ce : e091              dw $E091
79d0 : 1591              dw $1591
79d2 : 15e1              dw $15E1
79d4 : 9115              dw $9115
79d6 : 9115              dw $9115
79d8 : e091              dw $E091
79da : 15e1              dw $15E1
79dc : 15e0              dw $15E0
79de : 9115              dw $9115
79e0 : e191              dw $E191
79e2 : 1591              dw $1591
79e4 : 1591              dw $1591
79e6 : 15e3              dw $15E3
79e8 : 9115              dw $9115
79ea : 8087              dw $8087
79ec : 8ad1              dw $8AD1
79ee : 0111              dw $111
79f0 : f188              dw $F188
79f2 : 0606              dw $606
79f4 : 82c6              dw $82C6
79f6 : ff86              dw $FF86
79f8 : 1f87              dw $1F87
79fa : ffc0              dw $FFC0
79fc : 398f              dw $398F
79fe : 3c8f              dw $3C8F
7a00 : 3b34              dw $3B34
7a02 : 2d8f              dw $2D8F
7a04 : 87bd              dw $87BD
7a06 : 8adf              dw $8ADF
7a08 : 00f1              dw $F1
7a0a : 0188              dw $188
7a0c : 0206              dw $206
7a0e : 82c0              dw $82C0
7a10 : ff21              dw $FF21
7a12 : 241d              dw $241D
7a14 : 1a18              dw $1A18
7a16 : 1587              dw $1587
7a18 : c0df              dw $C0DF
7a1a : 0011              dw $11
7a1c : 0fe0              dw $FE0
7a1e : 8b89              dw $8B89
7a20 : 1f8d              dw $1F8D
7a22 : 00e1              dw $E1
7a24 : 8907              dw $8907
7a26 : 8d00              dw $8D00
7a28 : e089              dw $E089
7a2a : 1f8d              dw $1F8D
7a2c : 00e1              dw $E1
7a2e : 8907              dw $8907
7a30 : 8d00              dw $8D00
7a32 : e089              dw $E089
7a34 : 1f8d              dw $1F8D
7a36 : 008d              dw $8D
7a38 : 00e0              dw $E0
7a3a : 8b89              dw $8B89
7a3c : 1f8d              dw $1F8D
7a3e : 00e1              dw $E1
7a40 : 8907              dw $8907
7a42 : 8d00              dw $8D00
7a44 : e089              dw $E089
7a46 : 1f8d              dw $1F8D
7a48 : 00e1              dw $E1
7a4a : 8907              dw $8907
7a4c : 8d00              dw $8D00
7a4e : e089              dw $E089
7a50 : 1f8d              dw $1F8D
7a52 : 008d              dw $8D
7a54 : 00e0              dw $E0
7a56 : 8b89              dw $8B89
7a58 : 1f8d              dw $1F8D
7a5a : 00e1              dw $E1
7a5c : 8907              dw $8907
7a5e : 8d00              dw $8D00
7a60 : e089              dw $E089
7a62 : 1f8d              dw $1F8D
7a64 : 00e1              dw $E1
7a66 : 8907              dw $8907
7a68 : 8d00              dw $8D00
7a6a : e089              dw $E089
7a6c : 1f8d              dw $1F8D
7a6e : 008d              dw $8D
7a70 : 00e0              dw $E0
7a72 : 8b89              dw $8B89
7a74 : 1f8d              dw $1F8D
7a76 : 00e1              dw $E1
7a78 : 8907              dw $8907
7a7a : 8d00              dw $8D00
7a7c : e089              dw $E089
7a7e : 1f8d              dw $1F8D
7a80 : 00e1              dw $E1
7a82 : 8907              dw $8907
7a84 : 8d00              dw $8D00
7a86 : e08d              dw $E08D
7a88 : 008d              dw $8D
7a8a : 0087              dw $87
7a8c : c0df              dw $C0DF
7a8e : 0012              dw $12
7a90 : 0fe0              dw $FE0
7a92 : 9121              dw $9121
7a94 : 9145              dw $9145
7a96 : 9121              dw $9121
7a98 : 9121              dw $9121
7a9a : 9145              dw $9145
7a9c : 9121              dw $9121
7a9e : 9121              dw $9121
7aa0 : 9121              dw $9121
7aa2 : e091              dw $E091
7aa4 : 2191              dw $2191
7aa6 : 4591              dw $4591
7aa8 : 2191              dw $2191
7aaa : 2191              dw $2191
7aac : 4591              dw $4591
7aae : 2191              dw $2191
7ab0 : 2191              dw $2191
7ab2 : 21e0              dw $21E0
7ab4 : 9121              dw $9121
7ab6 : 9145              dw $9145
7ab8 : 9121              dw $9121
7aba : 9121              dw $9121
7abc : 9145              dw $9145
7abe : 9121              dw $9121
7ac0 : 9121              dw $9121
7ac2 : 9121              dw $9121
7ac4 : e091              dw $E091
7ac6 : 2191              dw $2191
7ac8 : 4591              dw $4591
7aca : 2191              dw $2191
7acc : 2191              dw $2191
7ace : 4591              dw $4591
7ad0 : 2191              dw $2191
7ad2 : 4591              dw $4591
7ad4 : 4587              dw $4587
7ad6 : df00              dw $DF00
7ad8 : 210f              dw $210F
7ada : 8a81              dw $8A81
7adc : e1c4              dw $E1C4
7ade : 9139              dw $9139
7ae0 : c0e0              dw $C0E0
7ae2 : 9128              dw $9128
7ae4 : 9034              dw $9034
7ae6 : 9128              dw $9128
7ae8 : 9034              dw $9034
7aea : 9124              dw $9124
7aec : 9030              dw $9030
7aee : e191              dw $E191
7af0 : 21c4              dw $21C4
7af2 : 9139              dw $9139
7af4 : e0c0              dw $E0C0
7af6 : 912b              dw $912B
7af8 : 902d              dw $902D
7afa : 9137              dw $9137
7afc : 9039              dw $9039
7afe : 878a              dw $878A
7b00 : df00              dw $DF00
7b02 : 4103              dw $4103
7b04 : c088              dw $C088
7b06 : 0101              dw $101
7b08 : 82e0              dw $82E0
7b0a : 2115              dw $2115
7b0c : 1f21              dw $1F21
7b0e : e191              dw $E191
7b10 : 8428              dw $8428
7b12 : 0124              dw $124
7b14 : e121              dw $E121
7b16 : e021              dw $E021
7b18 : 151f              dw $151F
7b1a : 21e1              dw $21E1
7b1c : 9184              dw $9184
7b1e : 2801              dw $2801
7b20 : 2421              dw $2421
7b22 : 87e0              dw $87E0
7b24 : 1a0e              dw $1A0E
7b26 : 181a              dw $181A
7b28 : e191              dw $E191
7b2a : 8428              dw $8428
7b2c : 0124              dw $124
7b2e : e11a              dw $E11A
7b30 : e01a              dw $E01A
7b32 : 0e18              dw $E18
7b34 : 1ae1              dw $1AE1
7b36 : 9184              dw $9184
7b38 : 2801              dw $2801
7b3a : 241a              dw $241A
7b3c : 87e0              dw $87E0
7b3e : 180c              dw $180C
7b40 : 1718              dw $1718
7b42 : e191              dw $E191
7b44 : 8428              dw $8428
7b46 : 0124              dw $124
7b48 : e118              dw $E118
7b4a : e018              dw $E018
7b4c : 0c17              dw $C17
7b4e : 18e1              dw $18E1
7b50 : 9184              dw $9184
7b52 : 2801              dw $2801
7b54 : 2418              dw $2418
7b56 : 87e0              dw $87E0
7b58 : 1d11              dw $1D11
7b5a : 1c1d              dw $1C1D
7b5c : e191              dw $E191
7b5e : 8428              dw $8428
7b60 : 0124              dw $124
7b62 : e11d              dw $E11D
7b64 : e01d              dw $E01D
7b66 : 111c              dw $111C
7b68 : 1de1              dw $1DE1
7b6a : 9184              dw $9184
7b6c : 2801              dw $2801
7b6e : 241d              dw $241D
7b70 : 878a              dw $878A
7b72 : df00              dw $DF00
7b74 : 6102              dw $6102
7b76 : c088              dw $C088
7b78 : 0101              dw $101
7b7a : 82e1              dw $82E1
7b7c : 9115              dw $9115
7b7e : 9115              dw $9115
7b80 : e191              dw $E191
7b82 : 8428              dw $8428
7b84 : 0124              dw $124
7b86 : e080              dw $E080
7b88 : e091              dw $E091
7b8a : 15e3              dw $15E3
7b8c : 9115              dw $9115
7b8e : e191              dw $E191
7b90 : 8428              dw $8428
7b92 : 0124              dw $124
7b94 : 8087              dw $8087
7b96 : 8adf              dw $8ADF
7b98 : 0061              dw $61
7b9a : 02c0              dw $2C0
7b9c : 8801              dw $8801
7b9e : 0182              dw $182
7ba0 : e380              dw $E380
7ba2 : e191              dw $E191
7ba4 : 8428              dw $8428
7ba6 : 0124              dw $124
7ba8 : e580              dw $E580
7baa : e191              dw $E191
7bac : 8428              dw $8428
7bae : 0124              dw $124
7bb0 : 8087              dw $8087
7bb2 : e191              dw $E191
7bb4 : 1391              dw $1391
7bb6 : 13e1              dw $13E1
7bb8 : 9184              dw $9184
7bba : 2801              dw $2801
7bbc : 24e0              dw $24E0
7bbe : 80e0              dw $80E0
7bc0 : 9113              dw $9113
7bc2 : e391              dw $E391
7bc4 : 13e1              dw $13E1
7bc6 : 9184              dw $9184
7bc8 : 2801              dw $2801
7bca : 2480              dw $2480
7bcc : 87e1              dw $87E1
7bce : 9111              dw $9111
7bd0 : 9111              dw $9111
7bd2 : e191              dw $E191
7bd4 : 8428              dw $8428
7bd6 : 0124              dw $124
7bd8 : e080              dw $E080
7bda : e091              dw $E091
7bdc : 11e3              dw $11E3
7bde : 9111              dw $9111
7be0 : e191              dw $E191
7be2 : 8428              dw $8428
7be4 : 0124              dw $124
7be6 : 8087              dw $8087
7be8 : e191              dw $E191
7bea : 0c91              dw $C91
7bec : 0ce1              dw $CE1
7bee : 9184              dw $9184
7bf0 : 2801              dw $2801
7bf2 : 24e0              dw $24E0
7bf4 : 80e0              dw $80E0
7bf6 : 910c              dw $910C
7bf8 : e391              dw $E391
7bfa : 0ce1              dw $CE1
7bfc : 9184              dw $9184
7bfe : 2801              dw $2801
7c00 : 2480              dw $2480
7c02 : 87e1              dw $87E1
7c04 : 910e              dw $910E
7c06 : 910e              dw $910E
7c08 : e191              dw $E191
7c0a : 8428              dw $8428
7c0c : 0124              dw $124
7c0e : e080              dw $E080
7c10 : e091              dw $E091
7c12 : 0ee3              dw $EE3
7c14 : 910e              dw $910E
7c16 : e191              dw $E191
7c18 : 8428              dw $8428
7c1a : 0124              dw $124
7c1c : 8087              dw $8087
7c1e : 0000              dw 0
7c20 : 0000              dw 0
7c22 : 0000              dw 0
7c24 : 0000              dw 0
                        
                        
                        ;---------------------
                        ; READ/WRITE memory, 3*102 + 76 = 382 bytes
                        ;---------------------
                        
7c26 :                  LA5_BASE_ROM:  ;status, read/write
                        ; ds 46  ;$2e
                         ;2e is first offset, 44 the highest
7c26 : ff00              dw $FF00
7c28 : 0006              dw 6
7c2a : 0006              dw 6
7c2c : 0700              dw $700
7c2e : 0000              dw 0
7c30 : f800              dw $F800
7c32 : f000              dw $F000
7c34 : dd01              dw $DD01
7c36 : f302              dw $F302
7c38 : 00ea              dw $EA
7c3a : 0f0f              dw $F0F
7c3c : 0f00              dw $F00
7c3e : 0000              dw 0
7c40 : 0020              dw $20
7c42 : ffff              dw $FFFF
                        
                        
                        ;+ = reset in init
7c44 :                  L0596E6_ROM:  ;channel 1 data, read/write, 102 bytes
7c44 : 0000              dw 0   ;0 +
7c46 : 0000              dw 0   ;2
7c48 : 00000000          dw 0,0   ;4 +
7c4c : 00000000          dw 0,0   ;8 +
7c50 : 00000000          dw 0,0   ;C +
7c54 : 0000              dw 0
7c56 : 0000              dw 0
7c58 : 0003              dw 3
7c5a : 05ca              dw $5CA
7c5c : 0003              dw 3
7c5e : 05cb              dw $5CB
7c60 : 0000              dw 0
7c62 : 0000              dw 0
7c64 : 0000              dw 0
7c66 : 0000              dw 0
7c68 : 0000              dw 0
7c6a : 0000              dw 0
7c6c : 0000              dw 0  ;$28 +
7c6e : 0000              dw 0
7c70 : 0002              dw 2
7c72 : 0000              dw 0
7c74 : 002b              dw $2B
7c76 : 0000              dw 0
7c78 : 0f00              dw $F00
7c7a : 0000              dw 0
7c7c : 0000              dw 0
7c7e : 0000              dw 0
7c80 : 6100              dw $6100
7c82 : 0000              dw 0
7c84 : 0100              dw $100
7c86 : 0000              dw 0
7c88 : 0200              dw $200
7c8a : 0000              dw 0
7c8c : 0200              dw $200
7c8e : 0000              dw 0
7c90 : 0f00              dw $F00
7c92 : 0000              dw 0
7c94 : 0002              dw 2
7c96 : 0000              dw 0
7c98 : 0001              dw 1
7c9a : 0000              dw 0
7c9c : 0003              dw 3
7c9e : 0000              dw 0
7ca0 : 00                db 0  ;$5c +
7ca1 : 00                db 0
7ca2 : 0000              dw 0
7ca4 : 0000              dw 0
7ca6 : 0000              dw 0
7ca8 : 0900              dw $900
7caa :                  L05974C_ROM:  ;channel 2 data, read/write
7caa : 2100              dw $2100
7cac : 0000              dw 0
7cae : 0003              dw 3
7cb0 : 0e24              dw $E24
7cb2 : 0003              dw 3
7cb4 : 0814              dw $814
7cb6 : 0000              dw 0
7cb8 : 0098              dw $98
7cba : 0000              dw 0
7cbc : 0000              dw 0
7cbe : 0003              dw 3
7cc0 : 05ca              dw $5CA
7cc2 : 0003              dw 3
7cc4 : 05cb              dw $5CB
7cc6 : 0000              dw 0
7cc8 : 0000              dw 0
7cca : 0000              dw 0
7ccc : 0000              dw 0
7cce : 0000              dw 0
7cd0 : 0000              dw 0
7cd2 : 0001              dw 1
7cd4 : 0000              dw 0
7cd6 : 0001              dw 1
7cd8 : 0000              dw 0
7cda : 0024              dw $24
7cdc : 0000              dw 0
7cde : 0f00              dw $F00
7ce0 : 0000              dw 0
7ce2 : 0000              dw 0
7ce4 : 0000              dw 0
7ce6 : 1100              dw $1100
7ce8 : 0000              dw 0
7cea : 1100              dw $1100
7cec : 0000              dw 0
7cee : 0f00              dw $F00
7cf0 : 0000              dw 0
7cf2 : 0f00              dw $F00
7cf4 : 0000              dw 0
7cf6 : 0f00              dw $F00
7cf8 : 0000              dw 0
7cfa : 0000              dw 0
7cfc : 0000              dw 0
7cfe : 0000              dw 0
7d00 : 0000              dw 0
7d02 : 0000              dw 0
7d04 : 0000              dw 0
7d06 : 0000              dw 0
7d08 : 0000              dw 0
7d0a : 0000              dw 0
7d0c : 0000              dw 0
7d0e : 1200              dw $1200
7d10 :                  L0597B2_ROM:  ;channel 3 data, read/write
7d10 : 2500              dw $2500
7d12 : 0000              dw 0
7d14 : 0003              dw 3
7d16 : 11e8              dw $11E8
7d18 : 0003              dw 3
7d1a : 0a40              dw $A40
7d1c : 0000              dw 0
7d1e : 0098              dw $98
7d20 : 0118              dw $118
7d22 : 0000              dw 0
7d24 : 0003              dw 3
7d26 : 05ca              dw $5CA
7d28 : 0003              dw 3
7d2a : 05cb              dw $5CB
7d2c : 0028              dw $28
7d2e : 0000              dw 0
7d30 : 0001              dw 1
7d32 : 0000              dw 0
7d34 : 0000              dw 0
7d36 : 0000              dw 0
7d38 : 0001              dw 1
7d3a : 0000              dw 0
7d3c : 0002              dw 2
7d3e : 0000              dw 0
7d40 : 0024              dw $24
7d42 : 0000              dw 0
7d44 : 0f00              dw $F00
7d46 : 0000              dw 0
7d48 : 0000              dw 0
7d4a : 0000              dw 0
7d4c : 6100              dw $6100
7d4e : 0000              dw 0
7d50 : 0100              dw $100
7d52 : 0000              dw 0
7d54 : 0200              dw $200
7d56 : 0000              dw 0
7d58 : 0200              dw $200
7d5a : 0000              dw 0
7d5c : 0f00              dw $F00
7d5e : 0000              dw 0
7d60 : 0001              dw 1
7d62 : 0000              dw 0
7d64 : 0001              dw 1
7d66 : 0000              dw 0
7d68 : 0000              dw 0
7d6a : 0000              dw 0
7d6c : 4000              dw $4000
7d6e : 0000              dw 0
7d70 : 0000              dw 0
7d72 : 0000              dw 0
7d74 : 2400              dw $2400
                        
                        
                        
                        
                        
                        ;-----------------
                        ;Vectrex RAM section
                          bss
                        
c8a0 =                    org TemporaryArea
                        
c8a0 =                  TitleLogoY: ds 1
c8a1 =                  VolumeTimer: ds 1
                        
c8a2 =                  ScrollInt: ds 1
c8a3 =                  ScrollTextPtr: ds 2
c8a5 =                  SineIndex1: ds 1
c8a6 =                  SineIndex2: ds 1
                        
                          code
                        
                          include "Thrust_Eeprom.asm"
                        ;Thrust EEPROM support
                        ;368 bytes
                        ;todo optimize size:  gör om ds1w_txbyte så att den tar count i A och data i X
                        ;                     load o verify har samma setup-code, gör till en sub som bägge anropar
                        
                        
                        ;
                        ;
                        ; Example DS2430A code
                        ;
                        ;
                        ; Copyright (c) 2003 Alex Herbert
                        ;
                        ;
                        
                        
                        ; PIA Registers
                        
d000 =                  CNTRL   equ     $d000   ; ORB / IRB - Output Register B / Input Register B
d001 =                  DAC     equ     $d001   ; ORA / IRA - Output Register A / Input Register A
d002 =                  DCNTRL  equ     $d002   ; DDRB      - Data Direction Register B
d003 =                  DDAC    equ     $d003   ; DDRA      - Data Direction Register A
d004 =                  T1LOLC  equ     $d004   ; T1C-L     - Timer 1 Counter/Latch Low byte
d005 =                  T1HOC   equ     $d005   ; T1C-H     - Timer 1 Counter High byte
d006 =                  T1LOL   equ     $d006   ; T1L-L     - Timer 1 Latch Low byte
d007 =                  T1HOL   equ     $d007   ; T1L-H     - Timer 1 Latch High byte
d008 =                  T2LOLC  equ     $d008   ; T2C-L     - Timer 2 Counter/Latch Low byte
d009 =                  T2HOC   equ     $d009   ; T2C-H     - Timer 2 Counter High byte
d00a =                  SHIFT   equ     $d00a   ; SR        - Shift Register
d00b =                  ACNTRL  equ     $d00b   ; ACR       - Auxiliary Control Register
d00c =                  PCNTRL  equ     $d00c   ; PCR       - Peripheral Control Register
d00d =                  IFLAG   equ     $d00d   ; IFR       - Interrupt Flag Register
d00e =                  IENABL  equ     $d00e   ; IER       - Interrupt Enable Register
                        
                        
                        
                        DP_IO macro
                          lda   #0xD0
                          tfr   a,dp
                          endm
                        
                        
                        ; EEPROM constants
0087 =                  EEPROM_CHECKSUM equ     $87     ; any value other than $00 or $e0
                        
                        
                        ;
                        ;
                        ; DS1W - Dallas Semiconductor 1-Wire Driver
                        ;
                        ;
                        ; Copyright (c) 2002 Alex Herbert
                        ;
                        ;
                        
                        
                        ; 1-Wire Timing constants
2a03 =                  DS1W_RESETDUR   equ     $2a03   ; Reset Pulse duration
                                                        ; $032a = 810 cycles = 540us
                        
d002 =                  DS1W_PRESDUR    equ     $d002   ; Presence Pulse duration
                                                        ; $02d0 = 720 cycles = 480us
                        
0078 =                  DS1W_TSLOTDUR   equ     $78     ; Time Slot duration
                                                        ; $78 = 120cycles = 80us
                        
                        
                        ; Note:
                        ;
                        ; For reliability DS1W_RESETDUR and DS1W_TSLOTDUR are set above the
                        ; minimums specified by the datasheet. To improve performance, values
                        ; closer to the specified minimums may be used.
                        ;
                        ; DS1W_RESETDUR minimum = 480us
                        ; DS1W_TSLOTDUR minimum = 60us
                        
                        
                        
                        
                        ; 1-Wire ROM commands
                        
0033 =                  DS1W_READROM    equ     $33
00cc =                  DS1W_SKIPROM    equ     $cc
                        
0055 =                  DS1W_MATCHROM   equ     $55
00f0 =                  DS1W_SEARCHROM  equ     $f0
                        
                        
                        
                        
                        ; Subroutines
                        
                                code
                        
                                direct  CNTRL
                        
                        
                        
                        ; ds1w_open
                        ;
                        ; function:
                        ;       Prepares Vectrex I/O hardware (6522) for 1-Wire communication.
                        ;
                        ; on entry:
                        ;       dp = $d0
                        ;
                        ; on exit:
                        ;       d  = undefined
7d76 :                  ds1w_open
7d76 : cc8118                   ldd     #$8118
7d79 : 9700                     sta     CNTRL           ; make sure PB7 is set, PB6 is cleared
7d7b : d70b                     stb     ACNTRL          ; Disable T1 output on PB7 (RAMP)
7d7d : 39                       rts
                        
                        
                        
                        
                        ; ds1w_close
                        ;
                        ; function:
                        ;       Restores Vectrex I/O hardware (6522) defaults.
                        ;
                        ; on entry:
                        ;       dp = $d0
                        ;
                        ; on exit:
                        ;       b  = undefined
7d7e :                  ds1w_close
7d7e : c698                     ldb     #$98
7d80 : d70b                     stb     ACNTRL          ; Enable T1 output on PB7 (RAMP)
7d82 : 39                       rts
                        
                        
                        
                        
                        ; ds1w_reset
                        ;
                        ; function:
                        ;       Reset 1-Wire device(s), and detect if device is present.
                        ;
                        ; on entry:
                        ;       dp = $d0
                        ;
                        ; on exit:
                        ;       a  = 0 if device is present, -1 if not.
                        ;       b  = undefined
                        ;       cc = z=1 and n=0 if device present,
                        ;            z=0 and n=1 if device not present.
7d83 :                  ds1w_reset
7d83 : cc2a03                   ldd     #DS1W_RESETDUR  ; reset pulse duration
7d86 : dd04                     std     T1LOLC          ; start timer
                        
                                ; generate reset pulse
                        
7d88 : 86df                     lda     #$df
7d8a : 9702                     sta     DCNTRL          ; PB6 direction = output
                        
7d8c : c640                     ldb     #$40
7d8e :                  dsreset_loop1
7d8e : d50d                     bitb    IFLAG
7d90 : 27fc                     beq     dsreset_loop1   ; wait for timer
                        
7d92 : 869f                     lda     #$9f
7d94 : 9702                     sta     DCNTRL          ; PB6 direction = input
                        
                                ; check for presence pulse
                        
7d96 : d500                     bitb    CNTRL           ; test PB6
7d98 : 271f                     beq     ds1w_notpresent ; PB6 was low too early (emulator?)
                        
7d9a : ccd002                   ldd     #DS1W_PRESDUR   ; presence pulse detect duration
7d9d : dd04                     std     T1LOLC          ; start timer
                        
7d9f : c640                     ldb     #$40
7da1 :                  dsreset_loop2
7da1 : d500                     bitb    CNTRL           ; test PB6
7da3 : 2706                     beq     dsreset_loop3
7da5 : d50d                     bitb    IFLAG           ; timeout?
7da7 : 27f8                     beq     dsreset_loop2
7da9 : 200e                     bra     ds1w_notpresent ; PB6 didn't go low (no device attached?)
                        
7dab :                  dsreset_loop3
7dab : d50d                     bitb    IFLAG
7dad : 27fc                     beq     dsreset_loop3   ; wait for timer
                        
7daf : d500                     bitb    CNTRL
7db1 : 2706                     beq     ds1w_notpresent ; PB6 stayed low too long (fault?)
                        
7db3 :                  ds1w_present
7db3 : 8678                     lda     #DS1W_TSLOTDUR  ; time slot duration
7db5 : 9704                     sta     T1LOLC          ; load timer latch
                        
7db7 : 4f                       clra                    ; return "no error"
7db8 : 39                       rts
                        
7db9 :                  ds1w_notpresent
7db9 : 86ff                     lda     #-1             ; return "device not present"
7dbb : 39                       rts
                        
                        
                        
                        
                        ; ds1w_txbyte
                        ;
                        ; function:
                        ;       Transmit byte to 1-Wire device.
                        ;
                        ; on entry:
                        ;       a  = byte to send
                        ;       dp = $d0
                        ;
                        ; on exit:
                        ;       d  = undefined
7dbc :                  ds1w_txbyte
7dbc : c608                     ldb     #$08            ; bits in byte
7dbe : e77f                     stb     -1,sp           ; put loop counter 'above' stack
                        
7dc0 :                  ds1w_txbits
7dc0 : 44                       lsra                    ; shift data into carry
7dc1 : 2515                     bcs     ds1w_txbit1
                        
7dc3 :                  ds1w_txbit0
7dc3 : 0f05                     clr     T1HOC           ; start timer
                        
                                ; long pulse low  ~~\________/~~
                        
7dc5 : c6df                     ldb     #$df
7dc7 : d702                     stb     DCNTRL          ; PB6 direction = output
                        
7dc9 : c640                     ldb     #$40
7dcb :                  dstx0_loop
7dcb : d50d                     bitb    IFLAG
7dcd : 27fc                     beq     dstx0_loop      ; wait for end of time slot
                        
7dcf : c69f                     ldb     #$9f
7dd1 : d702                     stb     DCNTRL          ; PB6 direction = input
                        
7dd3 : 6a7f                     dec     -1,sp
7dd5 : 26e9                     bne     ds1w_txbits
7dd7 : 39                       rts
                        
7dd8 :                  ds1w_txbit1
7dd8 : 0f05                     clr     T1HOC           ; start timer
                        
                                ; short pulse low  ~~\_/~~~~~~~~~
                        
7dda : c6df                     ldb     #$df
7ddc : d702                     stb     DCNTRL          ; PB6 direction = output
                        
7dde : c69f                     ldb     #$9f
7de0 : d702                     stb     DCNTRL          ; PB6 direction = input
                        
7de2 : c640                     ldb     #$40
7de4 :                  dstx1_loop
7de4 : d50d                     bitb    IFLAG
7de6 : 27fc                     beq     dstx1_loop      ; wait for end of time slot
                        
7de8 : 6a7f                     dec     -1,sp
7dea : 26d4                     bne     ds1w_txbits
7dec : 39                       rts
                        
                        
                        
                        
                        ; ds1w_rxbyte
                        ;
                        ; function:
                        ;       Receive byte from 1-Wire device.
                        ;
                        ; on entry:
                        ;       dp = $d0
                        ;
                        ; on exit:
                        ;       a  = received byte
                        ;       b  = undefined
7ded :                  ds1w_rxbyte
7ded : c608                     ldb     #$08            ; bits in byte
7def : e77f                     stb     -1,sp           ; put loop counter 'above' stack
                        
7df1 :                  ds1w_rxbits
7df1 : 0f05                     clr     T1HOC           ; start timer
                        
                                ; short pulse low  ~~\_xxxxxx~~~~
                        
7df3 : c6df                     ldb     #$df
7df5 : d702                     stb     DCNTRL          ; PB6 direction = output
                        
7df7 : c69f                     ldb     #$9f
7df9 : d702                     stb     DCNTRL          ; PB6 direction = input
                        
                                ; read response
                        
7dfb : 12                       nop                     ; timing
                        
7dfc : d600                     ldb     CNTRL           ; read PB
7dfe : 58                       lslb                    ; shift PB6...
7dff : 58                       lslb                    ; ...into carry...
7e00 : 46                       rora                    ; ...and rotate into result byte
                        
7e01 : c640                     ldb     #$40
7e03 :                  dsrx_loop
7e03 : d50d                     bitb    IFLAG
7e05 : 27fc                     beq     dsrx_loop       ; wait for end of time slot
                        
7e07 : 6a7f                     dec     -1,sp
7e09 : 26e6                     bne     ds1w_rxbits
7e0b : 39                       rts
                        
                                direct  -1
                        
                        
                        
                        
                        ; ds2430_verify
                        ;
                        ; function:
                        ;       compare DS2430 EEPROM to RAM
                        ;
                        ; on entry:
                        ;       x = data address
                        ;
                        ; on exit:
                        ;       a = 0 if same,
                        ;           non-zero if different
7e0c :                  ds2430_verify
7e0c : 8620                     lda     #$20            ; number of bytes to verify (loop counter)
7e0e : 341e                     pshs    d,dp,x          ; stack used registers
                        
                                DP_IO                   ; dp = $d0
7e10 : 86d0            >  lda   #0xD0
7e12 : 1f8b            >  tfr   a,dp
                        
                        
7e14 : bd7d76                   jsr     ds1w_open       ; open 1-wire port
                        
7e17 : bd7d83                   jsr     ds1w_reset      ; reset device
7e1a : 2b15                     bmi     dsverify_exit   ; exit if no device present
                        
7e1c : 86cc                     lda     #DS1W_SKIPROM   ; no need to access rom
7e1e : 8d9c                     jsr     ds1w_txbyte     ; send command
                        
7e20 : 86f0                     lda     #DS2430_READMEM ; copy eeprom to scratch pad
7e22 : 8d98                     jsr     ds1w_txbyte     ; send command
                        
7e24 : 4f                       clra                    ; address of first byte to verify
7e25 : 8d95                     jsr     ds1w_txbyte     ; send address
                        
7e27 :                  dsverify_loop
7e27 : 8dc4                     jsr     ds1w_rxbyte     ; read byte from scratch pad
7e29 : a180                     cmpa    ,x+             ; compare to ram
7e2b : 2604                     bne     dsverify_exit   ; exit if not same
7e2d : 6ae4                     dec     ,s              ; decrement loop counter
7e2f : 26f6                     bne     dsverify_loop   ; until all bytes are read
                        
7e31 :                  dsverify_exit
7e31 : bd7d7e                   jsr     ds1w_close      ; close port
7e34 : 359e                     puls    d,dp,x,pc       ; restore registers from stack and return
                        
                                direct  -1
                        
                        ; DS2430 Commands
                        
000f =                  DS2430_WRITESP  equ     $0f     ; Write bytes to Scratch Pad
0055 =                  DS2430_COPYSP   equ     $55     ; Copy entire Scratch Pad to EEPROM
00aa =                  DS2430_READSP   equ     $aa     ; Read bytes from Scratch Pad
00f0 =                  DS2430_READMEM  equ     $f0     ; As READSP, but copies EEPROM to SP first
                        
005a =                  DS2430_LOCKAR   equ     $5a     ; Lock Application Register
0066 =                  DS2430_READSR   equ     $66     ; Read Status Register
0099 =                  DS2430_WRITEAR  equ     $99     ; Write bytes to Application Register
00c3 =                  DS2430_READAR   equ     $c3     ; Read bytes from Application Register
                        
00a5 =                  DS2430_VALKEY   equ     $a5     ; Validation byte for COPYSP and LOCKAR
                        
                        
                        
                        ; DS2430 Timings
                        
983a =                  DS2430_COPYDUR  equ     $983a   ; $3a98 = 15000 cycles = 10ms
                        
                        
                        
                        
                        
                        ; ds2430_load
                        ;
                        ; function:
                        ;       load DS2430 EEPROM to RAM
                        ;
                        ; on entry:
                        ;       x = load address
                        ;
                        ; on exit:
                        ;       a = 0 if no error,
                        ;           non-zero if error
7e36 :                  ds2430_load
7e36 : 8620                     lda     #$20            ; number of bytes to load (loop counter)
7e38 : 341e                     pshs    d,dp,x          ; stack used registers
                        
                                DP_IO                   ; dp = $d0
7e3a : 86d0            >  lda   #0xD0
7e3c : 1f8b            >  tfr   a,dp
                        
                        
7e3e : bd7d76                   jsr     ds1w_open       ; open 1-wire port
                        
7e41 : bd7d83                   jsr     ds1w_reset      ; reset device
7e44 : 2b16                     bmi     dsload_exit     ; exit if no device present
                        
7e46 : 86cc                     lda     #DS1W_SKIPROM   ; no need to access rom
7e48 : bd7dbc                   jsr     ds1w_txbyte     ; send command
                        
7e4b : 86f0                     lda     #DS2430_READMEM ; copy eeprom to scratch pad
7e4d : bd7dbc                   jsr     ds1w_txbyte     ; send command
                        
7e50 : 4f                       clra                    ; address of first byte to load
7e51 : bd7dbc                   jsr     ds1w_txbyte     ; send address
                        
7e54 :                  dsload_loop
7e54 : 8d97                     jsr     ds1w_rxbyte     ; read byte from scratch pad
7e56 : a780                     sta     ,x+             ; save to ram
7e58 : 6ae4                     dec     ,s              ; decrement loop counter
7e5a : 26f8                     bne     dsload_loop     ; until all bytes are read
                        
7e5c :                  dsload_exit
7e5c : bd7d7e                   jsr     ds1w_close      ; close port
7e5f : 359e                     puls    d,dp,x,pc       ; restore registers from stack and return
                        
                                direct  -1
                        
                        
                        
                        
                        ; ds2430_save
                        ;
                        ; function:
                        ;       save RAM to DS2430 EEPROM
                        ;
                        ; on entry:
                        ;       x = address of data to save
                        ;
                        ; on exit:
                        ;       a = 0 if no error,
                        ;           non-zero if error
7e61 :                  ds2430_save
7e61 : 8620                     lda     #$20            ; number of bytes to save (loop counter)
7e63 : 341e                     pshs    d,dp,x          ; stack used registers
                        
                                DP_IO                   ; dp = $d0
7e65 : 86d0            >  lda   #0xD0
7e67 : 1f8b            >  tfr   a,dp
                        
                        
7e69 : bd7d76                   jsr     ds1w_open       ; open 1-wire port
                        
7e6c : bd7d83                   jsr     ds1w_reset      ; reset device
7e6f : 2b36                     bmi     dssave_exit     ; exit if no device present
                        
7e71 : 86cc                     lda     #DS1W_SKIPROM   ; no need to access rom
7e73 : bd7dbc                   jsr     ds1w_txbyte     ; send command
                        
7e76 : 860f                     lda     #DS2430_WRITESP ; write bytes to scratch pad
7e78 : bd7dbc                   jsr     ds1w_txbyte     ; send command
                        
7e7b : 4f                       clra                    ; address of first byte
7e7c : bd7dbc                   jsr     ds1w_txbyte     ; send address
                        
7e7f :                  dssave_loop
7e7f : a680                     lda     ,x+             ; get byte from ram
7e81 : bd7dbc                   jsr     ds1w_txbyte     ; send byte
7e84 : 6ae4                     dec     ,s              ; decrement loop counter
7e86 : 26f7                     bne     dssave_loop     ; until all bytes are sent
                        
7e88 : bd7d83                   jsr     ds1w_reset      ; reset device
                        
7e8b : 86cc                     lda     #DS1W_SKIPROM   ; no need to access rom
7e8d : bd7dbc                   jsr     ds1w_txbyte     ; send command
                        
7e90 : 8655                     lda     #DS2430_COPYSP  ; copy scratch pad to eeprom
7e92 : bd7dbc                   jsr     ds1w_txbyte     ; send command
                        
7e95 : 86a5                     lda     #DS2430_VALKEY  ; validation key
7e97 : bd7dbc                   jsr     ds1w_txbyte     ; send key
                        
7e9a : cc983a                   ldd     #DS2430_COPYDUR ; eeprom write (scratch pad copy) duration
7e9d : fdd004                   std     T1LOLC          ; start timer
                        
7ea0 : c640                     ldb     #$40
7ea2 :                  dssave_loop2
7ea2 : f5d00d                   bitb    IFLAG
7ea5 : 27fb                     beq     dssave_loop2    ; wait for timer
                        
7ea7 :                  dssave_exit
7ea7 : bd7d7e                   jsr     ds1w_close      ; close port
7eaa : 359e                     puls    d,dp,x,pc       ; restore registers from stack and return
                        
                                direct  -1
                        
                        
                        
7eac :                  eeprom_load
7eac : 8ec880                   ldx     #eeprom_buffer          ;
7eaf : 8d85                     jsr     ds2430_load             ; load 32 byte eeprom to ram
                        
7eb1 : cc0020                   ldd     #$0020                  ;
7eb4 :                  eeload_loop                             ;
7eb4 : ab80                     adda    ,x+                     ; sum the bytes
7eb6 : 5a                       decb                            ;
7eb7 : 26fb                     bne     eeload_loop             ;
                        
7eb9 : 8187                     cmpa    #EEPROM_CHECKSUM        ; equal to checksum?
7ebb : 2608                     bne     eeprom_format           ; if not, then format the eeprom
                        
7ebd : 39                       rts                             ; otherwise, return
                        
                        
                        ;Init eeprom-buffer with valid data
                        ;Called when eeprom is erased, or eeprom is not present
7ebe : 20203130303080   DefaultString: db '  1000',$80
7ec5 :                  eeprom_format
7ec5 : cec880             ldu #eeprom_buffer
                          mCombine d,DefaultButtonConfig,0
7ec8 : ccd800          >  ldd #(lo DefaultButtonConfig)<<8 | (lo 0)
                        
                          ;First byte is control, second is bonusgameenabled, the rest are highscores
7ecb : edc1               std ,u++
7ecd : c604               ldb #4
7ecf :                  eeformat_loop
7ecf : 8e7ebe             ldx #DefaultString
7ed2 : bdf8de             jsr Text_CopyString
7ed5 : 5a                 decb
7ed6 : 26f7               bne eeformat_loop
                        
                        
                        ;        ldx     #eeprom_buffer          ;
                        ;        ldu     #eeprom_defaults        ;
                        ;        ldb     #$1f                    ;
                        ;eeformat_loop                           ; copy default data (rom) to ram
                        ;        pulu    a                       ;
                        ;        sta     ,x+                     ;
                        ;        decb                            ;
                        ;        bne     eeformat_loop           ;
                        
                        
7ed8 :                  eeprom_save
7ed8 : 8ec880                   ldx     #eeprom_buffer          ;
7edb : cc871f                   ldd     #(EEPROM_CHECKSUM<<8)+$1f ;
7ede :                  eesave_loop                             ;
7ede : a080                     suba    ,x+                     ; create checksum byte
7ee0 : 5a                       decb                            ;
7ee1 : 26fb                     bne     eesave_loop             ;
7ee3 : a784                     sta     ,x                      ;
                        
7ee5 : 8ec880                   ldx     #eeprom_buffer          ;
7ee8 : bd7e0c                   jsr     ds2430_verify           ; compare ram to eeprom
7eeb : 4d                       tsta                            ;
7eec : 1026ff71                 bne     ds2430_save             ; if different, then update eeprom
                        
7ef0 : 39                       rts
                        
                        
                        
                        
ùðÄ^ü&Æ0008 =                  
No code generated.
